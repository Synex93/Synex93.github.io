<!DOCTYPE html>
<html lang="en" >

<head>
    <meta charset="UTF-8"><meta http-equiv="Content-Security-Policy"
content="default-src 'self';font-src 'self' data:;img-src 'self' https://* data:;media-src 'self';style-src 'self';frame-src player.vimeo.com https://www.youtube-nocookie.com;connect-src 'self';script-src 'self' 'self'">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="base" content="https://synex.space/">

    
    <title>
~/Syn3x • Reverse-自写壳学习与加密壳实现</title>

    
    
    

    
    

    
    
    
        
            <link rel="stylesheet" href="https://synex.space/custom_subset.css?h=0b9535a28bc3d5bf2321">
        
    

    
        <link rel="stylesheet" href="https://synex.space/main.css?h=045c365e19a4d50a64bb" />
        <link rel="stylesheet" href="https://synex.space/skins/mint.css?h=504215cf6bc10586b487" />

    <meta name="color-scheme" content="light dark" />
        <meta name="description" content="" />
        <meta property="og:description" content="" />

    

    <meta property="og:title" content="Reverse-自写壳学习与加密壳实现" />
    <meta property="og:type" content="article" />

    
<meta property="og:locale" content="en_GB" />

    <meta property="og:url" content="https:&#x2F;&#x2F;synex.space&#x2F;blog&#x2F;reverse-zi-xie-ke-xue-xi-yu-jia-mi-ke-shi-xian&#x2F;" /><meta property="og:site_name" content="~&#x2F;Syn3x">
        <noscript><link rel="stylesheet" href="https://synex.space/no_js.css"/></noscript>
        <script type="text/javascript" src="https://synex.space/js/initializeTheme.min.js"></script>
        <script defer src="https://synex.space/js/themeSwitcher.min.js"></script>
        <script defer src="https://synex.space/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e"></script>

        
    
</head>


<body>
    <a href="#main-content" id="skip-link">Skip to content</a>
    <header>
    <nav class="navbar">
        <div class="nav-title">
            <a class="home-title" href="https://synex.space/">~&#x2F;Syn3x</a>
        </div>
            <div class="nav-navs">
                <ul>
                        
                            <li>
                                <a class="nav-links no-hover-padding" href="https://synex.space/blog/">blog
                                </a>
                            </li>
                        
                            <li>
                                <a class="nav-links no-hover-padding" href="https://synex.space/archive/">archive
                                </a>
                            </li>
                        
                            <li>
                                <a class="nav-links no-hover-padding" href="https://synex.space/tags/">tags
                                </a>
                            </li>
                        
                            <li>
                                <a class="nav-links no-hover-padding" href="https://synex.space/friends/">friends
                                </a>
                            </li>
                        <li class="menu-icons-container">
                        <ul class="menu-icons-group">
                            <li class="js menu-icon">
                                <div role="button" tabindex="0" id="search-button" class="search-icon interactive-icon" title="Click or press $SHORTCUT to open search" aria-label="Click or press $SHORTCUT to open search">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960">
                                        <path d="M784-120 532-372q-30 24-69 38t-83 14q-109 0-184.5-75.5T120-580q0-109 75.5-184.5T380-840q109 0 184.5 75.5T640-580q0 44-14 83t-38 69l252 252-56 56ZM380-400q75 0 127.5-52.5T560-580q0-75-52.5-127.5T380-760q-75 0-127.5 52.5T200-580q0 75 52.5 127.5T380-400Z"/>
                                    </svg>
                                </div>
                            </li>

                            
                            

                            <li class="theme-switcher-wrapper js"><div
        title="Toggle dark&#x2F;light mode"
        class="theme-switcher"
        tabindex="0"
        role="button"
        aria-label="Toggle dark mode"
        aria-pressed="false">
    </div><div
        title="Reset mode to default"
        class="theme-resetter arrow"
        tabindex="0"
        role="button"
        aria-hidden="true"
        aria-label="Reset mode to default">
    </div>

</li>
</ul>
                    </li>
                </ul>
            </div>
        
    </nav>
</header>

    <div class="content" id="main-content">

        
        





<main>
    <article class="h-entry">
        <h1 class="p-name article-title">
            Reverse-自写壳学习与加密壳实现
        </h1>
        <a class="u-url u-uid" href="https://synex.space/blog/reverse-zi-xie-ke-xue-xi-yu-jia-mi-ke-shi-xian/"></a>

        <ul class="meta"><span class="hidden p-author h-card">
<a rel="author" href="https:&#x2F;&#x2F;synex.space&#x2F;" class="u-url " title=""></a>
</span>
<li><time class="dt-published" datetime="2026-02-21T16:36:00">21st Feb 2026</time></li><li title="2189 words"><span class='separator' aria-hidden='true'>•</span>11 min read</li><li class="tag"><span class='separator' aria-hidden='true'>•</span>Tags:&nbsp;</li><li class="tag"><a class="p-category" href="https://synex.space/tags/reverse/">Reverse</a>,&nbsp;</li><li class="tag"><a class="p-category" href="https://synex.space/tags/c/">C++</a>,&nbsp;</li><li class="tag"><a class="p-category" href="https://synex.space/tags/lief/">LIEF</a>,&nbsp;</li><li class="tag"><a class="p-category" href="https://synex.space/tags/asm/">asm</a>,&nbsp;</li><li class="tag"><a class="p-category" href="https://synex.space/tags/ke/">壳</a></li>
        </ul><section class="e-content body"><h2 id="guan-yu-cheng-xu-ke">关于程序壳</h2>
<p>一般分两种，加密壳和压缩壳，具体一般都是对text段进行操作，压缩或者加密，之后通过增加额外段，把程序入口设置到额外段，额外段的内容位text解密或解压一类。本文以64位程序为例，做一个简单的加壳程序。有<code>C++</code>编码经验的也可以直接参考项目，本文代码均已上传，项目地址如下</p>
<pre data-lang="url" class="language-url z-code"><code class="language-url" data-lang="url"><span class="z-text z-plain">https://github.com/Synex93/CppPacker.git
</span></code></pre>
<h2 id="shou-dong-shi-xian-liu-cheng">手动实现流程</h2>
<p>手动通过010进行加入一个自己的段，并且修改pe文件的初始位置为自己的段，自己的段直接jmp到text中，实际不做压缩也不做加密，只是做一个壳的正常加载流程。后面可以基于这些操作进行魔改实现上面所说的加密和压缩壳的操作。源码如下</p>
<pre data-lang="cpp" class="language-cpp z-code"><code class="language-cpp" data-lang="cpp"><span class="z-source z-c++"><span class="z-meta z-preprocessor z-include z-c++"><span class="z-keyword z-control z-import z-include z-c++">#include</span> <span class="z-string z-quoted z-other z-lt-gt z-include z-c++"><span class="z-punctuation z-definition z-string z-begin z-c++">&lt;</span>stdio.h<span class="z-punctuation z-definition z-string z-end z-c++">&gt;</span></span>
</span></span><span class="z-source z-c++"><span class="z-meta z-preprocessor z-include z-c++"><span class="z-keyword z-control z-import z-include z-c++">#include</span> <span class="z-string z-quoted z-other z-lt-gt z-include z-c++"><span class="z-punctuation z-definition z-string z-begin z-c++">&lt;</span>windows.h<span class="z-punctuation z-definition z-string z-end z-c++">&gt;</span></span>
</span></span><span class="z-source z-c++"><span class="z-storage z-type z-c">int</span> <span class="z-meta z-function z-c++"><span class="z-meta z-toc-list z-full-identifier z-c++"><span class="z-entity z-name z-function z-c++">main</span></span></span><span class="z-meta z-function z-parameters z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-function z-parameters z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-meta z-function z-c++">
</span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"></span><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-begin z-c++">{</span></span></span><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++">
</span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++">    <span class="z-meta z-function-call z-c++"><span class="z-variable z-function z-c++">SetConsoleOutputCP</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++"><span class="z-constant z-numeric z-integer z-decimal z-c++">65001</span></span></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++">    <span class="z-meta z-function-call z-c++"><span class="z-support z-function z-C99 z-c">printf</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++"><span class="z-string z-quoted z-double z-c"><span class="z-punctuation z-definition z-string z-begin z-c">&quot;</span>666,你成功的运行了我<span class="z-punctuation z-definition z-string z-end z-c">&quot;</span></span></span></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++"></span></span><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-end z-c++">}</span></span></span>
</span></code></pre>
<p>编译后，首先需要修改段数量，Nt Headers-&gt;File Hader-&gt;NumberOfSections，我这里为19，增加1就是改为20
<img src="https://image.boychai.xyz/article/Pasted%20image%2020260219185925.png" alt="" />
此时在<code>IMAGE_SECTION_HEADER SectionHeaders</code>中会发现多出了一个
<img src="https://image.boychai.xyz/article/Pasted%20image%2020260219185925.png" alt="" />
这里面比较重要的字段和含义分别如下</p>
<pre data-lang="text" class="language-text z-code"><code class="language-text" data-lang="text"><span class="z-text z-plain">1.Name 表示该区段的名字
</span><span class="z-text z-plain">2.VirtualSize 表示在内存中的大小(一般内存对齐为0x1000) 
</span><span class="z-text z-plain">3.virtualaddress 虚拟地址 即上一个区段的VirtualAddress + 上一个区段经内存对齐粒度对齐后的大小
</span><span class="z-text z-plain">4.sizeofdata 表示在文件中的大小（一般文件对齐为0x200) 
</span><span class="z-text z-plain">5.pointertorawdata 当前区段的偏移位置，也是起始位置 一般 上一个区段的PointerToRawData + 上一个区段的SizeOfRawData
</span></code></pre>
<p><img src="https://image.boychai.xyz/article/Pasted%20image%2020260219194509.png" alt="" />
这里需要注意的是pointertorawdata，如果写一般情况，上一个区段的下一个位置，但是这个位置通常是其他的数据，已经存在，为了不出现冲突，我们需要给移到文件最后面，并且这个数值需要文件对其<code>FileAlignment</code>，通常为200h的倍数，这里需要找到文件末尾，并且一直增加<code>00</code>找到一个是<code>200h</code>的倍数在填写过来。
还需要给读写执行权限
<img src="https://image.boychai.xyz/article/Pasted%20image%2020260219190716.png" alt="" />
之后在NTHADERS -&gt; OPTIONALHEADER64-&gt;SizeOfimage修改一下将他改为最后一个区段的内存地址+内存大小，之前设置的内容为</p>
<pre data-lang="text" class="language-text z-code"><code class="language-text" data-lang="text"><span class="z-text z-plain">VirtualAddress (RVA): 43000h
</span><span class="z-text z-plain">VirtualSize: 1000h (4096 字节)
</span></code></pre>
<p>这里需要修改为44000h
<img src="https://image.boychai.xyz/article/Pasted%20image%2020260219191054.png" alt="" />
后面如果我们需要关闭随机基址<code>ASLR</code>，我们手动加的是直接jmp，不进行计算基址了，需要在NtHeader-&gt;OptionHeader-&gt;DllCharacteristics-&gt;IMAGE_DLLCHARACTERISTICS_DYNAMIC_BASE 改为0
<img src="https://image.boychai.xyz/article/Pasted%20image%2020260219192058.png" alt="" />
之后我们修改函数入口，还是在OptionHeader，有一个AddressOfEntryPoint，直接修改为刚才咱们新增的区段，新增区段都是在最后面的，之前修改前的大小为<code>43000h</code>，我们只需要把<code>43000h</code>填上就可以了。(需要注意的还这里需要记住原值，因为这个位置是原始text的偏移，这里是1410h)
<img src="https://image.boychai.xyz/article/Pasted%20image%2020260219192359.png" alt="" />
<img src="https://image.boychai.xyz/article/Pasted%20image%2020260219192516.png" alt="" />
这里需要拿到基础基址和之前获取的text偏移位置<code>1410h</code>相加，基址在NtHeader-&gt;OptionHeader-&gt;ImageBase中
<img src="https://image.boychai.xyz/article/Pasted%20image%2020260219201406.png" alt="" />
实际跳转地址为<code>0x140000000+0x1410=0x140001410</code>，也就是需要执行的汇编代码为</p>
<pre data-lang="asm" class="language-asm z-code"><code class="language-asm" data-lang="asm"><span class="z-source z-assembly"><span class="z-keyword z-control z-assembly">mov</span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-variable z-parameter z-register z-assembly">rax</span><span class="z-source z-assembly">,</span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-constant z-character z-hexadecimal z-assembly">140001410h</span>
</span><span class="z-source z-assembly"><span class="z-keyword z-control z-assembly">jmp</span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-variable z-parameter z-register z-assembly">rax</span>
</span></code></pre>
<p>转换为<code>hex</code>为<code>48B81014004001000000FFE0</code>，具体可以参考网站<code>https://defuse.ca/online-x86-assembler.htm</code>转换，或者直接x64dbg直接敲命令复制。这段hex，直接追加到新增段<code>3F400h</code>位置
<img src="https://image.boychai.xyz/article/Pasted%20image%2020260219202245.png" alt="" />
保存通过x64dbg调试发现已经正常
<img src="https://image.boychai.xyz/article/Pasted%20image%2020260219202345.png" alt="" />
直接运行也是没有问题
<img src="https://image.boychai.xyz/article/Pasted%20image%2020260219202415.png" alt="" /></p>
<h2 id="c-shi-xian-liu-cheng">C++实现流程</h2>
<p>对于PE文件的修改这里就不手动定位了，看大部分的文章和视频教程基本都是手动解析和手动定位位置，本章节直接使用现成的库<code>lief</code>进行解析PE与定位字段了。通过<code>lief</code>解析代码如下</p>
<pre data-lang="cpp" class="language-cpp z-code"><code class="language-cpp" data-lang="cpp"><span class="z-source z-c++">    std<span class="z-punctuation z-accessor z-double-colon z-c++">::</span>unique_ptr<span class="z-punctuation z-section z-generic z-begin z-c++">&lt;</span>LIEF<span class="z-punctuation z-accessor z-double-colon z-c++">::</span>PE<span class="z-punctuation z-accessor z-double-colon z-c++">::</span>Binary<span class="z-punctuation z-section z-generic z-end z-c++">&gt;</span> pe <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-meta z-function-call z-c++">LIEF<span class="z-punctuation z-accessor z-double-colon z-c++">::</span>PE<span class="z-punctuation z-accessor z-double-colon z-c++">::</span>Parser<span class="z-punctuation z-accessor z-double-colon z-c++">::</span><span class="z-variable z-function z-c++">parse</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++">path</span></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></code></pre>
<p>解析后需要获取原始OEP位置，参考代码如下，这里是我们最终要跳转回的位置</p>
<pre data-lang="c++" class="language-c++ z-code"><code class="language-c++" data-lang="c++"><span class="z-source z-c++">        <span class="z-support z-type z-stdint z-c">uint32_t</span> old_oep <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-keyword z-operator z-word z-cast z-c++">static_cast</span><span class="z-punctuation z-section z-generic z-begin z-c++">&lt;</span><span class="z-support z-type z-stdint z-c">uint32_t</span><span class="z-punctuation z-section z-generic z-end z-c++">&gt;</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span>pe<span class="z-punctuation z-accessor z-arrow z-c++">-&gt;</span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">optional_header</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-accessor z-dot z-c++">.</span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">addressof_entrypoint</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-section z-group z-end z-c++">)</span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></code></pre>
<p>由于正常情况下都会开启<code>ASLR(地址空间布局随机化)</code>，如果直接写入OEP位置肯定是不行的，需要后面单独进行计算偏移跳转，这里我们先创建一个新段，并随便插入点汇编代码进行占位，下面代码还设置了新段的权限，参考代码如下</p>
<pre data-lang="C++" class="language-C++ z-code"><code class="language-C++" data-lang="C++"><span class="z-source z-c++">
</span><span class="z-source z-c++">        std<span class="z-punctuation z-accessor z-double-colon z-c++">::</span>vector<span class="z-punctuation z-section z-generic z-begin z-c++">&lt;</span><span class="z-support z-type z-stdint z-c">uint8_t</span><span class="z-punctuation z-section z-generic z-end z-c++">&gt;</span> content <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-begin z-c++">{</span>
</span></span><span class="z-source z-c++"><span class="z-meta z-block z-c++">            <span class="z-constant z-numeric z-integer z-hexadecimal z-c++"><span class="z-punctuation z-definition z-numeric z-base z-c++">0x</span>90</span><span class="z-punctuation z-separator z-c++">,</span> <span class="z-constant z-numeric z-integer z-hexadecimal z-c++"><span class="z-punctuation z-definition z-numeric z-base z-c++">0x</span>90</span><span class="z-punctuation z-separator z-c++">,</span> <span class="z-constant z-numeric z-integer z-hexadecimal z-c++"><span class="z-punctuation z-definition z-numeric z-base z-c++">0x</span>90</span><span class="z-punctuation z-separator z-c++">,</span> <span class="z-constant z-numeric z-integer z-hexadecimal z-c++"><span class="z-punctuation z-definition z-numeric z-base z-c++">0x</span>90</span><span class="z-punctuation z-separator z-c++">,</span>      <span class="z-comment z-line z-double-slash z-c"><span class="z-punctuation z-definition z-comment z-c">//</span> NOP
</span></span></span><span class="z-source z-c++"><span class="z-meta z-block z-c++">            <span class="z-constant z-numeric z-integer z-hexadecimal z-c++"><span class="z-punctuation z-definition z-numeric z-base z-c++">0x</span>E9</span><span class="z-punctuation z-separator z-c++">,</span> <span class="z-constant z-numeric z-integer z-hexadecimal z-c++"><span class="z-punctuation z-definition z-numeric z-base z-c++">0x</span>00</span><span class="z-punctuation z-separator z-c++">,</span> <span class="z-constant z-numeric z-integer z-hexadecimal z-c++"><span class="z-punctuation z-definition z-numeric z-base z-c++">0x</span>00</span><span class="z-punctuation z-separator z-c++">,</span> <span class="z-constant z-numeric z-integer z-hexadecimal z-c++"><span class="z-punctuation z-definition z-numeric z-base z-c++">0x</span>00</span><span class="z-punctuation z-separator z-c++">,</span> <span class="z-constant z-numeric z-integer z-hexadecimal z-c++"><span class="z-punctuation z-definition z-numeric z-base z-c++">0x</span>00</span> <span class="z-comment z-line z-double-slash z-c"><span class="z-punctuation z-definition z-comment z-c">//</span> JMP
</span></span></span><span class="z-source z-c++"><span class="z-meta z-block z-c++">        <span class="z-punctuation z-section z-block z-end z-c++">}</span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span><span class="z-source z-c++">
</span><span class="z-source z-c++">        LIEF<span class="z-punctuation z-accessor z-double-colon z-c++">::</span>PE<span class="z-punctuation z-accessor z-double-colon z-c++">::</span>Section <span class="z-meta z-function z-c++"><span class="z-meta z-toc-list z-full-identifier z-c++"><span class="z-entity z-name z-function z-c++">section</span></span></span><span class="z-meta z-function z-parameters z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-function z-parameters z-c++"><span class="z-meta z-group z-c++"><span class="z-string z-quoted z-double z-c"><span class="z-punctuation z-definition z-string z-begin z-c">&quot;</span>.Syn3x<span class="z-punctuation z-definition z-string z-end z-c">&quot;</span></span><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span><span class="z-source z-c++">        section<span class="z-punctuation z-accessor z-dot z-c++">.</span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">content</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++">content</span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span><span class="z-source z-c++">        section<span class="z-punctuation z-accessor z-dot z-c++">.</span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">characteristics</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++">
</span></span></span><span class="z-source z-c++"><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++">            <span class="z-keyword z-operator z-word z-cast z-c++">static_cast</span><span class="z-punctuation z-section z-generic z-begin z-c++">&lt;</span><span class="z-support z-type z-stdint z-c">uint32_t</span><span class="z-punctuation z-section z-generic z-end z-c++">&gt;</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span>LIEF<span class="z-punctuation z-accessor z-double-colon z-c++">::</span>PE<span class="z-punctuation z-accessor z-double-colon z-c++">::</span>Section<span class="z-punctuation z-accessor z-double-colon z-c++">::</span>CHARACTERISTICS<span class="z-punctuation z-accessor z-double-colon z-c++">::</span>MEM_READ<span class="z-punctuation z-section z-group z-end z-c++">)</span></span> <span class="z-keyword z-operator z-arithmetic z-c">|</span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++">            <span class="z-keyword z-operator z-word z-cast z-c++">static_cast</span><span class="z-punctuation z-section z-generic z-begin z-c++">&lt;</span><span class="z-support z-type z-stdint z-c">uint32_t</span><span class="z-punctuation z-section z-generic z-end z-c++">&gt;</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span>LIEF<span class="z-punctuation z-accessor z-double-colon z-c++">::</span>PE<span class="z-punctuation z-accessor z-double-colon z-c++">::</span>Section<span class="z-punctuation z-accessor z-double-colon z-c++">::</span>CHARACTERISTICS<span class="z-punctuation z-accessor z-double-colon z-c++">::</span>MEM_EXECUTE<span class="z-punctuation z-section z-group z-end z-c++">)</span></span> <span class="z-keyword z-operator z-arithmetic z-c">|</span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++">            <span class="z-keyword z-operator z-word z-cast z-c++">static_cast</span><span class="z-punctuation z-section z-generic z-begin z-c++">&lt;</span><span class="z-support z-type z-stdint z-c">uint32_t</span><span class="z-punctuation z-section z-generic z-end z-c++">&gt;</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span>LIEF<span class="z-punctuation z-accessor z-double-colon z-c++">::</span>PE<span class="z-punctuation z-accessor z-double-colon z-c++">::</span>Section<span class="z-punctuation z-accessor z-double-colon z-c++">::</span>CHARACTERISTICS<span class="z-punctuation z-accessor z-double-colon z-c++">::</span>CNT_CODE<span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span><span class="z-source z-c++">
</span><span class="z-source z-c++">        LIEF<span class="z-punctuation z-accessor z-double-colon z-c++">::</span>PE<span class="z-punctuation z-accessor z-double-colon z-c++">::</span>Section <span class="z-keyword z-operator z-c++">*</span>add_section <span class="z-keyword z-operator z-assignment z-c">=</span> pe<span class="z-punctuation z-accessor z-arrow z-c++">-&gt;</span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">add_section</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++">section</span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></code></pre>
<p>后面获取一下新增区段的跳转地址，并计算实际跳转偏移，并修改OEP</p>
<pre data-lang="C++" class="language-C++ z-code"><code class="language-C++" data-lang="C++"><span class="z-source z-c++">            <span class="z-comment z-line z-double-slash z-c"><span class="z-punctuation z-definition z-comment z-c">//</span> 获取跳转地址
</span></span><span class="z-source z-c++">            <span class="z-support z-type z-stdint z-c">uint32_t</span> section_rva <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-keyword z-operator z-word z-cast z-c++">static_cast</span><span class="z-punctuation z-section z-generic z-begin z-c++">&lt;</span><span class="z-support z-type z-stdint z-c">uint32_t</span><span class="z-punctuation z-section z-generic z-end z-c++">&gt;</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span>add_section<span class="z-punctuation z-accessor z-arrow z-c++">-&gt;</span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">virtual_address</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-section z-group z-end z-c++">)</span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span><span class="z-source z-c++">            <span class="z-comment z-line z-double-slash z-c"><span class="z-punctuation z-definition z-comment z-c">//</span> 跳转偏移地址计算
</span></span><span class="z-source z-c++">            <span class="z-support z-type z-stdint z-c">uint32_t</span> rel_offset <span class="z-keyword z-operator z-assignment z-c">=</span> old_oep <span class="z-keyword z-operator z-arithmetic z-c">-</span> content<span class="z-punctuation z-accessor z-dot z-c++">.</span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">size</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span><span class="z-source z-c++">
</span><span class="z-source z-c++">            <span class="z-comment z-line z-double-slash z-c"><span class="z-punctuation z-definition z-comment z-c">//</span> 修复真实跳转位置
</span></span><span class="z-source z-c++">            <span class="z-storage z-type z-c">auto</span> content_view <span class="z-keyword z-operator z-assignment z-c">=</span> add_section<span class="z-punctuation z-accessor z-arrow z-c++">-&gt;</span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">content</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span><span class="z-source z-c++">            std<span class="z-punctuation z-accessor z-double-colon z-c++">::</span>vector<span class="z-punctuation z-section z-generic z-begin z-c++">&lt;</span><span class="z-support z-type z-stdint z-c">uint8_t</span><span class="z-punctuation z-section z-generic z-end z-c++">&gt;</span> <span class="z-meta z-function z-c++"><span class="z-meta z-toc-list z-full-identifier z-c++"><span class="z-entity z-name z-function z-c++">final_content</span></span></span><span class="z-meta z-function z-parameters z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-function z-parameters z-c++"><span class="z-meta z-group z-c++">content_view<span class="z-punctuation z-accessor z-dot z-c++">.</span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">begin</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-separator z-c++">,</span> content_view<span class="z-punctuation z-accessor z-dot z-c++">.</span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">end</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span><span class="z-source z-c++">            <span class="z-meta z-function z-c++"><span class="z-meta z-toc-list z-full-identifier z-c++">std<span class="z-punctuation z-accessor z-double-colon z-c++">::</span><span class="z-entity z-name z-function z-constructor z-c++">memcpy</span></span></span><span class="z-meta z-function z-parameters z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-function z-parameters z-c++"><span class="z-meta z-group z-c++"><span class="z-keyword z-operator z-c">&amp;</span><span class="z-variable z-parameter z-c++">final_content</span><span class="z-meta z-brackets z-c++"><span class="z-punctuation z-section z-brackets z-begin z-c++">[</span><span class="z-constant z-numeric z-integer z-decimal z-c++">5</span><span class="z-punctuation z-section z-brackets z-end z-c++">]</span></span><span class="z-punctuation z-separator z-c++">,</span> <span class="z-keyword z-operator z-c">&amp;</span><span class="z-variable z-parameter z-c++">rel_offset</span><span class="z-punctuation z-separator z-c++">,</span> <span class="z-keyword z-operator z-word z-c++">sizeof</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span><span class="z-meta z-group z-c++"><span class="z-support z-type z-stdint z-c">uint32_t</span></span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span><span class="z-source z-c++">            add_section<span class="z-punctuation z-accessor z-arrow z-c++">-&gt;</span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">content</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++">final_content</span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span><span class="z-source z-c++">
</span><span class="z-source z-c++">            <span class="z-comment z-line z-double-slash z-c"><span class="z-punctuation z-definition z-comment z-c">//</span> 修改入口点
</span></span><span class="z-source z-c++">            pe<span class="z-punctuation z-accessor z-arrow z-c++">-&gt;</span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">optional_header</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-accessor z-dot z-c++">.</span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">addressof_entrypoint</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++">section_rva</span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></code></pre>
<p>后续的，在<code>lief</code>中构建保存中建议把<code>tls</code>构建改动的配置关闭，因为本身我们不会对tls做任何改动，并且本身程序很简单，似乎并没有涉及<code>tls</code>的部分，但是PE文件中又会存在<code>tls</code>部分数据，这部分数据可能是一个<code>孤儿数据</code>因为用不到，可能是一个默认值，但是在<code>lief</code>中他依旧回去寻找<code>tls</code>相关配置的一些地址做一些重新构建的行为，这里也不深入研究了，如果不想出现报错，建议关闭此选项，然后进行构建新的PE文件，上面的操作实际已经完整的实现了加壳过程，参考代码如下。</p>
<pre data-lang="c++" class="language-c++ z-code"><code class="language-c++" data-lang="c++"><span class="z-source z-c++">        LIEF<span class="z-punctuation z-accessor z-double-colon z-c++">::</span>PE<span class="z-punctuation z-accessor z-double-colon z-c++">::</span>Builder<span class="z-punctuation z-accessor z-double-colon z-c++">::</span>config_t config<span class="z-punctuation z-terminator z-c++">;</span>
</span><span class="z-source z-c++">        config<span class="z-punctuation z-accessor z-dot z-c++">.</span><span class="z-variable z-other z-readwrite z-member z-c++">tls</span> <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-constant z-language z-c">false</span><span class="z-punctuation z-terminator z-c++">;</span>
</span><span class="z-source z-c++">
</span><span class="z-source z-c++">        LIEF<span class="z-punctuation z-accessor z-double-colon z-c++">::</span>PE<span class="z-punctuation z-accessor z-double-colon z-c++">::</span>Builder <span class="z-meta z-function-call z-c++"><span class="z-variable z-function z-c++">builder</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">{</span></span></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++"><span class="z-keyword z-operator z-c">*</span>pe<span class="z-punctuation z-separator z-c++">,</span> config</span></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">}</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span><span class="z-source z-c++">        builder<span class="z-punctuation z-accessor z-dot z-c++">.</span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">build</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span><span class="z-source z-c++">
</span><span class="z-source z-c++">        std<span class="z-punctuation z-accessor z-double-colon z-c++">::</span>string output_name <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-string z-quoted z-double z-c"><span class="z-punctuation z-definition z-string z-begin z-c">&quot;</span>a.Syn3x.exe<span class="z-punctuation z-definition z-string z-end z-c">&quot;</span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span><span class="z-source z-c++">        builder<span class="z-punctuation z-accessor z-dot z-c++">.</span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">write</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++">output_name</span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></code></pre>
<p>这里把完整的构建源码也附上，简单注释也已标明</p>
<pre data-lang="c++" class="language-c++ z-code"><code class="language-c++" data-lang="c++"><span class="z-source z-c++"><span class="z-meta z-preprocessor z-include z-c++"><span class="z-keyword z-control z-import z-include z-c++">#include</span> <span class="z-string z-quoted z-other z-lt-gt z-include z-c++"><span class="z-punctuation z-definition z-string z-begin z-c++">&lt;</span>iostream<span class="z-punctuation z-definition z-string z-end z-c++">&gt;</span></span>
</span></span><span class="z-source z-c++"><span class="z-meta z-preprocessor z-include z-c++"><span class="z-keyword z-control z-import z-include z-c++">#include</span> <span class="z-string z-quoted z-other z-lt-gt z-include z-c++"><span class="z-punctuation z-definition z-string z-begin z-c++">&lt;</span>memory<span class="z-punctuation z-definition z-string z-end z-c++">&gt;</span></span>
</span></span><span class="z-source z-c++"><span class="z-meta z-preprocessor z-include z-c++"><span class="z-keyword z-control z-import z-include z-c++">#include</span> <span class="z-string z-quoted z-other z-lt-gt z-include z-c++"><span class="z-punctuation z-definition z-string z-begin z-c++">&lt;</span>string<span class="z-punctuation z-definition z-string z-end z-c++">&gt;</span></span>
</span></span><span class="z-source z-c++"><span class="z-meta z-preprocessor z-include z-c++"><span class="z-keyword z-control z-import z-include z-c++">#include</span> <span class="z-string z-quoted z-other z-lt-gt z-include z-c++"><span class="z-punctuation z-definition z-string z-begin z-c++">&lt;</span>vector<span class="z-punctuation z-definition z-string z-end z-c++">&gt;</span></span>
</span></span><span class="z-source z-c++"><span class="z-meta z-preprocessor z-include z-c++"><span class="z-keyword z-control z-import z-include z-c++">#include</span> <span class="z-string z-quoted z-other z-lt-gt z-include z-c++"><span class="z-punctuation z-definition z-string z-begin z-c++">&lt;</span>windows.h<span class="z-punctuation z-definition z-string z-end z-c++">&gt;</span></span>
</span></span><span class="z-source z-c++"><span class="z-meta z-preprocessor z-include z-c++"><span class="z-keyword z-control z-import z-include z-c++">#include</span> <span class="z-string z-quoted z-other z-lt-gt z-include z-c++"><span class="z-punctuation z-definition z-string z-begin z-c++">&lt;</span>iomanip<span class="z-punctuation z-definition z-string z-end z-c++">&gt;</span></span>
</span></span><span class="z-source z-c++"><span class="z-meta z-preprocessor z-include z-c++"><span class="z-keyword z-control z-import z-include z-c++">#include</span> <span class="z-string z-quoted z-other z-lt-gt z-include z-c++"><span class="z-punctuation z-definition z-string z-begin z-c++">&lt;</span>LIEF/LIEF.hpp<span class="z-punctuation z-definition z-string z-end z-c++">&gt;</span></span>
</span></span><span class="z-source z-c++"><span class="z-meta z-preprocessor z-include z-c++"><span class="z-keyword z-control z-import z-include z-c++">#include</span> <span class="z-string z-quoted z-other z-lt-gt z-include z-c++"><span class="z-punctuation z-definition z-string z-begin z-c++">&lt;</span>LIEF/PE.hpp<span class="z-punctuation z-definition z-string z-end z-c++">&gt;</span></span>
</span></span><span class="z-source z-c++">
</span><span class="z-source z-c++"><span class="z-storage z-type z-c">int</span> <span class="z-meta z-function z-c++"><span class="z-meta z-toc-list z-full-identifier z-c++"><span class="z-entity z-name z-function z-c++">main</span></span></span><span class="z-meta z-function z-parameters z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-function z-parameters z-c++"><span class="z-meta z-group z-c++"><span class="z-storage z-type z-c">int</span> <span class="z-variable z-parameter z-c++">argc</span><span class="z-punctuation z-separator z-c++">,</span> <span class="z-storage z-type z-c">char</span> <span class="z-keyword z-operator z-c">*</span><span class="z-keyword z-operator z-c">*</span><span class="z-variable z-parameter z-c++">argv</span><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-meta z-function z-c++">
</span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"></span><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-begin z-c++">{</span></span></span><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++">
</span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++">    <span class="z-meta z-function-call z-c++"><span class="z-variable z-function z-c++">SetConsoleOutputCP</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++"><span class="z-constant z-numeric z-integer z-decimal z-c++">65001</span></span></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++">    <span class="z-keyword z-control z-c++">if</span> <span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span>argc <span class="z-keyword z-operator z-comparison z-c">&lt;</span> <span class="z-constant z-numeric z-integer z-decimal z-c++">2</span><span class="z-punctuation z-section z-group z-end z-c++">)</span></span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++">    <span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-begin z-c++">{</span>
</span></span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++">        std<span class="z-punctuation z-accessor z-double-colon z-c++">::</span>cout <span class="z-keyword z-operator z-arithmetic z-c">&lt;&lt;</span> <span class="z-string z-quoted z-double z-c"><span class="z-punctuation z-definition z-string z-begin z-c">&quot;</span>第一个参数指定pe文件<span class="z-punctuation z-definition z-string z-end z-c">&quot;</span></span> <span class="z-keyword z-operator z-arithmetic z-c">&lt;&lt;</span> std<span class="z-punctuation z-accessor z-double-colon z-c++">::</span>endl<span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++">        <span class="z-keyword z-control z-flow z-return z-c++">return</span> <span class="z-constant z-numeric z-integer z-decimal z-c++">1</span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++">    <span class="z-punctuation z-section z-block z-end z-c++">}</span></span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++">    std<span class="z-punctuation z-accessor z-double-colon z-c++">::</span>string path <span class="z-keyword z-operator z-assignment z-c">=</span> argv<span class="z-meta z-brackets z-c++"><span class="z-punctuation z-section z-brackets z-begin z-c++">[</span><span class="z-constant z-numeric z-integer z-decimal z-c++">1</span><span class="z-punctuation z-section z-brackets z-end z-c++">]</span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++">    std<span class="z-punctuation z-accessor z-double-colon z-c++">::</span>unique_ptr<span class="z-punctuation z-section z-generic z-begin z-c++">&lt;</span>LIEF<span class="z-punctuation z-accessor z-double-colon z-c++">::</span>PE<span class="z-punctuation z-accessor z-double-colon z-c++">::</span>Binary<span class="z-punctuation z-section z-generic z-end z-c++">&gt;</span> pe <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-meta z-function-call z-c++">LIEF<span class="z-punctuation z-accessor z-double-colon z-c++">::</span>PE<span class="z-punctuation z-accessor z-double-colon z-c++">::</span>Parser<span class="z-punctuation z-accessor z-double-colon z-c++">::</span><span class="z-variable z-function z-c++">parse</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++">path</span></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++">    <span class="z-keyword z-control z-c++">if</span> <span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span>pe<span class="z-punctuation z-section z-group z-end z-c++">)</span></span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++">    <span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-begin z-c++">{</span>
</span></span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++">        <span class="z-comment z-line z-double-slash z-c"><span class="z-punctuation z-definition z-comment z-c">//</span> 获取原始OEP,需要跳回的地址
</span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++">        <span class="z-support z-type z-stdint z-c">uint32_t</span> old_oep <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-keyword z-operator z-word z-cast z-c++">static_cast</span><span class="z-punctuation z-section z-generic z-begin z-c++">&lt;</span><span class="z-support z-type z-stdint z-c">uint32_t</span><span class="z-punctuation z-section z-generic z-end z-c++">&gt;</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span>pe<span class="z-punctuation z-accessor z-arrow z-c++">-&gt;</span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">optional_header</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-accessor z-dot z-c++">.</span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">addressof_entrypoint</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-section z-group z-end z-c++">)</span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++">
</span></span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++">        <span class="z-comment z-line z-double-slash z-c"><span class="z-punctuation z-definition z-comment z-c">//</span> 初始化跳转汇编
</span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++">        std<span class="z-punctuation z-accessor z-double-colon z-c++">::</span>vector<span class="z-punctuation z-section z-generic z-begin z-c++">&lt;</span><span class="z-support z-type z-stdint z-c">uint8_t</span><span class="z-punctuation z-section z-generic z-end z-c++">&gt;</span> content <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-begin z-c++">{</span>
</span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++">            <span class="z-constant z-numeric z-integer z-hexadecimal z-c++"><span class="z-punctuation z-definition z-numeric z-base z-c++">0x</span>90</span><span class="z-punctuation z-separator z-c++">,</span> <span class="z-constant z-numeric z-integer z-hexadecimal z-c++"><span class="z-punctuation z-definition z-numeric z-base z-c++">0x</span>90</span><span class="z-punctuation z-separator z-c++">,</span> <span class="z-constant z-numeric z-integer z-hexadecimal z-c++"><span class="z-punctuation z-definition z-numeric z-base z-c++">0x</span>90</span><span class="z-punctuation z-separator z-c++">,</span> <span class="z-constant z-numeric z-integer z-hexadecimal z-c++"><span class="z-punctuation z-definition z-numeric z-base z-c++">0x</span>90</span><span class="z-punctuation z-separator z-c++">,</span>      <span class="z-comment z-line z-double-slash z-c"><span class="z-punctuation z-definition z-comment z-c">//</span> NOP
</span></span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++">            <span class="z-constant z-numeric z-integer z-hexadecimal z-c++"><span class="z-punctuation z-definition z-numeric z-base z-c++">0x</span>E9</span><span class="z-punctuation z-separator z-c++">,</span> <span class="z-constant z-numeric z-integer z-hexadecimal z-c++"><span class="z-punctuation z-definition z-numeric z-base z-c++">0x</span>00</span><span class="z-punctuation z-separator z-c++">,</span> <span class="z-constant z-numeric z-integer z-hexadecimal z-c++"><span class="z-punctuation z-definition z-numeric z-base z-c++">0x</span>00</span><span class="z-punctuation z-separator z-c++">,</span> <span class="z-constant z-numeric z-integer z-hexadecimal z-c++"><span class="z-punctuation z-definition z-numeric z-base z-c++">0x</span>00</span><span class="z-punctuation z-separator z-c++">,</span> <span class="z-constant z-numeric z-integer z-hexadecimal z-c++"><span class="z-punctuation z-definition z-numeric z-base z-c++">0x</span>00</span> <span class="z-comment z-line z-double-slash z-c"><span class="z-punctuation z-definition z-comment z-c">//</span> JMP
</span></span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++">        <span class="z-punctuation z-section z-block z-end z-c++">}</span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++">        <span class="z-comment z-line z-double-slash z-c"><span class="z-punctuation z-definition z-comment z-c">//</span> 创建段对象，并写入汇编指令和设置权限
</span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++">        LIEF<span class="z-punctuation z-accessor z-double-colon z-c++">::</span>PE<span class="z-punctuation z-accessor z-double-colon z-c++">::</span>Section <span class="z-meta z-function-call z-c++"><span class="z-variable z-function z-c++">section</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++"><span class="z-string z-quoted z-double z-c"><span class="z-punctuation z-definition z-string z-begin z-c">&quot;</span>.Syn3x<span class="z-punctuation z-definition z-string z-end z-c">&quot;</span></span></span></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++">        section<span class="z-punctuation z-accessor z-dot z-c++">.</span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">content</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++">content</span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++">        section<span class="z-punctuation z-accessor z-dot z-c++">.</span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">characteristics</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++">
</span></span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++">            <span class="z-keyword z-operator z-word z-cast z-c++">static_cast</span><span class="z-punctuation z-section z-generic z-begin z-c++">&lt;</span><span class="z-support z-type z-stdint z-c">uint32_t</span><span class="z-punctuation z-section z-generic z-end z-c++">&gt;</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span>LIEF<span class="z-punctuation z-accessor z-double-colon z-c++">::</span>PE<span class="z-punctuation z-accessor z-double-colon z-c++">::</span>Section<span class="z-punctuation z-accessor z-double-colon z-c++">::</span>CHARACTERISTICS<span class="z-punctuation z-accessor z-double-colon z-c++">::</span>MEM_READ<span class="z-punctuation z-section z-group z-end z-c++">)</span></span> <span class="z-keyword z-operator z-arithmetic z-c">|</span>
</span></span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++">            <span class="z-keyword z-operator z-word z-cast z-c++">static_cast</span><span class="z-punctuation z-section z-generic z-begin z-c++">&lt;</span><span class="z-support z-type z-stdint z-c">uint32_t</span><span class="z-punctuation z-section z-generic z-end z-c++">&gt;</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span>LIEF<span class="z-punctuation z-accessor z-double-colon z-c++">::</span>PE<span class="z-punctuation z-accessor z-double-colon z-c++">::</span>Section<span class="z-punctuation z-accessor z-double-colon z-c++">::</span>CHARACTERISTICS<span class="z-punctuation z-accessor z-double-colon z-c++">::</span>MEM_EXECUTE<span class="z-punctuation z-section z-group z-end z-c++">)</span></span> <span class="z-keyword z-operator z-arithmetic z-c">|</span>
</span></span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++">            <span class="z-keyword z-operator z-word z-cast z-c++">static_cast</span><span class="z-punctuation z-section z-generic z-begin z-c++">&lt;</span><span class="z-support z-type z-stdint z-c">uint32_t</span><span class="z-punctuation z-section z-generic z-end z-c++">&gt;</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span>LIEF<span class="z-punctuation z-accessor z-double-colon z-c++">::</span>PE<span class="z-punctuation z-accessor z-double-colon z-c++">::</span>Section<span class="z-punctuation z-accessor z-double-colon z-c++">::</span>CHARACTERISTICS<span class="z-punctuation z-accessor z-double-colon z-c++">::</span>CNT_CODE<span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++">        <span class="z-comment z-line z-double-slash z-c"><span class="z-punctuation z-definition z-comment z-c">//</span> 真正增加到段,新增成功会返回段地址
</span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++">        LIEF<span class="z-punctuation z-accessor z-double-colon z-c++">::</span>PE<span class="z-punctuation z-accessor z-double-colon z-c++">::</span>Section <span class="z-keyword z-operator z-c">*</span>add_section <span class="z-keyword z-operator z-assignment z-c">=</span> pe<span class="z-punctuation z-accessor z-arrow z-c++">-&gt;</span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">add_section</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++">section</span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++">        <span class="z-keyword z-control z-c++">if</span> <span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span>add_section <span class="z-keyword z-operator z-comparison z-c">!=</span> <span class="z-constant z-language z-c++">nullptr</span><span class="z-punctuation z-section z-group z-end z-c++">)</span></span>
</span></span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++">        <span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-begin z-c++">{</span>
</span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++">            <span class="z-comment z-line z-double-slash z-c"><span class="z-punctuation z-definition z-comment z-c">//</span> 获取跳转地址
</span></span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++">            <span class="z-support z-type z-stdint z-c">uint32_t</span> section_rva <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-keyword z-operator z-word z-cast z-c++">static_cast</span><span class="z-punctuation z-section z-generic z-begin z-c++">&lt;</span><span class="z-support z-type z-stdint z-c">uint32_t</span><span class="z-punctuation z-section z-generic z-end z-c++">&gt;</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span>add_section<span class="z-punctuation z-accessor z-arrow z-c++">-&gt;</span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">virtual_address</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-section z-group z-end z-c++">)</span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++">            <span class="z-comment z-line z-double-slash z-c"><span class="z-punctuation z-definition z-comment z-c">//</span> 跳转地址计算
</span></span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++">
</span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++">            <span class="z-support z-type z-stdint z-c">uint32_t</span> rel_offset <span class="z-keyword z-operator z-assignment z-c">=</span> old_oep <span class="z-keyword z-operator z-arithmetic z-c">-</span> <span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span>section_rva <span class="z-keyword z-operator z-arithmetic z-c">+</span> content<span class="z-punctuation z-accessor z-dot z-c++">.</span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">size</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-section z-group z-end z-c++">)</span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++">
</span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++">            <span class="z-comment z-line z-double-slash z-c"><span class="z-punctuation z-definition z-comment z-c">//</span> 修复真实跳转位置
</span></span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++">            <span class="z-storage z-type z-c">auto</span> content_view <span class="z-keyword z-operator z-assignment z-c">=</span> add_section<span class="z-punctuation z-accessor z-arrow z-c++">-&gt;</span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">content</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++">            std<span class="z-punctuation z-accessor z-double-colon z-c++">::</span>vector<span class="z-punctuation z-section z-generic z-begin z-c++">&lt;</span><span class="z-support z-type z-stdint z-c">uint8_t</span><span class="z-punctuation z-section z-generic z-end z-c++">&gt;</span> <span class="z-meta z-function-call z-c++"><span class="z-variable z-function z-c++">final_content</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++">content_view<span class="z-punctuation z-accessor z-dot z-c++">.</span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">begin</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-separator z-c++">,</span> content_view<span class="z-punctuation z-accessor z-dot z-c++">.</span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">end</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span></span></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++">            <span class="z-meta z-function-call z-c++">std<span class="z-punctuation z-accessor z-double-colon z-c++">::</span><span class="z-support z-function z-C99 z-c">memcpy</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++"><span class="z-keyword z-operator z-c">&amp;</span>final_content<span class="z-meta z-brackets z-c++"><span class="z-punctuation z-section z-brackets z-begin z-c++">[</span><span class="z-constant z-numeric z-integer z-decimal z-c++">5</span><span class="z-punctuation z-section z-brackets z-end z-c++">]</span></span><span class="z-punctuation z-separator z-c++">,</span> <span class="z-keyword z-operator z-c">&amp;</span>rel_offset<span class="z-punctuation z-separator z-c++">,</span> <span class="z-keyword z-operator z-word z-c++">sizeof</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span><span class="z-meta z-group z-c++"><span class="z-support z-type z-stdint z-c">uint32_t</span></span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++">            add_section<span class="z-punctuation z-accessor z-arrow z-c++">-&gt;</span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">content</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++">final_content</span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++">
</span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++">            <span class="z-comment z-line z-double-slash z-c"><span class="z-punctuation z-definition z-comment z-c">//</span> 修改入口点
</span></span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++">            pe<span class="z-punctuation z-accessor z-arrow z-c++">-&gt;</span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">optional_header</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-accessor z-dot z-c++">.</span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">addressof_entrypoint</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++">section_rva</span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++">        <span class="z-punctuation z-section z-block z-end z-c++">}</span></span>
</span></span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++">        <span class="z-comment z-line z-double-slash z-c"><span class="z-punctuation z-definition z-comment z-c">//</span> 创建构建新pe文件的配置，这里需要关闭某些不必要的表改动
</span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++">        LIEF<span class="z-punctuation z-accessor z-double-colon z-c++">::</span>PE<span class="z-punctuation z-accessor z-double-colon z-c++">::</span>Builder<span class="z-punctuation z-accessor z-double-colon z-c++">::</span>config_t config<span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++">        config<span class="z-punctuation z-accessor z-dot z-c++">.</span><span class="z-variable z-other z-readwrite z-member z-c++">tls</span> <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-constant z-language z-c">false</span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++">
</span></span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++">        <span class="z-comment z-line z-double-slash z-c"><span class="z-punctuation z-definition z-comment z-c">//</span> 创建正式的PE文件
</span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++">        LIEF<span class="z-punctuation z-accessor z-double-colon z-c++">::</span>PE<span class="z-punctuation z-accessor z-double-colon z-c++">::</span>Builder <span class="z-meta z-function-call z-c++"><span class="z-variable z-function z-c++">builder</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">{</span></span></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++"><span class="z-keyword z-operator z-c">*</span>pe<span class="z-punctuation z-separator z-c++">,</span> config</span></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">}</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++">        builder<span class="z-punctuation z-accessor z-dot z-c++">.</span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">build</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++">
</span></span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++">        builder<span class="z-punctuation z-accessor z-dot z-c++">.</span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">write</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++">path<span class="z-punctuation z-accessor z-dot z-c++">.</span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">insert</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++">path<span class="z-punctuation z-accessor z-dot z-c++">.</span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">length</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span> <span class="z-keyword z-operator z-arithmetic z-c">-</span> <span class="z-constant z-numeric z-integer z-decimal z-c++">4</span><span class="z-punctuation z-separator z-c++">,</span> <span class="z-string z-quoted z-double z-c"><span class="z-punctuation z-definition z-string z-begin z-c">&quot;</span>.Syn3x<span class="z-punctuation z-definition z-string z-end z-c">&quot;</span></span></span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span></span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++">    <span class="z-punctuation z-section z-block z-end z-c++">}</span></span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++">    <span class="z-keyword z-control z-flow z-return z-c++">return</span> <span class="z-constant z-numeric z-integer z-decimal z-c++">0</span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++"></span></span><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-end z-c++">}</span></span></span>
</span></code></pre>
<h2 id="jia-mi-ke-shi-xian">加密壳实现</h2>
<p>上面通过C++语言实现的只是普通的写了一个跳转，并不算是真正的壳，只是带着学习一下具体的加载流程，下面将对<code>.text</code>段进行操作，用简单的异或操作进行加密，在新增的段中，一般都不会去调用任何api，相当于在写硬编码，单纯异或操作对于汇编可能比较简单，这里就不通过写汇编的形式进行操作了。通过<code>存根</code>的方法这里单独写C代码，把C代码搞成硬编码塞进新的段中，这样相对直接写汇编相对友好，更方便的实现一些<code>"高级操作"</code>。这里先实现加解密的通用逻辑，这里实现的加解密实现如下，应该不是很难理解，这里不多说了</p>
<pre data-lang="c++" class="language-c++ z-code"><code class="language-c++" data-lang="c++"><span class="z-source z-c++">    <span class="z-keyword z-control z-c++">for</span> <span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span><span class="z-support z-type z-stdint z-c">uint64_t</span> i <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-constant z-numeric z-integer z-decimal z-c++">0</span><span class="z-punctuation z-terminator z-c++">;</span> i <span class="z-keyword z-operator z-comparison z-c">&lt;</span> text_size<span class="z-punctuation z-terminator z-c++">;</span> i<span class="z-keyword z-operator z-arithmetic z-c">++</span><span class="z-punctuation z-section z-group z-end z-c++">)</span></span>
</span><span class="z-source z-c++">    <span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-begin z-c++">{</span>
</span></span><span class="z-source z-c++"><span class="z-meta z-block z-c++">        ptr<span class="z-meta z-brackets z-c++"><span class="z-punctuation z-section z-brackets z-begin z-c++">[</span>i<span class="z-punctuation z-section z-brackets z-end z-c++">]</span></span> <span class="z-keyword z-operator z-assignment z-augmented z-c">^=</span> key<span class="z-punctuation z-terminator z-c++">;</span>
</span></span><span class="z-source z-c++"><span class="z-meta z-block z-c++">    <span class="z-punctuation z-section z-block z-end z-c++">}</span></span>
</span></code></pre>
<p>我们需要先创建一个子项目<code>Stub</code>，按照当前的思路，新段的解密代码是需要一个相当于<code>ShellCode</code>的东西，他必须在无任何依赖的情况下都可以执行，这部分硬编码我们使用C生成，如果感觉过于复杂，也可以直接写一段汇编代码进行，当前场景直接写汇编是比用C编译后导出方便的。<code>Stub</code>项目的代码如下，主要含义就是自动获取基址，本身开着随机地址，通过汇编去获取会更加方便直接，一些特定变量通过占位的形式先进行定义</p>
<pre data-lang="C" class="language-C z-code"><code class="language-C" data-lang="C"><span class="z-source z-c"><span class="z-meta z-preprocessor z-include z-c"><span class="z-keyword z-control z-import z-include z-c">#include</span> <span class="z-string z-quoted z-other z-lt-gt z-include z-c"><span class="z-punctuation z-definition z-string z-begin z-c">&lt;</span>stdint.h<span class="z-punctuation z-definition z-string z-end z-c">&gt;</span></span>
</span></span><span class="z-source z-c">
</span><span class="z-source z-c"><span class="z-comment z-line z-double-slash z-c"><span class="z-punctuation z-definition z-comment z-c">//</span> 特定占位变量
</span></span><span class="z-source z-c"><span class="z-meta z-preprocessor z-macro z-c"><span class="z-keyword z-control z-import z-define z-c">#define</span></span><span class="z-meta z-preprocessor z-macro z-c"> <span class="z-entity z-name z-constant z-preprocessor z-c">PLACEHOLDER_RVA</span></span><span class="z-meta z-preprocessor z-macro z-c"> <span class="z-constant z-numeric z-integer z-hexadecimal z-c"><span class="z-punctuation z-definition z-numeric z-base z-c">0x</span>1122334455667788<span class="z-storage z-type z-numeric z-c">ULL</span></span></span>
</span><span class="z-source z-c"><span class="z-meta z-preprocessor z-macro z-c"><span class="z-keyword z-control z-import z-define z-c">#define</span></span><span class="z-meta z-preprocessor z-macro z-c"> <span class="z-entity z-name z-constant z-preprocessor z-c">PLACEHOLDER_SIZE</span></span><span class="z-meta z-preprocessor z-macro z-c"> <span class="z-constant z-numeric z-integer z-hexadecimal z-c"><span class="z-punctuation z-definition z-numeric z-base z-c">0x</span>8877665544332211<span class="z-storage z-type z-numeric z-c">ULL</span></span></span>
</span><span class="z-source z-c"><span class="z-meta z-preprocessor z-macro z-c"><span class="z-keyword z-control z-import z-define z-c">#define</span></span><span class="z-meta z-preprocessor z-macro z-c"> <span class="z-entity z-name z-constant z-preprocessor z-c">PLACEHOLDER_OEP</span></span><span class="z-meta z-preprocessor z-macro z-c"> <span class="z-constant z-numeric z-integer z-hexadecimal z-c"><span class="z-punctuation z-definition z-numeric z-base z-c">0x</span>AABBCCDD11223344<span class="z-storage z-type z-numeric z-c">ULL</span></span></span>
</span><span class="z-source z-c"><span class="z-meta z-preprocessor z-macro z-c"><span class="z-keyword z-control z-import z-define z-c">#define</span></span><span class="z-meta z-preprocessor z-macro z-c"> <span class="z-entity z-name z-constant z-preprocessor z-c">PLACEHOLDER_KEY</span></span><span class="z-meta z-preprocessor z-macro z-c"> <span class="z-constant z-numeric z-integer z-hexadecimal z-c"><span class="z-punctuation z-definition z-numeric z-base z-c">0x</span>AABBCCDDEEFF1122<span class="z-storage z-type z-numeric z-c">ULL</span></span></span>
</span><span class="z-source z-c">
</span><span class="z-source z-c"><span class="z-meta z-attribute z-c"><span class="z-storage z-modifier z-c">__attribute__</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">((</span></span></span><span class="z-meta z-attribute z-c"><span class="z-meta z-group z-c">section<span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span><span class="z-string z-quoted z-double z-c"><span class="z-punctuation z-definition z-string z-begin z-c">&quot;</span>.text<span class="z-punctuation z-definition z-string z-end z-c">&quot;</span></span><span class="z-punctuation z-section z-group z-end z-c">)</span></span>, naked</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">))</span></span></span> <span class="z-storage z-type z-c">void</span> <span class="z-meta z-function z-c"><span class="z-entity z-name z-function z-c">stub_entry</span></span><span class="z-meta z-function z-parameters z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function z-parameters z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-meta z-function z-c">
</span></span><span class="z-source z-c"><span class="z-meta z-function z-c"></span><span class="z-meta z-function z-c"><span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-begin z-c">{</span></span></span><span class="z-meta z-function z-c"><span class="z-meta z-block z-c">
</span></span></span><span class="z-source z-c"><span class="z-meta z-function z-c"><span class="z-meta z-block z-c">    <span class="z-comment z-line z-double-slash z-c"><span class="z-punctuation z-definition z-comment z-c">//</span> 获取基址
</span></span></span></span><span class="z-source z-c"><span class="z-meta z-function z-c"><span class="z-meta z-block z-c">    <span class="z-support z-type z-stdint z-c">uintptr_t</span> image_base<span class="z-punctuation z-terminator z-c">;</span>
</span></span></span><span class="z-source z-c"><span class="z-meta z-function z-c"><span class="z-meta z-block z-c">    <span class="z-storage z-type z-c">__asm__</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span>
</span></span></span></span><span class="z-source z-c"><span class="z-meta z-function z-c"><span class="z-meta z-block z-c"><span class="z-meta z-group z-c">        <span class="z-string z-quoted z-double z-c"><span class="z-punctuation z-definition z-string z-begin z-c">&quot;</span>movq <span class="z-constant z-other z-placeholder z-c">%%</span>gs:0x60, <span class="z-constant z-other z-placeholder z-c">%%</span>rax<span class="z-constant z-character z-escape z-c">\n</span><span class="z-constant z-character z-escape z-c">\t</span><span class="z-punctuation z-definition z-string z-end z-c">&quot;</span></span>
</span></span></span></span><span class="z-source z-c"><span class="z-meta z-function z-c"><span class="z-meta z-block z-c"><span class="z-meta z-group z-c">        <span class="z-string z-quoted z-double z-c"><span class="z-punctuation z-definition z-string z-begin z-c">&quot;</span>movq 0x10(<span class="z-constant z-other z-placeholder z-c">%%</span>rax), %0<span class="z-constant z-character z-escape z-c">\n</span><span class="z-constant z-character z-escape z-c">\t</span><span class="z-punctuation z-definition z-string z-end z-c">&quot;</span></span>
</span></span></span></span><span class="z-source z-c"><span class="z-meta z-function z-c"><span class="z-meta z-block z-c"><span class="z-meta z-group z-c">        <span class="z-keyword z-operator z-ternary z-c">:</span> <span class="z-string z-quoted z-double z-c"><span class="z-punctuation z-definition z-string z-begin z-c">&quot;</span>=r<span class="z-punctuation z-definition z-string z-end z-c">&quot;</span></span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span>image_base<span class="z-punctuation z-section z-group z-end z-c">)</span></span> <span class="z-keyword z-operator z-ternary z-c">:</span> <span class="z-keyword z-operator z-ternary z-c">:</span> <span class="z-string z-quoted z-double z-c"><span class="z-punctuation z-definition z-string z-begin z-c">&quot;</span>rax<span class="z-punctuation z-definition z-string z-end z-c">&quot;</span></span><span class="z-punctuation z-section z-group z-end z-c">)</span></span><span class="z-punctuation z-terminator z-c">;</span>
</span></span></span><span class="z-source z-c"><span class="z-meta z-function z-c"><span class="z-meta z-block z-c">
</span></span></span><span class="z-source z-c"><span class="z-meta z-function z-c"><span class="z-meta z-block z-c">    <span class="z-comment z-line z-double-slash z-c"><span class="z-punctuation z-definition z-comment z-c">//</span> 在替换的时候这里会自动更新
</span></span></span></span><span class="z-source z-c"><span class="z-meta z-function z-c"><span class="z-meta z-block z-c">    <span class="z-support z-type z-stdint z-c">uint64_t</span> text_rva <span class="z-keyword z-operator z-assignment z-c">=</span> PLACEHOLDER_RVA<span class="z-punctuation z-terminator z-c">;</span>
</span></span></span><span class="z-source z-c"><span class="z-meta z-function z-c"><span class="z-meta z-block z-c">    <span class="z-support z-type z-stdint z-c">uint64_t</span> text_size <span class="z-keyword z-operator z-assignment z-c">=</span> PLACEHOLDER_SIZE<span class="z-punctuation z-terminator z-c">;</span>
</span></span></span><span class="z-source z-c"><span class="z-meta z-function z-c"><span class="z-meta z-block z-c">    <span class="z-support z-type z-stdint z-c">uint64_t</span> old_oep <span class="z-keyword z-operator z-assignment z-c">=</span> PLACEHOLDER_OEP<span class="z-punctuation z-terminator z-c">;</span>
</span></span></span><span class="z-source z-c"><span class="z-meta z-function z-c"><span class="z-meta z-block z-c">    <span class="z-support z-type z-stdint z-c">uint64_t</span> key <span class="z-keyword z-operator z-assignment z-c">=</span> PLACEHOLDER_KEY<span class="z-punctuation z-terminator z-c">;</span>
</span></span></span><span class="z-source z-c"><span class="z-meta z-function z-c"><span class="z-meta z-block z-c">
</span></span></span><span class="z-source z-c"><span class="z-meta z-function z-c"><span class="z-meta z-block z-c">    <span class="z-comment z-line z-double-slash z-c"><span class="z-punctuation z-definition z-comment z-c">//</span> 解密
</span></span></span></span><span class="z-source z-c"><span class="z-meta z-function z-c"><span class="z-meta z-block z-c">    <span class="z-support z-type z-stdint z-c">uint8_t</span> <span class="z-keyword z-operator z-c">*</span>ptr <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span><span class="z-support z-type z-stdint z-c">uint8_t</span> <span class="z-keyword z-operator z-c">*</span><span class="z-punctuation z-section z-group z-end z-c">)</span></span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span>image_base <span class="z-keyword z-operator z-arithmetic z-c">+</span> text_rva<span class="z-punctuation z-section z-group z-end z-c">)</span></span><span class="z-punctuation z-terminator z-c">;</span>
</span></span></span><span class="z-source z-c"><span class="z-meta z-function z-c"><span class="z-meta z-block z-c">    <span class="z-keyword z-control z-c">for</span> <span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span><span class="z-support z-type z-stdint z-c">uint64_t</span> i <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-constant z-numeric z-integer z-decimal z-c">0</span><span class="z-punctuation z-terminator z-c">;</span> i <span class="z-keyword z-operator z-comparison z-c">&lt;</span> text_size<span class="z-punctuation z-terminator z-c">;</span> i<span class="z-keyword z-operator z-arithmetic z-c">++</span><span class="z-punctuation z-section z-group z-end z-c">)</span></span>
</span></span></span><span class="z-source z-c"><span class="z-meta z-function z-c"><span class="z-meta z-block z-c">    <span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-begin z-c">{</span>
</span></span></span></span><span class="z-source z-c"><span class="z-meta z-function z-c"><span class="z-meta z-block z-c"><span class="z-meta z-block z-c">        ptr<span class="z-meta z-brackets z-c"><span class="z-punctuation z-section z-brackets z-begin z-c">[</span>i<span class="z-punctuation z-section z-brackets z-end z-c">]</span></span> <span class="z-keyword z-operator z-assignment z-augmented z-c">^=</span> key<span class="z-punctuation z-terminator z-c">;</span>
</span></span></span></span><span class="z-source z-c"><span class="z-meta z-function z-c"><span class="z-meta z-block z-c"><span class="z-meta z-block z-c">    <span class="z-punctuation z-section z-block z-end z-c">}</span></span>
</span></span></span><span class="z-source z-c"><span class="z-meta z-function z-c"><span class="z-meta z-block z-c">
</span></span></span><span class="z-source z-c"><span class="z-meta z-function z-c"><span class="z-meta z-block z-c">    <span class="z-comment z-line z-double-slash z-c"><span class="z-punctuation z-definition z-comment z-c">//</span> 跳回 text
</span></span></span></span><span class="z-source z-c"><span class="z-meta z-function z-c"><span class="z-meta z-block z-c">    <span class="z-support z-type z-stdint z-c">uintptr_t</span> text <span class="z-keyword z-operator z-assignment z-c">=</span> image_base <span class="z-keyword z-operator z-arithmetic z-c">+</span> old_oep<span class="z-punctuation z-terminator z-c">;</span>
</span></span></span><span class="z-source z-c"><span class="z-meta z-function z-c"><span class="z-meta z-block z-c">    <span class="z-storage z-type z-c">__asm__</span> <span class="z-meta z-function-call z-c"><span class="z-variable z-function z-c">__volatile__</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c">
</span></span></span></span></span><span class="z-source z-c"><span class="z-meta z-function z-c"><span class="z-meta z-block z-c"><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c">        <span class="z-string z-quoted z-double z-c"><span class="z-punctuation z-definition z-string z-begin z-c">&quot;</span>jmp *%0<span class="z-punctuation z-definition z-string z-end z-c">&quot;</span></span>
</span></span></span></span></span><span class="z-source z-c"><span class="z-meta z-function z-c"><span class="z-meta z-block z-c"><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c">        <span class="z-keyword z-operator z-ternary z-c">:</span>
</span></span></span></span></span><span class="z-source z-c"><span class="z-meta z-function z-c"><span class="z-meta z-block z-c"><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c">        <span class="z-keyword z-operator z-ternary z-c">:</span> <span class="z-string z-quoted z-double z-c"><span class="z-punctuation z-definition z-string z-begin z-c">&quot;</span>r<span class="z-punctuation z-definition z-string z-end z-c">&quot;</span></span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span>text<span class="z-punctuation z-section z-group z-end z-c">)</span></span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-punctuation z-terminator z-c">;</span>
</span></span></span><span class="z-source z-c"><span class="z-meta z-function z-c"><span class="z-meta z-block z-c"></span></span><span class="z-meta z-function z-c"><span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-end z-c">}</span></span></span>
</span></code></pre>
<p>环境采用<code>cmake</code>编译，编译参数如下，这里会直接生成一个obj文件，用的时候直接通过<code>objcopy</code>即可拿到刚才所说的<code>ShellCode</code>硬编码</p>
<pre data-lang="CmakeLists.txt" class="language-CmakeLists.txt z-code"><code class="language-CmakeLists.txt" data-lang="CmakeLists.txt"><span class="z-source z-cmake"><span class="z-meta z-function-call z-cmake"><span class="z-support z-function z-cmake_minimum_required z-cmake">cmake_minimum_required</span></span><span class="z-meta z-function-call z-arguments z-cmake"><span class="z-punctuation z-section z-parens z-begin z-cmake">(</span><span class="z-variable z-parameter z-VERSION z-cmake">VERSION</span> <span class="z-meta z-string z-unquoted z-cmake">3.15</span><span class="z-punctuation z-section z-parens z-end z-cmake">)</span></span>
</span><span class="z-source z-cmake"><span class="z-meta z-function-call z-cmake"><span class="z-support z-function z-project z-cmake">project</span></span><span class="z-meta z-function-call z-arguments z-cmake"><span class="z-punctuation z-section z-parens z-begin z-cmake">(</span><span class="z-meta z-string z-unquoted z-cmake">StubProject</span> <span class="z-meta z-string z-unquoted z-cmake">C</span><span class="z-punctuation z-section z-parens z-end z-cmake">)</span></span>
</span><span class="z-source z-cmake">
</span><span class="z-source z-cmake"><span class="z-meta z-function-call z-cmake"><span class="z-support z-function z-add_library z-cmake">add_library</span></span><span class="z-meta z-function-call z-arguments z-cmake"><span class="z-punctuation z-section z-parens z-begin z-cmake">(</span><span class="z-meta z-string z-unquoted z-cmake">xor_stub</span> <span class="z-variable z-parameter z-OBJECT z-cmake">OBJECT</span> <span class="z-meta z-string z-unquoted z-cmake">xor-stub.c</span><span class="z-punctuation z-section z-parens z-end z-cmake">)</span></span>
</span><span class="z-source z-cmake">
</span><span class="z-source z-cmake"><span class="z-comment z-line z-cmake"><span class="z-punctuation z-definition z-comment z-cmake">#</span> 尽可能多的禁用一些无关生成的指令代码</span>
</span><span class="z-source z-cmake"><span class="z-comment z-line z-cmake"><span class="z-punctuation z-definition z-comment z-cmake">#</span> MSVC</span>
</span><span class="z-source z-cmake"><span class="z-meta z-function-call z-cmake"><span class="z-keyword z-control z-if z-cmake">if</span></span><span class="z-meta z-group z-if z-cmake"><span class="z-meta z-function-call z-arguments z-cmake"><span class="z-punctuation z-section z-parens z-begin z-cmake">(</span><span class="z-meta z-string z-unquoted z-cmake">MSVC</span><span class="z-punctuation z-section z-parens z-end z-cmake">)</span></span>
</span></span><span class="z-source z-cmake"><span class="z-meta z-group z-if z-cmake">    <span class="z-meta z-function-call z-cmake"><span class="z-support z-function z-target_compile_options z-cmake">target_compile_options</span></span><span class="z-meta z-function-call z-arguments z-cmake"><span class="z-punctuation z-section z-parens z-begin z-cmake">(</span><span class="z-meta z-string z-unquoted z-cmake">xor_stub</span> <span class="z-variable z-parameter z-PRIVATE z-cmake">PRIVATE</span> 
</span></span></span><span class="z-source z-cmake"><span class="z-meta z-group z-if z-cmake"><span class="z-meta z-function-call z-arguments z-cmake">        <span class="z-meta z-string z-unquoted z-cmake">/GS-</span>        
</span></span></span><span class="z-source z-cmake"><span class="z-meta z-group z-if z-cmake"><span class="z-meta z-function-call z-arguments z-cmake">        <span class="z-meta z-string z-unquoted z-cmake">/MT</span>       
</span></span></span><span class="z-source z-cmake"><span class="z-meta z-group z-if z-cmake"><span class="z-meta z-function-call z-arguments z-cmake">        <span class="z-meta z-string z-unquoted z-cmake">/Od</span>         
</span></span></span><span class="z-source z-cmake"><span class="z-meta z-group z-if z-cmake"><span class="z-meta z-function-call z-arguments z-cmake">        <span class="z-meta z-string z-unquoted z-cmake">/TC</span>        
</span></span></span><span class="z-source z-cmake"><span class="z-meta z-group z-if z-cmake"><span class="z-meta z-function-call z-arguments z-cmake">    <span class="z-punctuation z-section z-parens z-end z-cmake">)</span></span>
</span></span><span class="z-source z-cmake"><span class="z-meta z-group z-if z-cmake"><span class="z-meta z-function-call z-cmake"><span class="z-keyword z-control z-else z-cmake">else</span></span></span><span class="z-meta z-group z-else z-cmake"><span class="z-meta z-function-call z-arguments z-cmake"><span class="z-punctuation z-section z-parens z-begin z-cmake">(</span><span class="z-punctuation z-section z-parens z-end z-cmake">)</span></span>
</span></span><span class="z-source z-cmake"><span class="z-meta z-group z-else z-cmake">    <span class="z-comment z-line z-cmake"><span class="z-punctuation z-definition z-comment z-cmake">#</span> MinGW / GCC </span>
</span></span><span class="z-source z-cmake"><span class="z-meta z-group z-else z-cmake">    <span class="z-meta z-function-call z-cmake"><span class="z-support z-function z-target_compile_options z-cmake">target_compile_options</span></span><span class="z-meta z-function-call z-arguments z-cmake"><span class="z-punctuation z-section z-parens z-begin z-cmake">(</span><span class="z-meta z-string z-unquoted z-cmake">xor_stub</span> <span class="z-variable z-parameter z-PRIVATE z-cmake">PRIVATE</span> 
</span></span></span><span class="z-source z-cmake"><span class="z-meta z-group z-else z-cmake"><span class="z-meta z-function-call z-arguments z-cmake">        <span class="z-meta z-string z-unquoted z-cmake">-fno-stack-protector</span>   
</span></span></span><span class="z-source z-cmake"><span class="z-meta z-group z-else z-cmake"><span class="z-meta z-function-call z-arguments z-cmake">        <span class="z-meta z-string z-unquoted z-cmake">-ffreestanding</span>        
</span></span></span><span class="z-source z-cmake"><span class="z-meta z-group z-else z-cmake"><span class="z-meta z-function-call z-arguments z-cmake">        <span class="z-meta z-string z-unquoted z-cmake">-fno-pic</span>               
</span></span></span><span class="z-source z-cmake"><span class="z-meta z-group z-else z-cmake"><span class="z-meta z-function-call z-arguments z-cmake">        <span class="z-meta z-string z-unquoted z-cmake">-fno-common</span>            
</span></span></span><span class="z-source z-cmake"><span class="z-meta z-group z-else z-cmake"><span class="z-meta z-function-call z-arguments z-cmake">    <span class="z-punctuation z-section z-parens z-end z-cmake">)</span></span>
</span></span><span class="z-source z-cmake"><span class="z-meta z-group z-else z-cmake"><span class="z-meta z-function-call z-cmake"><span class="z-keyword z-control z-endif z-cmake">endif</span></span></span><span class="z-meta z-function-call z-arguments z-cmake"><span class="z-punctuation z-section z-parens z-begin z-cmake">(</span><span class="z-punctuation z-section z-parens z-end z-cmake">)</span></span>
</span></code></pre>
<p>现在回去写加壳程序，和上面基本一样，只是多了两个步骤，首先是对<code>text</code>段进行加密，加密这部分代码如下</p>
<pre data-lang="C++" class="language-C++ z-code"><code class="language-C++" data-lang="C++"><span class="z-source z-c++">    <span class="z-storage z-type z-c">auto</span> text_sec <span class="z-keyword z-operator z-assignment z-c">=</span> pe<span class="z-punctuation z-accessor z-arrow z-c++">-&gt;</span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">get_section</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-string z-quoted z-double z-c"><span class="z-punctuation z-definition z-string z-begin z-c">&quot;</span>.text<span class="z-punctuation z-definition z-string z-end z-c">&quot;</span></span></span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span><span class="z-source z-c++">    <span class="z-storage z-type z-c">auto</span> content <span class="z-keyword z-operator z-assignment z-c">=</span> text_sec<span class="z-punctuation z-accessor z-arrow z-c++">-&gt;</span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">content</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span><span class="z-source z-c++">    std<span class="z-punctuation z-accessor z-double-colon z-c++">::</span>vector<span class="z-punctuation z-section z-generic z-begin z-c++">&lt;</span><span class="z-support z-type z-stdint z-c">uint8_t</span><span class="z-punctuation z-section z-generic z-end z-c++">&gt;</span> <span class="z-meta z-function z-c++"><span class="z-meta z-toc-list z-full-identifier z-c++"><span class="z-entity z-name z-function z-c++">encrypted</span></span></span><span class="z-meta z-function z-parameters z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-function z-parameters z-c++"><span class="z-meta z-group z-c++">content<span class="z-punctuation z-accessor z-dot z-c++">.</span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">begin</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-separator z-c++">,</span> content<span class="z-punctuation z-accessor z-dot z-c++">.</span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">end</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span><span class="z-source z-c++">    <span class="z-keyword z-control z-c++">for</span> <span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span><span class="z-storage z-type z-c">auto</span> <span class="z-keyword z-operator z-c">&amp;</span>b <span class="z-keyword z-operator z-ternary z-c">:</span> encrypted<span class="z-punctuation z-section z-group z-end z-c++">)</span></span>
</span><span class="z-source z-c++">        b <span class="z-keyword z-operator z-assignment z-augmented z-c">^=</span> xor_key<span class="z-punctuation z-terminator z-c++">;</span>
</span><span class="z-source z-c++">    text_sec<span class="z-punctuation z-accessor z-arrow z-c++">-&gt;</span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">content</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++">encrypted</span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span><span class="z-source z-c++">    <span class="z-comment z-line z-double-slash z-c"><span class="z-punctuation z-definition z-comment z-c">//</span> 增加一下text的写入权限，解密需要写入权限
</span></span><span class="z-source z-c++">    text_sec<span class="z-punctuation z-accessor z-arrow z-c++">-&gt;</span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">add_characteristic</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++">LIEF<span class="z-punctuation z-accessor z-double-colon z-c++">::</span>PE<span class="z-punctuation z-accessor z-double-colon z-c++">::</span>Section<span class="z-punctuation z-accessor z-double-colon z-c++">::</span>CHARACTERISTICS<span class="z-punctuation z-accessor z-double-colon z-c++">::</span>MEM_WRITE</span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></code></pre>
<p>第二个步骤就是对刚才生成的硬编码加载进新段，这里加载前还需要把对应的一些地址也搞进去，这里需要从<code>Stub</code>子项目编译成品中获取出对应的<code>text</code>硬编码，具体命令如下</p>
<pre data-lang="cmd" class="language-cmd z-code"><code class="language-cmd" data-lang="cmd"><span class="z-source z-dosbatch">objcopy -j .text -O binary .\build\Stub\CMakeFiles\xor_stub.<span class="z-keyword z-command z-dosbatch">dir</span>\xor-stub.c.obj stub.bin
</span></code></pre>
<p>提取后，对应的提取和硬传参相关代码如下</p>
<pre data-lang="c++" class="language-c++ z-code"><code class="language-c++" data-lang="c++"><span class="z-source z-c++">    std<span class="z-punctuation z-accessor z-double-colon z-c++">::</span>ifstream <span class="z-meta z-function z-c++"><span class="z-meta z-toc-list z-full-identifier z-c++"><span class="z-entity z-name z-function z-c++">stub_f</span></span></span><span class="z-meta z-function z-parameters z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-function z-parameters z-c++"><span class="z-meta z-group z-c++"><span class="z-string z-quoted z-double z-c"><span class="z-punctuation z-definition z-string z-begin z-c">&quot;</span>stub.bin<span class="z-punctuation z-definition z-string z-end z-c">&quot;</span></span><span class="z-punctuation z-separator z-c++">,</span> std<span class="z-punctuation z-accessor z-double-colon z-c++">::</span>ios<span class="z-punctuation z-accessor z-double-colon z-c++">::</span><span class="z-variable z-parameter z-c++">binary</span><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span><span class="z-source z-c++">    std<span class="z-punctuation z-accessor z-double-colon z-c++">::</span>vector<span class="z-punctuation z-section z-generic z-begin z-c++">&lt;</span><span class="z-support z-type z-stdint z-c">uint8_t</span><span class="z-punctuation z-section z-generic z-end z-c++">&gt;</span> <span class="z-meta z-function z-c++"><span class="z-meta z-toc-list z-full-identifier z-c++"><span class="z-entity z-name z-function z-c++">stub_code</span></span></span><span class="z-meta z-function z-parameters z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-function z-parameters z-c++"><span class="z-meta z-group z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span><span class="z-meta z-function-call z-c++">std<span class="z-punctuation z-accessor z-double-colon z-c++">::</span><span class="z-variable z-function z-c++">istreambuf_iterator</span><span class="z-punctuation z-section z-generic z-begin z-c++">&lt;</span><span class="z-storage z-type z-c">char</span><span class="z-punctuation z-section z-generic z-end z-c++">&gt;</span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++">stub_f</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-section z-group z-end z-c++">)</span></span><span class="z-punctuation z-separator z-c++">,</span> <span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-begin z-c++">{</span><span class="z-punctuation z-section z-block z-end z-c++">}</span></span><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span><span class="z-source z-c++">
</span><span class="z-source z-c++">    <span class="z-meta z-function-call z-c++"><span class="z-variable z-function z-c++">patch_placeholder</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++">stub_code<span class="z-punctuation z-separator z-c++">,</span> <span class="z-constant z-numeric z-integer z-hexadecimal z-c++"><span class="z-punctuation z-definition z-numeric z-base z-c++">0x</span>1122334455667788<span class="z-storage z-type z-numeric z-c++">ULL</span></span><span class="z-punctuation z-separator z-c++">,</span> text_sec<span class="z-punctuation z-accessor z-arrow z-c++">-&gt;</span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">virtual_address</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span></span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span><span class="z-source z-c++">    <span class="z-meta z-function-call z-c++"><span class="z-variable z-function z-c++">patch_placeholder</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++">stub_code<span class="z-punctuation z-separator z-c++">,</span> <span class="z-constant z-numeric z-integer z-hexadecimal z-c++"><span class="z-punctuation z-definition z-numeric z-base z-c++">0x</span>8877665544332211<span class="z-storage z-type z-numeric z-c++">ULL</span></span><span class="z-punctuation z-separator z-c++">,</span> text_sec<span class="z-punctuation z-accessor z-arrow z-c++">-&gt;</span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">virtual_size</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span></span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span><span class="z-source z-c++">    <span class="z-meta z-function-call z-c++"><span class="z-variable z-function z-c++">patch_placeholder</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++">stub_code<span class="z-punctuation z-separator z-c++">,</span> <span class="z-constant z-numeric z-integer z-hexadecimal z-c++"><span class="z-punctuation z-definition z-numeric z-base z-c++">0x</span>AABBCCDD11223344<span class="z-storage z-type z-numeric z-c++">ULL</span></span><span class="z-punctuation z-separator z-c++">,</span> pe<span class="z-punctuation z-accessor z-arrow z-c++">-&gt;</span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">optional_header</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-accessor z-dot z-c++">.</span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">addressof_entrypoint</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span></span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span><span class="z-source z-c++">    <span class="z-meta z-function-call z-c++"><span class="z-variable z-function z-c++">patch_placeholder</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++">stub_code<span class="z-punctuation z-separator z-c++">,</span> <span class="z-constant z-numeric z-integer z-hexadecimal z-c++"><span class="z-punctuation z-definition z-numeric z-base z-c++">0x</span>AABBCCDDEEFF1122<span class="z-storage z-type z-numeric z-c++">ULL</span></span><span class="z-punctuation z-separator z-c++">,</span> xor_key</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span><span class="z-source z-c++">
</span><span class="z-source z-c++">    LIEF<span class="z-punctuation z-accessor z-double-colon z-c++">::</span>PE<span class="z-punctuation z-accessor z-double-colon z-c++">::</span>Section <span class="z-meta z-function z-c++"><span class="z-meta z-toc-list z-full-identifier z-c++"><span class="z-entity z-name z-function z-c++">new_sec</span></span></span><span class="z-meta z-function z-parameters z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-function z-parameters z-c++"><span class="z-meta z-group z-c++"><span class="z-string z-quoted z-double z-c"><span class="z-punctuation z-definition z-string z-begin z-c">&quot;</span>.Syn3x<span class="z-punctuation z-definition z-string z-end z-c">&quot;</span></span><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span><span class="z-source z-c++">    new_sec<span class="z-punctuation z-accessor z-dot z-c++">.</span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">content</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++">stub_code</span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span><span class="z-source z-c++">    new_sec<span class="z-punctuation z-accessor z-dot z-c++">.</span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">add_characteristic</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++">LIEF<span class="z-punctuation z-accessor z-double-colon z-c++">::</span>PE<span class="z-punctuation z-accessor z-double-colon z-c++">::</span>Section<span class="z-punctuation z-accessor z-double-colon z-c++">::</span>CHARACTERISTICS<span class="z-punctuation z-accessor z-double-colon z-c++">::</span>MEM_READ</span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span><span class="z-source z-c++">    new_sec<span class="z-punctuation z-accessor z-dot z-c++">.</span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">add_characteristic</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++">LIEF<span class="z-punctuation z-accessor z-double-colon z-c++">::</span>PE<span class="z-punctuation z-accessor z-double-colon z-c++">::</span>Section<span class="z-punctuation z-accessor z-double-colon z-c++">::</span>CHARACTERISTICS<span class="z-punctuation z-accessor z-double-colon z-c++">::</span>MEM_EXECUTE</span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span><span class="z-source z-c++">    new_sec<span class="z-punctuation z-accessor z-dot z-c++">.</span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">add_characteristic</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++">LIEF<span class="z-punctuation z-accessor z-double-colon z-c++">::</span>PE<span class="z-punctuation z-accessor z-double-colon z-c++">::</span>Section<span class="z-punctuation z-accessor z-double-colon z-c++">::</span>CHARACTERISTICS<span class="z-punctuation z-accessor z-double-colon z-c++">::</span>MEM_WRITE</span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span><span class="z-source z-c++">    <span class="z-storage z-type z-c">auto</span> added <span class="z-keyword z-operator z-assignment z-c">=</span> pe<span class="z-punctuation z-accessor z-arrow z-c++">-&gt;</span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">add_section</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++">new_sec</span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span><span class="z-source z-c++">	<span class="z-comment z-line z-double-slash z-c"><span class="z-punctuation z-definition z-comment z-c">//</span> OEP
</span></span><span class="z-source z-c++">    pe<span class="z-punctuation z-accessor z-arrow z-c++">-&gt;</span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">optional_header</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-accessor z-dot z-c++">.</span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">addressof_entrypoint</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++">added<span class="z-punctuation z-accessor z-arrow z-c++">-&gt;</span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">virtual_address</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span></span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></code></pre>
<p>这里应该不是特别难理解，里面有一个<code>patch_placeholder</code>函数，具体实现如下</p>
<pre data-lang="C++" class="language-C++ z-code"><code class="language-C++" data-lang="C++"><span class="z-source z-c++"><span class="z-storage z-type z-c">void</span> <span class="z-meta z-function z-c++"><span class="z-meta z-toc-list z-full-identifier z-c++"><span class="z-entity z-name z-function z-c++">patch_placeholder</span></span></span><span class="z-meta z-function z-parameters z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-function z-parameters z-c++"><span class="z-meta z-group z-c++">std<span class="z-punctuation z-accessor z-double-colon z-c++">::</span>vector<span class="z-punctuation z-section z-generic z-begin z-c++">&lt;</span><span class="z-support z-type z-stdint z-c">uint8_t</span><span class="z-punctuation z-section z-generic z-end z-c++">&gt;</span> <span class="z-keyword z-operator z-c">&amp;</span><span class="z-variable z-parameter z-c++">data</span><span class="z-punctuation z-separator z-c++">,</span> <span class="z-support z-type z-stdint z-c">uint64_t</span> <span class="z-variable z-parameter z-c++">placeholder</span><span class="z-punctuation z-separator z-c++">,</span> <span class="z-support z-type z-stdint z-c">uint64_t</span> <span class="z-variable z-parameter z-c++">real_value</span><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-meta z-function z-c++">
</span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"></span><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-begin z-c++">{</span></span></span><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++">
</span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++">    <span class="z-storage z-type z-c">auto</span> it <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-meta z-function-call z-c++">std<span class="z-punctuation z-accessor z-double-colon z-c++">::</span><span class="z-variable z-function z-c++">search</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++">data<span class="z-punctuation z-accessor z-dot z-c++">.</span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">begin</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-separator z-c++">,</span> data<span class="z-punctuation z-accessor z-dot z-c++">.</span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">end</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-separator z-c++">,</span>
</span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++">                          <span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span><span class="z-support z-type z-stdint z-c">uint8_t</span> <span class="z-keyword z-operator z-c">*</span><span class="z-punctuation z-section z-group z-end z-c++">)</span></span><span class="z-keyword z-operator z-c">&amp;</span>placeholder<span class="z-punctuation z-separator z-c++">,</span> <span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span><span class="z-support z-type z-stdint z-c">uint8_t</span> <span class="z-keyword z-operator z-c">*</span><span class="z-punctuation z-section z-group z-end z-c++">)</span></span><span class="z-keyword z-operator z-c">&amp;</span>placeholder <span class="z-keyword z-operator z-arithmetic z-c">+</span> <span class="z-constant z-numeric z-integer z-decimal z-c++">8</span></span></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++">    <span class="z-keyword z-control z-c++">if</span> <span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span>it <span class="z-keyword z-operator z-comparison z-c">!=</span> data<span class="z-punctuation z-accessor z-dot z-c++">.</span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">end</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-section z-group z-end z-c++">)</span></span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++">    <span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-begin z-c++">{</span>
</span></span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++">        <span class="z-meta z-function-call z-c++">std<span class="z-punctuation z-accessor z-double-colon z-c++">::</span><span class="z-support z-function z-C99 z-c">memcpy</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++"><span class="z-keyword z-operator z-c">&amp;</span><span class="z-keyword z-operator z-c">*</span>it<span class="z-punctuation z-separator z-c++">,</span> <span class="z-keyword z-operator z-c">&amp;</span>real_value<span class="z-punctuation z-separator z-c++">,</span> <span class="z-constant z-numeric z-integer z-decimal z-c++">8</span></span></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++">        <span class="z-keyword z-control z-flow z-return z-c++">return</span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++">    <span class="z-punctuation z-section z-block z-end z-c++">}</span></span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++">    std<span class="z-punctuation z-accessor z-double-colon z-c++">::</span>cerr <span class="z-keyword z-operator z-arithmetic z-c">&lt;&lt;</span> <span class="z-string z-quoted z-double z-c"><span class="z-punctuation z-definition z-string z-begin z-c">&quot;</span>error:<span class="z-punctuation z-definition z-string z-end z-c">&quot;</span></span> <span class="z-keyword z-operator z-arithmetic z-c">&lt;&lt;</span> std<span class="z-punctuation z-accessor z-double-colon z-c++">::</span>hex <span class="z-keyword z-operator z-arithmetic z-c">&lt;&lt;</span> placeholder <span class="z-keyword z-operator z-arithmetic z-c">&lt;&lt;</span> std<span class="z-punctuation z-accessor z-double-colon z-c++">::</span>endl<span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++"></span></span><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-end z-c++">}</span></span></span>
</span></code></pre>
<p>其他区别基本没有了，这里把加壳程序源码也奉上</p>
<pre data-lang="C++" class="language-C++ z-code"><code class="language-C++" data-lang="C++"><span class="z-source z-c++"><span class="z-meta z-preprocessor z-include z-c++"><span class="z-keyword z-control z-import z-include z-c++">#include</span> <span class="z-string z-quoted z-other z-lt-gt z-include z-c++"><span class="z-punctuation z-definition z-string z-begin z-c++">&lt;</span>iostream<span class="z-punctuation z-definition z-string z-end z-c++">&gt;</span></span>
</span></span><span class="z-source z-c++"><span class="z-meta z-preprocessor z-include z-c++"><span class="z-keyword z-control z-import z-include z-c++">#include</span> <span class="z-string z-quoted z-other z-lt-gt z-include z-c++"><span class="z-punctuation z-definition z-string z-begin z-c++">&lt;</span>vector<span class="z-punctuation z-definition z-string z-end z-c++">&gt;</span></span>
</span></span><span class="z-source z-c++"><span class="z-meta z-preprocessor z-include z-c++"><span class="z-keyword z-control z-import z-include z-c++">#include</span> <span class="z-string z-quoted z-other z-lt-gt z-include z-c++"><span class="z-punctuation z-definition z-string z-begin z-c++">&lt;</span>fstream<span class="z-punctuation z-definition z-string z-end z-c++">&gt;</span></span>
</span></span><span class="z-source z-c++"><span class="z-meta z-preprocessor z-include z-c++"><span class="z-keyword z-control z-import z-include z-c++">#include</span> <span class="z-string z-quoted z-other z-lt-gt z-include z-c++"><span class="z-punctuation z-definition z-string z-begin z-c++">&lt;</span>algorithm<span class="z-punctuation z-definition z-string z-end z-c++">&gt;</span></span>
</span></span><span class="z-source z-c++"><span class="z-meta z-preprocessor z-include z-c++"><span class="z-keyword z-control z-import z-include z-c++">#include</span> <span class="z-string z-quoted z-other z-lt-gt z-include z-c++"><span class="z-punctuation z-definition z-string z-begin z-c++">&lt;</span>cstring<span class="z-punctuation z-definition z-string z-end z-c++">&gt;</span></span>
</span></span><span class="z-source z-c++"><span class="z-meta z-preprocessor z-include z-c++"><span class="z-keyword z-control z-import z-include z-c++">#include</span> <span class="z-string z-quoted z-other z-lt-gt z-include z-c++"><span class="z-punctuation z-definition z-string z-begin z-c++">&lt;</span>LIEF/PE.hpp<span class="z-punctuation z-definition z-string z-end z-c++">&gt;</span></span>
</span></span><span class="z-source z-c++">
</span><span class="z-source z-c++"><span class="z-comment z-line z-double-slash z-c"><span class="z-punctuation z-definition z-comment z-c">//</span> 特定特征替换
</span></span><span class="z-source z-c++"><span class="z-storage z-type z-c">void</span> <span class="z-meta z-function z-c++"><span class="z-meta z-toc-list z-full-identifier z-c++"><span class="z-entity z-name z-function z-c++">patch_placeholder</span></span></span><span class="z-meta z-function z-parameters z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-function z-parameters z-c++"><span class="z-meta z-group z-c++">std<span class="z-punctuation z-accessor z-double-colon z-c++">::</span>vector<span class="z-punctuation z-section z-generic z-begin z-c++">&lt;</span><span class="z-support z-type z-stdint z-c">uint8_t</span><span class="z-punctuation z-section z-generic z-end z-c++">&gt;</span> <span class="z-keyword z-operator z-c">&amp;</span><span class="z-variable z-parameter z-c++">data</span><span class="z-punctuation z-separator z-c++">,</span> <span class="z-support z-type z-stdint z-c">uint64_t</span> <span class="z-variable z-parameter z-c++">placeholder</span><span class="z-punctuation z-separator z-c++">,</span> <span class="z-support z-type z-stdint z-c">uint64_t</span> <span class="z-variable z-parameter z-c++">real_value</span><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-meta z-function z-c++">
</span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"></span><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-begin z-c++">{</span></span></span><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++">
</span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++">    <span class="z-storage z-type z-c">auto</span> it <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-meta z-function-call z-c++">std<span class="z-punctuation z-accessor z-double-colon z-c++">::</span><span class="z-variable z-function z-c++">search</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++">data<span class="z-punctuation z-accessor z-dot z-c++">.</span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">begin</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-separator z-c++">,</span> data<span class="z-punctuation z-accessor z-dot z-c++">.</span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">end</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-separator z-c++">,</span>
</span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++">                          <span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span><span class="z-support z-type z-stdint z-c">uint8_t</span> <span class="z-keyword z-operator z-c">*</span><span class="z-punctuation z-section z-group z-end z-c++">)</span></span><span class="z-keyword z-operator z-c">&amp;</span>placeholder<span class="z-punctuation z-separator z-c++">,</span> <span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span><span class="z-support z-type z-stdint z-c">uint8_t</span> <span class="z-keyword z-operator z-c">*</span><span class="z-punctuation z-section z-group z-end z-c++">)</span></span><span class="z-keyword z-operator z-c">&amp;</span>placeholder <span class="z-keyword z-operator z-arithmetic z-c">+</span> <span class="z-constant z-numeric z-integer z-decimal z-c++">8</span></span></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++">    <span class="z-keyword z-control z-c++">if</span> <span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span>it <span class="z-keyword z-operator z-comparison z-c">!=</span> data<span class="z-punctuation z-accessor z-dot z-c++">.</span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">end</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-section z-group z-end z-c++">)</span></span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++">    <span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-begin z-c++">{</span>
</span></span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++">        <span class="z-meta z-function-call z-c++">std<span class="z-punctuation z-accessor z-double-colon z-c++">::</span><span class="z-support z-function z-C99 z-c">memcpy</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++"><span class="z-keyword z-operator z-c">&amp;</span><span class="z-keyword z-operator z-c">*</span>it<span class="z-punctuation z-separator z-c++">,</span> <span class="z-keyword z-operator z-c">&amp;</span>real_value<span class="z-punctuation z-separator z-c++">,</span> <span class="z-constant z-numeric z-integer z-decimal z-c++">8</span></span></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++">        <span class="z-keyword z-control z-flow z-return z-c++">return</span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++">    <span class="z-punctuation z-section z-block z-end z-c++">}</span></span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++">    std<span class="z-punctuation z-accessor z-double-colon z-c++">::</span>cerr <span class="z-keyword z-operator z-arithmetic z-c">&lt;&lt;</span> <span class="z-string z-quoted z-double z-c"><span class="z-punctuation z-definition z-string z-begin z-c">&quot;</span>error:<span class="z-punctuation z-definition z-string z-end z-c">&quot;</span></span> <span class="z-keyword z-operator z-arithmetic z-c">&lt;&lt;</span> std<span class="z-punctuation z-accessor z-double-colon z-c++">::</span>hex <span class="z-keyword z-operator z-arithmetic z-c">&lt;&lt;</span> placeholder <span class="z-keyword z-operator z-arithmetic z-c">&lt;&lt;</span> std<span class="z-punctuation z-accessor z-double-colon z-c++">::</span>endl<span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++"></span></span><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-end z-c++">}</span></span></span>
</span><span class="z-source z-c++">
</span><span class="z-source z-c++"><span class="z-storage z-type z-c">int</span> <span class="z-meta z-function z-c++"><span class="z-meta z-toc-list z-full-identifier z-c++"><span class="z-entity z-name z-function z-c++">main</span></span></span><span class="z-meta z-function z-parameters z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-function z-parameters z-c++"><span class="z-meta z-group z-c++"><span class="z-storage z-type z-c">int</span> <span class="z-variable z-parameter z-c++">argc</span><span class="z-punctuation z-separator z-c++">,</span> <span class="z-storage z-type z-c">char</span> <span class="z-keyword z-operator z-c">*</span><span class="z-keyword z-operator z-c">*</span><span class="z-variable z-parameter z-c++">argv</span><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-meta z-function z-c++">
</span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"></span><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-begin z-c++">{</span></span></span><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++">
</span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++">    <span class="z-keyword z-control z-c++">if</span> <span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span>argc <span class="z-keyword z-operator z-comparison z-c">&lt;</span> <span class="z-constant z-numeric z-integer z-decimal z-c++">2</span><span class="z-punctuation z-section z-group z-end z-c++">)</span></span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++">    <span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-begin z-c++">{</span>
</span></span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++">        std<span class="z-punctuation z-accessor z-double-colon z-c++">::</span>cout <span class="z-keyword z-operator z-arithmetic z-c">&lt;&lt;</span> <span class="z-string z-quoted z-double z-c"><span class="z-punctuation z-definition z-string z-begin z-c">&quot;</span>第一个参数指定pe文件<span class="z-punctuation z-definition z-string z-end z-c">&quot;</span></span> <span class="z-keyword z-operator z-arithmetic z-c">&lt;&lt;</span> std<span class="z-punctuation z-accessor z-double-colon z-c++">::</span>endl<span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++">        <span class="z-keyword z-control z-flow z-return z-c++">return</span> <span class="z-constant z-numeric z-integer z-decimal z-c++">1</span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++">    <span class="z-punctuation z-section z-block z-end z-c++">}</span></span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++">
</span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++">    std<span class="z-punctuation z-accessor z-double-colon z-c++">::</span>string path <span class="z-keyword z-operator z-assignment z-c">=</span> argv<span class="z-meta z-brackets z-c++"><span class="z-punctuation z-section z-brackets z-begin z-c++">[</span><span class="z-constant z-numeric z-integer z-decimal z-c++">1</span><span class="z-punctuation z-section z-brackets z-end z-c++">]</span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++">    <span class="z-support z-type z-stdint z-c">uint8_t</span> xor_key <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-constant z-numeric z-integer z-hexadecimal z-c++"><span class="z-punctuation z-definition z-numeric z-base z-c++">0x</span>AB</span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++">
</span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++">    <span class="z-storage z-type z-c">auto</span> pe <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-meta z-function-call z-c++">LIEF<span class="z-punctuation z-accessor z-double-colon z-c++">::</span>PE<span class="z-punctuation z-accessor z-double-colon z-c++">::</span>Parser<span class="z-punctuation z-accessor z-double-colon z-c++">::</span><span class="z-variable z-function z-c++">parse</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++">path</span></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++">    <span class="z-storage z-type z-c">auto</span> text_sec <span class="z-keyword z-operator z-assignment z-c">=</span> pe<span class="z-punctuation z-accessor z-arrow z-c++">-&gt;</span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">get_section</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-string z-quoted z-double z-c"><span class="z-punctuation z-definition z-string z-begin z-c">&quot;</span>.text<span class="z-punctuation z-definition z-string z-end z-c">&quot;</span></span></span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++">
</span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++">    <span class="z-comment z-line z-double-slash z-c"><span class="z-punctuation z-definition z-comment z-c">//</span> 加密text段
</span></span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++">    <span class="z-storage z-type z-c">auto</span> content <span class="z-keyword z-operator z-assignment z-c">=</span> text_sec<span class="z-punctuation z-accessor z-arrow z-c++">-&gt;</span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">content</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++">    std<span class="z-punctuation z-accessor z-double-colon z-c++">::</span>vector<span class="z-punctuation z-section z-generic z-begin z-c++">&lt;</span><span class="z-support z-type z-stdint z-c">uint8_t</span><span class="z-punctuation z-section z-generic z-end z-c++">&gt;</span> <span class="z-meta z-function-call z-c++"><span class="z-variable z-function z-c++">encrypted</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++">content<span class="z-punctuation z-accessor z-dot z-c++">.</span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">begin</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-separator z-c++">,</span> content<span class="z-punctuation z-accessor z-dot z-c++">.</span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">end</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span></span></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++">    <span class="z-keyword z-control z-c++">for</span> <span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span><span class="z-storage z-type z-c">auto</span> <span class="z-keyword z-operator z-c">&amp;</span>b <span class="z-keyword z-operator z-ternary z-c">:</span> encrypted<span class="z-punctuation z-section z-group z-end z-c++">)</span></span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++">        b <span class="z-keyword z-operator z-assignment z-augmented z-c">^=</span> xor_key<span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++">    text_sec<span class="z-punctuation z-accessor z-arrow z-c++">-&gt;</span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">content</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++">encrypted</span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++">
</span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++">    <span class="z-comment z-line z-double-slash z-c"><span class="z-punctuation z-definition z-comment z-c">//</span> text 增加可写权限
</span></span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++">    text_sec<span class="z-punctuation z-accessor z-arrow z-c++">-&gt;</span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">add_characteristic</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++">LIEF<span class="z-punctuation z-accessor z-double-colon z-c++">::</span>PE<span class="z-punctuation z-accessor z-double-colon z-c++">::</span>Section<span class="z-punctuation z-accessor z-double-colon z-c++">::</span>CHARACTERISTICS<span class="z-punctuation z-accessor z-double-colon z-c++">::</span>MEM_WRITE</span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++">
</span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++">    <span class="z-comment z-line z-double-slash z-c"><span class="z-punctuation z-definition z-comment z-c">//</span> 加载生成的存根代码
</span></span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++">    std<span class="z-punctuation z-accessor z-double-colon z-c++">::</span>ifstream <span class="z-meta z-function-call z-c++"><span class="z-variable z-function z-c++">stub_f</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++"><span class="z-string z-quoted z-double z-c"><span class="z-punctuation z-definition z-string z-begin z-c">&quot;</span>stub.bin<span class="z-punctuation z-definition z-string z-end z-c">&quot;</span></span><span class="z-punctuation z-separator z-c++">,</span> std<span class="z-punctuation z-accessor z-double-colon z-c++">::</span>ios<span class="z-punctuation z-accessor z-double-colon z-c++">::</span>binary</span></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++">    std<span class="z-punctuation z-accessor z-double-colon z-c++">::</span>vector<span class="z-punctuation z-section z-generic z-begin z-c++">&lt;</span><span class="z-support z-type z-stdint z-c">uint8_t</span><span class="z-punctuation z-section z-generic z-end z-c++">&gt;</span> <span class="z-meta z-function-call z-c++"><span class="z-variable z-function z-c++">stub_code</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span><span class="z-meta z-function-call z-c++">std<span class="z-punctuation z-accessor z-double-colon z-c++">::</span><span class="z-variable z-function z-c++">istreambuf_iterator</span><span class="z-punctuation z-section z-generic z-begin z-c++">&lt;</span><span class="z-storage z-type z-c">char</span><span class="z-punctuation z-section z-generic z-end z-c++">&gt;</span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++">stub_f</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-section z-group z-end z-c++">)</span></span><span class="z-punctuation z-separator z-c++">,</span> <span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-begin z-c++">{</span><span class="z-punctuation z-section z-block z-end z-c++">}</span></span></span></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++">
</span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++">    <span class="z-comment z-line z-double-slash z-c"><span class="z-punctuation z-definition z-comment z-c">//</span> 通过特定特征替换数值
</span></span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++">    <span class="z-meta z-function-call z-c++"><span class="z-variable z-function z-c++">patch_placeholder</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++">stub_code<span class="z-punctuation z-separator z-c++">,</span> <span class="z-constant z-numeric z-integer z-hexadecimal z-c++"><span class="z-punctuation z-definition z-numeric z-base z-c++">0x</span>1122334455667788<span class="z-storage z-type z-numeric z-c++">ULL</span></span><span class="z-punctuation z-separator z-c++">,</span> text_sec<span class="z-punctuation z-accessor z-arrow z-c++">-&gt;</span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">virtual_address</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span></span></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++">    <span class="z-meta z-function-call z-c++"><span class="z-variable z-function z-c++">patch_placeholder</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++">stub_code<span class="z-punctuation z-separator z-c++">,</span> <span class="z-constant z-numeric z-integer z-hexadecimal z-c++"><span class="z-punctuation z-definition z-numeric z-base z-c++">0x</span>8877665544332211<span class="z-storage z-type z-numeric z-c++">ULL</span></span><span class="z-punctuation z-separator z-c++">,</span> text_sec<span class="z-punctuation z-accessor z-arrow z-c++">-&gt;</span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">virtual_size</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span></span></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++">    <span class="z-meta z-function-call z-c++"><span class="z-variable z-function z-c++">patch_placeholder</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++">stub_code<span class="z-punctuation z-separator z-c++">,</span> <span class="z-constant z-numeric z-integer z-hexadecimal z-c++"><span class="z-punctuation z-definition z-numeric z-base z-c++">0x</span>AABBCCDD11223344<span class="z-storage z-type z-numeric z-c++">ULL</span></span><span class="z-punctuation z-separator z-c++">,</span> pe<span class="z-punctuation z-accessor z-arrow z-c++">-&gt;</span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">optional_header</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-accessor z-dot z-c++">.</span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">addressof_entrypoint</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span></span></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++">    <span class="z-meta z-function-call z-c++"><span class="z-variable z-function z-c++">patch_placeholder</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++">stub_code<span class="z-punctuation z-separator z-c++">,</span> <span class="z-constant z-numeric z-integer z-hexadecimal z-c++"><span class="z-punctuation z-definition z-numeric z-base z-c++">0x</span>AABBCCDDEEFF1122<span class="z-storage z-type z-numeric z-c++">ULL</span></span><span class="z-punctuation z-separator z-c++">,</span> xor_key</span></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++">
</span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++">    <span class="z-comment z-line z-double-slash z-c"><span class="z-punctuation z-definition z-comment z-c">//</span> 创建壳段
</span></span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++">    LIEF<span class="z-punctuation z-accessor z-double-colon z-c++">::</span>PE<span class="z-punctuation z-accessor z-double-colon z-c++">::</span>Section <span class="z-meta z-function-call z-c++"><span class="z-variable z-function z-c++">new_sec</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++"><span class="z-string z-quoted z-double z-c"><span class="z-punctuation z-definition z-string z-begin z-c">&quot;</span>.Syn3x<span class="z-punctuation z-definition z-string z-end z-c">&quot;</span></span></span></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++">    new_sec<span class="z-punctuation z-accessor z-dot z-c++">.</span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">content</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++">stub_code</span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++">    new_sec<span class="z-punctuation z-accessor z-dot z-c++">.</span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">add_characteristic</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++">LIEF<span class="z-punctuation z-accessor z-double-colon z-c++">::</span>PE<span class="z-punctuation z-accessor z-double-colon z-c++">::</span>Section<span class="z-punctuation z-accessor z-double-colon z-c++">::</span>CHARACTERISTICS<span class="z-punctuation z-accessor z-double-colon z-c++">::</span>MEM_READ</span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++">    new_sec<span class="z-punctuation z-accessor z-dot z-c++">.</span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">add_characteristic</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++">LIEF<span class="z-punctuation z-accessor z-double-colon z-c++">::</span>PE<span class="z-punctuation z-accessor z-double-colon z-c++">::</span>Section<span class="z-punctuation z-accessor z-double-colon z-c++">::</span>CHARACTERISTICS<span class="z-punctuation z-accessor z-double-colon z-c++">::</span>MEM_EXECUTE</span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++">    new_sec<span class="z-punctuation z-accessor z-dot z-c++">.</span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">add_characteristic</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++">LIEF<span class="z-punctuation z-accessor z-double-colon z-c++">::</span>PE<span class="z-punctuation z-accessor z-double-colon z-c++">::</span>Section<span class="z-punctuation z-accessor z-double-colon z-c++">::</span>CHARACTERISTICS<span class="z-punctuation z-accessor z-double-colon z-c++">::</span>MEM_WRITE</span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++">    <span class="z-storage z-type z-c">auto</span> added <span class="z-keyword z-operator z-assignment z-c">=</span> pe<span class="z-punctuation z-accessor z-arrow z-c++">-&gt;</span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">add_section</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++">new_sec</span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++">
</span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++">    <span class="z-comment z-line z-double-slash z-c"><span class="z-punctuation z-definition z-comment z-c">//</span> 更新OEP
</span></span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++">    pe<span class="z-punctuation z-accessor z-arrow z-c++">-&gt;</span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">optional_header</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-accessor z-dot z-c++">.</span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">addressof_entrypoint</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++">added<span class="z-punctuation z-accessor z-arrow z-c++">-&gt;</span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">virtual_address</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span></span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++">
</span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++">    <span class="z-comment z-line z-double-slash z-c"><span class="z-punctuation z-definition z-comment z-c">//</span> 构建
</span></span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++">    LIEF<span class="z-punctuation z-accessor z-double-colon z-c++">::</span>PE<span class="z-punctuation z-accessor z-double-colon z-c++">::</span>Builder<span class="z-punctuation z-accessor z-double-colon z-c++">::</span>config_t config<span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++">    config<span class="z-punctuation z-accessor z-dot z-c++">.</span><span class="z-variable z-other z-readwrite z-member z-c++">tls</span> <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-constant z-language z-c">false</span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++">
</span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++">    <span class="z-comment z-line z-double-slash z-c"><span class="z-punctuation z-definition z-comment z-c">//</span> 创建正式的PE文件
</span></span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++">    LIEF<span class="z-punctuation z-accessor z-double-colon z-c++">::</span>PE<span class="z-punctuation z-accessor z-double-colon z-c++">::</span>Builder <span class="z-meta z-function-call z-c++"><span class="z-variable z-function z-c++">builder</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">{</span></span></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++"><span class="z-keyword z-operator z-c">*</span>pe<span class="z-punctuation z-separator z-c++">,</span> config</span></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">}</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++">    builder<span class="z-punctuation z-accessor z-dot z-c++">.</span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">build</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++">    builder<span class="z-punctuation z-accessor z-dot z-c++">.</span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">write</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++">path<span class="z-punctuation z-accessor z-dot z-c++">.</span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">insert</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++">path<span class="z-punctuation z-accessor z-dot z-c++">.</span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">length</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span> <span class="z-keyword z-operator z-arithmetic z-c">-</span> <span class="z-constant z-numeric z-integer z-decimal z-c++">4</span><span class="z-punctuation z-separator z-c++">,</span> <span class="z-string z-quoted z-double z-c"><span class="z-punctuation z-definition z-string z-begin z-c">&quot;</span>.Syn3x<span class="z-punctuation z-definition z-string z-end z-c">&quot;</span></span></span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span></span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++">    <span class="z-keyword z-control z-flow z-return z-c++">return</span> <span class="z-constant z-numeric z-integer z-decimal z-c++">0</span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++"></span></span><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-end z-c++">}</span></span></span>
</span></code></pre>
<h2 id="xie-zai-hou-mian">写在后面</h2>
<h3 id="guan-yu-ben-wen-jia-mi-ke">关于本文加密壳</h3>
<p>当前实现的加密壳还是有一个小问题的，通过ida打开加壳程序可以看的很完善，但是通过x64dbg进行调试打开会一直报一个权限错误的异常，这里因为只是为了学习原理和简单的实现一下，就没有深入的研究这个问题了，但是基本上是没有什么太大的问题。欢迎大佬指出问题。</p>
<h3 id="ya-suo-ke-shi-xian">压缩壳实现？</h3>
<p>压缩壳的实现无非就是把新增段的逻辑替换成压缩<code>text</code>段，有一点比较重要的点，就是这里搞的壳都是不去修改一些系统调用的，都是基于当前PE可以直接运行的，如果是需要添加额外调用，类似于WINAPI这些内容，还有一些其他的库的调用，按照当前思路都是不行的，需要深入的研究PE文件，有兴趣的可以去搞一搞。</p>
<h3 id="winapidiao-yong">WINAPI调用？</h3>
<p>程序的载入肯定都是要加载<code>kernel32.dll</code>的，winapi实际可以动态的去获取，然后通过下面流程来调用其他API，这样也可以直接丢入到这个段中</p>
<pre data-lang="text" class="language-text z-code"><code class="language-text" data-lang="text"><span class="z-text z-plain">GetKernel32Address -&gt; GetProcAddress -&gt; LoadLibrary -&gt; GetModuleHandle -&gt; GetModuleHandle(&quot;dll&quot;)
</span></code></pre>

        </section>
        
        

        
            
            
            

            
        
            
            
            

            
        
            
            
            

            
        
            
            
            

            
        
        </article>
</main>

    <div id="button-container">
        
        
            <div id="toc-floating-container">
                <input type="checkbox" id="toc-toggle" class="toggle"/>
                <label for="toc-toggle" id="toc-button" class="button" title="Toggle Table of Contents">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960"><path d="M414.82-193.094q-18.044 0-30.497-12.32-12.453-12.319-12.453-30.036t12.453-30.086q12.453-12.37 30.497-12.37h392.767q17.237 0 29.927 12.487 12.69 12.486 12.69 30.203 0 17.716-12.69 29.919t-29.927 12.203H414.82Zm0-244.833q-18.044 0-30.497-12.487Q371.87-462.9 371.87-480.45t12.453-29.92q12.453-12.369 30.497-12.369h392.767q17.237 0 29.927 12.511 12.69 12.512 12.69 29.845 0 17.716-12.69 30.086-12.69 12.37-29.927 12.37H414.82Zm0-245.167q-18.044 0-30.497-12.32t-12.453-30.037q0-17.716 12.453-30.086 12.453-12.369 30.497-12.369h392.767q17.237 0 29.927 12.486 12.69 12.487 12.69 30.203 0 17.717-12.69 29.92-12.69 12.203-29.927 12.203H414.82ZM189.379-156.681q-32.652 0-55.878-22.829t-23.226-55.731q0-32.549 23.15-55.647 23.151-23.097 55.95-23.097 32.799 0 55.313 23.484 22.515 23.484 22.515 56.246 0 32.212-22.861 54.893-22.861 22.681-54.963 22.681Zm0-245.167q-32.652 0-55.878-23.134-23.226-23.135-23.226-55.623 0-32.487 23.467-55.517t56.12-23.03q32.102 0 54.721 23.288 22.62 23.288 22.62 55.775 0 32.488-22.861 55.364-22.861 22.877-54.963 22.877Zm-.82-244.833q-32.224 0-55.254-23.288-23.03-23.289-23.03-55.623 0-32.333 23.271-55.364 23.272-23.03 55.495-23.03 32.224 0 55.193 23.288 22.969 23.289 22.969 55.622 0 32.334-23.21 55.364-23.21 23.031-55.434 23.031Z"/></svg>
                </label>
                <div class="toc-content">
                    

<div class="toc-container">
    

    <ul>
        
            
            
                <li><a href="https://synex.space/blog/reverse-zi-xie-ke-xue-xi-yu-jia-mi-ke-shi-xian/#guan-yu-cheng-xu-ke">关于程序壳</a>
                    
                </li>
            
        
            
            
                <li><a href="https://synex.space/blog/reverse-zi-xie-ke-xue-xi-yu-jia-mi-ke-shi-xian/#shou-dong-shi-xian-liu-cheng">手动实现流程</a>
                    
                </li>
            
        
            
            
                <li><a href="https://synex.space/blog/reverse-zi-xie-ke-xue-xi-yu-jia-mi-ke-shi-xian/#c-shi-xian-liu-cheng">C++实现流程</a>
                    
                </li>
            
        
            
            
                <li><a href="https://synex.space/blog/reverse-zi-xie-ke-xue-xi-yu-jia-mi-ke-shi-xian/#jia-mi-ke-shi-xian">加密壳实现</a>
                    
                </li>
            
        
            
            
                <li><a href="https://synex.space/blog/reverse-zi-xie-ke-xue-xi-yu-jia-mi-ke-shi-xian/#xie-zai-hou-mian">写在后面</a>
                    
                        <ul>
                            
                                
                                    <li><a href="https://synex.space/blog/reverse-zi-xie-ke-xue-xi-yu-jia-mi-ke-shi-xian/#guan-yu-ben-wen-jia-mi-ke">关于本文加密壳</a>
                                        
                                    </li>
                                
                            
                                
                                    <li><a href="https://synex.space/blog/reverse-zi-xie-ke-xue-xi-yu-jia-mi-ke-shi-xian/#ya-suo-ke-shi-xian">压缩壳实现？</a>
                                        
                                    </li>
                                
                            
                                
                                    <li><a href="https://synex.space/blog/reverse-zi-xie-ke-xue-xi-yu-jia-mi-ke-shi-xian/#winapidiao-yong">WINAPI调用？</a>
                                        
                                    </li>
                                
                            
                        </ul>
                    
                </li>
            
        
    </ul>
</div>


                </div>
            </div>
        

        
        

        
        <a href="#" id="top-button" class="no-hover-padding" title="Go to the top of the page">
            <svg viewBox="0 0 20 20" fill="currentColor"><path d="M3.293 9.707a1 1 0 010-1.414l6-6a1 1 0 011.414 0l6 6a1 1 0 01-1.414 1.414L11 5.414V17a1 1 0 11-2 0V5.414L4.707 9.707a1 1 0 01-1.414 0z"/></svg>
        </a>
    </div>


<span id="copy-success" class="hidden">
        Copied!
    </span>
    <span id="copy-init" class="hidden">
        Copy code to clipboard
    </span>
    <script defer src="https://synex.space/js/copyCodeToClipboard.min.js"></script>


    </div>
    <footer>
    <section>
        <nav class="socials nav-navs">
        </nav>

        
        <nav class="nav-navs">
        </nav>

        <div class="credits">
            <small>
                

                
                Powered by
                <a rel="" 

 href="https://www.getzola.org">Zola</a>
                &amp;
                <a rel="" 

 href="https://github.com/welpo/tabi">tabi</a>

                </small>
        </div>
    </section>

    <div id="searchModal" class="search-modal js" role="dialog" aria-labelledby="modalTitle">
    <h1 id="modalTitle" class="visually-hidden">Search</h1>
    <div id="modal-content">
        <div id="searchBar">
            <div class="search-icon" aria-hidden="true">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960">
                    <path d="M784-120 532-372q-30 24-69 38t-83 14q-109 0-184.5-75.5T120-580q0-109 75.5-184.5T380-840q109 0 184.5 75.5T640-580q0 44-14 83t-38 69l252 252-56 56ZM380-400q75 0 127.5-52.5T560-580q0-75-52.5-127.5T380-760q-75 0-127.5 52.5T200-580q0 75 52.5 127.5T380-400Z"/>
                </svg>
            </div>
            <input id="searchInput" role="combobox" autocomplete="off" spellcheck="false" aria-expanded="false" aria-controls="results-container" placeholder="Search…"/>
            <div id="clear-search" class="close-icon interactive-icon" tabindex="0" role="button" title="Clear search">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960">
                <path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/>
                </svg>
            </div>
        </div>
        <div id="results-container">
            <div id="results-info"><span id="zero_results"> No results</span>
                <span id="one_results"> $NUMBER result</span>
                <span id="many_results"> $NUMBER results</span><span id="two_results"> $NUMBER results</span>
                <span id="few_results"> $NUMBER results</span>
            </div>
            <div id="results" role="listbox"></div>
        </div>
    </div>
</div>
</footer>


    
    
</body>

</html>
