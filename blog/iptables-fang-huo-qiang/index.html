<!DOCTYPE html>
<html lang="en" >

<head>
    <meta charset="UTF-8"><meta http-equiv="Content-Security-Policy"
content="default-src 'self';font-src 'self' data:;img-src 'self' https://* data:;media-src 'self';style-src 'self';frame-src player.vimeo.com https://www.youtube-nocookie.com;connect-src 'self';script-src 'self' 'self'">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="base" content="https://synex.space/">

    
    <title>
~/S9n3x • IPTABLES-防火墙管理</title>

    
    
    

    
    

    
    
    
        
            <link rel="stylesheet" href="https://synex.space/custom_subset.css?h=0b9535a28bc3d5bf2321">
        
    

    
        <link rel="stylesheet" href="https://synex.space/main.css?h=3716ab3457d2dd050b3c" />
        <link rel="stylesheet" href="https://synex.space/skins/mint.css?h=504215cf6bc10586b487" />

    <meta name="color-scheme" content="light dark" />
        <meta name="description" content="" />
        <meta property="og:description" content="" />

    

    <meta property="og:title" content="IPTABLES-防火墙管理" />
    <meta property="og:type" content="article" />

    
<meta property="og:locale" content="en_GB" />

    <meta property="og:url" content="https:&#x2F;&#x2F;synex.space&#x2F;blog&#x2F;iptables-fang-huo-qiang&#x2F;" /><meta property="og:site_name" content="~&#x2F;S9n3x">
        <noscript><link rel="stylesheet" href="https://synex.space/no_js.css"/></noscript>
        <script type="text/javascript" src="https://synex.space/js/initializeTheme.min.js"></script>
        <script defer src="https://synex.space/js/themeSwitcher.min.js"></script>
        <script defer src="https://synex.space/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e"></script>

        
    
</head>


<body>
    <a href="#main-content" id="skip-link">Skip to content</a>
    <header>
    <nav class="navbar">
        <div class="nav-title">
            <a class="home-title" href="https://synex.space/">~&#x2F;S9n3x</a>
        </div>
            <div class="nav-navs">
                <ul>
                        
                            <li>
                                <a class="nav-links no-hover-padding" href="https://synex.space/blog/">blog
                                </a>
                            </li>
                        
                            <li>
                                <a class="nav-links no-hover-padding" href="https://synex.space/archive/">archive
                                </a>
                            </li>
                        
                            <li>
                                <a class="nav-links no-hover-padding" href="https://synex.space/tags/">tags
                                </a>
                            </li>
                        
                            <li>
                                <a class="nav-links no-hover-padding" href="https://synex.space/friends/">friends
                                </a>
                            </li>
                        <li class="menu-icons-container">
                        <ul class="menu-icons-group">
                            <li class="js menu-icon">
                                <div role="button" tabindex="0" id="search-button" class="search-icon interactive-icon" title="Click or press $SHORTCUT to open search" aria-label="Click or press $SHORTCUT to open search">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960">
                                        <path d="M784-120 532-372q-30 24-69 38t-83 14q-109 0-184.5-75.5T120-580q0-109 75.5-184.5T380-840q109 0 184.5 75.5T640-580q0 44-14 83t-38 69l252 252-56 56ZM380-400q75 0 127.5-52.5T560-580q0-75-52.5-127.5T380-760q-75 0-127.5 52.5T200-580q0 75 52.5 127.5T380-400Z"/>
                                    </svg>
                                </div>
                            </li>

                            
                            

                            <li class="theme-switcher-wrapper js"><div
        title="Toggle dark&#x2F;light mode"
        class="theme-switcher"
        tabindex="0"
        role="button"
        aria-label="Toggle dark mode"
        aria-pressed="false">
    </div><div
        title="Reset mode to default"
        class="theme-resetter arrow"
        tabindex="0"
        role="button"
        aria-hidden="true"
        aria-label="Reset mode to default">
    </div>

</li>
</ul>
                    </li>
                </ul>
            </div>
        
    </nav>
</header>

    <div class="content" id="main-content">

        
        





<main>
    <article class="h-entry">
        <h1 class="p-name article-title">
            IPTABLES-防火墙管理
        </h1>
        <a class="u-url u-uid" href="https://synex.space/blog/iptables-fang-huo-qiang/"></a>

        <ul class="meta"><span class="hidden p-author h-card">
<a rel="author" href="https:&#x2F;&#x2F;synex.space&#x2F;" class="u-url " title=""></a>
</span>
<li><time class="dt-published" datetime="2022-05-25T11:40:00">25th May 2022</time></li><li title="2205 words"><span class='separator' aria-hidden='true'>•</span>12 min read</li><li class="tag"><span class='separator' aria-hidden='true'>•</span>Tags:&nbsp;</li><li class="tag"><a class="p-category" href="https://synex.space/tags/kai-yuan-gong-ju/">开源工具</a>,&nbsp;</li><li class="tag"><a class="p-category" href="https://synex.space/tags/iptables/">iptables</a>,&nbsp;</li><li class="tag"><a class="p-category" href="https://synex.space/tags/xi-tong-guan-li/">系统管理</a></li>
        </ul><section class="e-content body"><h1 id="gai-shu">概述</h1>
<p>Netfilter/iptables(以下简称iptbales)是unix/linux自带的一款优秀切开放源代码的完全自由的基于包过滤的防护墙工具，他的功能十分强大，使用非常灵活，可以对流入和流出服务器的数据包进行很精细的控制。
Iptables是linux2.4以2.6内核中集成的服务。其功能与安全性比其老一辈ipfwadm,ipchains强大的多(长江后浪推前浪)，iptable主要是工作在OSI模型的二三四层，如果重新编译内核，iptables也可以支持7层控制(squid代理+iptables)。</p>
<h1 id="zhuan-ye-ming-ci">专业名词</h1>
<h2 id="netfilter-iptables">Netfilter/iptables</h2>
<p>可以把Netfilter/iptables看作一栋楼，里面存放着很多的表。</p>
<h2 id="biao-tables">表(tables)</h2>
<p>表(tables)是链的容器,即所有的链(chains)都属于其对应的表(tables)上，可以把表(iptables)当作一套房子。
表有filter nat mangle raw四个表。</p>
<table><thead><tr><th>表名</th><th>作用</th></tr></thead><tbody>
<tr><td>filter表</td><td>I负责过滤功能，内核模块：iptables_filter</td></tr>
<tr><td>nat表</td><td>负责网络地址转换功能，内核模块：iptable_nat</td></tr>
<tr><td>mangle表</td><td>解析报文，做出修改，重新封装的功能，内核模块：iptable_mangle</td></tr>
<tr><td>raw表</td><td>关闭nat表上启用的链接追踪机制，内核模块：iptable_raw</td></tr>
</tbody></table>
<h2 id="lian-chains">链(chains)</h2>
<p>链(chains)是规则(Policys)的容器。如果把表(tables)当作一套房子,那么链就是里面的房间，卧室，厨房，客厅什么的。
链有INPUT OUTPUT FORWARD PREROUTING POSTROUTING 不同的表有不同的链</p>
<h2 id="gui-ze-policy">规则(Policy)</h2>
<p>规(Policy)则就是一条条过滤的语句用来控制流量动作的。</p>
<h1 id="guan-yu-biao-he-lian">关于表和链</h1>
<h2 id="guan-xi">关系</h2>
<table><thead><tr><th>表</th><th>链</th></tr></thead><tbody>
<tr><td>filter表</td><td>INPUT，FORWARD,OUTPUT</td></tr>
<tr><td>nat表</td><td>PREROUTING,OUTPUT,POSTROUTING,INPUT(centos6没有)</td></tr>
<tr><td>mangle表</td><td>PREROUTING,INPUT,FORWARD,OUTPUT,POSTROUTING</td></tr>
<tr><td>raw表</td><td>PREROUTING,OUTPUT</td></tr>
</tbody></table>
<h2 id="filter">Filter</h2>
<p>主要是和自身有关，真正负责主机防火墙功能的(过滤流入流出主机的数据包)。Filter表是iptables默认使用的表，这个表定义了三个链(chains)，工作场景主要是作为主机的防火墙。</p>
<p>INPUT链 负责过滤所有目标地址是本机地址的数据。通俗的讲，就是过滤进入主机的数据包。
FORWARD链 负责转发流经主机的数据包。起转发的作用，和nat关系很大，后面会详细介绍。 LVSNAT模式。net.ipv4.ip_forward = 0
OUTPUT链 处理所有源地址是本机地址的数据包。通俗的讲，就是处理从主机发去的数据包。</p>
<h2 id="nat">NAT</h2>
<p>负责网络地址转换，即来源与目的ip地址和port的转换。主要应用于局域网共享上网或者特殊的端口转换服务相关。(和主机本身无关)
NAT功能一般用于的场景</p>
<ul>
<li>用于做企业路由或网关，共享上网。</li>
<li>做内部IP地址一对一映射，硬件防火墙映射IP到内部服务器，FTP服务。</li>
<li>Web，单个端口映射，直接映射80端口</li>
</ul>
<p>OUTPUT链 和主机发出去的数据包有关。改变主机发出数据包的目标地址。
PREROUTING链 在数据包到达防火墙时进行路由判断之前执行的规则，作用是改变数据包的目的地址，目的端口等。(通俗的说就是收信时，根据规则重写收件人的地址)
POSTROUTING链 在数据包离开防火墙时进行路由判断之后的规则，作用改变数据包的源地址，源端口等。(通俗的说就是寄信的时候可以改变发件人的地址)</p>
<h2 id="mangle">Mangle</h2>
<p>主要负责修改数据包中特殊的路由标记，如TTL，TOS，MARK等。这个表定义了5个链
INPUT FORWARD OUTPUT PREROUTING POSTROUTING
这个表基本用不到知道即可</p>
<h2 id="raw">RAW</h2>
<p>主要是用来控制数据包是否需要通过iptables来处理的一个表 比如web服务器流量很大80端口默认开着需要filter表的INPUT是否来通过 使用RAW表之后则这条就不需要经过iptables防火墙了直接忽略通 防止流量过高 iptables处理不过来提高服务器性能
链只有两个
PREROUTING和OUTPUT
在表中数据包最早经过就是RAW所以可以让iptables不处理对应的数据包
#工作流程#</p>
<h2 id="guo-lu-liu-cheng">过滤流程</h2>
<p>iptables是采取包过滤机制工作的，所以它会对请求的数据包的包头数据进行分析、并根据我们预先设定的规则进行匹配来判断之后进行的动作。下图为过滤的流程图
<img src="https://image.boychai.xyz/article/IPTABLES_1.png" alt="过滤流程" /></p>
<h2 id="biao-lian-gong-zuo-liu-cheng">表链工作流程</h2>
<p>下图为较为具体的工作流程图
<img src="https://image.boychai.xyz/article/IPTABLES_2.png" alt="详细图" />
下图为简易流程图
<img src="https://image.boychai.xyz/article/IPTABLES_3.png" alt="简易图" />
平常我们其实只需要顾及到nat的prerouting、postrouting和filter的input、forward以他的一般是用不到</p>
<h1 id="ming-ling">命令</h1>
<h2 id="zhu-yi">注意</h2>
<ul>
<li>CentOS6自带iptables 往后的版本应该都是改用firewalld防火墙了 使用iptables的话得stop服务或者mask服务 systemctl sotp/mask firwealld才行 之后不管是那个版本iptables应该都是自带的但是还缺一样东西iptables-services这个包安装之后才可以使用service iptables的命令来进行管理服务这个包很重要</li>
<li>规则的动作丢弃比拒绝更好一些拒绝会回包丢弃是直接忽略还有一个理由就是说如果别人来判断你的主机是否存货拒绝的话就代表你的服务器存在 忽略的话他就会以为你这个东西不存在因为没有回包。</li>
</ul>
<h2 id="fu-wu-guan-li">服务管理</h2>
<pre class="z-code"><code><span class="z-text z-plain">systemctl start iptables		//开启服务
</span><span class="z-text z-plain">systemctl stop iptables		//关闭服务
</span><span class="z-text z-plain">systemctl enable iptables 	//设置开机自启
</span><span class="z-text z-plain">systemctl disable iptables 	//设置开机自动关闭
</span><span class="z-text z-plain">service iptables save 		//保存当前设置下次开机之后会生效
</span></code></pre>
<p>**Ps:**在centos7版本之后默认不会安装iptables-services，如果需要使用服务管理则需要安装一下"yum -y install iptables-services",iptables默认会有一个配置表(/var/sysconfig/iptabels这个文件) 这个表记录这本机的所有的iptables配置 每次开机之后都会找这个文件使其里面的配置生效service iptables save就是把当前临时的配置保存到这个表里使下次重载或者重启时生效 这一步很重要</p>
<h2 id="gui-ze-guan-li">规则管理</h2>
<pre class="z-code"><code><span class="z-text z-plain">iptables -L 	//列出表的规则 默认不加任何参数输出的时filter表的规则
</span><span class="z-text z-plain">iptables -F 	//清除所有的规则(无法清除默认的规则)
</span><span class="z-text z-plain">iptables -X	//删除用户自定义的链(用的很少)
</span><span class="z-text z-plain">iptables -N  //创建链(用的少)
</span><span class="z-text z-plain">iptables -Z  //把链的计数器清零
</span></code></pre>
<h2 id="gui-ze-pei-zhi">规则配置</h2>
<pre class="z-code"><code><span class="z-text z-plain">iptables -t 	//指定表
</span><span class="z-text z-plain">iptables -t [表] -A  //指定链以及添加规则的方式(在规则低端添加规则)
</span><span class="z-text z-plain">iptables -t [表] -I   //指定链以及添加规则的方式(在规则顶端添加规则)
</span><span class="z-text z-plain">iptables -t [表] -D   //指定链以及删除对应规则
</span><span class="z-text z-plain">iptables -t [表] -A/I [链] -p //指定ip协议tcp/udp
</span><span class="z-text z-plain">iptables -t [表] -A/I [链] –p [tcp/udp] --dport //指定目标端口
</span><span class="z-text z-plain">iptables -t [表] -A/I [链] -i 	//指定流入网卡
</span><span class="z-text z-plain">iptables -t [表] -A/I [链] -o	//指定流出网卡
</span><span class="z-text z-plain">iptables -t [表] -A/I [链] -s 	//指定源地址
</span><span class="z-text z-plain">iptables -t [表] -A/I [链] [相应参数] -j //指定动作(一共三种通过(ACCEPT) 拒绝(REJECT) 丢弃(DROP))
</span></code></pre>
<h2 id="li">例</h2>
<ul>
<li>丢弃22端口(ssh)的链接
iptables -t filter -A INPUT -p tcp --dport 22 -j DROP</li>
<li>丢弃某个IP的所有包
iptables -t filter -A INPUT -s [IPADDR] -j DROP</li>
<li>除了某个IP的数据其他全部丢弃
iptables -t filter -A INPUT ! -s [IPADDR] -j DROP</li>
<li>禁用整个网卡
iptables -t filter -A INPUT -i [网卡名称] -j DROP</li>
<li>范围性丢弃端口链接
iptables -t filter -A INPUT -p tcp –dport [最小:最大] -j DROP</li>
<li>丢弃多个端口的链接
iptables -t filter -A INPUT -p tcp -m multiport –dport [23,24,25...] -j DROP</li>
</ul>
<h1 id="natbiao">NAT表</h1>
<h2 id="zhu-yi-1">注意</h2>
<p>因为NAT是负责网络转换这块，最好是把内核的转发更能打开，不然路由链就不生效
cat /etc/sysctl.conf |grep net.ipv4.ip_forward
net.ipv4.ip_forward = 1
sysctl -p   //生效</p>
<h2 id="snat">SNAT</h2>
<p>Ip转换 一般用于局域网做网管内网ip转换为可上网的ip 提供内网主机上网使用
命令：
Iptables -t nat -A POSTROUTING -s 源地址 -d 0.0.0.0/0 -j SNAT –to-source 转换的ip</p>
<h2 id="dnat">DNAT</h2>
<p>端口转发 一般用于端口转发做反向代理 可以防止内网主机完全暴露在公网环境中.
自己的端口转发
IP tables -t nat -A PREROUTING -p tcp –dport 本机端口 -J REDIRECT –to-port 转到端口
主机的端口转发
Iptables -t nat -A PREROUTING -p tcp –dport 本机端口 -J DNAT –to-destination 主机:端口</p>
<h2 id="masquerade">MASQUERADE</h2>
<p>Ip伪装 一般用于局域网做网管内网ip转换为可上网的ip 提供内网主机上网使用
命令：
Iptables -t nat -A POSTROUTING -s 源地址 -d 0.0.0.0/0 -j MASQUERADE</p>

        </section>
        
        

        
            
            
            

            
        
            
            
            

            
        
            
            
            

            
        
            
            
            

            
        
        </article>
</main>


<span id="copy-success" class="hidden">
        Copied!
    </span>
    <span id="copy-init" class="hidden">
        Copy code to clipboard
    </span>
    <script defer src="https://synex.space/js/copyCodeToClipboard.min.js"></script>


    </div>
    <footer>
    <section>
        <nav class="socials nav-navs">
        </nav>

        
        <nav class="nav-navs">
        </nav>

        <div class="credits">
            <small>
                

                
                Powered by
                <a rel="" 

 href="https://www.getzola.org">Zola</a>
                &amp;
                <a rel="" 

 href="https://github.com/welpo/tabi">tabi</a>

                </small>
        </div>
    </section>

    <div id="searchModal" class="search-modal js" role="dialog" aria-labelledby="modalTitle">
    <h1 id="modalTitle" class="visually-hidden">Search</h1>
    <div id="modal-content">
        <div id="searchBar">
            <div class="search-icon" aria-hidden="true">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960">
                    <path d="M784-120 532-372q-30 24-69 38t-83 14q-109 0-184.5-75.5T120-580q0-109 75.5-184.5T380-840q109 0 184.5 75.5T640-580q0 44-14 83t-38 69l252 252-56 56ZM380-400q75 0 127.5-52.5T560-580q0-75-52.5-127.5T380-760q-75 0-127.5 52.5T200-580q0 75 52.5 127.5T380-400Z"/>
                </svg>
            </div>
            <input id="searchInput" role="combobox" autocomplete="off" spellcheck="false" aria-expanded="false" aria-controls="results-container" placeholder="Search…"/>
            <div id="clear-search" class="close-icon interactive-icon" tabindex="0" role="button" title="Clear search">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960">
                <path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/>
                </svg>
            </div>
        </div>
        <div id="results-container">
            <div id="results-info"><span id="zero_results"> No results</span>
                <span id="one_results"> $NUMBER result</span>
                <span id="many_results"> $NUMBER results</span><span id="two_results"> $NUMBER results</span>
                <span id="few_results"> $NUMBER results</span>
            </div>
            <div id="results" role="listbox"></div>
        </div>
    </div>
</div>
</footer>


    
    
</body>

</html>
