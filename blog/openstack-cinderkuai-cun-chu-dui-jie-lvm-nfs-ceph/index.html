<!DOCTYPE html>
<html lang="en" >

<head>
    <meta charset="UTF-8"><meta http-equiv="Content-Security-Policy"
content="default-src 'self';font-src 'self' data:;img-src 'self' https://* data:;media-src 'self';style-src 'self';frame-src player.vimeo.com https://www.youtube-nocookie.com;connect-src 'self';script-src 'self' 'self'">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="base" content="https://synex.space/">

    
    <title>
~/S9n3x • OpenStack-Cinder块存储-对接LVM、NFS、CEPH</title>

    
    
    

    
    

    
    
    
        
            <link rel="stylesheet" href="https://synex.space/custom_subset.css?h=0b9535a28bc3d5bf2321">
        
    

    
        <link rel="stylesheet" href="https://synex.space/main.css?h=3716ab3457d2dd050b3c" />
        <link rel="stylesheet" href="https://synex.space/skins/mint.css?h=504215cf6bc10586b487" />

    <meta name="color-scheme" content="light dark" />
        <meta name="description" content="" />
        <meta property="og:description" content="" />

    

    <meta property="og:title" content="OpenStack-Cinder块存储-对接LVM、NFS、CEPH" />
    <meta property="og:type" content="article" />

    
<meta property="og:locale" content="en_GB" />

    <meta property="og:url" content="https:&#x2F;&#x2F;synex.space&#x2F;blog&#x2F;openstack-cinderkuai-cun-chu-dui-jie-lvm-nfs-ceph&#x2F;" /><meta property="og:site_name" content="~&#x2F;S9n3x">
        <noscript><link rel="stylesheet" href="https://synex.space/no_js.css"/></noscript>
        <script type="text/javascript" src="https://synex.space/js/initializeTheme.min.js"></script>
        <script defer src="https://synex.space/js/themeSwitcher.min.js"></script>
        <script defer src="https://synex.space/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e"></script>

        
    
</head>


<body>
    <a href="#main-content" id="skip-link">Skip to content</a>
    <header>
    <nav class="navbar">
        <div class="nav-title">
            <a class="home-title" href="https://synex.space/">~&#x2F;S9n3x</a>
        </div>
            <div class="nav-navs">
                <ul>
                        
                            <li>
                                <a class="nav-links no-hover-padding" href="https://synex.space/blog/">blog
                                </a>
                            </li>
                        
                            <li>
                                <a class="nav-links no-hover-padding" href="https://synex.space/archive/">archive
                                </a>
                            </li>
                        
                            <li>
                                <a class="nav-links no-hover-padding" href="https://synex.space/tags/">tags
                                </a>
                            </li>
                        
                            <li>
                                <a class="nav-links no-hover-padding" href="https://synex.space/friends/">friends
                                </a>
                            </li>
                        <li class="menu-icons-container">
                        <ul class="menu-icons-group">
                            <li class="js menu-icon">
                                <div role="button" tabindex="0" id="search-button" class="search-icon interactive-icon" title="Click or press $SHORTCUT to open search" aria-label="Click or press $SHORTCUT to open search">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960">
                                        <path d="M784-120 532-372q-30 24-69 38t-83 14q-109 0-184.5-75.5T120-580q0-109 75.5-184.5T380-840q109 0 184.5 75.5T640-580q0 44-14 83t-38 69l252 252-56 56ZM380-400q75 0 127.5-52.5T560-580q0-75-52.5-127.5T380-760q-75 0-127.5 52.5T200-580q0 75 52.5 127.5T380-400Z"/>
                                    </svg>
                                </div>
                            </li>

                            
                            

                            <li class="theme-switcher-wrapper js"><div
        title="Toggle dark&#x2F;light mode"
        class="theme-switcher"
        tabindex="0"
        role="button"
        aria-label="Toggle dark mode"
        aria-pressed="false">
    </div><div
        title="Reset mode to default"
        class="theme-resetter arrow"
        tabindex="0"
        role="button"
        aria-hidden="true"
        aria-label="Reset mode to default">
    </div>

</li>
</ul>
                    </li>
                </ul>
            </div>
        
    </nav>
</header>

    <div class="content" id="main-content">

        
        





<main>
    <article class="h-entry">
        <h1 class="p-name article-title">
            OpenStack-Cinder块存储-对接LVM、NFS、CEPH
        </h1>
        <a class="u-url u-uid" href="https://synex.space/blog/openstack-cinderkuai-cun-chu-dui-jie-lvm-nfs-ceph/"></a>

        <ul class="meta"><span class="hidden p-author h-card">
<a rel="author" href="https:&#x2F;&#x2F;synex.space&#x2F;" class="u-url " title=""></a>
</span>
<li><time class="dt-published" datetime="2025-01-11T16:05:00">11th Jan 2025</time></li><li title="1466 words"><span class='separator' aria-hidden='true'>•</span>8 min read</li><li class="tag"><span class='separator' aria-hidden='true'>•</span>Tags:&nbsp;</li><li class="tag"><a class="p-category" href="https://synex.space/tags/kai-yuan-gong-ju/">开源工具</a>,&nbsp;</li><li class="tag"><a class="p-category" href="https://synex.space/tags/openstack/">OpenStack</a>,&nbsp;</li><li class="tag"><a class="p-category" href="https://synex.space/tags/stein/">Stein</a>,&nbsp;</li><li class="tag"><a class="p-category" href="https://synex.space/tags/cinder/">Cinder</a>,&nbsp;</li><li class="tag"><a class="p-category" href="https://synex.space/tags/lvm/">LVM</a>,&nbsp;</li><li class="tag"><a class="p-category" href="https://synex.space/tags/nfs/">NFS</a>,&nbsp;</li><li class="tag"><a class="p-category" href="https://synex.space/tags/ceph/">CEPH</a></li>
        </ul><section class="e-content body"><h1 id="qian-yan">前言</h1>
<p>参考文档：https://docs.openstack.org/cinder/stein/install/
块存储通过cinder组件对接，他也分为控制节点和计算节点的区分。</p>
<h1 id="kong-zhi-jie-dian">控制节点</h1>
<p>参考文档： https://docs.openstack.org/cinder/stein/install/cinder-controller-install-rdo.html
先去创库授权，在控制节点执行下面命令</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">mysql</span></span><span class="z-meta z-function-call z-arguments z-shell"><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>u</span> root<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>p</span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">CREATE</span></span><span class="z-meta z-function-call z-arguments z-shell"> DATABASE cinder</span><span class="z-keyword z-operator z-logical z-continue z-shell">;</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">GRANT</span></span><span class="z-meta z-function-call z-arguments z-shell"> ALL PRIVILEGES ON cinder.<span class="z-keyword z-operator z-regexp z-quantifier z-shell">*</span> TO <span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>cinder<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span>@<span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>localhost<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span> <span class="z-punctuation z-separator z-continuation z-line z-shell">\
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell">  IDENTIFIED BY <span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>CINDER_DBPASS<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span></span><span class="z-keyword z-operator z-logical z-continue z-shell">;</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">GRANT</span></span><span class="z-meta z-function-call z-arguments z-shell"> ALL PRIVILEGES ON cinder.<span class="z-keyword z-operator z-regexp z-quantifier z-shell">*</span> TO <span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>cinder<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span>@<span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>%<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span> <span class="z-punctuation z-separator z-continuation z-line z-shell">\
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell">  IDENTIFIED BY <span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>CINDER_DBPASS<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span></span><span class="z-keyword z-operator z-logical z-continue z-shell">;</span>
</span></code></pre>
<p>在认证组件中创建用户、授权</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">./admin-openrc</span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">openstack</span></span><span class="z-meta z-function-call z-arguments z-shell"> user create<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>domain</span> default<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>password</span> CINDER_PASS cinder</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">openstack</span></span><span class="z-meta z-function-call z-arguments z-shell"> role add<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>project</span> service<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>user</span> cinder admin</span>
</span></code></pre>
<p>创建服务实体</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">openstack</span></span><span class="z-meta z-function-call z-arguments z-shell"> service create<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>name</span> cinderv2 <span class="z-punctuation z-separator z-continuation z-line z-shell">\
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell"><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell">  --</span>description</span> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&quot;</span>OpenStack Block Storage<span class="z-punctuation z-definition z-string z-end z-shell">&quot;</span></span> volumev2</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">openstack</span></span><span class="z-meta z-function-call z-arguments z-shell"> service create<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>name</span> cinderv3 <span class="z-punctuation z-separator z-continuation z-line z-shell">\
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell"><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell">  --</span>description</span> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&quot;</span>OpenStack Block Storage<span class="z-punctuation z-definition z-string z-end z-shell">&quot;</span></span> volumev3</span>
</span></code></pre>
<p>创建api访问入口</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">openstack</span></span><span class="z-meta z-function-call z-arguments z-shell"> endpoint create<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>region</span> RegionOne <span class="z-punctuation z-separator z-continuation z-line z-shell">\
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell">  volumev2 public http://controller:8776/v2/<span class="z-meta z-group z-expansion z-job z-shell"><span class="z-punctuation z-definition z-variable z-job z-shell">%</span></span><span class="z-constant z-character z-escape z-shell">\(</span>project_id<span class="z-constant z-character z-escape z-shell">\)</span>s</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">openstack</span></span><span class="z-meta z-function-call z-arguments z-shell"> endpoint create<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>region</span> RegionOne <span class="z-punctuation z-separator z-continuation z-line z-shell">\
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell">  volumev2 internal http://controller:8776/v2/<span class="z-meta z-group z-expansion z-job z-shell"><span class="z-punctuation z-definition z-variable z-job z-shell">%</span></span><span class="z-constant z-character z-escape z-shell">\(</span>project_id<span class="z-constant z-character z-escape z-shell">\)</span>s</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">openstack</span></span><span class="z-meta z-function-call z-arguments z-shell"> endpoint create<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>region</span> RegionOne <span class="z-punctuation z-separator z-continuation z-line z-shell">\
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell">  volumev2 admin http://controller:8776/v2/<span class="z-meta z-group z-expansion z-job z-shell"><span class="z-punctuation z-definition z-variable z-job z-shell">%</span></span><span class="z-constant z-character z-escape z-shell">\(</span>project_id<span class="z-constant z-character z-escape z-shell">\)</span>s</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">openstack</span></span><span class="z-meta z-function-call z-arguments z-shell"> endpoint create<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>region</span> RegionOne <span class="z-punctuation z-separator z-continuation z-line z-shell">\
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell">  volumev3 public http://controller:8776/v3/<span class="z-meta z-group z-expansion z-job z-shell"><span class="z-punctuation z-definition z-variable z-job z-shell">%</span></span><span class="z-constant z-character z-escape z-shell">\(</span>project_id<span class="z-constant z-character z-escape z-shell">\)</span>s</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">openstack</span></span><span class="z-meta z-function-call z-arguments z-shell"> endpoint create<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>region</span> RegionOne <span class="z-punctuation z-separator z-continuation z-line z-shell">\
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell">  volumev3 internal http://controller:8776/v3/<span class="z-meta z-group z-expansion z-job z-shell"><span class="z-punctuation z-definition z-variable z-job z-shell">%</span></span><span class="z-constant z-character z-escape z-shell">\(</span>project_id<span class="z-constant z-character z-escape z-shell">\)</span>s</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">openstack</span></span><span class="z-meta z-function-call z-arguments z-shell"> endpoint create<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>region</span> RegionOne <span class="z-punctuation z-separator z-continuation z-line z-shell">\
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell">  volumev3 admin http://controller:8776/v3/<span class="z-meta z-group z-expansion z-job z-shell"><span class="z-punctuation z-definition z-variable z-job z-shell">%</span></span><span class="z-constant z-character z-escape z-shell">\(</span>project_id<span class="z-constant z-character z-escape z-shell">\)</span>s</span>
</span></code></pre>
<p>安装软件包</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">yum</span></span><span class="z-meta z-function-call z-arguments z-shell"> install<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>y</span> openstack-cinder</span>
</span></code></pre>
<p>备份配置文件</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">cp</span></span><span class="z-meta z-function-call z-arguments z-shell"> /etc/cinder/cinder.conf<span class="z-meta z-group z-expansion z-brace z-shell"><span class="z-punctuation z-section z-expansion z-brace z-begin z-shell">{</span><span class="z-punctuation z-separator z-shell">,</span>.bak<span class="z-punctuation z-section z-expansion z-brace z-end z-shell">}</span></span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">egrep</span></span><span class="z-meta z-function-call z-arguments z-shell"><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>v</span> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&quot;</span>^#|^$<span class="z-punctuation z-definition z-string z-end z-shell">&quot;</span></span> /etc/cinder/cinder.conf.bak <span class="z-keyword z-operator z-assignment z-redirection z-shell">&gt;</span> /etc/cinder/cinder.conf </span>
</span></code></pre>
<p>修改<code>/etc/cinder/cinder.conf </code>文件，主要是以下内容</p>
<pre data-lang="/etc/cinder/cinder.conf" class="language-/etc/cinder/cinder.conf z-code"><code class="language-/etc/cinder/cinder.conf" data-lang="/etc/cinder/cinder.conf"><span class="z-text z-plain">[DEFAULT]
</span><span class="z-text z-plain">my_ip = 10.0.0.11
</span><span class="z-text z-plain">transport_url = rabbit://openstack:RABBIT_PASS@controller
</span><span class="z-text z-plain">auth_strategy = keystone
</span><span class="z-text z-plain">[database]
</span><span class="z-text z-plain">connection = mysql+pymysql://cinder:CINDER_DBPASS@controller/cinder
</span><span class="z-text z-plain">[keystone_authtoken]
</span><span class="z-text z-plain">www_authenticate_uri = http://controller:5000
</span><span class="z-text z-plain">auth_url = http://controller:5000
</span><span class="z-text z-plain">memcached_servers = controller:11211
</span><span class="z-text z-plain">auth_type = password
</span><span class="z-text z-plain">project_domain_name = default
</span><span class="z-text z-plain">user_domain_name = default
</span><span class="z-text z-plain">project_name = service
</span><span class="z-text z-plain">username = cinder
</span><span class="z-text z-plain">password = CINDER_PASS
</span><span class="z-text z-plain">[oslo_concurrency]
</span><span class="z-text z-plain">lock_path = /var/lib/cinder/tmp
</span></code></pre>
<p>以cinder的身份填充数据库，这一步会有一个弃用信息，不用管。</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">su</span></span><span class="z-meta z-function-call z-arguments z-shell"><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>s</span> /bin/sh<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>c</span> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&quot;</span>cinder-manage db sync<span class="z-punctuation z-definition z-string z-end z-shell">&quot;</span></span> cinder</span>
</span></code></pre>
<p>对接控制节点的计算服务,编辑nova的配置<code>/etc/nova/nova.conf</code>,主要是下面内容</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">[cinder]</span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">os_region_name</span></span><span class="z-meta z-function-call z-arguments z-shell"> = RegionOne</span>
</span></code></pre>
<p>重启nova组件</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">systemctl</span></span><span class="z-meta z-function-call z-arguments z-shell"> restart openstack-nova-api.service</span>
</span></code></pre>
<p>启动cinder组件</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">systemctl</span></span><span class="z-meta z-function-call z-arguments z-shell"> enable<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>now</span> openstack-cinder-api.service openstack-cinder-scheduler.service</span>
</span></code></pre>
<p>验证可以参考链接： https://docs.openstack.org/cinder/stein/install/cinder-verify.html</p>
<h1 id="cun-chu-jie-dian">存储节点</h1>
<p>参考文档： https://docs.openstack.org/cinder/stein/install/cinder-storage-install-rdo.html
官方推荐使用lvm+块存储的方式来做openstack的存储
这里在计算节点compute1安装第一个存储节点</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">yum</span></span><span class="z-meta z-function-call z-arguments z-shell"> install<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>y</span> lvm2 device-mapper-persistent-data</span>
</span></code></pre>
<p>启动服务</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">systemctl</span></span><span class="z-meta z-function-call z-arguments z-shell"> enable<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>now</span> lvm2-lvmetad.service</span>
</span></code></pre>
<p>现在给这个节点添加一个硬盘
<img src="https://image.boychai.xyz/article/Pasted%20image%2020250105204918.png" alt="" />
使用下面命令让主机热加载硬盘</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-support z-function z-echo z-shell">echo</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>- - -<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span> <span class="z-keyword z-operator z-assignment z-redirection z-shell">&gt;</span>/sys/class/scsi_host/host0/scan </span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-support z-function z-echo z-shell">echo</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>- - -<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span> <span class="z-keyword z-operator z-assignment z-redirection z-shell">&gt;</span>/sys/class/scsi_host/host1/scan </span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-support z-function z-echo z-shell">echo</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>- - -<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span> <span class="z-keyword z-operator z-assignment z-redirection z-shell">&gt;</span>/sys/class/scsi_host/host2/scan </span>
</span></code></pre>
<p>开始创建存储卷</p>
<pre data-lang="bashs" class="language-bashs z-code"><code class="language-bashs" data-lang="bashs"><span class="z-text z-plain">pvcreate /dev/sdb
</span><span class="z-text z-plain">vgcreate cinder-volumes /dev/sdb
</span></code></pre>
<p>编辑lvm的配置文件<code>/etc/lvm/lvm.conf</code>然后参考文档： https://docs.openstack.org/cinder/stein/install/cinder-storage-install-rdo.html#prerequisites
说是建议不让lvm去扫描咱们使用的这个卷，如果不加可能会导致后期出现各种问题，还有就是如果系统本身也是lvm也需要加上，我这里系统用的就是lvm的方式所以修改的内容是</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">filter</span></span><span class="z-meta z-function-call z-arguments z-shell"> = <span class="z-keyword z-control z-regexp z-set z-begin z-shell">[</span> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&quot;</span>a/sda/<span class="z-punctuation z-definition z-string z-end z-shell">&quot;</span></span>, <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&quot;</span>a/sdb/<span class="z-punctuation z-definition z-string z-end z-shell">&quot;</span></span>, <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&quot;</span>r/.*/<span class="z-punctuation z-definition z-string z-end z-shell">&quot;</span></span><span class="z-keyword z-control z-regexp z-set z-end z-shell">]</span></span>
</span></code></pre>
<p>他还提醒其他计算节点如果采用的也是lvm也要过滤掉sda，如果是请跟随设置。
安装软件包</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">yum</span></span><span class="z-meta z-function-call z-arguments z-shell"> install<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>y</span> openstack-cinder targetcli python-keystone</span>
</span></code></pre>
<p>备份</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">cp</span></span><span class="z-meta z-function-call z-arguments z-shell"> /etc/cinder/cinder.conf<span class="z-meta z-group z-expansion z-brace z-shell"><span class="z-punctuation z-section z-expansion z-brace z-begin z-shell">{</span><span class="z-punctuation z-separator z-shell">,</span>.bak<span class="z-punctuation z-section z-expansion z-brace z-end z-shell">}</span></span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">egrep</span></span><span class="z-meta z-function-call z-arguments z-shell"><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>v</span> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&quot;</span>^#|^$<span class="z-punctuation z-definition z-string z-end z-shell">&quot;</span></span> /etc/cinder/cinder.conf.bak <span class="z-keyword z-operator z-assignment z-redirection z-shell">&gt;</span> /etc/cinder/cinder.conf</span>
</span></code></pre>
<p>修改配置文件<code>/etc/cinder/cinder.conf</code>，主要是下面内容</p>
<pre data-lang="/etc/cinder/cinder.conf" class="language-/etc/cinder/cinder.conf z-code"><code class="language-/etc/cinder/cinder.conf" data-lang="/etc/cinder/cinder.conf"><span class="z-text z-plain">[DEFAULT]
</span><span class="z-text z-plain">enabled_backends = lvm
</span><span class="z-text z-plain">glance_api_servers = http://controller:9292
</span><span class="z-text z-plain"># 当前ip
</span><span class="z-text z-plain">my_ip = 10.0.0.31
</span><span class="z-text z-plain">transport_url = rabbit://openstack:RABBIT_PASS@controller
</span><span class="z-text z-plain">auth_strategy = keystone
</span><span class="z-text z-plain">[database]
</span><span class="z-text z-plain">connection = mysql+pymysql://cinder:CINDER_DBPASS@controller/cinder
</span><span class="z-text z-plain">[keystone_authtoken]
</span><span class="z-text z-plain">www_authenticate_uri = http://controller:5000
</span><span class="z-text z-plain">auth_url = http://controller:5000
</span><span class="z-text z-plain">memcached_servers = controller:11211
</span><span class="z-text z-plain">auth_type = password
</span><span class="z-text z-plain">project_domain_name = default
</span><span class="z-text z-plain">user_domain_name = default
</span><span class="z-text z-plain">project_name = service
</span><span class="z-text z-plain">username = cinder
</span><span class="z-text z-plain">password = CINDER_PASS
</span><span class="z-text z-plain">[oslo_concurrency]
</span><span class="z-text z-plain">lock_path = /var/lib/cinder/tmp
</span><span class="z-text z-plain">[lvm]
</span><span class="z-text z-plain">volume_driver = cinder.volume.drivers.lvm.LVMVolumeDriver
</span><span class="z-text z-plain">volume_group = cinder-volumes
</span><span class="z-text z-plain">target_protocol = iscsi
</span><span class="z-text z-plain">target_helper = lioadm
</span></code></pre>
<p>启动服务</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">systemctl</span></span><span class="z-meta z-function-call z-arguments z-shell"> enable<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>now</span> openstack-cinder-volume.service target.service</span>
</span></code></pre>
<p>验证参考链接： https://docs.openstack.org/cinder/stein/install/cinder-verify.html
此时打开仪表盘会发现项目中多出了一个卷
<img src="https://image.boychai.xyz/article/Pasted%20image%2020250105212115.png" alt="" /></p>
<h1 id="qi-ta-cun-chu">其他存储</h1>
<p>上面对接的是lvm的，下面开始对接nfs和ceph的</p>
<h2 id="dui-jie-nfs">对接NFS</h2>
<p>具体可以参考：</p>
<ul>
<li>https://docs.openstack.org/cinder/stein/drivers.html#nfsdriver</li>
<li>https://www.cnblogs.com/jiawei2527/p/14028185.html</li>
</ul>
<p>这里在compute1、2上对接NFS，然后NFS是跑在2上的，为什么要在两台主机上配置呢？是因为一个cinder的存储节点可以对接多种存储，这里为了做演示都展示一下。
这里先配置一下NFS，在compute2上，具体操作如下</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">yum</span></span><span class="z-meta z-function-call z-arguments z-shell"><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>y</span> install nfs-utils</span>
</span></code></pre>
<p>编辑<code>/etc/exports</code>配置文件，写入以下内容</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">/data</span></span><span class="z-meta z-function-call z-arguments z-shell"> 10.0.0.0/24(rw,async,no_root_squash,no_all_squash</span><span class="z-meta z-function-call z-shell"></span>)
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">/data2</span></span><span class="z-meta z-function-call z-arguments z-shell"> 10.0.0.0/24(rw,async,no_root_squash,no_all_squash</span><span class="z-meta z-function-call z-shell"></span>)
</span></code></pre>
<p>创建目录以及启动并加载配置</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">[root@compute2</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-meta z-group z-expansion z-tilde"><span class="z-variable z-language z-tilde z-shell">~</span></span>]# mkdir /data</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">[root@compute2</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-meta z-group z-expansion z-tilde"><span class="z-variable z-language z-tilde z-shell">~</span></span>]# mkdir /data2</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">[root@compute2</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-meta z-group z-expansion z-tilde"><span class="z-variable z-language z-tilde z-shell">~</span></span>]# systemctl enable rpcbind</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">[root@compute2</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-meta z-group z-expansion z-tilde"><span class="z-variable z-language z-tilde z-shell">~</span></span>]# systemctl enable nfs</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">Created</span></span><span class="z-meta z-function-call z-arguments z-shell"> symlink from /etc/systemd/system/multi-user.target.wants/nfs-server.service to /usr/lib/systemd/system/nfs-server.service.</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">[root@compute2</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-meta z-group z-expansion z-tilde"><span class="z-variable z-language z-tilde z-shell">~</span></span>]# systemctl start rpcbind</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">[root@compute2</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-meta z-group z-expansion z-tilde"><span class="z-variable z-language z-tilde z-shell">~</span></span>]# systemctl start nfs</span>
</span></code></pre>
<p>在compute1中执行命令<code>showmount -e 10.0.0.32</code>验证nfs</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">[root@compute1</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-meta z-group z-expansion z-tilde"><span class="z-variable z-language z-tilde z-shell">~</span></span>]# showmount<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>e</span> 10.0.0.32</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">Export</span></span><span class="z-meta z-function-call z-arguments z-shell"> list for 10.0.0.32:</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">/data2</span></span><span class="z-meta z-function-call z-arguments z-shell"> 10.0.0.0/24</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">/data</span></span><span class="z-meta z-function-call z-arguments z-shell">  10.0.0.0/24</span>
</span></code></pre>
<p>在compute1的cinder上对接NFS存储，编辑配置文件<code>/etc/cinder/cinder.conf</code>，主要修改内容如下</p>
<pre data-lang="/etc/cinder/cinder.conf" class="language-/etc/cinder/cinder.conf z-code"><code class="language-/etc/cinder/cinder.conf" data-lang="/etc/cinder/cinder.conf"><span class="z-text z-plain">[DEFAULT]
</span><span class="z-text z-plain">...
</span><span class="z-text z-plain">enabled_backends = lvm,nfs
</span><span class="z-text z-plain">...
</span><span class="z-text z-plain">[lvm]
</span><span class="z-text z-plain">...
</span><span class="z-text z-plain">volume_backend_name = lvm
</span><span class="z-text z-plain">...
</span><span class="z-text z-plain">
</span><span class="z-text z-plain">[nfs]
</span><span class="z-text z-plain">volume_driver = cinder.volume.drivers.nfs.NfsDriver
</span><span class="z-text z-plain">nfs_shares_config = /etc/cinder/nfs_shares
</span><span class="z-text z-plain">volume_backend_name = nfs1
</span></code></pre>
<p>编辑<code>/etc/cinder/nfs_shares</code>写入下面内容</p>
<pre data-lang="/etc/cinder/nfs_shares" class="language-/etc/cinder/nfs_shares z-code"><code class="language-/etc/cinder/nfs_shares" data-lang="/etc/cinder/nfs_shares"><span class="z-text z-plain">10.0.0.32:/data
</span></code></pre>
<p>重启服务</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">systemctl</span></span><span class="z-meta z-function-call z-arguments z-shell"> restart openstack-cinder-volume.service</span>
</span></code></pre>
<p>现在再去compute2去创建第二个存储节点，并且对接NFS
参考文档： https://docs.openstack.org/cinder/stein/install/cinder-storage-install-rdo.html
安装软件包</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">yum</span></span><span class="z-meta z-function-call z-arguments z-shell"> install<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>y</span> device-mapper-persistent-data openstack-cinder targetcli python-keystone</span>
</span></code></pre>
<p>备份</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">cp</span></span><span class="z-meta z-function-call z-arguments z-shell"> /etc/cinder/cinder.conf<span class="z-meta z-group z-expansion z-brace z-shell"><span class="z-punctuation z-section z-expansion z-brace z-begin z-shell">{</span><span class="z-punctuation z-separator z-shell">,</span>.bak<span class="z-punctuation z-section z-expansion z-brace z-end z-shell">}</span></span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">egrep</span></span><span class="z-meta z-function-call z-arguments z-shell"><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>v</span> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&quot;</span>^#|^$<span class="z-punctuation z-definition z-string z-end z-shell">&quot;</span></span> /etc/cinder/cinder.conf.bak <span class="z-keyword z-operator z-assignment z-redirection z-shell">&gt;</span> /etc/cinder/cinder.conf</span>
</span></code></pre>
<p>编辑<code>/etc/cinder/cinder.conf</code>，主要内容如下</p>
<pre data-lang="/etc/cinder/cinder.conf" class="language-/etc/cinder/cinder.conf z-code"><code class="language-/etc/cinder/cinder.conf" data-lang="/etc/cinder/cinder.conf"><span class="z-text z-plain">[DEFAULT]
</span><span class="z-text z-plain">glance_api_servers = http://controller:9292
</span><span class="z-text z-plain">enabled_backends  = nfs
</span><span class="z-text z-plain">my_ip = 10.0.0.32
</span><span class="z-text z-plain">auth_strategy = keystone
</span><span class="z-text z-plain">transport_url = rabbit://openstack:RABBIT_PASS@controller
</span><span class="z-text z-plain">[database]
</span><span class="z-text z-plain">connection = mysql+pymysql://cinder:CINDER_DBPASS@controller/cinder
</span><span class="z-text z-plain">[keystone_authtoken]
</span><span class="z-text z-plain">www_authenticate_uri = http://controller:5000
</span><span class="z-text z-plain">auth_url = http://controller:5000
</span><span class="z-text z-plain">memcached_servers = controller:11211
</span><span class="z-text z-plain">auth_type = password
</span><span class="z-text z-plain">project_domain_name = default
</span><span class="z-text z-plain">user_domain_name = default
</span><span class="z-text z-plain">project_name = service
</span><span class="z-text z-plain">username = cinder
</span><span class="z-text z-plain">password = CINDER_PASS
</span><span class="z-text z-plain">[oslo_concurrency]
</span><span class="z-text z-plain">lock_path = /var/lib/cinder/tmp
</span><span class="z-text z-plain">[nfs]
</span><span class="z-text z-plain">volume_driver = cinder.volume.drivers.nfs.NfsDriver
</span><span class="z-text z-plain">nfs_shares_config = /etc/cinder/nfs_shares
</span><span class="z-text z-plain">volume_backend_name = nfs2
</span></code></pre>
<p>编辑NFS连接文件<code>/etc/cinder/nfs_shares</code>,主要内容如下</p>
<pre data-lang="/etc/cinder/nfs_shares" class="language-/etc/cinder/nfs_shares z-code"><code class="language-/etc/cinder/nfs_shares" data-lang="/etc/cinder/nfs_shares"><span class="z-text z-plain">10.0.0.32:/data2
</span></code></pre>
<p>启动服务</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">systemctl</span></span><span class="z-meta z-function-call z-arguments z-shell"> enable<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>now</span> openstack-cinder-volume.service target.service</span>
</span></code></pre>
<p>这里算是配置了三个存储，一个是compute1上的lvm，nfs1，然后compute2上的一个nfs2，它们三个在openstack也可以做到区分，也建议做区分的使用，打开仪表盘的<code>管理员-》卷-》卷类型</code>中创建三个卷类型
<img src="https://image.boychai.xyz/article/Pasted%20image%2020250105223017.png" alt="" />
挨个更新它们的元数据
<img src="https://image.boychai.xyz/article/Pasted%20image%2020250105223116.png" alt="" />
下面是nfs2的
<img src="https://image.boychai.xyz/article/Pasted%20image%2020250105223141.png" alt="" />
其他三个同理，这里就是给对接的卷做分类，通过配置的<code>volume_backend_name</code>选项做分类，三个都做好之后去<code>计算-》卷-》卷</code>中创建卷，此时就可以选择卷类型
<img src="https://image.boychai.xyz/article/Pasted%20image%2020250105223348.png" alt="" />
我这里挨个创建5G大小的卷，然后去对应提供存储的主机中查看卷情况
<img src="https://image.boychai.xyz/article/Pasted%20image%2020250105223903.png" alt="" />
全部可用，去主机中查看
compute1主机的lvm
<img src="https://image.boychai.xyz/article/Pasted%20image%2020250105223606.png" alt="" />
compute2主机的nfs1和nfs2
<img src="https://image.boychai.xyz/article/Pasted%20image%2020250105223638.png" alt="" /></p>
<h2 id="dui-jie-ceph">对接Ceph</h2>
<p>我的Ceph机器的ip对应表如下,网络是互通的</p>
<pre data-lang="text" class="language-text z-code"><code class="language-text" data-lang="text"><span class="z-text z-plain"># 网络配置
</span><span class="z-text z-plain">主机名          NAT网络         
</span><span class="z-text z-plain">node1       10.0.0.150/24
</span><span class="z-text z-plain">node2       10.0.0.151/24
</span><span class="z-text z-plain">node3       10.0.0.152/24
</span></code></pre>
<p>我ceph的版本是reef，比较新，我这里因为环境问题，操作风险较大，对接的时候建议是采用对应版本的软件，我这里是使用ceph的<code>nautilus</code>版本的客户端去对接<code>reef</code>的Ceph集群，在每一台compute主机上安装ceph工具，S版本集群默认自带的最高就是<code>nautilus</code>版本</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">yum</span></span><span class="z-meta z-function-call z-arguments z-shell"><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>y</span> install ceph-common</span>
</span></code></pre>
<p>之后在ceph的管理节点上创建一个位置用来存放cinder的数据,具体含义可以参考Ceph的文档</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">ceph</span></span><span class="z-meta z-function-call z-arguments z-shell"> osd pool create volumes 128</span>
</span></code></pre>
<p>之后再创建一个访问凭证</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">ceph</span></span><span class="z-meta z-function-call z-arguments z-shell"> auth get-or-create client.cinder mon <span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>allow r<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span> osd <span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>allow class-read object_prefix rbd_children, allow rwx pool=volumes,allow rwx pool=vms, allow rx pool=images<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span></span>
</span></code></pre>
<p>执行返回结果如下</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">[client.cinder]</span></span>
</span><span class="z-source z-shell z-bash">        <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">key</span></span><span class="z-meta z-function-call z-arguments z-shell"> = AQBAE4Jnr2FADxAA+5RG4nU8mOzkL3eHVzcdug==</span>
</span></code></pre>
<p>需要把这个内容复制到所有openstack节点的<code>/etc/ceph/ceph.client.cinder.keyring</code>位置，命令如下</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">cat</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-keyword z-operator z-assignment z-redirection z-shell">&gt;&gt;</span> /etc/ceph/ceph.client.cinder.keyring <span class="z-string z-unquoted z-heredoc z-shell"><span class="z-keyword z-operator z-assignment z-redirection z-shell">&lt;&lt;</span><span class="z-keyword z-control z-heredoc-token z-shell">EOF</span></span><span class="z-string z-unquoted z-heredoc z-shell">
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell"><span class="z-string z-unquoted z-heredoc z-shell">[client.cinder]
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell"><span class="z-string z-unquoted z-heredoc z-shell">        key = AQBAE4Jnr2FADxAA+5RG4nU8mOzkL3eHVzcdug==
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell"><span class="z-string z-unquoted z-heredoc z-shell"><span class="z-keyword z-control z-heredoc-token z-shell">EOF</span></span></span>
</span><span class="z-source z-shell z-bash"><span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell"> 给权限,两种命令都可以,第一条是需要在cinder组件装好才能用</span><span class="z-comment z-line z-number-sign z-shell">
</span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">chown</span></span><span class="z-meta z-function-call z-arguments z-shell"> cinder:cinder /etc/ceph/ceph.client.cinder.keyring</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">chmod</span></span><span class="z-meta z-function-call z-arguments z-shell"> +r /etc/ceph/ceph.client.cinder.keyring</span>
</span></code></pre>
<p>在所有的compute主机中中配置secret，执行下面命令</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell"> 生成一个uuid</span><span class="z-comment z-line z-number-sign z-shell">
</span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">uuidgen</span></span>
</span><span class="z-source z-shell z-bash"><span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell"> 我这里返回的是 ed4a34e1-590e-4cce-b35a-286a48d7b040 ,注意所有主机都必须是这个uuid</span><span class="z-comment z-line z-number-sign z-shell">
</span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">cat</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-keyword z-operator z-assignment z-redirection z-shell">&gt;</span> secret.xml <span class="z-string z-unquoted z-heredoc z-shell"><span class="z-keyword z-operator z-assignment z-redirection z-shell">&lt;&lt;</span><span class="z-keyword z-control z-heredoc-token z-shell">EOF</span></span><span class="z-string z-unquoted z-heredoc z-shell">
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell"><span class="z-string z-unquoted z-heredoc z-shell">&lt;secret ephemeral=&#39;no&#39; private=&#39;no&#39;&gt;
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell"><span class="z-string z-unquoted z-heredoc z-shell">  &lt;uuid&gt;ed4a34e1-590e-4cce-b35a-286a48d7b040&lt;/uuid&gt;
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell"><span class="z-string z-unquoted z-heredoc z-shell">  &lt;usage type=&#39;ceph&#39;&gt;
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell"><span class="z-string z-unquoted z-heredoc z-shell">    &lt;name&gt;client.cinder secret&lt;/name&gt;
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell"><span class="z-string z-unquoted z-heredoc z-shell">  &lt;/usage&gt;
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell"><span class="z-string z-unquoted z-heredoc z-shell">&lt;/secret&gt;
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell"><span class="z-string z-unquoted z-heredoc z-shell"><span class="z-keyword z-control z-heredoc-token z-shell">EOF</span></span></span>
</span></code></pre>
<p>然后定义密钥文件和设置ceph的凭证，</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">virsh</span></span><span class="z-meta z-function-call z-arguments z-shell"> secret-define<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>file</span> secret.xml</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">cat</span></span><span class="z-meta z-function-call z-arguments z-shell"> /etc/ceph/ceph.client.cinder.keyring</span><span class="z-keyword z-operator z-logical z-pipe z-shell">|</span><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">grep</span></span><span class="z-meta z-function-call z-arguments z-shell"> key</span><span class="z-keyword z-operator z-logical z-pipe z-shell">|</span><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">awk</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>{print $3}<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span> <span class="z-keyword z-operator z-assignment z-redirection z-shell">&gt;</span> ./client.cinder.key</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">virsh</span></span><span class="z-meta z-function-call z-arguments z-shell"> secret-set-value<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>secret</span> ed4a34e1-590e-4cce-b35a-286a48d7b040<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>base64</span> <span class="z-meta z-group z-expansion z-command z-parens z-shell"><span class="z-punctuation z-definition z-variable z-shell">$</span><span class="z-punctuation z-section z-parens z-begin z-shell">(</span><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">cat</span></span><span class="z-meta z-function-call z-arguments z-shell"> ./client.cinder.key</span><span class="z-punctuation z-section z-parens z-end z-shell">)</span></span></span>
</span></code></pre>
<p>之后在compute3把Ceph的<code>/etc/ceph/ceph.conf</code>文件拿过来，我这里的的内容如下</p>
<pre data-lang="/etc/ceph/ceph.conf" class="language-/etc/ceph/ceph.conf z-code"><code class="language-/etc/ceph/ceph.conf" data-lang="/etc/ceph/ceph.conf"><span class="z-text z-plain">[global]
</span><span class="z-text z-plain">        fsid = 81ecd502-cf4e-11ef-baaf-000c297bc826
</span><span class="z-text z-plain">        mon_host = [v2:10.0.0.150:3300/0,v1:10.0.0.150:6789/0] [v2:10.0.0.151:3300/0,v1:10.0.0.151:6789/0] [v2:10.0.0.152:3300/0,v1:10.0.0.152:6789/0]
</span></code></pre>
<p>它记录着一些连接地址什么的，需要把这个文件放到对接ceph的cinder的<code>/etc/ceph/ceph.conf</code>中，命令如下</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">cat</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-keyword z-operator z-assignment z-redirection z-shell">&gt;</span> /etc/ceph/ceph.conf <span class="z-string z-unquoted z-heredoc z-shell"><span class="z-keyword z-operator z-assignment z-redirection z-shell">&lt;&lt;</span><span class="z-keyword z-control z-heredoc-token z-shell">EOF</span></span><span class="z-string z-unquoted z-heredoc z-shell">
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell"><span class="z-string z-unquoted z-heredoc z-shell">[global]
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell"><span class="z-string z-unquoted z-heredoc z-shell">        fsid = 81ecd502-cf4e-11ef-baaf-000c297bc826
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell"><span class="z-string z-unquoted z-heredoc z-shell">        mon_host = [v2:10.0.0.150:3300/0,v1:10.0.0.150:6789/0] [v2:10.0.0.151:3300/0,v1:10.0.0.151:6789/0] [v2:10.0.0.152:3300/0,v1:10.0.0.152:6789/0]
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell"><span class="z-string z-unquoted z-heredoc z-shell"><span class="z-keyword z-control z-heredoc-token z-shell">EOF</span></span></span>
</span></code></pre>
<p>在compute3中安装cinder</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">yum</span></span><span class="z-meta z-function-call z-arguments z-shell"> install<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>y</span> openstack-cinder targetcli python-keystone</span>
</span></code></pre>
<p>备份</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">cp</span></span><span class="z-meta z-function-call z-arguments z-shell"> /etc/cinder/cinder.conf<span class="z-meta z-group z-expansion z-brace z-shell"><span class="z-punctuation z-section z-expansion z-brace z-begin z-shell">{</span><span class="z-punctuation z-separator z-shell">,</span>.bak<span class="z-punctuation z-section z-expansion z-brace z-end z-shell">}</span></span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">egrep</span></span><span class="z-meta z-function-call z-arguments z-shell"><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>v</span> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&quot;</span>^#|^$<span class="z-punctuation z-definition z-string z-end z-shell">&quot;</span></span> /etc/cinder/cinder.conf.bak <span class="z-keyword z-operator z-assignment z-redirection z-shell">&gt;</span> /etc/cinder/cinder.conf</span>
</span></code></pre>
<p>修改配置文件<code>/etc/cinder/cinder.conf</code>，主要是下面内容</p>
<pre data-lang="/etc/cinder/cinder.conf" class="language-/etc/cinder/cinder.conf z-code"><code class="language-/etc/cinder/cinder.conf" data-lang="/etc/cinder/cinder.conf"><span class="z-text z-plain">[DEFAULT]
</span><span class="z-text z-plain">glance_api_servers = http://controller:9292
</span><span class="z-text z-plain">my_ip = 10.0.0.33 
</span><span class="z-text z-plain">transport_url = rabbit://openstack:RABBIT_PASS@controller
</span><span class="z-text z-plain">auth_strategy = keystone
</span><span class="z-text z-plain">enabled_backends = ceph
</span><span class="z-text z-plain">[database]
</span><span class="z-text z-plain">connection = mysql+pymysql://cinder:CINDER_DBPASS@controller/cinder
</span><span class="z-text z-plain">[keystone_authtoken]
</span><span class="z-text z-plain">www_authenticate_uri = http://controller:5000
</span><span class="z-text z-plain">auth_url = http://controller:5000
</span><span class="z-text z-plain">memcached_servers = controller:11211
</span><span class="z-text z-plain">auth_type = password
</span><span class="z-text z-plain">project_domain_name = default
</span><span class="z-text z-plain">user_domain_name = default
</span><span class="z-text z-plain">project_name = service
</span><span class="z-text z-plain">username = cinder
</span><span class="z-text z-plain">password = CINDER_PASS
</span><span class="z-text z-plain">[oslo_concurrency]
</span><span class="z-text z-plain">lock_path = /var/lib/cinder/tmp
</span><span class="z-text z-plain">[ceph]
</span><span class="z-text z-plain">volume_driver = cinder.volume.drivers.rbd.RBDDriver
</span><span class="z-text z-plain">rbd_pool = volumes
</span><span class="z-text z-plain">rados_connect_timeout = -1
</span><span class="z-text z-plain">rbd_user = cinder
</span><span class="z-text z-plain">rbd_secret_uuid = ed4a34e1-590e-4cce-b35a-286a48d7b040
</span><span class="z-text z-plain">volume_backend_name = ceph
</span><span class="z-text z-plain">rbd_ceph_conf = /etc/ceph/ceph.conf
</span></code></pre>
<p>和普通官网不一样的就是我这里没配lvm直接配的ceph,要注意的是<code>my_ip</code>、<code>rbd_secret_uuid</code>、<code>volume_backend_name</code>参数，需要根据自己情况去写。启动服务相关命令如下</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">systemctl</span></span><span class="z-meta z-function-call z-arguments z-shell"> enable openstack-cinder-volume.service target.service</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">systemctl</span></span><span class="z-meta z-function-call z-arguments z-shell"> start openstack-cinder-volume.service target.service</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">systemctl</span></span><span class="z-meta z-function-call z-arguments z-shell"> restart openstack-cinder-volume.service</span>
</span></code></pre>
<p>这里在仪表中创建一个卷类型，使用<code>volume_backend_name = ceph</code>来设置元数据
<img src="https://image.boychai.xyz/article/Pasted%20image%2020250111152532.png" alt="" />
<img src="https://image.boychai.xyz/article/Pasted%20image%2020250111152605.png" alt="" />
尝试创建卷试试
<img src="https://image.boychai.xyz/article/Pasted%20image%2020250111152717.png" alt="" />
<img src="https://image.boychai.xyz/article/Pasted%20image%2020250111153536.png" alt="" />
成功创建，去ceph中查看
<img src="https://image.boychai.xyz/article/Pasted%20image%2020250111154039.png" alt="" />
在cinder的控制主机中查看
<img src="https://image.boychai.xyz/article/Pasted%20image%2020250111162947.png" alt="" /></p>

        </section>
        
        

        
            
            
            

            
        
            
            
            

            
        
            
            
            

            
        
            
            
            

            
        
        </article>
</main>


<span id="copy-success" class="hidden">
        Copied!
    </span>
    <span id="copy-init" class="hidden">
        Copy code to clipboard
    </span>
    <script defer src="https://synex.space/js/copyCodeToClipboard.min.js"></script>


    </div>
    <footer>
    <section>
        <nav class="socials nav-navs">
        </nav>

        
        <nav class="nav-navs">
        </nav>

        <div class="credits">
            <small>
                

                
                Powered by
                <a rel="" 

 href="https://www.getzola.org">Zola</a>
                &amp;
                <a rel="" 

 href="https://github.com/welpo/tabi">tabi</a>

                </small>
        </div>
    </section>

    <div id="searchModal" class="search-modal js" role="dialog" aria-labelledby="modalTitle">
    <h1 id="modalTitle" class="visually-hidden">Search</h1>
    <div id="modal-content">
        <div id="searchBar">
            <div class="search-icon" aria-hidden="true">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960">
                    <path d="M784-120 532-372q-30 24-69 38t-83 14q-109 0-184.5-75.5T120-580q0-109 75.5-184.5T380-840q109 0 184.5 75.5T640-580q0 44-14 83t-38 69l252 252-56 56ZM380-400q75 0 127.5-52.5T560-580q0-75-52.5-127.5T380-760q-75 0-127.5 52.5T200-580q0 75 52.5 127.5T380-400Z"/>
                </svg>
            </div>
            <input id="searchInput" role="combobox" autocomplete="off" spellcheck="false" aria-expanded="false" aria-controls="results-container" placeholder="Search…"/>
            <div id="clear-search" class="close-icon interactive-icon" tabindex="0" role="button" title="Clear search">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960">
                <path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/>
                </svg>
            </div>
        </div>
        <div id="results-container">
            <div id="results-info"><span id="zero_results"> No results</span>
                <span id="one_results"> $NUMBER result</span>
                <span id="many_results"> $NUMBER results</span><span id="two_results"> $NUMBER results</span>
                <span id="few_results"> $NUMBER results</span>
            </div>
            <div id="results" role="listbox"></div>
        </div>
    </div>
</div>
</footer>


    
    
</body>

</html>
