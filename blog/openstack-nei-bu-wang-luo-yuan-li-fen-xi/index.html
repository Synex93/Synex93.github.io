<!DOCTYPE html>
<html lang="en" >

<head>
    <meta charset="UTF-8"><meta http-equiv="Content-Security-Policy"
content="default-src 'self';font-src 'self' data:;img-src 'self' https://* data:;media-src 'self';style-src 'self';frame-src player.vimeo.com https://www.youtube-nocookie.com;connect-src 'self';script-src 'self' 'self'">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="base" content="https://synex.space/">

    
    <title>
~/S9n3x • OpenStack-内部网络原理分析</title>

    
    
    

    
    

    
    
    
        
            <link rel="stylesheet" href="https://synex.space/custom_subset.css?h=0b9535a28bc3d5bf2321">
        
    

    
        <link rel="stylesheet" href="https://synex.space/main.css?h=3716ab3457d2dd050b3c" />
        <link rel="stylesheet" href="https://synex.space/skins/mint.css?h=504215cf6bc10586b487" />

    <meta name="color-scheme" content="light dark" />
        <meta name="description" content="" />
        <meta property="og:description" content="" />

    

    <meta property="og:title" content="OpenStack-内部网络原理分析" />
    <meta property="og:type" content="article" />

    
<meta property="og:locale" content="en_GB" />

    <meta property="og:url" content="https:&#x2F;&#x2F;synex.space&#x2F;blog&#x2F;openstack-nei-bu-wang-luo-yuan-li-fen-xi&#x2F;" /><meta property="og:site_name" content="~&#x2F;S9n3x">
        <noscript><link rel="stylesheet" href="https://synex.space/no_js.css"/></noscript>
        <script type="text/javascript" src="https://synex.space/js/initializeTheme.min.js"></script>
        <script defer src="https://synex.space/js/themeSwitcher.min.js"></script>
        <script defer src="https://synex.space/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e"></script>

        
    
</head>


<body>
    <a href="#main-content" id="skip-link">Skip to content</a>
    <header>
    <nav class="navbar">
        <div class="nav-title">
            <a class="home-title" href="https://synex.space/">~&#x2F;S9n3x</a>
        </div>
            <div class="nav-navs">
                <ul>
                        
                            <li>
                                <a class="nav-links no-hover-padding" href="https://synex.space/blog/">blog
                                </a>
                            </li>
                        
                            <li>
                                <a class="nav-links no-hover-padding" href="https://synex.space/archive/">archive
                                </a>
                            </li>
                        
                            <li>
                                <a class="nav-links no-hover-padding" href="https://synex.space/tags/">tags
                                </a>
                            </li>
                        
                            <li>
                                <a class="nav-links no-hover-padding" href="https://synex.space/friends/">friends
                                </a>
                            </li>
                        <li class="menu-icons-container">
                        <ul class="menu-icons-group">
                            <li class="js menu-icon">
                                <div role="button" tabindex="0" id="search-button" class="search-icon interactive-icon" title="Click or press $SHORTCUT to open search" aria-label="Click or press $SHORTCUT to open search">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960">
                                        <path d="M784-120 532-372q-30 24-69 38t-83 14q-109 0-184.5-75.5T120-580q0-109 75.5-184.5T380-840q109 0 184.5 75.5T640-580q0 44-14 83t-38 69l252 252-56 56ZM380-400q75 0 127.5-52.5T560-580q0-75-52.5-127.5T380-760q-75 0-127.5 52.5T200-580q0 75 52.5 127.5T380-400Z"/>
                                    </svg>
                                </div>
                            </li>

                            
                            

                            <li class="theme-switcher-wrapper js"><div
        title="Toggle dark&#x2F;light mode"
        class="theme-switcher"
        tabindex="0"
        role="button"
        aria-label="Toggle dark mode"
        aria-pressed="false">
    </div><div
        title="Reset mode to default"
        class="theme-resetter arrow"
        tabindex="0"
        role="button"
        aria-hidden="true"
        aria-label="Reset mode to default">
    </div>

</li>
</ul>
                    </li>
                </ul>
            </div>
        
    </nav>
</header>

    <div class="content" id="main-content">

        
        





<main>
    <article class="h-entry">
        <h1 class="p-name article-title">
            OpenStack-内部网络原理分析
        </h1>
        <a class="u-url u-uid" href="https://synex.space/blog/openstack-nei-bu-wang-luo-yuan-li-fen-xi/"></a>

        <ul class="meta"><span class="hidden p-author h-card">
<a rel="author" href="https:&#x2F;&#x2F;synex.space&#x2F;" class="u-url " title=""></a>
</span>
<li><time class="dt-published" datetime="2025-02-15T15:05:00">15th Feb 2025</time></li><li title="4173 words"><span class='separator' aria-hidden='true'>•</span>21 min read</li><li class="tag"><span class='separator' aria-hidden='true'>•</span>Tags:&nbsp;</li><li class="tag"><a class="p-category" href="https://synex.space/tags/kai-yuan-gong-ju/">开源工具</a>,&nbsp;</li><li class="tag"><a class="p-category" href="https://synex.space/tags/openstack/">OpenStack</a>,&nbsp;</li><li class="tag"><a class="p-category" href="https://synex.space/tags/provider/">Provider</a>,&nbsp;</li><li class="tag"><a class="p-category" href="https://synex.space/tags/vxlan/">VXLAN</a></li>
        </ul><section class="e-content body"><h1 id="qian-yan">前言</h1>
<p>基于组件理解文章，这里单独做一个对于openstack网络组件<code>Neutron</code>的理解，本文只是我自己对于它的理解，因为网上的资料比较有限，本文只能代表我个人理解，有不对的地方欢迎大佬指正。我的环境是<code>Linux Bridge</code> + <code>VXLAN</code>的形式，具体的配置体现可以参考搭建文章的下面内容</p>
<blockquote>
<p>官方文档-1： https://docs.openstack.org/neutron/stein/install/controller-install-rdo.html
官方文档-2： https://docs.openstack.org/neutron/stein/install/controller-install-option1-rdo.html
官方文档-3： https://docs.openstack.org/neutron/stein/install/controller-install-option2-rdo.html
linux bridge： https://blog.boychai.xyz/index.php/archives/83/ (网站已被迁移，请在本站搜索 OpenStack-Stein版搭建-1控制1计算)
VXLAN： https://blog.boychai.xyz/index.php/archives/88/ (网站已被迁移，请在本站搜索 OpenStack-网络-FLAT与VXLAN)</p>
</blockquote>
<h1 id="gong-ying-shang-providerwang-luo">供应商-Provider网络</h1>
<p>在没有创建<code>Self-service networks</code>网络的的时候，创建一个主机参考下面openstack网络拓扑
<img src="https://image.boychai.xyz/img/Pasted%20image%2020250215141929.png" alt="" />
网络相关的信息如下
<img src="https://image.boychai.xyz/img/Pasted%20image%2020250215143526.png" alt="" />
<img src="https://image.boychai.xyz/img/Pasted%20image%2020250215143547.png" alt="" />
<img src="https://image.boychai.xyz/img/Pasted%20image%2020250215143955.png" alt="" />
主机未开机的时候，在网络控制节点的网络情况是这样的</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">[root@controller</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-meta z-group z-expansion z-tilde"><span class="z-variable z-language z-tilde z-shell">~</span></span>]# ip link</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">......</span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">2:</span></span><span class="z-meta z-function-call z-arguments z-shell"> ens33: <span class="z-keyword z-operator z-assignment z-redirection z-shell">&lt;</span>BROADCAST,MULTICAST,UP,LOWER_UP<span class="z-keyword z-operator z-assignment z-redirection z-shell">&gt;</span> mtu 1500 qdisc pfifo_fast master brqdd604587-35 state UP mode DEFAULT group default qlen 1000</span>
</span><span class="z-source z-shell z-bash">    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">link/ether</span></span><span class="z-meta z-function-call z-arguments z-shell"> 00:0c:29:08:b5:9e brd ff:ff:ff:ff:ff:ff</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">8:</span></span><span class="z-meta z-function-call z-arguments z-shell"> tapa98eeb82-7a@if2: <span class="z-keyword z-operator z-assignment z-redirection z-shell">&lt;</span>BROADCAST,MULTICAST,UP,LOWER_UP<span class="z-keyword z-operator z-assignment z-redirection z-shell">&gt;</span> mtu 1500 qdisc noqueue master brqdd604587-35 state UP mode DEFAULT group default qlen 1000</span>
</span><span class="z-source z-shell z-bash">    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">link/ether</span></span><span class="z-meta z-function-call z-arguments z-shell"> 0a:04:25:5a:e2:67 brd ff:ff:ff:ff:ff:ff link-netnsid 2</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">9:</span></span><span class="z-meta z-function-call z-arguments z-shell"> brqdd604587-35: <span class="z-keyword z-operator z-assignment z-redirection z-shell">&lt;</span>BROADCAST,MULTICAST,UP,LOWER_UP<span class="z-keyword z-operator z-assignment z-redirection z-shell">&gt;</span> mtu 1500 qdisc noqueue state UP mode DEFAULT group default qlen 1000</span>
</span><span class="z-source z-shell z-bash">    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">link/ether</span></span><span class="z-meta z-function-call z-arguments z-shell"> 00:0c:29:08:b5:9e brd ff:ff:ff:ff:ff:ff</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">[root@controller</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-meta z-group z-expansion z-tilde"><span class="z-variable z-language z-tilde z-shell">~</span></span>]# brctl show</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">bridge</span></span><span class="z-meta z-function-call z-arguments z-shell"> name     bridge id               STP enabled     interfaces</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">brqdd604587-35</span></span><span class="z-meta z-function-call z-arguments z-shell">          8000.000c2908b59e       no              ens33</span>
</span><span class="z-source z-shell z-bash">                                                        <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">tapa98eeb82-7a</span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">[root@controller</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-meta z-group z-expansion z-tilde"><span class="z-variable z-language z-tilde z-shell">~</span></span>]# ip a</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">......</span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">2:</span></span><span class="z-meta z-function-call z-arguments z-shell"> ens33: <span class="z-keyword z-operator z-assignment z-redirection z-shell">&lt;</span>BROADCAST,MULTICAST,UP,LOWER_UP<span class="z-keyword z-operator z-assignment z-redirection z-shell">&gt;</span> mtu 1500 qdisc pfifo_fast master brqdd604587-35 state UP group default qlen 1000</span>
</span><span class="z-source z-shell z-bash">    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">link/ether</span></span><span class="z-meta z-function-call z-arguments z-shell"> 00:0c:29:08:b5:9e brd ff:ff:ff:ff:ff:ff</span>
</span><span class="z-source z-shell z-bash">    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">inet6</span></span><span class="z-meta z-function-call z-arguments z-shell"> fe80::ad6b:bdb0:9b14:c54d/64 scope link noprefixroute</span>
</span><span class="z-source z-shell z-bash">       <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">valid_lft</span></span><span class="z-meta z-function-call z-arguments z-shell"> forever preferred_lft forever</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">8:</span></span><span class="z-meta z-function-call z-arguments z-shell"> tapa98eeb82-7a@if2: <span class="z-keyword z-operator z-assignment z-redirection z-shell">&lt;</span>BROADCAST,MULTICAST,UP,LOWER_UP<span class="z-keyword z-operator z-assignment z-redirection z-shell">&gt;</span> mtu 1500 qdisc noqueue master brqdd604587-35 state UP group default qlen 1000</span>
</span><span class="z-source z-shell z-bash">    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">link/ether</span></span><span class="z-meta z-function-call z-arguments z-shell"> 0a:04:25:5a:e2:67 brd ff:ff:ff:ff:ff:ff link-netnsid 2</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">9:</span></span><span class="z-meta z-function-call z-arguments z-shell"> brqdd604587-35: <span class="z-keyword z-operator z-assignment z-redirection z-shell">&lt;</span>BROADCAST,MULTICAST,UP,LOWER_UP<span class="z-keyword z-operator z-assignment z-redirection z-shell">&gt;</span> mtu 1500 qdisc noqueue state UP group default qlen 1000</span>
</span><span class="z-source z-shell z-bash">    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">link/ether</span></span><span class="z-meta z-function-call z-arguments z-shell"> 00:0c:29:08:b5:9e brd ff:ff:ff:ff:ff:ff</span>
</span><span class="z-source z-shell z-bash">    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">inet</span></span><span class="z-meta z-function-call z-arguments z-shell"> 10.0.0.11/24 brd 10.0.0.255 scope global brqdd604587-35</span>
</span><span class="z-source z-shell z-bash">       <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">valid_lft</span></span><span class="z-meta z-function-call z-arguments z-shell"> forever preferred_lft forever</span>
</span><span class="z-source z-shell z-bash">    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">inet6</span></span><span class="z-meta z-function-call z-arguments z-shell"> fe80::d061:3cff:fedd:3f85/64 scope link</span>
</span><span class="z-source z-shell z-bash">       <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">valid_lft</span></span><span class="z-meta z-function-call z-arguments z-shell"> forever preferred_lft forever</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">[root@controller</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-meta z-group z-expansion z-tilde"><span class="z-variable z-language z-tilde z-shell">~</span></span>]# ip netns</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">qdhcp-dd604587-3542-409b-9ca8-eed06840fb55</span></span><span class="z-meta z-function-call z-arguments z-shell"> (id: 2</span><span class="z-meta z-function-call z-shell"></span>)
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">[root@controller</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-meta z-group z-expansion z-tilde"><span class="z-variable z-language z-tilde z-shell">~</span></span>]# ip netns exec qdhcp-dd604587-3542-409b-9ca8-eed06840fb55 ip a</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">...</span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">2:</span></span><span class="z-meta z-function-call z-arguments z-shell"> ns-a98eeb82-7a@if8: <span class="z-keyword z-operator z-assignment z-redirection z-shell">&lt;</span>BROADCAST,MULTICAST,UP,LOWER_UP<span class="z-keyword z-operator z-assignment z-redirection z-shell">&gt;</span> mtu 1500 qdisc noqueue state UP group default qlen 1000</span>
</span><span class="z-source z-shell z-bash">    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">link/ether</span></span><span class="z-meta z-function-call z-arguments z-shell"> fa:16:3e:53:6f:70 brd ff:ff:ff:ff:ff:ff link-netnsid 0</span>
</span><span class="z-source z-shell z-bash">    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">inet</span></span><span class="z-meta z-function-call z-arguments z-shell"> 10.0.0.200/24 brd 10.0.0.255 scope global ns-a98eeb82-7a</span>
</span><span class="z-source z-shell z-bash">       <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">valid_lft</span></span><span class="z-meta z-function-call z-arguments z-shell"> forever preferred_lft forever</span>
</span><span class="z-source z-shell z-bash">    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">inet</span></span><span class="z-meta z-function-call z-arguments z-shell"> 169.254.169.254/16 brd 169.254.255.255 scope global ns-a98eeb82-7a</span>
</span><span class="z-source z-shell z-bash">       <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">valid_lft</span></span><span class="z-meta z-function-call z-arguments z-shell"> forever preferred_lft forever</span>
</span><span class="z-source z-shell z-bash">    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">inet6</span></span><span class="z-meta z-function-call z-arguments z-shell"> fe80::f816:3eff:fe53:6f70/64 scope link</span>
</span><span class="z-source z-shell z-bash">       <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">valid_lft</span></span><span class="z-meta z-function-call z-arguments z-shell"> forever preferred_lft forever</span>
</span></code></pre>
<p>在对应实例的计算节点网络是这样的</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">[root@compute1</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-meta z-group z-expansion z-tilde"><span class="z-variable z-language z-tilde z-shell">~</span></span>]# ip link</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">......</span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">2:</span></span><span class="z-meta z-function-call z-arguments z-shell"> ens33: <span class="z-keyword z-operator z-assignment z-redirection z-shell">&lt;</span>BROADCAST,MULTICAST,UP,LOWER_UP<span class="z-keyword z-operator z-assignment z-redirection z-shell">&gt;</span> mtu 1500 qdisc pfifo_fast master brqdd604587-35 state UP mode DEFAULT group default qlen 1000</span>
</span><span class="z-source z-shell z-bash">    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">link/ether</span></span><span class="z-meta z-function-call z-arguments z-shell"> 00:0c:29:a8:d7:e0 brd ff:ff:ff:ff:ff:ff</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">6:</span></span><span class="z-meta z-function-call z-arguments z-shell"> brqdd604587-35: <span class="z-keyword z-operator z-assignment z-redirection z-shell">&lt;</span>BROADCAST,MULTICAST,UP,LOWER_UP<span class="z-keyword z-operator z-assignment z-redirection z-shell">&gt;</span> mtu 1500 qdisc noqueue state UP mode DEFAULT group default qlen 1000</span>
</span><span class="z-source z-shell z-bash">    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">link/ether</span></span><span class="z-meta z-function-call z-arguments z-shell"> 00:0c:29:a8:d7:e0 brd ff:ff:ff:ff:ff:ff</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">[root@compute1</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-meta z-group z-expansion z-tilde"><span class="z-variable z-language z-tilde z-shell">~</span></span>]# brctl show</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">bridge</span></span><span class="z-meta z-function-call z-arguments z-shell"> name     bridge id               STP enabled     interfaces</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">brqdd604587-35</span></span><span class="z-meta z-function-call z-arguments z-shell">          8000.000c29a8d7e0       no              ens33</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">[root@compute1</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-meta z-group z-expansion z-tilde"><span class="z-variable z-language z-tilde z-shell">~</span></span>]# ip a</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">......</span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">2:</span></span><span class="z-meta z-function-call z-arguments z-shell"> ens33: <span class="z-keyword z-operator z-assignment z-redirection z-shell">&lt;</span>BROADCAST,MULTICAST,UP,LOWER_UP<span class="z-keyword z-operator z-assignment z-redirection z-shell">&gt;</span> mtu 1500 qdisc pfifo_fast master brqdd604587-35 state UP group default qlen 1000</span>
</span><span class="z-source z-shell z-bash">    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">link/ether</span></span><span class="z-meta z-function-call z-arguments z-shell"> 00:0c:29:a8:d7:e0 brd ff:ff:ff:ff:ff:ff</span>
</span><span class="z-source z-shell z-bash">    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">inet6</span></span><span class="z-meta z-function-call z-arguments z-shell"> fe80::ad6b:bdb0:9b14:c54d/64 scope link tentative noprefixroute dadfailed</span>
</span><span class="z-source z-shell z-bash">       <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">valid_lft</span></span><span class="z-meta z-function-call z-arguments z-shell"> forever preferred_lft forever</span>
</span><span class="z-source z-shell z-bash">    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">inet6</span></span><span class="z-meta z-function-call z-arguments z-shell"> fe80::5597:3a9:a4bd:ae3a/64 scope link noprefixroute</span>
</span><span class="z-source z-shell z-bash">       <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">valid_lft</span></span><span class="z-meta z-function-call z-arguments z-shell"> forever preferred_lft forever</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">6:</span></span><span class="z-meta z-function-call z-arguments z-shell"> brqdd604587-35: <span class="z-keyword z-operator z-assignment z-redirection z-shell">&lt;</span>BROADCAST,MULTICAST,UP,LOWER_UP<span class="z-keyword z-operator z-assignment z-redirection z-shell">&gt;</span> mtu 1500 qdisc noqueue state UP group default qlen 1000</span>
</span><span class="z-source z-shell z-bash">    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">link/ether</span></span><span class="z-meta z-function-call z-arguments z-shell"> 00:0c:29:a8:d7:e0 brd ff:ff:ff:ff:ff:ff</span>
</span><span class="z-source z-shell z-bash">    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">inet</span></span><span class="z-meta z-function-call z-arguments z-shell"> 10.0.0.31/24 brd 10.0.0.255 scope global brqdd604587-35</span>
</span><span class="z-source z-shell z-bash">       <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">valid_lft</span></span><span class="z-meta z-function-call z-arguments z-shell"> forever preferred_lft forever</span>
</span></code></pre>
<p>可以看到网络的id<code>dd604587-3542-409b-9ca8-eed06840fb55</code>会在网络控制节点和实例对应计算节点上创建一个网卡，并且取id的前10位作为网卡的名字，即<code>brqdd604587-35</code>，然后就是网络中的端口，可以参考上面网络端口的图片，上面有一个<code>network:dhcp</code>的端口，我感觉这个可以理解为在这个网络上的设备，这个dhcp的端口的名字为<code>a98eeb82-7abe</code>，可以对为网络控制节点中的<code>netns(网络命名空间)</code>，里面的一个设备<code>ns-a98eeb82-7a@if8</code>命名格式也是前10位，可以知道这个接口是当前网络中的DHCP服务，其中这个设备通过<code>link-netnsid</code>和<code>@if8</code>的标识可以判断出他是一个虚拟接口<code>(veth pair对)</code>，通过<code>@if8</code>可以看出他是从主机的<code>tapa98eeb82-7a</code>网卡接出来的，<code>tapa98eeb82-7a</code>是网桥<code>brqdd604587-35</code>中的接口。然后当前两台机器的网桥<code>brctl show</code>中可以看到<code>brqdd604587-35</code>都是<code>ens33</code>的网桥。当前它们的网络架构如下
<img src="https://image.boychai.xyz/img/Pasted%20image%2020250215163534.png" alt="" />
当实例开机，他们的网络情况会变会变成下面这样，网络控制节情况如下</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">[root@controller</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-meta z-group z-expansion z-tilde"><span class="z-variable z-language z-tilde z-shell">~</span></span>]# ip link</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">......</span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">2:</span></span><span class="z-meta z-function-call z-arguments z-shell"> ens33: <span class="z-keyword z-operator z-assignment z-redirection z-shell">&lt;</span>BROADCAST,MULTICAST,UP,LOWER_UP<span class="z-keyword z-operator z-assignment z-redirection z-shell">&gt;</span> mtu 1500 qdisc pfifo_fast master brqdd604587-35 state UP mode DEFAULT group default qlen 1000</span>
</span><span class="z-source z-shell z-bash">    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">link/ether</span></span><span class="z-meta z-function-call z-arguments z-shell"> 00:0c:29:08:b5:9e brd ff:ff:ff:ff:ff:ff</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">8:</span></span><span class="z-meta z-function-call z-arguments z-shell"> tapa98eeb82-7a@if2: <span class="z-keyword z-operator z-assignment z-redirection z-shell">&lt;</span>BROADCAST,MULTICAST,UP,LOWER_UP<span class="z-keyword z-operator z-assignment z-redirection z-shell">&gt;</span> mtu 1500 qdisc noqueue master brqdd604587-35 state UP mode DEFAULT group default qlen 1000</span>
</span><span class="z-source z-shell z-bash">    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">link/ether</span></span><span class="z-meta z-function-call z-arguments z-shell"> 0a:04:25:5a:e2:67 brd ff:ff:ff:ff:ff:ff link-netnsid 2</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">9:</span></span><span class="z-meta z-function-call z-arguments z-shell"> brqdd604587-35: <span class="z-keyword z-operator z-assignment z-redirection z-shell">&lt;</span>BROADCAST,MULTICAST,UP,LOWER_UP<span class="z-keyword z-operator z-assignment z-redirection z-shell">&gt;</span> mtu 1500 qdisc noqueue state UP mode DEFAULT group default qlen 1000</span>
</span><span class="z-source z-shell z-bash">    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">link/ether</span></span><span class="z-meta z-function-call z-arguments z-shell"> 00:0c:29:08:b5:9e brd ff:ff:ff:ff:ff:ff</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">[root@controller</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-meta z-group z-expansion z-tilde"><span class="z-variable z-language z-tilde z-shell">~</span></span>]# brctl show</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">bridge</span></span><span class="z-meta z-function-call z-arguments z-shell"> name     bridge id               STP enabled     interfaces</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">brqdd604587-35</span></span><span class="z-meta z-function-call z-arguments z-shell">          8000.000c2908b59e       no              ens33</span>
</span><span class="z-source z-shell z-bash">                                                        <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">tapa98eeb82-7a</span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">[root@controller</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-meta z-group z-expansion z-tilde"><span class="z-variable z-language z-tilde z-shell">~</span></span>]# ip a</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">......</span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">8:</span></span><span class="z-meta z-function-call z-arguments z-shell"> tapa98eeb82-7a@if2: <span class="z-keyword z-operator z-assignment z-redirection z-shell">&lt;</span>BROADCAST,MULTICAST,UP,LOWER_UP<span class="z-keyword z-operator z-assignment z-redirection z-shell">&gt;</span> mtu 1500 qdisc noqueue master brqdd604587-35 state UP group default qlen 1000</span>
</span><span class="z-source z-shell z-bash">    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">link/ether</span></span><span class="z-meta z-function-call z-arguments z-shell"> 0a:04:25:5a:e2:67 brd ff:ff:ff:ff:ff:ff link-netnsid 2</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">9:</span></span><span class="z-meta z-function-call z-arguments z-shell"> brqdd604587-35: <span class="z-keyword z-operator z-assignment z-redirection z-shell">&lt;</span>BROADCAST,MULTICAST,UP,LOWER_UP<span class="z-keyword z-operator z-assignment z-redirection z-shell">&gt;</span> mtu 1500 qdisc noqueue state UP group default qlen 1000</span>
</span><span class="z-source z-shell z-bash">    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">link/ether</span></span><span class="z-meta z-function-call z-arguments z-shell"> 00:0c:29:08:b5:9e brd ff:ff:ff:ff:ff:ff</span>
</span><span class="z-source z-shell z-bash">    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">inet</span></span><span class="z-meta z-function-call z-arguments z-shell"> 10.0.0.11/24 brd 10.0.0.255 scope global brqdd604587-35</span>
</span><span class="z-source z-shell z-bash">       <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">valid_lft</span></span><span class="z-meta z-function-call z-arguments z-shell"> forever preferred_lft forever</span>
</span><span class="z-source z-shell z-bash">    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">inet6</span></span><span class="z-meta z-function-call z-arguments z-shell"> fe80::d061:3cff:fedd:3f85/64 scope link</span>
</span><span class="z-source z-shell z-bash">       <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">valid_lft</span></span><span class="z-meta z-function-call z-arguments z-shell"> forever preferred_lft forever</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">[root@controller</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-meta z-group z-expansion z-tilde"><span class="z-variable z-language z-tilde z-shell">~</span></span>]# ip netns</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">qdhcp-dd604587-3542-409b-9ca8-eed06840fb55</span></span><span class="z-meta z-function-call z-arguments z-shell"> (id: 2</span><span class="z-meta z-function-call z-shell"></span>)
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">[root@controller</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-meta z-group z-expansion z-tilde"><span class="z-variable z-language z-tilde z-shell">~</span></span>]# ip netns exec qdhcp-dd604587-3542-409b-9ca8-eed06840fb55 ip a</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">......</span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">2:</span></span><span class="z-meta z-function-call z-arguments z-shell"> ns-a98eeb82-7a@if8: <span class="z-keyword z-operator z-assignment z-redirection z-shell">&lt;</span>BROADCAST,MULTICAST,UP,LOWER_UP<span class="z-keyword z-operator z-assignment z-redirection z-shell">&gt;</span> mtu 1500 qdisc noqueue state UP group default qlen 1000</span>
</span><span class="z-source z-shell z-bash">    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">link/ether</span></span><span class="z-meta z-function-call z-arguments z-shell"> fa:16:3e:53:6f:70 brd ff:ff:ff:ff:ff:ff link-netnsid 0</span>
</span><span class="z-source z-shell z-bash">    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">inet</span></span><span class="z-meta z-function-call z-arguments z-shell"> 10.0.0.200/24 brd 10.0.0.255 scope global ns-a98eeb82-7a</span>
</span><span class="z-source z-shell z-bash">       <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">valid_lft</span></span><span class="z-meta z-function-call z-arguments z-shell"> forever preferred_lft forever</span>
</span><span class="z-source z-shell z-bash">    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">inet</span></span><span class="z-meta z-function-call z-arguments z-shell"> 169.254.169.254/16 brd 169.254.255.255 scope global ns-a98eeb82-7a</span>
</span><span class="z-source z-shell z-bash">       <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">valid_lft</span></span><span class="z-meta z-function-call z-arguments z-shell"> forever preferred_lft forever</span>
</span><span class="z-source z-shell z-bash">    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">inet6</span></span><span class="z-meta z-function-call z-arguments z-shell"> fe80::f816:3eff:fe53:6f70/64 scope link</span>
</span><span class="z-source z-shell z-bash">       <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">valid_lft</span></span><span class="z-meta z-function-call z-arguments z-shell"> forever preferred_lft forever</span>
</span></code></pre>
<p>在对应实例的计算节点中他的网络变成了这样</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">[root@compute1</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-meta z-group z-expansion z-tilde"><span class="z-variable z-language z-tilde z-shell">~</span></span>]# ip link</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">......</span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">2:</span></span><span class="z-meta z-function-call z-arguments z-shell"> ens33: <span class="z-keyword z-operator z-assignment z-redirection z-shell">&lt;</span>BROADCAST,MULTICAST,UP,LOWER_UP<span class="z-keyword z-operator z-assignment z-redirection z-shell">&gt;</span> mtu 1500 qdisc pfifo_fast master brqdd604587-35 state UP mode DEFAULT group default qlen 1000</span>
</span><span class="z-source z-shell z-bash">    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">link/ether</span></span><span class="z-meta z-function-call z-arguments z-shell"> 00:0c:29:a8:d7:e0 brd ff:ff:ff:ff:ff:ff</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">6:</span></span><span class="z-meta z-function-call z-arguments z-shell"> brqdd604587-35: <span class="z-keyword z-operator z-assignment z-redirection z-shell">&lt;</span>BROADCAST,MULTICAST,UP,LOWER_UP<span class="z-keyword z-operator z-assignment z-redirection z-shell">&gt;</span> mtu 1500 qdisc noqueue state UP mode DEFAULT group default qlen 1000</span>
</span><span class="z-source z-shell z-bash">    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">link/ether</span></span><span class="z-meta z-function-call z-arguments z-shell"> 00:0c:29:a8:d7:e0 brd ff:ff:ff:ff:ff:ff</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">8:</span></span><span class="z-meta z-function-call z-arguments z-shell"> tap76c0c08c-79: <span class="z-keyword z-operator z-assignment z-redirection z-shell">&lt;</span>BROADCAST,MULTICAST,UP,LOWER_UP<span class="z-keyword z-operator z-assignment z-redirection z-shell">&gt;</span> mtu 1500 qdisc pfifo_fast master brqdd604587-35 state UNKNOWN mode DEFAULT group default qlen 1000</span>
</span><span class="z-source z-shell z-bash">    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">link/ether</span></span><span class="z-meta z-function-call z-arguments z-shell"> fe:16:3e:4d:6a:b1 brd ff:ff:ff:ff:ff:ff</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">[root@compute1</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-meta z-group z-expansion z-tilde"><span class="z-variable z-language z-tilde z-shell">~</span></span>]# brctl show</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">bridge</span></span><span class="z-meta z-function-call z-arguments z-shell"> name     bridge id               STP enabled     interfaces</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">brqdd604587-35</span></span><span class="z-meta z-function-call z-arguments z-shell">          8000.000c29a8d7e0       no              ens33</span>
</span><span class="z-source z-shell z-bash">                                                        <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">tap76c0c08c-79</span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">[root@compute1</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-meta z-group z-expansion z-tilde"><span class="z-variable z-language z-tilde z-shell">~</span></span>]# ip a</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">......</span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">6:</span></span><span class="z-meta z-function-call z-arguments z-shell"> brqdd604587-35: <span class="z-keyword z-operator z-assignment z-redirection z-shell">&lt;</span>BROADCAST,MULTICAST,UP,LOWER_UP<span class="z-keyword z-operator z-assignment z-redirection z-shell">&gt;</span> mtu 1500 qdisc noqueue state UP group default qlen 1000</span>
</span><span class="z-source z-shell z-bash">    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">link/ether</span></span><span class="z-meta z-function-call z-arguments z-shell"> 00:0c:29:a8:d7:e0 brd ff:ff:ff:ff:ff:ff</span>
</span><span class="z-source z-shell z-bash">    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">inet</span></span><span class="z-meta z-function-call z-arguments z-shell"> 10.0.0.31/24 brd 10.0.0.255 scope global brqdd604587-35</span>
</span><span class="z-source z-shell z-bash">       <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">valid_lft</span></span><span class="z-meta z-function-call z-arguments z-shell"> forever preferred_lft forever</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">8:</span></span><span class="z-meta z-function-call z-arguments z-shell"> tap76c0c08c-79: <span class="z-keyword z-operator z-assignment z-redirection z-shell">&lt;</span>BROADCAST,MULTICAST,UP,LOWER_UP<span class="z-keyword z-operator z-assignment z-redirection z-shell">&gt;</span> mtu 1500 qdisc pfifo_fast master brqdd604587-35 state UNKNOWN group default qlen 1000</span>
</span><span class="z-source z-shell z-bash">    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">link/ether</span></span><span class="z-meta z-function-call z-arguments z-shell"> fe:16:3e:4d:6a:b1 brd ff:ff:ff:ff:ff:ff</span>
</span><span class="z-source z-shell z-bash">    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">inet6</span></span><span class="z-meta z-function-call z-arguments z-shell"> fe80::fc16:3eff:fe4d:6ab1/64 scope link</span>
</span><span class="z-source z-shell z-bash">       <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">valid_lft</span></span><span class="z-meta z-function-call z-arguments z-shell"> forever preferred_lft forever</span>
</span></code></pre>
<p>改变主要是在计算节点，在计算节点中他的网桥关联了一个新的接口<code>tap76c0c08c-79</code>,这个接口是怎么来的呢，可以参考虚机的配置</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">[root@compute1</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-meta z-group z-expansion z-tilde"><span class="z-variable z-language z-tilde z-shell">~</span></span>]# virsh list</span>
</span><span class="z-source z-shell z-bash"> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">Id</span></span><span class="z-meta z-function-call z-arguments z-shell">    Name                           State</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">----------------------------------------------------</span></span>
</span><span class="z-source z-shell z-bash"> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">3</span></span><span class="z-meta z-function-call z-arguments z-shell">     instance-00000010              running</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">[root@compute1</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-meta z-group z-expansion z-tilde"><span class="z-variable z-language z-tilde z-shell">~</span></span>]# cd /etc/libvirt/qemu/</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">[root@compute1</span></span><span class="z-meta z-function-call z-arguments z-shell"> qemu]# ls</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">instance-00000010.xml</span></span><span class="z-meta z-function-call z-arguments z-shell">  networks</span>
</span></code></pre>
<p>在<code>instance-00000010.xml</code>中，网络接口相关配置如下</p>
<pre data-lang="xml" class="language-xml z-code"><code class="language-xml" data-lang="xml"><span class="z-text z-xml">    <span class="z-meta z-tag z-xml"><span class="z-punctuation z-definition z-tag z-begin z-xml">&lt;</span><span class="z-entity z-name z-tag z-localname z-xml">interface</span> <span class="z-entity z-other z-attribute-name z-localname z-xml">type</span><span class="z-punctuation z-separator z-key-value z-xml">=</span><span class="z-string z-quoted z-single z-xml"><span class="z-punctuation z-definition z-string z-begin z-xml">&#39;</span>bridge<span class="z-punctuation z-definition z-string z-end z-xml">&#39;</span></span><span class="z-punctuation z-definition z-tag z-end z-xml">&gt;</span></span>
</span><span class="z-text z-xml">      <span class="z-meta z-tag z-xml"><span class="z-punctuation z-definition z-tag z-begin z-xml">&lt;</span><span class="z-entity z-name z-tag z-localname z-xml">mac</span> <span class="z-entity z-other z-attribute-name z-localname z-xml">address</span><span class="z-punctuation z-separator z-key-value z-xml">=</span><span class="z-string z-quoted z-single z-xml"><span class="z-punctuation z-definition z-string z-begin z-xml">&#39;</span>fa:16:3e:4d:6a:b1<span class="z-punctuation z-definition z-string z-end z-xml">&#39;</span></span><span class="z-punctuation z-definition z-tag z-end z-xml">&gt;</span></span><span class="z-meta z-tag z-xml"><span class="z-punctuation z-definition z-tag z-begin z-xml">&lt;/</span><span class="z-entity z-name z-tag z-localname z-xml">mac</span><span class="z-punctuation z-definition z-tag z-end z-xml">&gt;</span></span>
</span><span class="z-text z-xml">      <span class="z-meta z-tag z-xml"><span class="z-punctuation z-definition z-tag z-begin z-xml">&lt;</span><span class="z-entity z-name z-tag z-localname z-xml">source</span> <span class="z-entity z-other z-attribute-name z-localname z-xml">bridge</span><span class="z-punctuation z-separator z-key-value z-xml">=</span><span class="z-string z-quoted z-single z-xml"><span class="z-punctuation z-definition z-string z-begin z-xml">&#39;</span>brqdd604587-35<span class="z-punctuation z-definition z-string z-end z-xml">&#39;</span></span><span class="z-punctuation z-definition z-tag z-end z-xml">&gt;</span></span><span class="z-meta z-tag z-xml"><span class="z-punctuation z-definition z-tag z-begin z-xml">&lt;/</span><span class="z-entity z-name z-tag z-localname z-xml">source</span><span class="z-punctuation z-definition z-tag z-end z-xml">&gt;</span></span>
</span><span class="z-text z-xml">      <span class="z-meta z-tag z-xml"><span class="z-punctuation z-definition z-tag z-begin z-xml">&lt;</span><span class="z-entity z-name z-tag z-localname z-xml">target</span> <span class="z-entity z-other z-attribute-name z-localname z-xml">dev</span><span class="z-punctuation z-separator z-key-value z-xml">=</span><span class="z-string z-quoted z-single z-xml"><span class="z-punctuation z-definition z-string z-begin z-xml">&#39;</span>tap76c0c08c-79<span class="z-punctuation z-definition z-string z-end z-xml">&#39;</span></span><span class="z-punctuation z-definition z-tag z-end z-xml">&gt;</span></span><span class="z-meta z-tag z-xml"><span class="z-punctuation z-definition z-tag z-begin z-xml">&lt;/</span><span class="z-entity z-name z-tag z-localname z-xml">target</span><span class="z-punctuation z-definition z-tag z-end z-xml">&gt;</span></span>
</span><span class="z-text z-xml">      <span class="z-meta z-tag z-xml"><span class="z-punctuation z-definition z-tag z-begin z-xml">&lt;</span><span class="z-entity z-name z-tag z-localname z-xml">model</span> <span class="z-entity z-other z-attribute-name z-localname z-xml">type</span><span class="z-punctuation z-separator z-key-value z-xml">=</span><span class="z-string z-quoted z-single z-xml"><span class="z-punctuation z-definition z-string z-begin z-xml">&#39;</span>virtio<span class="z-punctuation z-definition z-string z-end z-xml">&#39;</span></span><span class="z-punctuation z-definition z-tag z-end z-xml">&gt;</span></span><span class="z-meta z-tag z-xml"><span class="z-punctuation z-definition z-tag z-begin z-xml">&lt;/</span><span class="z-entity z-name z-tag z-localname z-xml">model</span><span class="z-punctuation z-definition z-tag z-end z-xml">&gt;</span></span>
</span><span class="z-text z-xml">      <span class="z-meta z-tag z-xml"><span class="z-punctuation z-definition z-tag z-begin z-xml">&lt;</span><span class="z-entity z-name z-tag z-localname z-xml">mtu</span> <span class="z-entity z-other z-attribute-name z-localname z-xml">size</span><span class="z-punctuation z-separator z-key-value z-xml">=</span><span class="z-string z-quoted z-single z-xml"><span class="z-punctuation z-definition z-string z-begin z-xml">&#39;</span>1500<span class="z-punctuation z-definition z-string z-end z-xml">&#39;</span></span><span class="z-punctuation z-definition z-tag z-end z-xml">&gt;</span></span><span class="z-meta z-tag z-xml"><span class="z-punctuation z-definition z-tag z-begin z-xml">&lt;/</span><span class="z-entity z-name z-tag z-localname z-xml">mtu</span><span class="z-punctuation z-definition z-tag z-end z-xml">&gt;</span></span>
</span><span class="z-text z-xml">      <span class="z-meta z-tag z-xml"><span class="z-punctuation z-definition z-tag z-begin z-xml">&lt;</span><span class="z-entity z-name z-tag z-localname z-xml">address</span> <span class="z-entity z-other z-attribute-name z-localname z-xml">type</span><span class="z-punctuation z-separator z-key-value z-xml">=</span><span class="z-string z-quoted z-single z-xml"><span class="z-punctuation z-definition z-string z-begin z-xml">&#39;</span>pci<span class="z-punctuation z-definition z-string z-end z-xml">&#39;</span></span> <span class="z-entity z-other z-attribute-name z-localname z-xml">domain</span><span class="z-punctuation z-separator z-key-value z-xml">=</span><span class="z-string z-quoted z-single z-xml"><span class="z-punctuation z-definition z-string z-begin z-xml">&#39;</span>0x0000<span class="z-punctuation z-definition z-string z-end z-xml">&#39;</span></span> <span class="z-entity z-other z-attribute-name z-localname z-xml">bus</span><span class="z-punctuation z-separator z-key-value z-xml">=</span><span class="z-string z-quoted z-single z-xml"><span class="z-punctuation z-definition z-string z-begin z-xml">&#39;</span>0x00<span class="z-punctuation z-definition z-string z-end z-xml">&#39;</span></span> <span class="z-entity z-other z-attribute-name z-localname z-xml">slot</span><span class="z-punctuation z-separator z-key-value z-xml">=</span><span class="z-string z-quoted z-single z-xml"><span class="z-punctuation z-definition z-string z-begin z-xml">&#39;</span>0x03<span class="z-punctuation z-definition z-string z-end z-xml">&#39;</span></span> <span class="z-entity z-other z-attribute-name z-localname z-xml">function</span><span class="z-punctuation z-separator z-key-value z-xml">=</span><span class="z-string z-quoted z-single z-xml"><span class="z-punctuation z-definition z-string z-begin z-xml">&#39;</span>0x0<span class="z-punctuation z-definition z-string z-end z-xml">&#39;</span></span><span class="z-punctuation z-definition z-tag z-end z-xml">&gt;</span></span><span class="z-meta z-tag z-xml"><span class="z-punctuation z-definition z-tag z-begin z-xml">&lt;/</span><span class="z-entity z-name z-tag z-localname z-xml">address</span><span class="z-punctuation z-definition z-tag z-end z-xml">&gt;</span></span>
</span><span class="z-text z-xml">    <span class="z-meta z-tag z-xml"><span class="z-punctuation z-definition z-tag z-begin z-xml">&lt;/</span><span class="z-entity z-name z-tag z-localname z-xml">interface</span><span class="z-punctuation z-definition z-tag z-end z-xml">&gt;</span></span>
</span></code></pre>
<p>它基于<code>brqdd604587-35</code>做了一个桥接的虚拟接口到<code>tap76c0c08c-79</code>提供给虚机用。现在的网络架构如下
<img src="https://image.boychai.xyz/img/Pasted%20image%2020250215165908.png" alt="" />
从<a href="https://blog.boychai.xyz/index.php/archives/93/">组件理解</a>中可以知道，当前的这个供应商网络<code>provider</code>在实际通信中只是做了一层网络映射，映射到实际网络中，我们这里其实可以理解为虚机是直连在这个外部交换机上的，出现问题可以参考一下思考总结里的实验。</p>
<h1 id="zi-zhu-shi-vxlanwang-luo">自助式-Vxlan网络</h1>
<p><code>Self-service networks</code>的VXLAN网络，网络拓扑拓扑如下
<img src="https://image.boychai.xyz/img/Pasted%20image%2020250217154812.png" alt="" />
网络相关配置如下
<img src="https://image.boychai.xyz/img/Pasted%20image%2020250217160721.png" alt="" />
<img src="https://image.boychai.xyz/img/Pasted%20image%2020250217160703.png" alt="" />
<img src="https://image.boychai.xyz/img/Pasted%20image%2020250217160622.png" alt="" />
<img src="https://image.boychai.xyz/img/Pasted%20image%2020250217160541.png" alt="" />
<img src="https://image.boychai.xyz/img/Pasted%20image%2020250217160531.png" alt="" />
开启主机去看网络信息，在控制节点的网络信息如下</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">[root@controller</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-meta z-group z-expansion z-tilde"><span class="z-variable z-language z-tilde z-shell">~</span></span>]# ip link</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">2:</span></span><span class="z-meta z-function-call z-arguments z-shell"> ens33: <span class="z-keyword z-operator z-assignment z-redirection z-shell">&lt;</span>BROADCAST,MULTICAST,UP,LOWER_UP<span class="z-keyword z-operator z-assignment z-redirection z-shell">&gt;</span> mtu 1500 qdisc pfifo_fast master brqdd604587-35 state UP mode DEFAULT group default qlen 1000</span>
</span><span class="z-source z-shell z-bash">    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">link/ether</span></span><span class="z-meta z-function-call z-arguments z-shell"> 00:0c:29:08:b5:9e brd ff:ff:ff:ff:ff:ff</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">4:</span></span><span class="z-meta z-function-call z-arguments z-shell"> ens37: <span class="z-keyword z-operator z-assignment z-redirection z-shell">&lt;</span>BROADCAST,MULTICAST,UP,LOWER_UP<span class="z-keyword z-operator z-assignment z-redirection z-shell">&gt;</span> mtu 1500 qdisc pfifo_fast state UP mode DEFAULT group default qlen 1000</span>
</span><span class="z-source z-shell z-bash">    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">link/ether</span></span><span class="z-meta z-function-call z-arguments z-shell"> 00:0c:29:08:b5:b2 brd ff:ff:ff:ff:ff:ff</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">7:</span></span><span class="z-meta z-function-call z-arguments z-shell"> tap7cb3b509-23@if2: <span class="z-keyword z-operator z-assignment z-redirection z-shell">&lt;</span>BROADCAST,MULTICAST,UP,LOWER_UP<span class="z-keyword z-operator z-assignment z-redirection z-shell">&gt;</span> mtu 1450 qdisc noqueue master brq7f850748-2d state UP mode DEFAULT group default qlen 1000</span>
</span><span class="z-source z-shell z-bash">    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">link/ether</span></span><span class="z-meta z-function-call z-arguments z-shell"> 9a:4f:c8:45:64:e7 brd ff:ff:ff:ff:ff:ff link-netnsid 1</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">8:</span></span><span class="z-meta z-function-call z-arguments z-shell"> vxlan-1: <span class="z-keyword z-operator z-assignment z-redirection z-shell">&lt;</span>BROADCAST,MULTICAST,UP,LOWER_UP<span class="z-keyword z-operator z-assignment z-redirection z-shell">&gt;</span> mtu 1450 qdisc noqueue master brq7f850748-2d state UNKNOWN mode DEFAULT</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">group</span></span><span class="z-meta z-function-call z-arguments z-shell"> default qlen 1000</span>
</span><span class="z-source z-shell z-bash">    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">link/ether</span></span><span class="z-meta z-function-call z-arguments z-shell"> 0a:b6:1f:77:c4:1b brd ff:ff:ff:ff:ff:ff</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">9:</span></span><span class="z-meta z-function-call z-arguments z-shell"> brq7f850748-2d: <span class="z-keyword z-operator z-assignment z-redirection z-shell">&lt;</span>BROADCAST,MULTICAST,UP,LOWER_UP<span class="z-keyword z-operator z-assignment z-redirection z-shell">&gt;</span> mtu 1450 qdisc noqueue state UP mode DEFAULT group default qlen 1000</span>
</span><span class="z-source z-shell z-bash">    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">link/ether</span></span><span class="z-meta z-function-call z-arguments z-shell"> 0a:b6:1f:77:c4:1b brd ff:ff:ff:ff:ff:ff</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">10:</span></span><span class="z-meta z-function-call z-arguments z-shell"> brqdd604587-35: <span class="z-keyword z-operator z-assignment z-redirection z-shell">&lt;</span>BROADCAST,MULTICAST,UP,LOWER_UP<span class="z-keyword z-operator z-assignment z-redirection z-shell">&gt;</span> mtu 1500 qdisc noqueue state UP mode DEFAULT group default qlen</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">1000</span></span>
</span><span class="z-source z-shell z-bash">    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">link/ether</span></span><span class="z-meta z-function-call z-arguments z-shell"> 00:0c:29:08:b5:9e brd ff:ff:ff:ff:ff:ff</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">14:</span></span><span class="z-meta z-function-call z-arguments z-shell"> tapf00694f6-24@if2: <span class="z-keyword z-operator z-assignment z-redirection z-shell">&lt;</span>BROADCAST,MULTICAST,UP,LOWER_UP<span class="z-keyword z-operator z-assignment z-redirection z-shell">&gt;</span> mtu 1500 qdisc noqueue master brqdd604587-35 state UP mode DEFAULT group default qlen 1000</span>
</span><span class="z-source z-shell z-bash">    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">link/ether</span></span><span class="z-meta z-function-call z-arguments z-shell"> 5a:b6:d1:fe:08:64 brd ff:ff:ff:ff:ff:ff link-netnsid 0</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">15:</span></span><span class="z-meta z-function-call z-arguments z-shell"> tap31b0feaa-20@if3: <span class="z-keyword z-operator z-assignment z-redirection z-shell">&lt;</span>BROADCAST,MULTICAST,UP,LOWER_UP<span class="z-keyword z-operator z-assignment z-redirection z-shell">&gt;</span> mtu 1450 qdisc noqueue master brq7f850748-2d state UP mode DEFAULT group default qlen 1000</span>
</span><span class="z-source z-shell z-bash">    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">link/ether</span></span><span class="z-meta z-function-call z-arguments z-shell"> 3e:f5:9d:44:57:29 brd ff:ff:ff:ff:ff:ff link-netnsid 0</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">[root@controller</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-meta z-group z-expansion z-tilde"><span class="z-variable z-language z-tilde z-shell">~</span></span>]# ip a</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">2:</span></span><span class="z-meta z-function-call z-arguments z-shell"> ens33: <span class="z-keyword z-operator z-assignment z-redirection z-shell">&lt;</span>BROADCAST,MULTICAST,UP,LOWER_UP<span class="z-keyword z-operator z-assignment z-redirection z-shell">&gt;</span> mtu 1500 qdisc pfifo_fast master brqdd604587-35 state UP group default qlen 1000</span>
</span><span class="z-source z-shell z-bash">    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">link/ether</span></span><span class="z-meta z-function-call z-arguments z-shell"> 00:0c:29:08:b5:9e brd ff:ff:ff:ff:ff:ff</span>
</span><span class="z-source z-shell z-bash">    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">inet6</span></span><span class="z-meta z-function-call z-arguments z-shell"> fe80::ad6b:bdb0:9b14:c54d/64 scope link noprefixroute</span>
</span><span class="z-source z-shell z-bash">       <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">valid_lft</span></span><span class="z-meta z-function-call z-arguments z-shell"> forever preferred_lft forever</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">4:</span></span><span class="z-meta z-function-call z-arguments z-shell"> ens37: <span class="z-keyword z-operator z-assignment z-redirection z-shell">&lt;</span>BROADCAST,MULTICAST,UP,LOWER_UP<span class="z-keyword z-operator z-assignment z-redirection z-shell">&gt;</span> mtu 1500 qdisc pfifo_fast state UP group default qlen 1000</span>
</span><span class="z-source z-shell z-bash">    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">link/ether</span></span><span class="z-meta z-function-call z-arguments z-shell"> 00:0c:29:08:b5:b2 brd ff:ff:ff:ff:ff:ff</span>
</span><span class="z-source z-shell z-bash">    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">inet</span></span><span class="z-meta z-function-call z-arguments z-shell"> 172.16.0.11/24 brd 172.16.0.255 scope global noprefixroute ens37</span>
</span><span class="z-source z-shell z-bash">       <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">valid_lft</span></span><span class="z-meta z-function-call z-arguments z-shell"> forever preferred_lft forever</span>
</span><span class="z-source z-shell z-bash">    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">inet6</span></span><span class="z-meta z-function-call z-arguments z-shell"> fe80::20c:29ff:fe08:b5b2/64 scope link</span>
</span><span class="z-source z-shell z-bash">       <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">valid_lft</span></span><span class="z-meta z-function-call z-arguments z-shell"> forever preferred_lft forever</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">7:</span></span><span class="z-meta z-function-call z-arguments z-shell"> tap7cb3b509-23@if2: <span class="z-keyword z-operator z-assignment z-redirection z-shell">&lt;</span>BROADCAST,MULTICAST,UP,LOWER_UP<span class="z-keyword z-operator z-assignment z-redirection z-shell">&gt;</span> mtu 1450 qdisc noqueue master brq7f850748-2d state UP group default qlen 1000</span>
</span><span class="z-source z-shell z-bash">    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">link/ether</span></span><span class="z-meta z-function-call z-arguments z-shell"> 9a:4f:c8:45:64:e7 brd ff:ff:ff:ff:ff:ff link-netnsid 1</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">8:</span></span><span class="z-meta z-function-call z-arguments z-shell"> vxlan-1: <span class="z-keyword z-operator z-assignment z-redirection z-shell">&lt;</span>BROADCAST,MULTICAST,UP,LOWER_UP<span class="z-keyword z-operator z-assignment z-redirection z-shell">&gt;</span> mtu 1450 qdisc noqueue master brq7f850748-2d state UNKNOWN group default qlen 1000</span>
</span><span class="z-source z-shell z-bash">    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">link/ether</span></span><span class="z-meta z-function-call z-arguments z-shell"> 0a:b6:1f:77:c4:1b brd ff:ff:ff:ff:ff:ff</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">9:</span></span><span class="z-meta z-function-call z-arguments z-shell"> brq7f850748-2d: <span class="z-keyword z-operator z-assignment z-redirection z-shell">&lt;</span>BROADCAST,MULTICAST,UP,LOWER_UP<span class="z-keyword z-operator z-assignment z-redirection z-shell">&gt;</span> mtu 1450 qdisc noqueue state UP group default qlen 1000</span>
</span><span class="z-source z-shell z-bash">    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">link/ether</span></span><span class="z-meta z-function-call z-arguments z-shell"> 0a:b6:1f:77:c4:1b brd ff:ff:ff:ff:ff:ff</span>
</span><span class="z-source z-shell z-bash">    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">inet6</span></span><span class="z-meta z-function-call z-arguments z-shell"> fe80::44b9:8bff:feee:1639/64 scope link</span>
</span><span class="z-source z-shell z-bash">       <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">valid_lft</span></span><span class="z-meta z-function-call z-arguments z-shell"> forever preferred_lft forever</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">10:</span></span><span class="z-meta z-function-call z-arguments z-shell"> brqdd604587-35: <span class="z-keyword z-operator z-assignment z-redirection z-shell">&lt;</span>BROADCAST,MULTICAST,UP,LOWER_UP<span class="z-keyword z-operator z-assignment z-redirection z-shell">&gt;</span> mtu 1500 qdisc noqueue state UP group default qlen 1000</span>
</span><span class="z-source z-shell z-bash">    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">link/ether</span></span><span class="z-meta z-function-call z-arguments z-shell"> 00:0c:29:08:b5:9e brd ff:ff:ff:ff:ff:ff</span>
</span><span class="z-source z-shell z-bash">    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">inet</span></span><span class="z-meta z-function-call z-arguments z-shell"> 10.0.0.11/24 brd 10.0.0.255 scope global brqdd604587-35</span>
</span><span class="z-source z-shell z-bash">       <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">valid_lft</span></span><span class="z-meta z-function-call z-arguments z-shell"> forever preferred_lft forever</span>
</span><span class="z-source z-shell z-bash">    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">inet6</span></span><span class="z-meta z-function-call z-arguments z-shell"> fe80::2073:d5ff:fedc:5d7/64 scope link</span>
</span><span class="z-source z-shell z-bash">       <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">valid_lft</span></span><span class="z-meta z-function-call z-arguments z-shell"> forever preferred_lft forever</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">14:</span></span><span class="z-meta z-function-call z-arguments z-shell"> tapf00694f6-24@if2: <span class="z-keyword z-operator z-assignment z-redirection z-shell">&lt;</span>BROADCAST,MULTICAST,UP,LOWER_UP<span class="z-keyword z-operator z-assignment z-redirection z-shell">&gt;</span> mtu 1500 qdisc noqueue master brqdd604587-35 state UP group</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">default</span></span><span class="z-meta z-function-call z-arguments z-shell"> qlen 1000</span>
</span><span class="z-source z-shell z-bash">    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">link/ether</span></span><span class="z-meta z-function-call z-arguments z-shell"> 5a:b6:d1:fe:08:64 brd ff:ff:ff:ff:ff:ff link-netnsid 0</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">15:</span></span><span class="z-meta z-function-call z-arguments z-shell"> tap31b0feaa-20@if3: <span class="z-keyword z-operator z-assignment z-redirection z-shell">&lt;</span>BROADCAST,MULTICAST,UP,LOWER_UP<span class="z-keyword z-operator z-assignment z-redirection z-shell">&gt;</span> mtu 1450 qdisc noqueue master brq7f850748-2d state UP group</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">default</span></span><span class="z-meta z-function-call z-arguments z-shell"> qlen 1000</span>
</span><span class="z-source z-shell z-bash">    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">link/ether</span></span><span class="z-meta z-function-call z-arguments z-shell"> 3e:f5:9d:44:57:29 brd ff:ff:ff:ff:ff:ff link-netnsid 0</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">[root@controller</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-meta z-group z-expansion z-tilde"><span class="z-variable z-language z-tilde z-shell">~</span></span>]# ip netns</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">qrouter-e651f481-55aa-46a7-aa62-96ef71e5bac3</span></span><span class="z-meta z-function-call z-arguments z-shell"> (id: 0</span><span class="z-meta z-function-call z-shell"></span>)
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">qdhcp-7f850748-2d01-4f88-95fa-41b6144b1c02</span></span><span class="z-meta z-function-call z-arguments z-shell"> (id: 1</span><span class="z-meta z-function-call z-shell"></span>)
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">[root@controller</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-meta z-group z-expansion z-tilde"><span class="z-variable z-language z-tilde z-shell">~</span></span>]# ip netns exec qrouter-e651f481-55aa-46a7-aa62-96ef71e5bac3 ip a</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">2:</span></span><span class="z-meta z-function-call z-arguments z-shell"> qg-f00694f6-24@if14: <span class="z-keyword z-operator z-assignment z-redirection z-shell">&lt;</span>BROADCAST,MULTICAST,UP,LOWER_UP<span class="z-keyword z-operator z-assignment z-redirection z-shell">&gt;</span> mtu 1500 qdisc noqueue state UP group default qlen 1000</span>
</span><span class="z-source z-shell z-bash">    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">link/ether</span></span><span class="z-meta z-function-call z-arguments z-shell"> fa:16:3e:6a:e4:80 brd ff:ff:ff:ff:ff:ff link-netnsid 0</span>
</span><span class="z-source z-shell z-bash">    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">inet</span></span><span class="z-meta z-function-call z-arguments z-shell"> 10.0.0.208/24 brd 10.0.0.255 scope global qg-f00694f6-24</span>
</span><span class="z-source z-shell z-bash">       <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">valid_lft</span></span><span class="z-meta z-function-call z-arguments z-shell"> forever preferred_lft forever</span>
</span><span class="z-source z-shell z-bash">    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">inet6</span></span><span class="z-meta z-function-call z-arguments z-shell"> fe80::f816:3eff:fe6a:e480/64 scope link</span>
</span><span class="z-source z-shell z-bash">       <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">valid_lft</span></span><span class="z-meta z-function-call z-arguments z-shell"> forever preferred_lft forever</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">3:</span></span><span class="z-meta z-function-call z-arguments z-shell"> qr-31b0feaa-20@if15: <span class="z-keyword z-operator z-assignment z-redirection z-shell">&lt;</span>BROADCAST,MULTICAST,UP,LOWER_UP<span class="z-keyword z-operator z-assignment z-redirection z-shell">&gt;</span> mtu 1450 qdisc noqueue state UP group default qlen 1000</span>
</span><span class="z-source z-shell z-bash">    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">link/ether</span></span><span class="z-meta z-function-call z-arguments z-shell"> fa:16:3e:3d:18:d0 brd ff:ff:ff:ff:ff:ff link-netnsid 0</span>
</span><span class="z-source z-shell z-bash">    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">inet</span></span><span class="z-meta z-function-call z-arguments z-shell"> 10.10.10.1/24 brd 10.10.10.255 scope global qr-31b0feaa-20</span>
</span><span class="z-source z-shell z-bash">       <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">valid_lft</span></span><span class="z-meta z-function-call z-arguments z-shell"> forever preferred_lft forever</span>
</span><span class="z-source z-shell z-bash">    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">inet6</span></span><span class="z-meta z-function-call z-arguments z-shell"> fe80::f816:3eff:fe3d:18d0/64 scope link</span>
</span><span class="z-source z-shell z-bash">       <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">valid_lft</span></span><span class="z-meta z-function-call z-arguments z-shell"> forever preferred_lft forever</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">[root@controller</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-meta z-group z-expansion z-tilde"><span class="z-variable z-language z-tilde z-shell">~</span></span>]# ip netns exec qdhcp-7f850748-2d01-4f88-95fa-41b6144b1c02 ip a</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">2:</span></span><span class="z-meta z-function-call z-arguments z-shell"> ns-7cb3b509-23@if7: <span class="z-keyword z-operator z-assignment z-redirection z-shell">&lt;</span>BROADCAST,MULTICAST,UP,LOWER_UP<span class="z-keyword z-operator z-assignment z-redirection z-shell">&gt;</span> mtu 1450 qdisc noqueue state UP group default qlen 1000</span>
</span><span class="z-source z-shell z-bash">    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">link/ether</span></span><span class="z-meta z-function-call z-arguments z-shell"> fa:16:3e:85:9c:4c brd ff:ff:ff:ff:ff:ff link-netnsid 0</span>
</span><span class="z-source z-shell z-bash">    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">inet</span></span><span class="z-meta z-function-call z-arguments z-shell"> 10.10.10.100/24 brd 10.10.10.255 scope global ns-7cb3b509-23</span>
</span><span class="z-source z-shell z-bash">       <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">valid_lft</span></span><span class="z-meta z-function-call z-arguments z-shell"> forever preferred_lft forever</span>
</span><span class="z-source z-shell z-bash">    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">inet</span></span><span class="z-meta z-function-call z-arguments z-shell"> 169.254.169.254/16 brd 169.254.255.255 scope global ns-7cb3b509-23</span>
</span><span class="z-source z-shell z-bash">       <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">valid_lft</span></span><span class="z-meta z-function-call z-arguments z-shell"> forever preferred_lft forever</span>
</span><span class="z-source z-shell z-bash">    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">inet6</span></span><span class="z-meta z-function-call z-arguments z-shell"> fe80::f816:3eff:fe85:9c4c/64 scope link</span>
</span><span class="z-source z-shell z-bash">       <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">valid_lft</span></span><span class="z-meta z-function-call z-arguments z-shell"> forever preferred_lft forever</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">[root@controller</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-meta z-group z-expansion z-tilde"><span class="z-variable z-language z-tilde z-shell">~</span></span>]# brctl show</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">bridge</span></span><span class="z-meta z-function-call z-arguments z-shell"> name     bridge id               STP enabled     interfaces</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">brq7f850748-2d</span></span><span class="z-meta z-function-call z-arguments z-shell">          8000.0ab61f77c41b       no              tap31b0feaa-20</span>
</span><span class="z-source z-shell z-bash">                                                        <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">tap7cb3b509-23</span></span>
</span><span class="z-source z-shell z-bash">                                                        <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">vxlan-1</span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">brqdd604587-35</span></span><span class="z-meta z-function-call z-arguments z-shell">          8000.000c2908b59e       no              ens33</span>
</span><span class="z-source z-shell z-bash">                                                        <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">tapf00694f6-24</span></span>
</span></code></pre>
<p>由于内容较多，这里就先把控制节点的结构分析一下先看网桥，他有两个网桥，它与子网的ID是对的上号的，具体可以看看上面的截图，vxlan子网id为<code>7f850748-2d01-4f88-95fa-41b6144b1c02</code>这里的网桥名字就是<code>brq7f850748-2d</code>brq+子网id的前10位，然后我们先看一下<code>brqdd604587-35</code>，这个网络是外部<code>provider</code>网络，他是ens33的网桥，他有一个接口<code>tapf00694f6-24</code>，我们再看一下这个接口，发现在<code>qrouter-e651f481-55aa-46a7-aa62-96ef71e5bac3</code>命名空间中一个连接的接口<code>qg-f00694f6-24@if14</code>他的ip是<code>10.0.0.208</code>这里估计是一个出网的IP，他是在<code>provider</code>子网端口中也有记录，具体可以去集群中查看，然后再看一下<code>vxlan-1</code>的网桥<code>brq7f850748-2d</code>，上面除了<code>vxlan-1</code>的接口，还有两个虚拟接口分别是<code>tap31b0feaa-20</code>和<code>tap7cb3b509-23</code>，它们的对端可以在命名空间中找到，<code>tap31b0feaa-20</code>对端在<code>qrouter-e651f481-55aa-46a7-aa62-96ef71e5bac3</code>命名空间中，对应的接口名字是<code>qr-31b0feaa-20</code>，他的ip是<code>10.10.10.1</code>，这个ip可以得知是在当前子网的网关，在集群中可以得知的ip，这个命名空间中还有一个接口，它的对端刚好是<code>provider</code>网络的网桥中的接口，我们继续看<code>vxlan-1</code>网络的的个虚拟接口<code>tap7cb3b509-23</code>,他的对端是<code>qdhcp-7f850748-2d01-4f88-95fa-41b6144b1c02</code>命名空间中的<code>ns-7cb3b509-23</code>接口用作DHCP。
计算节点的网络信息如下</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">[root@compute1</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-meta z-group z-expansion z-tilde"><span class="z-variable z-language z-tilde z-shell">~</span></span>]# ip link</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">2:</span></span><span class="z-meta z-function-call z-arguments z-shell"> ens33: <span class="z-keyword z-operator z-assignment z-redirection z-shell">&lt;</span>BROADCAST,MULTICAST,UP,LOWER_UP<span class="z-keyword z-operator z-assignment z-redirection z-shell">&gt;</span> mtu 1500 qdisc pfifo_fast master brqdd604587-35 state UP mode DEFAULT group default qlen 1000</span>
</span><span class="z-source z-shell z-bash">    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">link/ether</span></span><span class="z-meta z-function-call z-arguments z-shell"> 00:0c:29:a8:d7:e0 brd ff:ff:ff:ff:ff:ff</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">4:</span></span><span class="z-meta z-function-call z-arguments z-shell"> ens37: <span class="z-keyword z-operator z-assignment z-redirection z-shell">&lt;</span>BROADCAST,MULTICAST,UP,LOWER_UP<span class="z-keyword z-operator z-assignment z-redirection z-shell">&gt;</span> mtu 1500 qdisc pfifo_fast state UP mode DEFAULT group default qlen 1000</span>
</span><span class="z-source z-shell z-bash">    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">link/ether</span></span><span class="z-meta z-function-call z-arguments z-shell"> 00:0c:29:a8:d7:f4 brd ff:ff:ff:ff:ff:ff</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">6:</span></span><span class="z-meta z-function-call z-arguments z-shell"> brqdd604587-35: <span class="z-keyword z-operator z-assignment z-redirection z-shell">&lt;</span>BROADCAST,MULTICAST,UP,LOWER_UP<span class="z-keyword z-operator z-assignment z-redirection z-shell">&gt;</span> mtu 1500 qdisc noqueue state UP mode DEFAULT group default qlen 1000</span>
</span><span class="z-source z-shell z-bash">    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">link/ether</span></span><span class="z-meta z-function-call z-arguments z-shell"> 00:0c:29:a8:d7:e0 brd ff:ff:ff:ff:ff:ff</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">7:</span></span><span class="z-meta z-function-call z-arguments z-shell"> brq7f850748-2d: <span class="z-keyword z-operator z-assignment z-redirection z-shell">&lt;</span>BROADCAST,MULTICAST,UP,LOWER_UP<span class="z-keyword z-operator z-assignment z-redirection z-shell">&gt;</span> mtu 1450 qdisc noqueue state UP mode DEFAULT group default qlen 1000</span>
</span><span class="z-source z-shell z-bash">    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">link/ether</span></span><span class="z-meta z-function-call z-arguments z-shell"> 6e:e5:c4:4f:34:c9 brd ff:ff:ff:ff:ff:ff</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">8:</span></span><span class="z-meta z-function-call z-arguments z-shell"> tap26500e0a-b5: <span class="z-keyword z-operator z-assignment z-redirection z-shell">&lt;</span>BROADCAST,MULTICAST,UP,LOWER_UP<span class="z-keyword z-operator z-assignment z-redirection z-shell">&gt;</span> mtu 1450 qdisc pfifo_fast master brq7f850748-2d state UNKNOWN mode DEFAULT group default qlen 1000</span>
</span><span class="z-source z-shell z-bash">    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">link/ether</span></span><span class="z-meta z-function-call z-arguments z-shell"> fe:16:3e:68:60:74 brd ff:ff:ff:ff:ff:ff</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">10:</span></span><span class="z-meta z-function-call z-arguments z-shell"> vxlan-1: <span class="z-keyword z-operator z-assignment z-redirection z-shell">&lt;</span>BROADCAST,MULTICAST,UP,LOWER_UP<span class="z-keyword z-operator z-assignment z-redirection z-shell">&gt;</span> mtu 1450 qdisc noqueue master brq7f850748-2d state UNKNOWN mode DEFAULT group default qlen 1000</span>
</span><span class="z-source z-shell z-bash">    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">link/ether</span></span><span class="z-meta z-function-call z-arguments z-shell"> 6e:e5:c4:4f:34:c9 brd ff:ff:ff:ff:ff:ff</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">[root@compute1</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-meta z-group z-expansion z-tilde"><span class="z-variable z-language z-tilde z-shell">~</span></span>]# ip a</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">2:</span></span><span class="z-meta z-function-call z-arguments z-shell"> ens33: <span class="z-keyword z-operator z-assignment z-redirection z-shell">&lt;</span>BROADCAST,MULTICAST,UP,LOWER_UP<span class="z-keyword z-operator z-assignment z-redirection z-shell">&gt;</span> mtu 1500 qdisc pfifo_fast master brqdd604587-35 state UP group default qlen 1000</span>
</span><span class="z-source z-shell z-bash">    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">link/ether</span></span><span class="z-meta z-function-call z-arguments z-shell"> 00:0c:29:a8:d7:e0 brd ff:ff:ff:ff:ff:ff</span>
</span><span class="z-source z-shell z-bash">    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">inet6</span></span><span class="z-meta z-function-call z-arguments z-shell"> fe80::ad6b:bdb0:9b14:c54d/64 scope link tentative noprefixroute dadfailed</span>
</span><span class="z-source z-shell z-bash">       <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">valid_lft</span></span><span class="z-meta z-function-call z-arguments z-shell"> forever preferred_lft forever</span>
</span><span class="z-source z-shell z-bash">    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">inet6</span></span><span class="z-meta z-function-call z-arguments z-shell"> fe80::5597:3a9:a4bd:ae3a/64 scope link tentative noprefixroute dadfailed</span>
</span><span class="z-source z-shell z-bash">       <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">valid_lft</span></span><span class="z-meta z-function-call z-arguments z-shell"> forever preferred_lft forever</span>
</span><span class="z-source z-shell z-bash">    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">inet6</span></span><span class="z-meta z-function-call z-arguments z-shell"> fe80::6f88:d473:e534:aaf9/64 scope link tentative noprefixroute dadfailed</span>
</span><span class="z-source z-shell z-bash">       <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">valid_lft</span></span><span class="z-meta z-function-call z-arguments z-shell"> forever preferred_lft forever</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">4:</span></span><span class="z-meta z-function-call z-arguments z-shell"> ens37: <span class="z-keyword z-operator z-assignment z-redirection z-shell">&lt;</span>BROADCAST,MULTICAST,UP,LOWER_UP<span class="z-keyword z-operator z-assignment z-redirection z-shell">&gt;</span> mtu 1500 qdisc pfifo_fast state UP group default qlen 1000</span>
</span><span class="z-source z-shell z-bash">    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">link/ether</span></span><span class="z-meta z-function-call z-arguments z-shell"> 00:0c:29:a8:d7:f4 brd ff:ff:ff:ff:ff:ff</span>
</span><span class="z-source z-shell z-bash">    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">inet</span></span><span class="z-meta z-function-call z-arguments z-shell"> 172.16.0.31/24 brd 172.16.0.255 scope global noprefixroute ens37</span>
</span><span class="z-source z-shell z-bash">       <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">valid_lft</span></span><span class="z-meta z-function-call z-arguments z-shell"> forever preferred_lft forever</span>
</span><span class="z-source z-shell z-bash">    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">inet6</span></span><span class="z-meta z-function-call z-arguments z-shell"> fe80::20c:29ff:fea8:d7f4/64 scope link</span>
</span><span class="z-source z-shell z-bash">       <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">valid_lft</span></span><span class="z-meta z-function-call z-arguments z-shell"> forever preferred_lft forever</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">6:</span></span><span class="z-meta z-function-call z-arguments z-shell"> brqdd604587-35: <span class="z-keyword z-operator z-assignment z-redirection z-shell">&lt;</span>BROADCAST,MULTICAST,UP,LOWER_UP<span class="z-keyword z-operator z-assignment z-redirection z-shell">&gt;</span> mtu 1500 qdisc noqueue state UP group default qlen 1000</span>
</span><span class="z-source z-shell z-bash">    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">link/ether</span></span><span class="z-meta z-function-call z-arguments z-shell"> 00:0c:29:a8:d7:e0 brd ff:ff:ff:ff:ff:ff</span>
</span><span class="z-source z-shell z-bash">    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">inet</span></span><span class="z-meta z-function-call z-arguments z-shell"> 10.0.0.31/24 brd 10.0.0.255 scope global brqdd604587-35</span>
</span><span class="z-source z-shell z-bash">       <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">valid_lft</span></span><span class="z-meta z-function-call z-arguments z-shell"> forever preferred_lft forever</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">7:</span></span><span class="z-meta z-function-call z-arguments z-shell"> brq7f850748-2d: <span class="z-keyword z-operator z-assignment z-redirection z-shell">&lt;</span>BROADCAST,MULTICAST,UP,LOWER_UP<span class="z-keyword z-operator z-assignment z-redirection z-shell">&gt;</span> mtu 1450 qdisc noqueue state UP group default qlen 1000</span>
</span><span class="z-source z-shell z-bash">    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">link/ether</span></span><span class="z-meta z-function-call z-arguments z-shell"> 6e:e5:c4:4f:34:c9 brd ff:ff:ff:ff:ff:ff</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">8:</span></span><span class="z-meta z-function-call z-arguments z-shell"> tap26500e0a-b5: <span class="z-keyword z-operator z-assignment z-redirection z-shell">&lt;</span>BROADCAST,MULTICAST,UP,LOWER_UP<span class="z-keyword z-operator z-assignment z-redirection z-shell">&gt;</span> mtu 1450 qdisc pfifo_fast master brq7f850748-2d state UNKNOWN group default qlen 1000</span>
</span><span class="z-source z-shell z-bash">    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">link/ether</span></span><span class="z-meta z-function-call z-arguments z-shell"> fe:16:3e:68:60:74 brd ff:ff:ff:ff:ff:ff</span>
</span><span class="z-source z-shell z-bash">    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">inet6</span></span><span class="z-meta z-function-call z-arguments z-shell"> fe80::fc16:3eff:fe68:6074/64 scope link</span>
</span><span class="z-source z-shell z-bash">       <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">valid_lft</span></span><span class="z-meta z-function-call z-arguments z-shell"> forever preferred_lft forever</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">10:</span></span><span class="z-meta z-function-call z-arguments z-shell"> vxlan-1: <span class="z-keyword z-operator z-assignment z-redirection z-shell">&lt;</span>BROADCAST,MULTICAST,UP,LOWER_UP<span class="z-keyword z-operator z-assignment z-redirection z-shell">&gt;</span> mtu 1450 qdisc noqueue master brq7f850748-2d state UNKNOWN group default qlen 1000</span>
</span><span class="z-source z-shell z-bash">    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">link/ether</span></span><span class="z-meta z-function-call z-arguments z-shell"> 6e:e5:c4:4f:34:c9 brd ff:ff:ff:ff:ff:ff</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">[root@compute1</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-meta z-group z-expansion z-tilde"><span class="z-variable z-language z-tilde z-shell">~</span></span>]# brctl show</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">bridge</span></span><span class="z-meta z-function-call z-arguments z-shell"> name     bridge id               STP enabled     interfaces</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">brq7f850748-2d</span></span><span class="z-meta z-function-call z-arguments z-shell">          8000.6ee5c44f34c9       no              tap26500e0a-b5</span>
</span><span class="z-source z-shell z-bash">                                                        <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">vxlan-1</span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">brqdd604587-35</span></span><span class="z-meta z-function-call z-arguments z-shell">          8000.000c29a8d7e0       no              ens33</span>
</span></code></pre>
<p>先看一下网桥，<code>brqdd604587-35</code>是<code>provider</code>网络的一个网桥，这里不多讲，在这个节点并没有使用到他，看一下另外一个网桥<code>brq7f850748-2d</code>，它是<code>vxlan-1</code>设备的网桥，另一个接口<code>tap26500e0a-b5</code>连接在实例中。
分析完上面的网络，这里再讲一下<code>vxlan-1</code>这个设备，他是<code>Neutron</code>负责管理的，就以现在的网络拓扑为例，他如果要出外网就需要去找<code>10.10.10.1</code>这个网关，他在控制节点上，他是如何找到它的？而且当前的网络信息，没有设备连接到ens37上，参考上面的引用，再搭建的过程中，这个网络是用来做vxlan的接口，他为啥是一个单独的接口没有任何的关联？这里就要说到vxlan了它们的通信是采用vxlan的方式，当前的拓扑<code>vxlan-1</code>是集群子网<code>brq7f850748-2d</code>网桥的最外层，网桥是桥接的它，在配置他的过程中还有一段配置如下</p>
<pre data-lang="/etc/neutron/plugins/ml2/linuxbridge_agent.ini" class="language-/etc/neutron/plugins/ml2/linuxbridge_agent.ini z-code"><code class="language-/etc/neutron/plugins/ml2/linuxbridge_agent.ini" data-lang="/etc/neutron/plugins/ml2/linuxbridge_agent.ini"><span class="z-text z-plain">[vxlan]
</span><span class="z-text z-plain">enable_vxlan = true
</span><span class="z-text z-plain">local_ip = 172.16.0.31
</span><span class="z-text z-plain">l2_population = true
</span></code></pre>
<p>这是在计算节点的配置，这个<code>local_ip</code>是用来封装vxlan的，它定义了vxlan具体使用的网卡，这个ip必须是当前主机的一个ip，而且必须要和对端vxlan设备相通，具体的跨节点数据包发过来之后，他会在数据包的基础上，封装一层，原地址就写这个<code>local_ip</code>，对端的ip则会写<code>FDB</code>表对应的IP，
这个对应表是通过<code>L2 Population</code>去发现，也有其他实现的方法(组播形式)，配置体现也在上面(vxlan配置)，通过命令<code>bridge fdb show dev vxlan-1</code>可以拿到学习到的<code>FDB</code>表，控制节点的内容如下</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">[root@controller</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-meta z-group z-expansion z-tilde"><span class="z-variable z-language z-tilde z-shell">~</span></span>]# bridge fdb show dev vxlan-1</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">0a:b6:1f:77:c4:1b</span></span><span class="z-meta z-function-call z-arguments z-shell"> vlan 1 master brq7f850748-2d permanent</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">0a:b6:1f:77:c4:1b</span></span><span class="z-meta z-function-call z-arguments z-shell"> master brq7f850748-2d permanent</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">00:00:00:00:00:00</span></span><span class="z-meta z-function-call z-arguments z-shell"> dst 172.16.0.31 self permanent</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">fa:16:3e:68:60:74</span></span><span class="z-meta z-function-call z-arguments z-shell"> dst 172.16.0.31 self permanent</span>
</span></code></pre>
<p>计算节点的内容如下</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">[root@compute1</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-meta z-group z-expansion z-tilde"><span class="z-variable z-language z-tilde z-shell">~</span></span>]# bridge fdb show dev vxlan-1</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">6e:e5:c4:4f:34:c9</span></span><span class="z-meta z-function-call z-arguments z-shell"> vlan 1 master brq7f850748-2d permanent</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">6e:e5:c4:4f:34:c9</span></span><span class="z-meta z-function-call z-arguments z-shell"> master brq7f850748-2d permanent</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">00:00:00:00:00:00</span></span><span class="z-meta z-function-call z-arguments z-shell"> dst 172.16.0.11 self permanent</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">fa:16:3e:85:9c:4c</span></span><span class="z-meta z-function-call z-arguments z-shell"> dst 172.16.0.11 self permanent</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">fa:16:3e:3d:18:d0</span></span><span class="z-meta z-function-call z-arguments z-shell"> dst 172.16.0.11 self permanent</span>
</span></code></pre>
<p>这里的<code>FDB</code>表内容是，对方mac地址+vxlan设备地址，这些mac具体对应的ip可以在对应的对端网络通过查看arp表获取，例如在控制节点的对应网络中，即<code>qdhcp-7f850748-2d01-4f88-95fa-41b6144b1c02</code>命名空间中的arp表如下</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">[root@controller</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-meta z-group z-expansion z-tilde"><span class="z-variable z-language z-tilde z-shell">~</span></span>]# ip netns exec qrouter-e651f481-55aa-46a7-aa62-96ef71e5bac3 ip a</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">......</span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">3:</span></span><span class="z-meta z-function-call z-arguments z-shell"> qr-31b0feaa-20@if15: <span class="z-keyword z-operator z-assignment z-redirection z-shell">&lt;</span>BROADCAST,MULTICAST,UP,LOWER_UP<span class="z-keyword z-operator z-assignment z-redirection z-shell">&gt;</span> mtu 1450 qdisc noqueue state UP group default qlen 1000</span>
</span><span class="z-source z-shell z-bash">    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">link/ether</span></span><span class="z-meta z-function-call z-arguments z-shell"> fa:16:3e:3d:18:d0 brd ff:ff:ff:ff:ff:ff link-netnsid 0</span>
</span><span class="z-source z-shell z-bash">    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">inet</span></span><span class="z-meta z-function-call z-arguments z-shell"> 10.10.10.1/24 brd 10.10.10.255 scope global qr-31b0feaa-20</span>
</span><span class="z-source z-shell z-bash">       <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">valid_lft</span></span><span class="z-meta z-function-call z-arguments z-shell"> forever preferred_lft forever</span>
</span><span class="z-source z-shell z-bash">    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">inet6</span></span><span class="z-meta z-function-call z-arguments z-shell"> fe80::f816:3eff:fe3d:18d0/64 scope link</span>
</span><span class="z-source z-shell z-bash">       <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">valid_lft</span></span><span class="z-meta z-function-call z-arguments z-shell"> forever preferred_lft forever</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">[root@controller</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-meta z-group z-expansion z-tilde"><span class="z-variable z-language z-tilde z-shell">~</span></span>]# ip netns exec qrouter-e651f481-55aa-46a7-aa62-96ef71e5bac3 arp</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">Address</span></span><span class="z-meta z-function-call z-arguments z-shell">                  HWtype  HWaddress           Flags Mask            Iface</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">10.10.10.133</span></span><span class="z-meta z-function-call z-arguments z-shell">             ether   fa:16:3e:68:60:74   C                     qr-31b0feaa-20</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">gateway</span></span><span class="z-meta z-function-call z-arguments z-shell">                  ether   00:50:56:ea:8e:2f   C                     qg-f00694f6-24</span>
</span></code></pre>
<p>在实例中的对应表如下
<img src="https://image.boychai.xyz/img/Pasted%20image%2020250217193639.png" alt="" />
控制节点的ip即当前vxlan网络的网关<code>10.10.10.1</code>mac地址是<code>fa:16:3e:3d:18:d0</code>，实例的ip是<code>10.10.10.133</code>mac地址是<code>fa:16:3e:68:60:74</code>，在对方节点学习到的arp也是如此，当发包的时候这些信息也都会存储在数据包中(<code>不仅仅是当前网络所有的网络都是这样的具体参考计算机网络学科</code>)，vxlan设备会拿到这些信息去查询<code>FDB</code>表，例如在计算点<code>fa:16:3e:3d:18:d0</code>这个mac地址对应的ip是<code>172.16.0.11</code>那么vxlan设备就会在这个数据包的基础上套一层<code>源地址</code>、<code>目的地址</code>、<code>VNI</code>标识等其他信息，这里不细说封装，源地址即<code>linuxbridge_agent</code>配置中的<code>local_ip</code>即<code>172.16.0.31</code>，对应的也会从这个地址的网卡发包，目的地址就是刚才查询到的<code>FDB</code>的地址，即<code>172.16.0.11</code>，然后<code>VNI</code>标识是用来区分网络的，因为所有的数据包都去走这个vxlan的udp端口，具体区分网络的方式就是通过这个<code>VNI</code>标识，封装好相关数据之后会发给对端，具体的对端端口可以通过下面命令获取</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">[root@controller</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-meta z-group z-expansion z-tilde"><span class="z-variable z-language z-tilde z-shell">~</span></span>]# ip<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>d</span> link show vxlan-1</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">8:</span></span><span class="z-meta z-function-call z-arguments z-shell"> vxlan-1: <span class="z-keyword z-operator z-assignment z-redirection z-shell">&lt;</span>BROADCAST,MULTICAST,UP,LOWER_UP<span class="z-keyword z-operator z-assignment z-redirection z-shell">&gt;</span> mtu 1450 qdisc noqueue master brq7f850748-2d state UNKNOWN mode DEFAULT</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">group</span></span><span class="z-meta z-function-call z-arguments z-shell"> default qlen 1000</span>
</span><span class="z-source z-shell z-bash">    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">link/ether</span></span><span class="z-meta z-function-call z-arguments z-shell"> 0a:b6:1f:77:c4:1b brd ff:ff:ff:ff:ff:ff promiscuity 1</span>
</span><span class="z-source z-shell z-bash">    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">vxlan</span></span><span class="z-meta z-function-call z-arguments z-shell"> id 1 dev ens37 srcport 0 0 dstport 8472 ageing 300 noudpcsum noudp6zerocsumtx noudp6zerocsumrx</span>
</span><span class="z-source z-shell z-bash">    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">bridge_slave</span></span><span class="z-meta z-function-call z-arguments z-shell"> state forwarding priority 32 cost 100 hairpin off guard off root_block off fastleave off learning on</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">flood</span></span><span class="z-meta z-function-call z-arguments z-shell"> on port_id 0x8001 port_no 0x1 designated_port 32769 designated_cost 0 designated_bridge 8000.a:b6:1f:77:c4:1b designated_root 8000.a:b6:1f:77:c4:1b hold_timer    0.00 message_age_timer    0.00 forward_delay_timer    0.00 topology_change_ack 0 config_pending 0 proxy_arp off proxy_arp_wifi off mcast_router 1 mcast_fast_leave off mcast_flood on addrgenmode eui64 numtxqueues 1 numrxqueues 1 gso_max_size 65536 gso_max_segs 65535</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">[root@controller</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-meta z-group z-expansion z-tilde"><span class="z-variable z-language z-tilde z-shell">~</span></span>]# ss<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>unl</span></span><span class="z-keyword z-operator z-logical z-pipe z-shell">|</span><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">grep</span></span><span class="z-meta z-function-call z-arguments z-shell"> 8472</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">UNCONN</span></span><span class="z-meta z-function-call z-arguments z-shell">     0      0            <span class="z-keyword z-operator z-regexp z-quantifier z-shell">*</span>:8472                     <span class="z-keyword z-operator z-regexp z-quantifier z-shell">*</span>:<span class="z-keyword z-operator z-regexp z-quantifier z-shell">*</span></span>
</span></code></pre>
<p>所有有vxlan设备的主机应该都是差不多的，vxlan的标准端口是<code>4789</code>，他这里指定的是<code>8472</code>，这个端口好像是思科的标准，这里的端口是内核负责监听的，所以这里你是不可以通过进程的形式找到他的监听程序的，他拿到数据就会丢到相应的<code>VXLAN</code>设备中这个设备会把这个包的最外层也就是上一个<code>VXLAN</code>设备给封装的相关内容剔除然后进行转发原本的地址，这样就实现了通信。
再说一下浮动IP，这里我创建一个浮动IP给当前实例绑定上，如下图
<img src="https://image.boychai.xyz/img/Pasted%20image%2020250217202736.png" alt="" />
绑定之后发现计算节点的网络信息并没有该边而是在计算节在<code>qrouter-e651f481-55aa-46a7-aa62-96ef71e5bac3</code>命名空间中的出网接口增加了一个IP，配置如下</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">[root@controller</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-meta z-group z-expansion z-tilde"><span class="z-variable z-language z-tilde z-shell">~</span></span>]# ip netns exec qrouter-e651f481-55aa-46a7-aa62-96ef71e5bac3 ip a</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">2:</span></span><span class="z-meta z-function-call z-arguments z-shell"> qg-f00694f6-24@if14: <span class="z-keyword z-operator z-assignment z-redirection z-shell">&lt;</span>BROADCAST,MULTICAST,UP,LOWER_UP<span class="z-keyword z-operator z-assignment z-redirection z-shell">&gt;</span> mtu 1500 qdisc noqueue state UP group default qlen 1000</span>
</span><span class="z-source z-shell z-bash">    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">link/ether</span></span><span class="z-meta z-function-call z-arguments z-shell"> fa:16:3e:6a:e4:80 brd ff:ff:ff:ff:ff:ff link-netnsid 0</span>
</span><span class="z-source z-shell z-bash">    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">inet</span></span><span class="z-meta z-function-call z-arguments z-shell"> 10.0.0.208/24 brd 10.0.0.255 scope global qg-f00694f6-24</span>
</span><span class="z-source z-shell z-bash">       <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">valid_lft</span></span><span class="z-meta z-function-call z-arguments z-shell"> forever preferred_lft forever</span>
</span><span class="z-source z-shell z-bash">    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">inet</span></span><span class="z-meta z-function-call z-arguments z-shell"> 10.0.0.210/32 brd 10.0.0.210 scope global qg-f00694f6-24</span>
</span><span class="z-source z-shell z-bash">       <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">valid_lft</span></span><span class="z-meta z-function-call z-arguments z-shell"> forever preferred_lft forever</span>
</span><span class="z-source z-shell z-bash">    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">inet6</span></span><span class="z-meta z-function-call z-arguments z-shell"> fe80::f816:3eff:fe6a:e480/64 scope link</span>
</span><span class="z-source z-shell z-bash">       <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">valid_lft</span></span><span class="z-meta z-function-call z-arguments z-shell"> forever preferred_lft forever</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">3:</span></span><span class="z-meta z-function-call z-arguments z-shell"> qr-31b0feaa-20@if15: <span class="z-keyword z-operator z-assignment z-redirection z-shell">&lt;</span>BROADCAST,MULTICAST,UP,LOWER_UP<span class="z-keyword z-operator z-assignment z-redirection z-shell">&gt;</span> mtu 1450 qdisc noqueue state UP group default qlen 1000</span>
</span><span class="z-source z-shell z-bash">    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">link/ether</span></span><span class="z-meta z-function-call z-arguments z-shell"> fa:16:3e:3d:18:d0 brd ff:ff:ff:ff:ff:ff link-netnsid 0</span>
</span><span class="z-source z-shell z-bash">    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">inet</span></span><span class="z-meta z-function-call z-arguments z-shell"> 10.10.10.1/24 brd 10.10.10.255 scope global qr-31b0feaa-20</span>
</span><span class="z-source z-shell z-bash">       <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">valid_lft</span></span><span class="z-meta z-function-call z-arguments z-shell"> forever preferred_lft forever</span>
</span><span class="z-source z-shell z-bash">    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">inet6</span></span><span class="z-meta z-function-call z-arguments z-shell"> fe80::f816:3eff:fe3d:18d0/64 scope link</span>
</span><span class="z-source z-shell z-bash">       <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">valid_lft</span></span><span class="z-meta z-function-call z-arguments z-shell"> forever preferred_lft forever</span>
</span></code></pre>
<p>对应的路由转发相关的规则会在iptables体现，具体参考下面命令</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">[root@controller</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-meta z-group z-expansion z-tilde"><span class="z-variable z-language z-tilde z-shell">~</span></span>]# ip netns exec qrouter-e651f481-55aa-46a7-aa62-96ef71e5bac3 iptables<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>t</span> nat<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>L</span><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>n</span><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>v</span></span><span class="z-keyword z-operator z-logical z-pipe z-shell">|</span><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">grep</span></span><span class="z-meta z-function-call z-arguments z-shell"> 210</span>
</span><span class="z-source z-shell z-bash">    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">0</span></span><span class="z-meta z-function-call z-arguments z-shell">     0 DNAT       all<span class="z-keyword z-operator z-end-of-options z-shell">  --</span></span><span class="z-meta z-function-call z-arguments z-shell">  <span class="z-keyword z-operator z-regexp z-quantifier z-shell">*</span>      <span class="z-keyword z-operator z-regexp z-quantifier z-shell">*</span>       0.0.0.0/0            10.0.0.210           to:10.10.10.133</span>
</span><span class="z-source z-shell z-bash">    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">0</span></span><span class="z-meta z-function-call z-arguments z-shell">     0 DNAT       all<span class="z-keyword z-operator z-end-of-options z-shell">  --</span></span><span class="z-meta z-function-call z-arguments z-shell">  <span class="z-keyword z-operator z-regexp z-quantifier z-shell">*</span>      <span class="z-keyword z-operator z-regexp z-quantifier z-shell">*</span>       0.0.0.0/0            10.0.0.210           to:10.10.10.133</span>
</span><span class="z-source z-shell z-bash">    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">0</span></span><span class="z-meta z-function-call z-arguments z-shell">     0 SNAT       all<span class="z-keyword z-operator z-end-of-options z-shell">  --</span></span><span class="z-meta z-function-call z-arguments z-shell">  <span class="z-keyword z-operator z-regexp z-quantifier z-shell">*</span>      <span class="z-keyword z-operator z-regexp z-quantifier z-shell">*</span>       10.10.10.133         0.0.0.0/0            to:10.0.0.210</span>
</span></code></pre>
<p>当前网络的结构关系如下图
<img src="https://image.boychai.xyz/img/Pasted%20image%2020250217211239.png" alt="" /></p>
<h1 id="si-kao-zong-jie">思考总结</h1>
<p>在研究openstack网络<code>Neutron</code>组件的过程中，心里好多疑问，我把它总结到这里，问题以及验证。</p>
<h2 id="zai-flatwang-luo-zhong-nei-bu-he-wai-bu-de-dhcpwei-shen-me-ke-yi-zuo-dao-hu-bu-gan-yu">在FLAT网络中内部和外部的DHCP为什么可以做到互不干预？</h2>
<p>这个问题其实并不严谨，我当时是上面<code>供应商-Provider网络</code>的结构，我外部是采用VMware的NAT网络，我给开了一个内部DHCP，配置如图
<img src="https://image.boychai.xyz/img/Pasted%20image%2020250216180004.png" alt="" />
然而我FLAT的子网中也配置了一个<code>DHCP-Agent</code>,如下图
<img src="https://image.boychai.xyz/img/Pasted%20image%2020250216180129.png" alt="" />
我发现它们两个DHCP互不干预，当子网的DHCP关闭，对应子网内的实例是无法通过外部DHCP获取IP的，然后外部的DHCP关掉，内部的打开，外部的对应网络下的虚机也是无法通过内部DHCP获取到IP的。各种文档解释<code>FLAT</code>网络都是相当于直连，但是为什么当前的的环境下DHCP不互通？而且我内部甚至可以使用外部的网关进行上网？我查了好多文章都没发现有人说这个的，我就进入虚机自己分析了，我最开始怀疑他做了内部隔离，就是两个广播域，他通过软件的方式去做映射，我通过把内部子网DHCP关掉，这样内部的实例就会去播报arp宣告，我发现不管是那台主机去抓包都会拿到他广播的数据包，并且外部的DHCP是回复了他的数据包的，这就很奇怪，如下图
<img src="https://image.boychai.xyz/img/Pasted%20image%2020250216191338.png" alt="" />
首先是第一个红框的内容，实例发送了DHCP广播<code>Discover</code>包，然而<code>10.0.0.254</code>明明给他了一个ip<code>10.0.0.254</code>但是后续就没了，按照正常顺序他应该回复一个<code>DHCP Request</code>的一个确认数据包，但是他这里没后续，并且继续去广播<code>Discover</code>包，而且他依旧回复了，给他了一个<code>10.0.0.161</code>，中途外部的DHCP一直广播ARP谁是这个他分配的这个<code>ip</code>一直也没有得到回复，后续一直再重复这个过程，这里可以判断出它们确实都在一个广播域中，只是客户端一直没去使用外部DHCP，在openstack网络结构中这一层的网桥(我这里叫做第二层网桥)，如图
<img src="https://image.boychai.xyz/img/Pasted%20image%2020250216192205.png" alt="" />
他有一个数据包过滤的作用，这里去计算节点中查看iptables过滤规则，发现了端倪，规则如下</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">[root@compute1</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-meta z-group z-expansion z-tilde"><span class="z-variable z-language z-tilde z-shell">~</span></span>]# iptables-save</span> <span class="z-keyword z-operator z-logical z-pipe z-shell">|</span> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">grep</span></span><span class="z-meta z-function-call z-arguments z-shell"><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>E</span> <span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>67|68<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">:INPUT</span></span><span class="z-meta z-function-call z-arguments z-shell"> ACCEPT <span class="z-keyword z-control z-regexp z-set z-begin z-shell">[</span>127064:177468678<span class="z-keyword z-control z-regexp z-set z-end z-shell">]</span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">-A</span></span><span class="z-meta z-function-call z-arguments z-shell"> neutron-linuxbri-i76c0c08c-7<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>d</span> 10.0.0.206/32<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>p</span> udp<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>m</span> udp<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>sport</span> 67<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>dport</span> 68<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>j</span> RETURN</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">-A</span></span><span class="z-meta z-function-call z-arguments z-shell"> neutron-linuxbri-i76c0c08c-7<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>d</span> 255.255.255.255/32<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>p</span> udp<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>m</span> udp<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>sport</span> 67<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>dport</span> 68<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>j</span> RETURN</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">-A</span></span><span class="z-meta z-function-call z-arguments z-shell"> neutron-linuxbri-o76c0c08c-7<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>s</span> 0.0.0.0/32<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>d</span> 255.255.255.255/32<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>p</span> udp<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>m</span> udp<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>sport</span> 68<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>dport</span> 67<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>m</span> comment<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>comment</span> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&quot;</span>Allow DHCP client traffic.<span class="z-punctuation z-definition z-string z-end z-shell">&quot;</span></span><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>j</span> RETURN</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">-A</span></span><span class="z-meta z-function-call z-arguments z-shell"> neutron-linuxbri-o76c0c08c-7<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>p</span> udp<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>m</span> udp<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>sport</span> 68<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>dport</span> 67<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>m</span> comment<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>comment</span> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&quot;</span>Allow DHCP client traffic.<span class="z-punctuation z-definition z-string z-end z-shell">&quot;</span></span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">-j</span></span><span class="z-meta z-function-call z-arguments z-shell"> RETURN</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">-A</span></span><span class="z-meta z-function-call z-arguments z-shell"> neutron-linuxbri-o76c0c08c-7<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>p</span> udp<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>m</span> udp<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>sport</span> 67<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>dport</span> 68<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>m</span> comment<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>comment</span> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&quot;</span>Prevent DHCP Spoofing by VM.<span class="z-punctuation z-definition z-string z-end z-shell">&quot;</span></span><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>j</span> DROP</span>
</span></code></pre>
<p>比较重要的是这两条规则，第一条规则如下</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">-A</span></span><span class="z-meta z-function-call z-arguments z-shell"> neutron-linuxbri-i76c0c08c-7<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>d</span> 10.0.0.206/32<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>p</span> udp<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>m</span> udp<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>sport</span> 67<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>dport</span> 68<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>j</span> RETURN</span>
</span></code></pre>
<p>第一条规则是当DHCP分配的地址是<code>10.0.0.206</code>的话则把这条丢到原链上的，即原本的<code>INPUT</code>、<code>OUTPUT</code>中只要是放行的则这条就是通过，去看了看原链上的规则就是<code>ACCEPT</code>,规则如下</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">[root@compute1</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-meta z-group z-expansion z-tilde"><span class="z-variable z-language z-tilde z-shell">~</span></span>]# iptables<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>L</span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">Chain</span></span><span class="z-meta z-function-call z-arguments z-shell"> INPUT (policy ACCEPT</span><span class="z-meta z-function-call z-shell"></span>)
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">target</span></span><span class="z-meta z-function-call z-arguments z-shell">     prot opt source               destination</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">neutron-linuxbri-INPUT</span></span><span class="z-meta z-function-call z-arguments z-shell">  all<span class="z-keyword z-operator z-end-of-options z-shell">  --</span></span><span class="z-meta z-function-call z-arguments z-shell">  anywhere             anywhere</span>
</span><span class="z-source z-shell z-bash">
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">Chain</span></span><span class="z-meta z-function-call z-arguments z-shell"> FORWARD (policy ACCEPT</span><span class="z-meta z-function-call z-shell"></span>)
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">target</span></span><span class="z-meta z-function-call z-arguments z-shell">     prot opt source               destination</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">neutron-filter-top</span></span><span class="z-meta z-function-call z-arguments z-shell">  all<span class="z-keyword z-operator z-end-of-options z-shell">  --</span></span><span class="z-meta z-function-call z-arguments z-shell">  anywhere             anywhere</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">neutron-linuxbri-FORWARD</span></span><span class="z-meta z-function-call z-arguments z-shell">  all<span class="z-keyword z-operator z-end-of-options z-shell">  --</span></span><span class="z-meta z-function-call z-arguments z-shell">  anywhere             anywhere</span>
</span><span class="z-source z-shell z-bash">
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">Chain</span></span><span class="z-meta z-function-call z-arguments z-shell"> OUTPUT (policy ACCEPT</span><span class="z-meta z-function-call z-shell"></span>)
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">target</span></span><span class="z-meta z-function-call z-arguments z-shell">     prot opt source               destination</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">neutron-filter-top</span></span><span class="z-meta z-function-call z-arguments z-shell">  all<span class="z-keyword z-operator z-end-of-options z-shell">  --</span></span><span class="z-meta z-function-call z-arguments z-shell">  anywhere             anywhere</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">neutron-linuxbri-OUTPUT</span></span><span class="z-meta z-function-call z-arguments z-shell">  all<span class="z-keyword z-operator z-end-of-options z-shell">  --</span></span><span class="z-meta z-function-call z-arguments z-shell">  anywhere             anywhere</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">......</span></span>
</span></code></pre>
<p>那就是说他这个实例允许收到这个ip的DHCP回包。再去看第二条，规则如下</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">-A</span></span><span class="z-meta z-function-call z-arguments z-shell"> neutron-linuxbri-o76c0c08c-7<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>p</span> udp<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>m</span> udp<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>sport</span> 67<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>dport</span> 68<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>m</span> comment<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>comment</span> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&quot;</span>Prevent DHCP Spoofing by VM.<span class="z-punctuation z-definition z-string z-end z-shell">&quot;</span></span><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>j</span> DROP</span>
</span></code></pre>
<p>iptables的规则是从上到下去匹配的，如果不符合上面<code>206</code>的规则那么这条将会丢弃所有DHCP的<code>Offer</code>包，就导致不管子网内的主机有没有配置DHCP，都没办法使用外部的DHCP。好，现在第一个疑问解决了，再看第二个为什么内部DHCP开启没办法给外部主机分配DHCP，我直接把VMware的DHCP关掉，关掉之后开一台这个网络的虚机，让他去通过DHCP获取IP，然后我在控制节点对应QDHCP的命名空间中去抓QDHCP的网卡，当外部主机区获取IP的时候抓到了下面的数据，如图
<img src="https://image.boychai.xyz/img/Pasted%20image%2020250216195031.png" alt="" />
发现他一直在发包DHCP的<code>Discover</code>包，一直在广播域中去找DHCP拿ip，但是<code>QDHCP</code>并没有回应他，到这里我就已经明白了，<code>Neutron</code>他自己维护的DHCP只会对集群自己的管理的实例进行服务，实现的方式估计也是通过MAC地址实现过滤，当符合他ip的MAC则就分配这个ip，如果不符合那么就不作为，具体可以参考他QDHCP实现软件的相关配置，我默认配置的DHCP-Agent实现方式如下</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">[root@controller</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-meta z-group z-expansion z-tilde"><span class="z-variable z-language z-tilde z-shell">~</span></span>]# cat /etc/neutron/dhcp_agent.ini</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">[DEFAULT]</span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">interface_driver</span></span><span class="z-meta z-function-call z-arguments z-shell"> = linuxbridge</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">dhcp_driver</span></span><span class="z-meta z-function-call z-arguments z-shell"> = neutron.agent.linux.dhcp.Dnsmasq</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">enable_isolated_metadata</span></span><span class="z-meta z-function-call z-arguments z-shell"> = true</span>
</span></code></pre>
<p>他的实现是采用<code>Dnsmasq</code>软件，我们去看一下他的启动参数，通过下面的命令拿到</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">[root@controller</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-meta z-group z-expansion z-tilde"><span class="z-variable z-language z-tilde z-shell">~</span></span>]# ip netns exec qdhcp-dd604587-3542-409b-9ca8-eed06840fb55 ps aux</span> <span class="z-keyword z-operator z-logical z-pipe z-shell">|</span><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">grep</span></span><span class="z-meta z-function-call z-arguments z-shell"> dnsmasq</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">nobody</span></span><span class="z-meta z-function-call z-arguments z-shell">     7584  0.0  0.0  56128  1068 <span class="z-keyword z-operator z-regexp z-quantifier z-shell">?</span>        S    17:22   0:00 dnsmasq<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>no-hosts</span><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>no-resolv</span><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>pid-file</span><span class="z-keyword z-operator z-assignment z-option z-shell">=</span>/var/lib/neutron/dhcp/dd604587-3542-409b-9ca8-eed06840fb55/pid<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>dhcp-hostsfile</span><span class="z-keyword z-operator z-assignment z-option z-shell">=</span>/var/lib/neutron/dhcp/dd604587-3542-409b-9ca8-eed06840fb55/host<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>addn-hosts</span><span class="z-keyword z-operator z-assignment z-option z-shell">=</span>/var/lib/neutron/dhcp/dd604587-3542-409b-9ca8-eed06840fb55/addn_hosts<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>dhcp-optsfile</span><span class="z-keyword z-operator z-assignment z-option z-shell">=</span>/var/lib/neutron/dhcp/dd604587-3542-409b-9ca8-eed06840fb55/opts<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>dhcp-leasefile</span><span class="z-keyword z-operator z-assignment z-option z-shell">=</span>/var/lib/neutron/dhcp/dd604587-3542-409b-9ca8-eed06840fb55/leases<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>dhcp-match</span><span class="z-keyword z-operator z-assignment z-option z-shell">=</span>set:ipxe,175<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>dhcp-userclass</span><span class="z-keyword z-operator z-assignment z-option z-shell">=</span>set:ipxe6,iPXE<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>local-service</span><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>bind-dynamic</span><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>dhcp-range</span><span class="z-keyword z-operator z-assignment z-option z-shell">=</span>set:subnet-69611b38-36b5-4e98-b47e-949c2137dbe1,10.0.0.0,static,255.255.255.0,86400s<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>dhcp-option-force</span><span class="z-keyword z-operator z-assignment z-option z-shell">=</span>option:mtu,1500<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>dhcp-lease-max</span><span class="z-keyword z-operator z-assignment z-option z-shell">=</span>256<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>conf-file</span><span class="z-keyword z-operator z-assignment z-option z-shell">=</span><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>domain</span><span class="z-keyword z-operator z-assignment z-option z-shell">=</span>openstacklocal</span>
</span></code></pre>
<p>具体的这些参数可以自己GPT，我这里说一下软件是怎么实现的这个功能，他的行参中有一项<code>--dhcp-hostsfile=/var/lib/neutron/dhcp/dd604587-3542-409b-9ca8-eed06840fb55/host</code>，这个参数的作用是加载一个 预定义的 MAC-IP 映射文件，仅响应文件中列出的 MAC 地址的 DHCP 请求。这个文件是由<code>neutron</code>去管理，内容可以查看一下</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">[root@controller</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-meta z-group z-expansion z-tilde"><span class="z-variable z-language z-tilde z-shell">~</span></span>]# cat /var/lib/neutron/dhcp/dd604587-3542-409b-9ca8-eed06840fb55/host</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">fa:16:3e:4d:6a:b1,host-10-0-0-206.openstacklocal,10.0.0.206</span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">fa:16:3e:cb:5e:78,host-10-0-0-200.openstacklocal,10.0.0.200</span></span>
</span></code></pre>
<p>这里就存着他自己和我的实例的对应表。到这里这个问题就清晰了，互不干预的原因是因为它内部有过滤规则和相应条件，内部只会把内部的DHCP包交给实例，否则会过滤掉，并且内部的DHCP不会去响应外部机器的<code>Discover</code>包。</p>
<h2 id="liang-ceng-wang-qiao-wang-qiao-he-openstackzhong-de-gai-nian-dui-ying-guan-xi">两层网桥网桥和OpenStack中的概念对应关系</h2>
<p>具体参考下图，具体的实验可以通过在同网络下一个子网一个实例，一个一个去增加实例和子网网络等操作，去节点中查看他们的网络ip网卡网桥对应表。
<img src="https://image.boychai.xyz/img/Pasted%20image%2020250217211208.png" alt="" /></p>
<h2 id="chu-liao-vxlande-shi-xian-huan-you-qi-ta-de-ma">除了VXLAN的实现还有其他的吗？</h2>
<p>有的兄弟，有的，VLAN、VXLAN、GRE、Flat、Geneve、Local，如图
<img src="https://image.boychai.xyz/img/Pasted%20image%2020250217211517.png" alt="" />
它们的区别这里大体讲一下</p>
<ul>
<li>VLAN 我记得VLAN是有数量限制的，应该是4096个，如果采用VLAN的形式还需要在对应的网络设备接口中打<code>Trunk</code>需要配合。</li>
<li>VXLAN 它支持16M的网络数量，可以说是基本用不完，还可以跨数据中心，他就有一点缺点，他需要多一层数据封包，多了额外的计算资源的开销。</li>
<li>GRE 这是个隧道协议，它可以跨多个物理网络，并且支持协议也多灵活度也高，但是他不提供数据加密，通常需要配合<code>IPsec</code>，还有就是带宽和性能受到隧道负载的影响。</li>
<li>Flat 不多说了 就是直连网络，而且没有网络隔离。</li>
<li>Geneve 这个比VXLAN更加优秀，但是他比较新，还没有普及。</li>
<li>Local 虚机想要通信必须在同一个主机并且同一个Local网络中，条件苛刻，但是比较安全。</li>
</ul>
<p>要注意的是，在配置这些网络的时候请在配置中设置支持，配置参考<code>/etc/neutron/plugins/ml2/ml2_conf.ini</code></p>
<pre data-lang="/etc/neutron/plugins/ml2/ml2_conf.ini" class="language-/etc/neutron/plugins/ml2/ml2_conf.ini z-code"><code class="language-/etc/neutron/plugins/ml2/ml2_conf.ini" data-lang="/etc/neutron/plugins/ml2/ml2_conf.ini"><span class="z-text z-plain">type_drivers = flat,vlan,vxlan
</span></code></pre>

        </section>
        
        

        
            
            
            

            
        
            
            
            

            
        
            
            
            

            
        
            
            
            

            
        
        </article>
</main>


<span id="copy-success" class="hidden">
        Copied!
    </span>
    <span id="copy-init" class="hidden">
        Copy code to clipboard
    </span>
    <script defer src="https://synex.space/js/copyCodeToClipboard.min.js"></script>


    </div>
    <footer>
    <section>
        <nav class="socials nav-navs">
        </nav>

        
        <nav class="nav-navs">
        </nav>

        <div class="credits">
            <small>
                

                
                Powered by
                <a rel="" 

 href="https://www.getzola.org">Zola</a>
                &amp;
                <a rel="" 

 href="https://github.com/welpo/tabi">tabi</a>

                </small>
        </div>
    </section>

    <div id="searchModal" class="search-modal js" role="dialog" aria-labelledby="modalTitle">
    <h1 id="modalTitle" class="visually-hidden">Search</h1>
    <div id="modal-content">
        <div id="searchBar">
            <div class="search-icon" aria-hidden="true">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960">
                    <path d="M784-120 532-372q-30 24-69 38t-83 14q-109 0-184.5-75.5T120-580q0-109 75.5-184.5T380-840q109 0 184.5 75.5T640-580q0 44-14 83t-38 69l252 252-56 56ZM380-400q75 0 127.5-52.5T560-580q0-75-52.5-127.5T380-760q-75 0-127.5 52.5T200-580q0 75 52.5 127.5T380-400Z"/>
                </svg>
            </div>
            <input id="searchInput" role="combobox" autocomplete="off" spellcheck="false" aria-expanded="false" aria-controls="results-container" placeholder="Search…"/>
            <div id="clear-search" class="close-icon interactive-icon" tabindex="0" role="button" title="Clear search">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960">
                <path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/>
                </svg>
            </div>
        </div>
        <div id="results-container">
            <div id="results-info"><span id="zero_results"> No results</span>
                <span id="one_results"> $NUMBER result</span>
                <span id="many_results"> $NUMBER results</span><span id="two_results"> $NUMBER results</span>
                <span id="few_results"> $NUMBER results</span>
            </div>
            <div id="results" role="listbox"></div>
        </div>
    </div>
</div>
</footer>


    
    
</body>

</html>
