<!DOCTYPE html>
<html lang="en" >

<head>
    <meta charset="UTF-8"><meta http-equiv="Content-Security-Policy"
content="default-src 'self';font-src 'self' data:;img-src 'self' https://* data:;media-src 'self';style-src 'self';frame-src player.vimeo.com https://www.youtube-nocookie.com;connect-src 'self';script-src 'self' 'self'">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="base" content="https://synex.space/">

    
    <title>
~/S9n3x • Ingress-Nginx传递用户真实ip问题</title>

    
    
    

    
    

    
    
    
        
            <link rel="stylesheet" href="https://synex.space/custom_subset.css?h=0b9535a28bc3d5bf2321">
        
    

    
        <link rel="stylesheet" href="https://synex.space/main.css?h=3716ab3457d2dd050b3c" />
        <link rel="stylesheet" href="https://synex.space/skins/mint.css?h=504215cf6bc10586b487" />

    <meta name="color-scheme" content="light dark" />
        <meta name="description" content="" />
        <meta property="og:description" content="" />

    

    <meta property="og:title" content="Ingress-Nginx传递用户真实ip问题" />
    <meta property="og:type" content="article" />

    
<meta property="og:locale" content="en_GB" />

    <meta property="og:url" content="https:&#x2F;&#x2F;synex.space&#x2F;blog&#x2F;ingress-nginxchuan-di-yong-hu-zhen-shi-ipwen-ti&#x2F;" /><meta property="og:site_name" content="~&#x2F;S9n3x">
        <noscript><link rel="stylesheet" href="https://synex.space/no_js.css"/></noscript>
        <script type="text/javascript" src="https://synex.space/js/initializeTheme.min.js"></script>
        <script defer src="https://synex.space/js/themeSwitcher.min.js"></script>
        <script defer src="https://synex.space/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e"></script>

        
    
</head>


<body>
    <a href="#main-content" id="skip-link">Skip to content</a>
    <header>
    <nav class="navbar">
        <div class="nav-title">
            <a class="home-title" href="https://synex.space/">~&#x2F;S9n3x</a>
        </div>
            <div class="nav-navs">
                <ul>
                        
                            <li>
                                <a class="nav-links no-hover-padding" href="https://synex.space/blog/">blog
                                </a>
                            </li>
                        
                            <li>
                                <a class="nav-links no-hover-padding" href="https://synex.space/archive/">archive
                                </a>
                            </li>
                        
                            <li>
                                <a class="nav-links no-hover-padding" href="https://synex.space/tags/">tags
                                </a>
                            </li>
                        
                            <li>
                                <a class="nav-links no-hover-padding" href="https://synex.space/friends/">friends
                                </a>
                            </li>
                        <li class="menu-icons-container">
                        <ul class="menu-icons-group">
                            <li class="js menu-icon">
                                <div role="button" tabindex="0" id="search-button" class="search-icon interactive-icon" title="Click or press $SHORTCUT to open search" aria-label="Click or press $SHORTCUT to open search">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960">
                                        <path d="M784-120 532-372q-30 24-69 38t-83 14q-109 0-184.5-75.5T120-580q0-109 75.5-184.5T380-840q109 0 184.5 75.5T640-580q0 44-14 83t-38 69l252 252-56 56ZM380-400q75 0 127.5-52.5T560-580q0-75-52.5-127.5T380-760q-75 0-127.5 52.5T200-580q0 75 52.5 127.5T380-400Z"/>
                                    </svg>
                                </div>
                            </li>

                            
                            

                            <li class="theme-switcher-wrapper js"><div
        title="Toggle dark&#x2F;light mode"
        class="theme-switcher"
        tabindex="0"
        role="button"
        aria-label="Toggle dark mode"
        aria-pressed="false">
    </div><div
        title="Reset mode to default"
        class="theme-resetter arrow"
        tabindex="0"
        role="button"
        aria-hidden="true"
        aria-label="Reset mode to default">
    </div>

</li>
</ul>
                    </li>
                </ul>
            </div>
        
    </nav>
</header>

    <div class="content" id="main-content">

        
        





<main>
    <article class="h-entry">
        <h1 class="p-name article-title">
            Ingress-Nginx传递用户真实ip问题
        </h1>
        <a class="u-url u-uid" href="https://synex.space/blog/ingress-nginxchuan-di-yong-hu-zhen-shi-ipwen-ti/"></a>

        <ul class="meta"><span class="hidden p-author h-card">
<a rel="author" href="https:&#x2F;&#x2F;synex.space&#x2F;" class="u-url " title=""></a>
</span>
<li><time class="dt-published" datetime="2023-08-25T09:53:00">25th Aug 2023</time></li><li title="1193 words"><span class='separator' aria-hidden='true'>•</span>6 min read</li><li class="tag"><span class='separator' aria-hidden='true'>•</span>Tags:&nbsp;</li><li class="tag"><a class="p-category" href="https://synex.space/tags/kubernetes/">Kubernetes</a>,&nbsp;</li><li class="tag"><a class="p-category" href="https://synex.space/tags/wen-ti-jie-jue/">问题解决</a>,&nbsp;</li><li class="tag"><a class="p-category" href="https://synex.space/tags/ingress-nginx/">Ingress-Nginx</a></li>
        </ul><section class="e-content body"><h1 id="yin-ru-wen-ti">引入问题</h1>
<p>我的K8s环境是宿主机的hyper-v虚拟出来的，如果要映射到外面则还需要再我的宿主机上面再做一层反代，我采用的是nginx，当ingress整好之后，我从我从我腾讯云上复制了一段nginx配置放到了我的宿主机，<strong>主要配置</strong>如下：</p>
<pre data-lang="nginx" class="language-nginx z-code"><code class="language-nginx" data-lang="nginx"><span class="z-text z-plain">location /test/ {
</span><span class="z-text z-plain">       proxy_pass http://kubernetes.boychai.xyz/test/;
</span><span class="z-text z-plain">       proxy_set_header Host $host;
</span><span class="z-text z-plain">       proxy_set_header X-Real-IP $remote_addr; 
</span><span class="z-text z-plain">       proxy_set_header REMOTE-HOST $remote_addr;
</span><span class="z-text z-plain">       proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
</span><span class="z-text z-plain">}
</span></code></pre>
<p>为了防止传入的ip是代理主机的ip我这里设置了Host、X-Real-IP、REMOTE-HOST、X-Forwarded-For。经过测试之后发现使用宿主机配置的代理访问时返回404，在宿主机上直接却没问题。</p>
<h1 id="fang-wen-wen-ti">访问问题</h1>
<h2 id="ri-zhi">日志</h2>
<p>我去查看了宿主机的nginx日志、ingress-nginx-controller日志、应用程序的日志，发现除了宿主机的nginx均没有日志记录，宿主机日志信息如下</p>
<pre data-lang="nginx_log" class="language-nginx_log z-code"><code class="language-nginx_log" data-lang="nginx_log"><span class="z-text z-plain">111.180.204.54 - - [25/Aug/2023:22:12:21 +0800] &quot;GET /test/ HTTP/1.1&quot; 404 548 &quot;-&quot; &quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/116.0.0.0 Safari/537.36&quot;
</span></code></pre>
<p>除了这一条之外其他的日志均无404。</p>
<h2 id="jie-jue">解决</h2>
<p>看到日志之后有点懵，因为我的宿主机是可以直接访问ingress暴露出来的服务的，而且没有报错正常访问，我是用反代之后就报错404，我最开始以为这个404就是我宿主机报的，但是宿主机的404默认页面会返回nginx的版本，如下图
<img src="https://image.boychai.xyz/article/Pasted%20image%2020230825221640.png" alt="" />
而我反代返回的404页面则是这样的
<img src="https://image.boychai.xyz/article/Pasted%20image%2020230825221711.png" alt="" />
一想就是我ingress返回的页面，但是我去查看ingress-nginx-controller的日志并无404的报错，日志查看命令如下，访问时并无产生记录</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">[root@kubernetes</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-meta z-group z-expansion z-tilde"><span class="z-variable z-language z-tilde z-shell">~</span></span>]# kubectl<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>n</span> ingress-nginx logs<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>f</span>  ingress-nginx-controller-kc5np</span>
</span></code></pre>
<p>我这里去尝试修改宿主机的反代配置，配置如下</p>
<pre data-lang="nginx" class="language-nginx z-code"><code class="language-nginx" data-lang="nginx"><span class="z-text z-plain">location /test/ {
</span><span class="z-text z-plain">       proxy_pass http://kubernetes.boychai.xyz/test/;
</span><span class="z-text z-plain">}
</span></code></pre>
<p>发现这样是可以正常访问程序的，这就奇怪了，难不成还能是因为我设置了这几个header的问题？我挨个注释这些header的配置发现问题出在下面这段配置</p>
<pre data-lang="nginx" class="language-nginx z-code"><code class="language-nginx" data-lang="nginx"><span class="z-text z-plain">proxy_set_header Host $host;
</span></code></pre>
<p>具体原因也没搞清楚但是取消使用这条配置就好了...</p>
<h2 id="yuan-yin">原因</h2>
<p>在Kubernetes的Ingress中,Host 头部用于根据不同的域名(或主机名)将请求路由到不同的服务。每个Ingress规则可以基于请求的 Host 头部将流量路由到不同的后端服务。我宿主机代理的域名和Ingress设置的域名不同，所以导致了这个问题，我外部代理的域名是<code>tools.boychai.xyz</code>而我k8s设置Ingress的域名则是<code>kubernetes.boychai.xyz</code>,当我在宿主机的代理设置了<code>proxy_set_header Host $host;</code>这段配置之后，请求发到Ingress之后,Ingress拿到的路由请求域名则是<code>tools.boychai.xyz</code>，而我又没有设置这个资源则就返回了404。</p>
<h1 id="ipchuan-di-wen-ti">IP传递问题</h1>
<h2 id="ri-zhi-1">日志</h2>
<p>能够访问之后发现最终的应用拿不到真是访问的ip，这里通过nginx直接返回X-Forwarded-For头信息来查看问题出在什么位置，宿主机Nginx配置如下</p>
<pre data-lang="nginx" class="language-nginx z-code"><code class="language-nginx" data-lang="nginx"><span class="z-text z-plain">location /aaa {
</span><span class="z-text z-plain">	default_type text/html;
</span><span class="z-text z-plain">    proxy_set_header X-Real-IP $remote_addr; 
</span><span class="z-text z-plain">    proxy_set_header REMOTE-HOST $remote_addr;
</span><span class="z-text z-plain">    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
</span><span class="z-text z-plain">    return 200 &quot;proxy_add_x_forwarded_for:$proxy_add_x_forwarded_for&quot;;
</span><span class="z-text z-plain">}
</span><span class="z-text z-plain">location /test/ {
</span><span class="z-text z-plain">	   # ingress暴露的地址`http://kubernetes.boychai.xyz/test/`
</span><span class="z-text z-plain">       proxy_pass http://kubernetes.boychai.xyz/test/;
</span><span class="z-text z-plain">       proxy_set_header X-Real-IP $remote_addr; 
</span><span class="z-text z-plain">       proxy_set_header REMOTE-HOST $remote_addr;
</span><span class="z-text z-plain">       proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
</span><span class="z-text z-plain">}
</span></code></pre>
<p>后端Nginx配置如下</p>
<pre data-lang="nginx" class="language-nginx z-code"><code class="language-nginx" data-lang="nginx"><span class="z-text z-plain">location / {
</span><span class="z-text z-plain">	default_type text/html;
</span><span class="z-text z-plain">    return 200 &quot;proxy_add_x_forwarded_for:$proxy_add_x_forwarded_for&quot;;
</span><span class="z-text z-plain">}
</span></code></pre>
<p>这样访问反代的<code>/aaa</code>就是访问反代主机的ip，访问反代的<code>/test</code>就会返回访问nginx的后端访问的ip，访问结果如下
访问<code>/aaa</code>返回</p>
<pre data-lang="text" class="language-text z-code"><code class="language-text" data-lang="text"><span class="z-text z-plain">proxy_add_x_forwarded_for:111.180.204.54
</span></code></pre>
<p>访问<code>/test</code>返回</p>
<pre data-lang="text" class="language-text z-code"><code class="language-text" data-lang="text"><span class="z-text z-plain">proxy_add_x_forwarded_for:192.16.1.1, 192.16.1.2
</span></code></pre>
<h2 id="jie-jue-1">解决</h2>
<p>查看访问返回的信息发现直接访问代理的ip是没问题的，那就是Ingress的锅了，这里的<code>1.1</code>和<code>1.2</code>依次是反代的ip和k8s主机的ip，到ingress这层没有把<code>x_forwarded_for</code>头加进来，这里我去官方翻了翻文档发现了三条和<code>x_forwarded_for</code>有关系的配置，如下</p>
<pre data-lang="yaml" class="language-yaml z-code"><code class="language-yaml" data-lang="yaml"><span class="z-source z-yaml"><span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">data</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span>
</span><span class="z-source z-yaml">  <span class="z-constant z-numeric z-float z-decimal z-yaml"><span class="z-punctuation z-separator z-decimal z-yaml">.</span>..</span>
</span><span class="z-source z-yaml">  <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">compute-full-forwarded-for</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> <span class="z-string z-quoted z-double z-yaml"><span class="z-punctuation z-definition z-string z-begin z-yaml">&quot;</span>true<span class="z-punctuation z-definition z-string z-end z-yaml">&quot;</span></span>
</span><span class="z-source z-yaml">  <span class="z-comment z-line z-number-sign z-yaml"><span class="z-punctuation z-definition z-comment z-line z-number-sign z-yaml">#</span> 这一条可以不加也需要知道
</span></span><span class="z-source z-yaml">  <span class="z-comment z-line z-number-sign z-yaml"><span class="z-punctuation z-definition z-comment z-line z-number-sign z-yaml">#</span> forwarded-for-header: &quot;X-Forwarded-For&quot;
</span></span><span class="z-source z-yaml">  <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">use-forwarded-headers</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> <span class="z-string z-quoted z-double z-yaml"><span class="z-punctuation z-definition z-string z-begin z-yaml">&quot;</span>true<span class="z-punctuation z-definition z-string z-end z-yaml">&quot;</span></span>
</span><span class="z-source z-yaml">
</span></code></pre>
<p>给ingress的cm加上这两条配置即可解决问题，最终<code>/test</code>返回的内容如下</p>
<pre data-lang="text" class="language-text z-code"><code class="language-text" data-lang="text"><span class="z-text z-plain">proxy_add_x_forwarded_for:111.180.204.54, 192.16.1.1, 192.16.1.2
</span></code></pre>
<h2 id="yuan-yin-1">原因</h2>
<p>Ingress默认是没有配置传递真实IP功能的，需要配置，这三条配置和官网文档如下：</p>
<ol>
<li>use-forwarded-headers
文档位置: https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/configmap/#use-forwarded-headers
如果为<code>true</code>，则ingress-nginx会将传入的x-forward-*传递到上游，如果是Ingress上层还有一层ingress则需要配置这一条。如果他直接暴露在公网中或者它基于L3的网络负载后门则不需要管，因为它默认就是false。</li>
<li>forwarded-for-header
文档位置: https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/configmap/#forwarded-for-header
这个用来设置客户端来源的真实IP，默认就是X-Forwarded-For。这里不需要额外配置。</li>
<li>compute-full-forwarded-for
文档位置: https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/configmap/#compute-full-forwarded-for
如果开启了<code>use-forwarded-headers</code>的话，会发现还是没能获取到客户端的真实IP，原因是当前X-Forwaded-Fox变量是从remote_addr获取的，每次都是拿上一层的代理ip，这段配置的作用是将客户端用户访问所经过的代理ip都追加到X-Forwaded-Fox.</li>
</ol>

        </section>
        
        

        
            
            
            

            
        
            
            
            

            
        
            
            
            

            
        
            
            
            

            
        
        </article>
</main>


<span id="copy-success" class="hidden">
        Copied!
    </span>
    <span id="copy-init" class="hidden">
        Copy code to clipboard
    </span>
    <script defer src="https://synex.space/js/copyCodeToClipboard.min.js"></script>


    </div>
    <footer>
    <section>
        <nav class="socials nav-navs">
        </nav>

        
        <nav class="nav-navs">
        </nav>

        <div class="credits">
            <small>
                

                
                Powered by
                <a rel="" 

 href="https://www.getzola.org">Zola</a>
                &amp;
                <a rel="" 

 href="https://github.com/welpo/tabi">tabi</a>

                </small>
        </div>
    </section>

    <div id="searchModal" class="search-modal js" role="dialog" aria-labelledby="modalTitle">
    <h1 id="modalTitle" class="visually-hidden">Search</h1>
    <div id="modal-content">
        <div id="searchBar">
            <div class="search-icon" aria-hidden="true">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960">
                    <path d="M784-120 532-372q-30 24-69 38t-83 14q-109 0-184.5-75.5T120-580q0-109 75.5-184.5T380-840q109 0 184.5 75.5T640-580q0 44-14 83t-38 69l252 252-56 56ZM380-400q75 0 127.5-52.5T560-580q0-75-52.5-127.5T380-760q-75 0-127.5 52.5T200-580q0 75 52.5 127.5T380-400Z"/>
                </svg>
            </div>
            <input id="searchInput" role="combobox" autocomplete="off" spellcheck="false" aria-expanded="false" aria-controls="results-container" placeholder="Search…"/>
            <div id="clear-search" class="close-icon interactive-icon" tabindex="0" role="button" title="Clear search">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960">
                <path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/>
                </svg>
            </div>
        </div>
        <div id="results-container">
            <div id="results-info"><span id="zero_results"> No results</span>
                <span id="one_results"> $NUMBER result</span>
                <span id="many_results"> $NUMBER results</span><span id="two_results"> $NUMBER results</span>
                <span id="few_results"> $NUMBER results</span>
            </div>
            <div id="results" role="listbox"></div>
        </div>
    </div>
</div>
</footer>


    
    
</body>

</html>
