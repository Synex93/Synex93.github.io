<!DOCTYPE html>
<html lang="en" >

<head>
    <meta charset="UTF-8"><meta http-equiv="Content-Security-Policy"
content="default-src 'self';font-src 'self' data:;img-src 'self' https://* data:;media-src 'self';style-src 'self';frame-src player.vimeo.com https://www.youtube-nocookie.com;connect-src 'self';script-src 'self' 'self'">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="base" content="https://synex.space/">

    
    <title>
~/S9n3x • GitLab内存占用过高的问题</title>

    
    
    

    
    

    
    
    
        
            <link rel="stylesheet" href="https://synex.space/custom_subset.css?h=0b9535a28bc3d5bf2321">
        
    

    
        <link rel="stylesheet" href="https://synex.space/main.css?h=3716ab3457d2dd050b3c" />
        <link rel="stylesheet" href="https://synex.space/skins/mint.css?h=504215cf6bc10586b487" />

    <meta name="color-scheme" content="light dark" />
        <meta name="description" content="" />
        <meta property="og:description" content="" />

    

    <meta property="og:title" content="GitLab内存占用过高的问题" />
    <meta property="og:type" content="article" />

    
<meta property="og:locale" content="en_GB" />

    <meta property="og:url" content="https:&#x2F;&#x2F;synex.space&#x2F;blog&#x2F;gitlabnei-cun-zhan-yong-guo-gao-de-wen-ti&#x2F;" /><meta property="og:site_name" content="~&#x2F;S9n3x">
        <noscript><link rel="stylesheet" href="https://synex.space/no_js.css"/></noscript>
        <script type="text/javascript" src="https://synex.space/js/initializeTheme.min.js"></script>
        <script defer src="https://synex.space/js/themeSwitcher.min.js"></script>
        <script defer src="https://synex.space/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e"></script>

        
    
</head>


<body>
    <a href="#main-content" id="skip-link">Skip to content</a>
    <header>
    <nav class="navbar">
        <div class="nav-title">
            <a class="home-title" href="https://synex.space/">~&#x2F;S9n3x</a>
        </div>
            <div class="nav-navs">
                <ul>
                        
                            <li>
                                <a class="nav-links no-hover-padding" href="https://synex.space/blog/">blog
                                </a>
                            </li>
                        
                            <li>
                                <a class="nav-links no-hover-padding" href="https://synex.space/archive/">archive
                                </a>
                            </li>
                        
                            <li>
                                <a class="nav-links no-hover-padding" href="https://synex.space/tags/">tags
                                </a>
                            </li>
                        
                            <li>
                                <a class="nav-links no-hover-padding" href="https://synex.space/friends/">friends
                                </a>
                            </li>
                        <li class="menu-icons-container">
                        <ul class="menu-icons-group">
                            <li class="js menu-icon">
                                <div role="button" tabindex="0" id="search-button" class="search-icon interactive-icon" title="Click or press $SHORTCUT to open search" aria-label="Click or press $SHORTCUT to open search">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960">
                                        <path d="M784-120 532-372q-30 24-69 38t-83 14q-109 0-184.5-75.5T120-580q0-109 75.5-184.5T380-840q109 0 184.5 75.5T640-580q0 44-14 83t-38 69l252 252-56 56ZM380-400q75 0 127.5-52.5T560-580q0-75-52.5-127.5T380-760q-75 0-127.5 52.5T200-580q0 75 52.5 127.5T380-400Z"/>
                                    </svg>
                                </div>
                            </li>

                            
                            

                            <li class="theme-switcher-wrapper js"><div
        title="Toggle dark&#x2F;light mode"
        class="theme-switcher"
        tabindex="0"
        role="button"
        aria-label="Toggle dark mode"
        aria-pressed="false">
    </div><div
        title="Reset mode to default"
        class="theme-resetter arrow"
        tabindex="0"
        role="button"
        aria-hidden="true"
        aria-label="Reset mode to default">
    </div>

</li>
</ul>
                    </li>
                </ul>
            </div>
        
    </nav>
</header>

    <div class="content" id="main-content">

        
        





<main>
    <article class="h-entry">
        <h1 class="p-name article-title">
            GitLab内存占用过高的问题
        </h1>
        <a class="u-url u-uid" href="https://synex.space/blog/gitlabnei-cun-zhan-yong-guo-gao-de-wen-ti/"></a>

        <ul class="meta"><span class="hidden p-author h-card">
<a rel="author" href="https:&#x2F;&#x2F;synex.space&#x2F;" class="u-url " title=""></a>
</span>
<li><time class="dt-published" datetime="2024-11-12T10:43:00">12th Nov 2024</time></li><li title="1058 words"><span class='separator' aria-hidden='true'>•</span>6 min read</li><li class="tag"><span class='separator' aria-hidden='true'>•</span>Tags:&nbsp;</li><li class="tag"><a class="p-category" href="https://synex.space/tags/wen-ti-jie-jue/">问题解决</a>,&nbsp;</li><li class="tag"><a class="p-category" href="https://synex.space/tags/gitlab/">Gitlab</a>,&nbsp;</li><li class="tag"><a class="p-category" href="https://synex.space/tags/nei-cun-zhan-yong/">内存占用</a>,&nbsp;</li><li class="tag"><a class="p-category" href="https://synex.space/tags/diao-hua/">调化</a></li>
        </ul><section class="e-content body"><h1 id="nei-cun-zhan-yong">内存占用</h1>
<p>gitlab内存占用是出奇的高，我这里高的离谱，top一看全都是gitlab的进程
<img src="https://image.boychai.xyz/article/Pasted%20image%2020241111194836.png" alt="占用" /></p>
<h1 id="zu-jian-diao-you">组件调优</h1>
<p>进入容器通过命令<code>gitlab-ctl status</code>可以看到所有运行的组件</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">root@gitlab:/#</span></span><span class="z-meta z-function-call z-arguments z-shell"> gitlab-ctl status</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">run:</span></span><span class="z-meta z-function-call z-arguments z-shell"> alertmanager: (pid 680</span><span class="z-meta z-function-call z-shell"></span>) <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">162s</span></span><span class="z-keyword z-operator z-logical z-continue z-shell">;</span> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">run:</span></span><span class="z-meta z-function-call z-arguments z-shell"> log: (pid 483</span><span class="z-meta z-function-call z-shell"></span>) <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">296s</span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">run:</span></span><span class="z-meta z-function-call z-arguments z-shell"> gitaly: (pid 275</span><span class="z-meta z-function-call z-shell"></span>) <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">324s</span></span><span class="z-keyword z-operator z-logical z-continue z-shell">;</span> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">run:</span></span><span class="z-meta z-function-call z-arguments z-shell"> log: (pid 272</span><span class="z-meta z-function-call z-shell"></span>) <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">324s</span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">run:</span></span><span class="z-meta z-function-call z-arguments z-shell"> gitlab-exporter: (pid 651</span><span class="z-meta z-function-call z-shell"></span>) <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">167s</span></span><span class="z-keyword z-operator z-logical z-continue z-shell">;</span> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">run:</span></span><span class="z-meta z-function-call z-arguments z-shell"> log: (pid 407</span><span class="z-meta z-function-call z-shell"></span>) <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">315s</span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">run:</span></span><span class="z-meta z-function-call z-arguments z-shell"> gitlab-kas: (pid 350</span><span class="z-meta z-function-call z-shell"></span>) <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">317s</span></span><span class="z-keyword z-operator z-logical z-continue z-shell">;</span> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">run:</span></span><span class="z-meta z-function-call z-arguments z-shell"> log: (pid 349</span><span class="z-meta z-function-call z-shell"></span>) <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">317s</span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">run:</span></span><span class="z-meta z-function-call z-arguments z-shell"> gitlab-workhorse: (pid 359</span><span class="z-meta z-function-call z-shell"></span>) <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">317s</span></span><span class="z-keyword z-operator z-logical z-continue z-shell">;</span> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">run:</span></span><span class="z-meta z-function-call z-arguments z-shell"> log: (pid 358</span><span class="z-meta z-function-call z-shell"></span>) <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">317s</span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">run:</span></span><span class="z-meta z-function-call z-arguments z-shell"> logrotate: (pid 274</span><span class="z-meta z-function-call z-shell"></span>) <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">324s</span></span><span class="z-keyword z-operator z-logical z-continue z-shell">;</span> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">run:</span></span><span class="z-meta z-function-call z-arguments z-shell"> log: (pid 271</span><span class="z-meta z-function-call z-shell"></span>) <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">324s</span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">run:</span></span><span class="z-meta z-function-call z-arguments z-shell"> nginx: (pid 363</span><span class="z-meta z-function-call z-shell"></span>) <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">317s</span></span><span class="z-keyword z-operator z-logical z-continue z-shell">;</span> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">run:</span></span><span class="z-meta z-function-call z-arguments z-shell"> log: (pid 362</span><span class="z-meta z-function-call z-shell"></span>) <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">317s</span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">run:</span></span><span class="z-meta z-function-call z-arguments z-shell"> postgres-exporter: (pid 692</span><span class="z-meta z-function-call z-shell"></span>) <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">161s</span></span><span class="z-keyword z-operator z-logical z-continue z-shell">;</span> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">run:</span></span><span class="z-meta z-function-call z-arguments z-shell"> log: (pid 545</span><span class="z-meta z-function-call z-shell"></span>) <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">290s</span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">run:</span></span><span class="z-meta z-function-call z-arguments z-shell"> postgresql: (pid 361</span><span class="z-meta z-function-call z-shell"></span>) <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">317s</span></span><span class="z-keyword z-operator z-logical z-continue z-shell">;</span> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">run:</span></span><span class="z-meta z-function-call z-arguments z-shell"> log: (pid 360</span><span class="z-meta z-function-call z-shell"></span>) <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">317s</span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">run:</span></span><span class="z-meta z-function-call z-arguments z-shell"> prometheus: (pid 661</span><span class="z-meta z-function-call z-shell"></span>) <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">166s</span></span><span class="z-keyword z-operator z-logical z-continue z-shell">;</span> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">run:</span></span><span class="z-meta z-function-call z-arguments z-shell"> log: (pid 465</span><span class="z-meta z-function-call z-shell"></span>) <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">302s</span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">run:</span></span><span class="z-meta z-function-call z-arguments z-shell"> puma: (pid 354</span><span class="z-meta z-function-call z-shell"></span>) <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">317s</span></span><span class="z-keyword z-operator z-logical z-continue z-shell">;</span> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">run:</span></span><span class="z-meta z-function-call z-arguments z-shell"> log: (pid 353</span><span class="z-meta z-function-call z-shell"></span>) <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">317s</span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">run:</span></span><span class="z-meta z-function-call z-arguments z-shell"> redis: (pid 276</span><span class="z-meta z-function-call z-shell"></span>) <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">324s</span></span><span class="z-keyword z-operator z-logical z-continue z-shell">;</span> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">run:</span></span><span class="z-meta z-function-call z-arguments z-shell"> log: (pid 273</span><span class="z-meta z-function-call z-shell"></span>) <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">324s</span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">run:</span></span><span class="z-meta z-function-call z-arguments z-shell"> redis-exporter: (pid 653</span><span class="z-meta z-function-call z-shell"></span>) <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">167s</span></span><span class="z-keyword z-operator z-logical z-continue z-shell">;</span> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">run:</span></span><span class="z-meta z-function-call z-arguments z-shell"> log: (pid 429</span><span class="z-meta z-function-call z-shell"></span>) <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">310s</span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">run:</span></span><span class="z-meta z-function-call z-arguments z-shell"> sidekiq: (pid 365</span><span class="z-meta z-function-call z-shell"></span>) <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">317s</span></span><span class="z-keyword z-operator z-logical z-continue z-shell">;</span> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">run:</span></span><span class="z-meta z-function-call z-arguments z-shell"> log: (pid 364</span><span class="z-meta z-function-call z-shell"></span>) <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">317s</span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">run:</span></span><span class="z-meta z-function-call z-arguments z-shell"> sshd: (pid 33</span><span class="z-meta z-function-call z-shell"></span>) <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">354s</span></span><span class="z-keyword z-operator z-logical z-continue z-shell">;</span> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">run:</span></span><span class="z-meta z-function-call z-arguments z-shell"> log: (pid 32</span><span class="z-meta z-function-call z-shell"></span>) <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">354s</span></span>
</span></code></pre>
<p>默认gitlab会开启这么多的组件,它们的用处如下</p>
<ul>
<li><strong>alertmanager</strong>：用于处理和管理 Prometheus 监控的告警。它负责接收告警信息并发送通知（例如邮件、Slack）。</li>
<li><strong>gitaly</strong>：Git 仓库的服务管理器，负责优化 Git 操作的性能。GitLab 使用 Gitaly 来高效处理仓库请求，如分支操作和合并请求。</li>
<li><strong>gitlab-exporter</strong>：用于导出 GitLab 的性能和健康数据，以便通过 Prometheus 进行监控。</li>
<li><strong>gitlab-kas</strong>：GitLab Kubernetes Agent Server (KAS) 服务，支持 GitLab 与 Kubernetes 集群的通信，用于 DevOps 管理和 CI/CD 集成。</li>
<li><strong>gitlab-workhorse</strong>：HTTP 服务器，用于处理来自客户端的请求（如文件上传/下载）并与 GitLab Rails 应用交互。</li>
<li><strong>logrotate</strong>：日志文件轮转工具，定期管理日志文件，防止日志占用过多的磁盘空间。</li>
<li><strong>nginx</strong>：Web 服务器和反向代理，将来自客户端的 HTTP 请求转发到 GitLab 工作进程（如 puma 和 gitlab-workhorse）。</li>
<li><strong>postgres-exporter</strong>：将 PostgreSQL 数据库的性能指标导出到 Prometheus，用于数据库监控。</li>
<li><strong>postgresql</strong>：GitLab 使用的 PostgreSQL 数据库，用于存储应用数据，如用户信息、项目和配置等。</li>
<li><strong>prometheus</strong>：监控和告警系统，收集 GitLab 和其组件的性能指标，并存储和显示相关监控信息。</li>
<li><strong>puma</strong>：Rails 应用服务器，运行 GitLab 的核心应用逻辑，处理所有核心业务逻辑和 API 请求。</li>
<li><strong>redis</strong>：内存数据库，GitLab 使用 Redis 存储缓存、会话数据和队列任务。</li>
<li><strong>redis-exporter</strong>：导出 Redis 的监控指标到 Prometheus，以监控 Redis 的状态。</li>
<li><strong>sidekiq</strong>：后台任务处理服务，GitLab 使用它来处理异步任务，如发送通知、执行计划任务等。</li>
<li><strong>sshd</strong>：GitLab 的 SSH 服务，使用户可以通过 SSH 协议进行 Git 仓库操作（如推送和克隆），提高数据传输的安全性。</li>
</ul>
<p>对于个人来说，alertmanager、gitlab-exporter、gitlab-kas、postgres-exporter、prometheus、redis-exporter可以说是基本用不到基本都是监控相关的组件，然后gitlab-kas是用来对接k8s的，如果用不到这个功能也完全可以关闭，还有就是如果本地环境有redis和postgresql，这俩组件也完全也可移除。
对于生产环境，可以根据上面所写的组件作用来做移除，如果是一些小型企业我感觉这些组件基本上也用不到，开着就是吃内存。下面开始移除组件
编辑<code>gitlab.rb</code>配置文件，主要是做下面更改</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell"> 关闭alertmanager组件,这条配置大概是再2423行，默认是注释的，他的默认值为true</span><span class="z-comment z-line z-number-sign z-shell">
</span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">alertmanager[<span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>enable<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span>]</span></span><span class="z-meta z-function-call z-arguments z-shell"> = false</span>
</span><span class="z-source z-shell z-bash"><span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell"> 关闭gitlab_exporter组件,这条配置大概率是在2536行，默认是注释的，他的默认值为true</span><span class="z-comment z-line z-number-sign z-shell">
</span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">gitlab_exporter[<span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>enable<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span>]</span></span><span class="z-meta z-function-call z-arguments z-shell"> = false</span>
</span><span class="z-source z-shell z-bash"><span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell"> 关闭gitlab_kas组件,这条配置大概率是在2152行，默认是注释的，他的默认值是true </span><span class="z-comment z-line z-number-sign z-shell">
</span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">gitlab_kas[<span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>enable<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span>]</span></span><span class="z-meta z-function-call z-arguments z-shell"> = false</span>
</span><span class="z-source z-shell z-bash"><span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell"> 关闭postgres_exporter组件,大概在2497行,默认是注释的，默认值是true</span><span class="z-comment z-line z-number-sign z-shell">
</span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">postgres_exporter[<span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>enable<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span>]</span></span><span class="z-meta z-function-call z-arguments z-shell"> = false</span>
</span><span class="z-source z-shell z-bash"><span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell"> 关闭redis-exporter组件,大概率是在2472行,默认是注释的，默认值是true</span><span class="z-comment z-line z-number-sign z-shell">
</span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">redis_exporter[<span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>enable<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span>]</span></span><span class="z-meta z-function-call z-arguments z-shell"> = false</span>
</span><span class="z-source z-shell z-bash"><span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell"> 关闭prometheus组件,大概率是在2576行,默认是注释的，默认值是true</span><span class="z-comment z-line z-number-sign z-shell">
</span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">prometheus_monitoring[<span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>enable<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span>]</span></span><span class="z-meta z-function-call z-arguments z-shell"> = false</span>
</span></code></pre>
<h1 id="pei-zhi-diao-you">配置调优</h1>
<p>在配置种还有不少线程、内存相关的配置，可以参考下面进行修改</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell"> 在1303行有一段下面的配置,他默认值是20,他是sidekiq组件的并发数,因为我是个人使用,我这里依次改成15、10、5发现区别不大,我这里直接用5了,可以根据个人环境来调试</span><span class="z-comment z-line z-number-sign z-shell">
</span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">sidekiq[<span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>concurrency<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span>]</span></span><span class="z-meta z-function-call z-arguments z-shell"> = 5</span>
</span><span class="z-source z-shell z-bash"><span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell"> 在1419行,有一个postgresql的缓存,这个默认是256MB,我这里直接改成64MB了</span><span class="z-comment z-line z-number-sign z-shell">
</span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">postgresql[<span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>shared_buffers<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span>]</span></span><span class="z-meta z-function-call z-arguments z-shell"> = <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&quot;</span>64MB<span class="z-punctuation z-definition z-string z-end z-shell">&quot;</span></span></span>
</span><span class="z-source z-shell z-bash"><span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell"> 在1506行,有一个postgresql的线程数量,它默认为8,我这里改成4了 </span><span class="z-comment z-line z-number-sign z-shell">
</span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">postgresql[<span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>max_worker_processes<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span>]</span></span><span class="z-meta z-function-call z-arguments z-shell"> = 4</span>
</span><span class="z-source z-shell z-bash"><span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell"> 在1271行,有一个Puma线程最大占用,默认使1024,这里修改成256</span><span class="z-comment z-line z-number-sign z-shell">
</span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">puma[<span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>per_worker_max_memory_mb<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span>]</span></span><span class="z-meta z-function-call z-arguments z-shell"> = 256</span>
</span><span class="z-source z-shell z-bash"><span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell"> 在2543行有一段gitlab_exporter组件的配置,默认是true,给他改成false</span><span class="z-comment z-line z-number-sign z-shell">
</span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">gitlab_exporter[<span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>enable<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span>]</span></span><span class="z-meta z-function-call z-arguments z-shell"> = false</span>
</span><span class="z-source z-shell z-bash"><span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell"> 然后再1243有这么几段配置,它们分别代表工作进程数,然后工作进程的线程池大小</span><span class="z-comment z-line z-number-sign z-shell">
</span></span><span class="z-source z-shell z-bash"><span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell"> 默认是2个工作进程最小4最大4,算下来就是8个线程,这里进行修改</span><span class="z-comment z-line z-number-sign z-shell">
</span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">puma[<span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>worker_processes<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span>]</span></span><span class="z-meta z-function-call z-arguments z-shell"> = 2</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">puma[<span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>min_threads<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span>]</span></span><span class="z-meta z-function-call z-arguments z-shell"> = 1</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">puma[<span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>max_threads<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span>]</span></span><span class="z-meta z-function-call z-arguments z-shell"> = 2</span>
</span></code></pre>
<h1 id="wai-zhi-shu-ju-ku">外置数据库</h1>
<p>如果要用外置存储数据库，则可以参考修改下面配置</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">postgresql[<span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>enable<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span>]</span></span><span class="z-meta z-function-call z-arguments z-shell"> = false</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">gitlab_rails[<span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>db_adapter<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span>]</span></span><span class="z-meta z-function-call z-arguments z-shell"> = <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&quot;</span>postgresql<span class="z-punctuation z-definition z-string z-end z-shell">&quot;</span></span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">gitlab_rails[<span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>db_encoding<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span>]</span></span><span class="z-meta z-function-call z-arguments z-shell"> = <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&quot;</span>unicode<span class="z-punctuation z-definition z-string z-end z-shell">&quot;</span></span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">gitlab_rails[<span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>db_database<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span>]</span></span><span class="z-meta z-function-call z-arguments z-shell"> = <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&quot;</span>gitlab<span class="z-punctuation z-definition z-string z-end z-shell">&quot;</span></span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">gitlab_rails[<span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>db_username<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span>]</span></span><span class="z-meta z-function-call z-arguments z-shell"> = <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&quot;</span>gitlab<span class="z-punctuation z-definition z-string z-end z-shell">&quot;</span></span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">gitlab_rails[<span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>db_password<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span>]</span></span><span class="z-meta z-function-call z-arguments z-shell"> = <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&quot;</span>passwd<span class="z-punctuation z-definition z-string z-end z-shell">&quot;</span></span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">gitlab_rails[<span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>db_host<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span>]</span></span><span class="z-meta z-function-call z-arguments z-shell"> = <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&quot;</span>databases.workstation.boychai.xyz<span class="z-punctuation z-definition z-string z-end z-shell">&quot;</span></span></span>
</span></code></pre>
<p>要注意的是，尽量修改配置，而不是增加配置</p>
<h1 id="wai-zhi-huan-cun">外置缓存</h1>
<p>如果要用外置Reids缓存，则可以参考修改下面配置</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">redis[<span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>enable<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span>]</span></span><span class="z-meta z-function-call z-arguments z-shell"> = false</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">gitlab_rails[<span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>redis_host<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span>]</span></span><span class="z-meta z-function-call z-arguments z-shell"> = <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&quot;</span>databases.workstation.boychai.xyz<span class="z-punctuation z-definition z-string z-end z-shell">&quot;</span></span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">gitlab_rails[<span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>redis_password<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span>]</span></span><span class="z-meta z-function-call z-arguments z-shell"> = <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&quot;</span>passwd<span class="z-punctuation z-definition z-string z-end z-shell">&quot;</span></span></span>
</span><span class="z-source z-shell z-bash"><span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell"> 这个是redis的命名空间</span><span class="z-comment z-line z-number-sign z-shell">
</span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">gitlab_rails[<span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>redis_database<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span>]</span></span><span class="z-meta z-function-call z-arguments z-shell"> = 1</span>
</span></code></pre>
<p>要注意的是，尽量修改配置，而不是增加配置</p>
<h1 id="jia-zai-pei-zhi">加载配置</h1>
<p>我当前配置如下</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">[root@localhost</span></span><span class="z-meta z-function-call z-arguments z-shell"> config]# cat gitlab.rb</span> <span class="z-keyword z-operator z-logical z-pipe z-shell">|</span><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">grep</span></span><span class="z-meta z-function-call z-arguments z-shell"><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>Ev</span> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&quot;</span>^#|^$<span class="z-punctuation z-definition z-string z-end z-shell">&quot;</span></span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">external_url</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>......<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">puma[<span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>worker_processes<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span>]</span></span><span class="z-meta z-function-call z-arguments z-shell"> = 2</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">puma[<span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>min_threads<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span>]</span></span><span class="z-meta z-function-call z-arguments z-shell"> = 1</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">puma[<span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>max_threads<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span>]</span></span><span class="z-meta z-function-call z-arguments z-shell"> = 2</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">puma[<span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>per_worker_max_memory_mb<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span>]</span></span><span class="z-meta z-function-call z-arguments z-shell"> = 256</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">sidekiq[<span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>concurrency<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span>]</span></span><span class="z-meta z-function-call z-arguments z-shell"> = 5</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">postgresql[<span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>shared_buffers<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span>]</span></span><span class="z-meta z-function-call z-arguments z-shell"> = <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&quot;</span>64MB<span class="z-punctuation z-definition z-string z-end z-shell">&quot;</span></span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">postgresql[<span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>max_worker_processes<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span>]</span></span><span class="z-meta z-function-call z-arguments z-shell"> = 2</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">gitlab_kas[<span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>enable<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span>]</span></span><span class="z-meta z-function-call z-arguments z-shell"> = false</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">alertmanager[<span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>enable<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span>]</span></span><span class="z-meta z-function-call z-arguments z-shell"> = false</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">redis_exporter[<span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>enable<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span>]</span></span><span class="z-meta z-function-call z-arguments z-shell"> = false</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">postgres_exporter[<span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>enable<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span>]</span></span><span class="z-meta z-function-call z-arguments z-shell"> = false</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">gitlab_exporter[<span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>enable<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span>]</span></span><span class="z-meta z-function-call z-arguments z-shell"> = false</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">prometheus_monitoring[<span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>enable<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span>]</span></span><span class="z-meta z-function-call z-arguments z-shell"> = false</span>
</span></code></pre>
<p>执行<code>gitlab-ctl reconfigure</code>命令进行重载配置,然后直接重启容器</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">root@gitlab:/#</span></span><span class="z-meta z-function-call z-arguments z-shell"> gitlab-ctl reconfigure</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">......</span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">[2024-11-11T13:17:13+00:00]</span></span><span class="z-meta z-function-call z-arguments z-shell"> INFO: Running report handlers</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">Running</span></span><span class="z-meta z-function-call z-arguments z-shell"> handlers complete</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">[2024-11-11T13:17:13+00:00]</span></span><span class="z-meta z-function-call z-arguments z-shell"> INFO: Report handlers complete</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">Infra</span></span><span class="z-meta z-function-call z-arguments z-shell"> Phase complete, 5/633 resources updated in 38 seconds</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">gitlab</span></span><span class="z-meta z-function-call z-arguments z-shell"> Reconfigured!</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">root@gitlab:/#</span></span><span class="z-meta z-function-call z-arguments z-shell"> gitlab-ctl restart</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">ok:</span></span><span class="z-meta z-function-call z-arguments z-shell"> run: gitaly: (pid 1766</span><span class="z-meta z-function-call z-shell"></span>) <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">0s</span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">ok:</span></span><span class="z-meta z-function-call z-arguments z-shell"> run: gitlab-workhorse: (pid 1773</span><span class="z-meta z-function-call z-shell"></span>) <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">0s</span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">ok:</span></span><span class="z-meta z-function-call z-arguments z-shell"> run: logrotate: (pid 1798</span><span class="z-meta z-function-call z-shell"></span>) <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">1s</span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">ok:</span></span><span class="z-meta z-function-call z-arguments z-shell"> run: nginx: (pid 1806</span><span class="z-meta z-function-call z-shell"></span>) <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">0s</span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">ok:</span></span><span class="z-meta z-function-call z-arguments z-shell"> run: postgresql: (pid 1820</span><span class="z-meta z-function-call z-shell"></span>) <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">0s</span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">ok:</span></span><span class="z-meta z-function-call z-arguments z-shell"> run: puma: (pid 1847</span><span class="z-meta z-function-call z-shell"></span>) <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">0s</span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">ok:</span></span><span class="z-meta z-function-call z-arguments z-shell"> run: redis: (pid 1852</span><span class="z-meta z-function-call z-shell"></span>) <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">0s</span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">ok:</span></span><span class="z-meta z-function-call z-arguments z-shell"> run: sidekiq: (pid 1864</span><span class="z-meta z-function-call z-shell"></span>) <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">0s</span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">ok:</span></span><span class="z-meta z-function-call z-arguments z-shell"> run: sshd: (pid 1893</span><span class="z-meta z-function-call z-shell"></span>) <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">0s</span></span>
</span></code></pre>
<p>再次执行<code>gitlab-ctl status</code>查看组件状态</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">root@gitlab:/#</span></span><span class="z-meta z-function-call z-arguments z-shell"> gitlab-ctl status</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">run:</span></span><span class="z-meta z-function-call z-arguments z-shell"> gitaly: (pid 1931</span><span class="z-meta z-function-call z-shell"></span>) <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">180s</span></span><span class="z-keyword z-operator z-logical z-continue z-shell">;</span> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">run:</span></span><span class="z-meta z-function-call z-arguments z-shell"> log: (pid 332</span><span class="z-meta z-function-call z-shell"></span>) <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">726s</span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">run:</span></span><span class="z-meta z-function-call z-arguments z-shell"> gitlab-workhorse: (pid 1942</span><span class="z-meta z-function-call z-shell"></span>) <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">180s</span></span><span class="z-keyword z-operator z-logical z-continue z-shell">;</span> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">run:</span></span><span class="z-meta z-function-call z-arguments z-shell"> log: (pid 437</span><span class="z-meta z-function-call z-shell"></span>) <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">714s</span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">run:</span></span><span class="z-meta z-function-call z-arguments z-shell"> logrotate: (pid 1961</span><span class="z-meta z-function-call z-shell"></span>) <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">180s</span></span><span class="z-keyword z-operator z-logical z-continue z-shell">;</span> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">run:</span></span><span class="z-meta z-function-call z-arguments z-shell"> log: (pid 335</span><span class="z-meta z-function-call z-shell"></span>) <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">726s</span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">run:</span></span><span class="z-meta z-function-call z-arguments z-shell"> nginx: (pid 1968</span><span class="z-meta z-function-call z-shell"></span>) <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">179s</span></span><span class="z-keyword z-operator z-logical z-continue z-shell">;</span> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">run:</span></span><span class="z-meta z-function-call z-arguments z-shell"> log: (pid 435</span><span class="z-meta z-function-call z-shell"></span>) <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">714s</span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">run:</span></span><span class="z-meta z-function-call z-arguments z-shell"> postgresql: (pid 1984</span><span class="z-meta z-function-call z-shell"></span>) <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">179s</span></span><span class="z-keyword z-operator z-logical z-continue z-shell">;</span> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">run:</span></span><span class="z-meta z-function-call z-arguments z-shell"> log: (pid 432</span><span class="z-meta z-function-call z-shell"></span>) <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">714s</span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">run:</span></span><span class="z-meta z-function-call z-arguments z-shell"> puma: (pid 1988</span><span class="z-meta z-function-call z-shell"></span>) <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">178s</span></span><span class="z-keyword z-operator z-logical z-continue z-shell">;</span> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">run:</span></span><span class="z-meta z-function-call z-arguments z-shell"> log: (pid 436</span><span class="z-meta z-function-call z-shell"></span>) <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">714s</span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">run:</span></span><span class="z-meta z-function-call z-arguments z-shell"> redis: (pid 2007</span><span class="z-meta z-function-call z-shell"></span>) <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">178s</span></span><span class="z-keyword z-operator z-logical z-continue z-shell">;</span> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">run:</span></span><span class="z-meta z-function-call z-arguments z-shell"> log: (pid 330</span><span class="z-meta z-function-call z-shell"></span>) <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">726s</span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">run:</span></span><span class="z-meta z-function-call z-arguments z-shell"> sidekiq: (pid 2016</span><span class="z-meta z-function-call z-shell"></span>) <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">176s</span></span><span class="z-keyword z-operator z-logical z-continue z-shell">;</span> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">run:</span></span><span class="z-meta z-function-call z-arguments z-shell"> log: (pid 433</span><span class="z-meta z-function-call z-shell"></span>) <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">714s</span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">run:</span></span><span class="z-meta z-function-call z-arguments z-shell"> sshd: (pid 2499</span><span class="z-meta z-function-call z-shell"></span>) <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">0s</span></span><span class="z-keyword z-operator z-logical z-continue z-shell">;</span> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">run:</span></span><span class="z-meta z-function-call z-arguments z-shell"> log: (pid 40</span><span class="z-meta z-function-call z-shell"></span>) <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">756s</span></span>
</span></code></pre>
<p>再次查看占用,这里是因为刚启动稳定在内存剩余2000m了,具体调优的方式可以参考本文,实际这个占用算式较低的了..
<img src="https://image.boychai.xyz/article/Pasted%20image%2020241111213919.png" alt="占用" /></p>
<h1 id="wai-zhi-shu-ju-huan-jing">外置数据环境</h1>
<p>在我本地K8s环境中，配置如下</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">[root@control</span></span><span class="z-meta z-function-call z-arguments z-shell"> service-gitlab-config-pvc-362bde8b-f3d4-405f-8c00-683815f92fe0]# cat gitlab.rb</span> <span class="z-keyword z-operator z-logical z-pipe z-shell">|</span><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">grep</span></span><span class="z-meta z-function-call z-arguments z-shell"><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>Ev</span> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&quot;</span>^#|^$<span class="z-punctuation z-definition z-string z-end z-shell">&quot;</span></span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">external_url</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>xxxxxx<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">gitlab_rails[<span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>smtp_enable<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span>]</span></span><span class="z-meta z-function-call z-arguments z-shell"> = true</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">gitlab_rails[<span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>smtp_address<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span>]</span></span><span class="z-meta z-function-call z-arguments z-shell"> = <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&quot;</span>xxxxxx<span class="z-punctuation z-definition z-string z-end z-shell">&quot;</span></span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">gitlab_rails[<span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>smtp_port<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span>]</span></span><span class="z-meta z-function-call z-arguments z-shell"> = 465</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">gitlab_rails[<span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>smtp_user_name<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span>]</span></span><span class="z-meta z-function-call z-arguments z-shell"> = <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&quot;</span>xxxxxx<span class="z-punctuation z-definition z-string z-end z-shell">&quot;</span></span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">gitlab_rails[<span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>smtp_password<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span>]</span></span><span class="z-meta z-function-call z-arguments z-shell"> = <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&quot;</span>xxxxxx<span class="z-punctuation z-definition z-string z-end z-shell">&quot;</span></span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">gitlab_rails[<span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>smtp_tls<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span>]</span></span><span class="z-meta z-function-call z-arguments z-shell"> = true</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">gitlab_rails[<span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>gitlab_email_enabled<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span>]</span></span><span class="z-meta z-function-call z-arguments z-shell"> = true</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">gitlab_rails[<span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>gitlab_email_from<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span>]</span></span><span class="z-meta z-function-call z-arguments z-shell"> = <span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>coding@boychai.xyz<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">gitlab_rails[<span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>gitlab_email_display_name<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span>]</span></span><span class="z-meta z-function-call z-arguments z-shell"> = <span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>Codeing<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">gitlab_rails[<span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>gitlab_email_reply_to<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span>]</span></span><span class="z-meta z-function-call z-arguments z-shell"> = <span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>admin@boychai.xyz<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">gitlab_rails[<span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>db_adapter<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span>]</span></span><span class="z-meta z-function-call z-arguments z-shell"> = <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&quot;</span>postgresql<span class="z-punctuation z-definition z-string z-end z-shell">&quot;</span></span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">gitlab_rails[<span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>db_encoding<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span>]</span></span><span class="z-meta z-function-call z-arguments z-shell"> = <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&quot;</span>unicode<span class="z-punctuation z-definition z-string z-end z-shell">&quot;</span></span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">gitlab_rails[<span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>db_database<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span>]</span></span><span class="z-meta z-function-call z-arguments z-shell"> = <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&quot;</span>gitlab<span class="z-punctuation z-definition z-string z-end z-shell">&quot;</span></span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">gitlab_rails[<span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>db_username<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span>]</span></span><span class="z-meta z-function-call z-arguments z-shell"> = <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&quot;</span>gitlab<span class="z-punctuation z-definition z-string z-end z-shell">&quot;</span></span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">gitlab_rails[<span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>db_password<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span>]</span></span><span class="z-meta z-function-call z-arguments z-shell"> = <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&quot;</span>xxxxxxx<span class="z-punctuation z-definition z-string z-end z-shell">&quot;</span></span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">gitlab_rails[<span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>db_host<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span>]</span></span><span class="z-meta z-function-call z-arguments z-shell"> = <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&quot;</span>xxxxxxx<span class="z-punctuation z-definition z-string z-end z-shell">&quot;</span></span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">gitlab_rails[<span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>redis_host<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span>]</span></span><span class="z-meta z-function-call z-arguments z-shell"> = <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&quot;</span>xxxxxxx<span class="z-punctuation z-definition z-string z-end z-shell">&quot;</span></span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">gitlab_rails[<span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>redis_password<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span>]</span></span><span class="z-meta z-function-call z-arguments z-shell"> = <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&quot;</span>xxxxxxx<span class="z-punctuation z-definition z-string z-end z-shell">&quot;</span></span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">gitlab_rails[<span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>redis_database<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span>]</span></span><span class="z-meta z-function-call z-arguments z-shell"> = 1</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">puma[<span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>per_worker_max_memory_mb<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span>]</span></span><span class="z-meta z-function-call z-arguments z-shell"> = 256</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">sidekiq[<span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>enable<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span>]</span></span><span class="z-meta z-function-call z-arguments z-shell"> = true</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">sidekiq[<span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>concurrency<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span>]</span></span><span class="z-meta z-function-call z-arguments z-shell"> = 5</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">postgresql[<span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>enable<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span>]</span></span><span class="z-meta z-function-call z-arguments z-shell"> = false</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">postgresql[<span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>shared_buffers<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span>]</span></span><span class="z-meta z-function-call z-arguments z-shell"> =  <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&quot;</span>64MB<span class="z-punctuation z-definition z-string z-end z-shell">&quot;</span></span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">postgresql[<span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>max_worker_processes<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span>]</span></span><span class="z-meta z-function-call z-arguments z-shell"> = 4</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">redis[<span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>enable<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span>]</span></span><span class="z-meta z-function-call z-arguments z-shell"> = false</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">logrotate[<span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>enable<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span>]</span></span><span class="z-meta z-function-call z-arguments z-shell"> = true</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">gitlab_kas[<span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>enable<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span>]</span></span><span class="z-meta z-function-call z-arguments z-shell"> = false</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">prometheus[<span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>enable<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span>]</span></span><span class="z-meta z-function-call z-arguments z-shell"> = false</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">alertmanager[<span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>enable<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span>]</span></span><span class="z-meta z-function-call z-arguments z-shell"> = false</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">gitlab_exporter[<span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>listen_address<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span>]</span></span><span class="z-meta z-function-call z-arguments z-shell"> = <span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>0.0.0.0<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">patroni[<span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>postgresql<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span>][<span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>max_worker_processes<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span>]</span></span><span class="z-meta z-function-call z-arguments z-shell"> = 4</span>
</span></code></pre>
<p>在我本地K8s环境中，启动的组件如下</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">root@gitlab-cb5f6f764-6vhhz:/#</span></span><span class="z-meta z-function-call z-arguments z-shell"> gitlab-ctl status</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">run:</span></span><span class="z-meta z-function-call z-arguments z-shell"> gitaly: (pid 265</span><span class="z-meta z-function-call z-shell"></span>) <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">1471577s</span></span><span class="z-keyword z-operator z-logical z-continue z-shell">;</span> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">run:</span></span><span class="z-meta z-function-call z-arguments z-shell"> log: (pid 293</span><span class="z-meta z-function-call z-shell"></span>) <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">1471576s</span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">run:</span></span><span class="z-meta z-function-call z-arguments z-shell"> gitlab-exporter: (pid 455</span><span class="z-meta z-function-call z-shell"></span>) <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">1471545s</span></span><span class="z-keyword z-operator z-logical z-continue z-shell">;</span> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">run:</span></span><span class="z-meta z-function-call z-arguments z-shell"> log: (pid 401</span><span class="z-meta z-function-call z-shell"></span>) <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">1471546s</span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">run:</span></span><span class="z-meta z-function-call z-arguments z-shell"> gitlab-workhorse: (pid 440</span><span class="z-meta z-function-call z-shell"></span>) <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">1471545s</span></span><span class="z-keyword z-operator z-logical z-continue z-shell">;</span> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">run:</span></span><span class="z-meta z-function-call z-arguments z-shell"> log: (pid 349</span><span class="z-meta z-function-call z-shell"></span>) <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">1471558s</span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">run:</span></span><span class="z-meta z-function-call z-arguments z-shell"> logrotate: (pid 562714</span><span class="z-meta z-function-call z-shell"></span>) <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">2656s</span></span><span class="z-keyword z-operator z-logical z-continue z-shell">;</span> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">run:</span></span><span class="z-meta z-function-call z-arguments z-shell"> log: (pid 562722</span><span class="z-meta z-function-call z-shell"></span>) <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">2655s</span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">run:</span></span><span class="z-meta z-function-call z-arguments z-shell"> nginx: (pid 369</span><span class="z-meta z-function-call z-shell"></span>) <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">1471553s</span></span><span class="z-keyword z-operator z-logical z-continue z-shell">;</span> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">run:</span></span><span class="z-meta z-function-call z-arguments z-shell"> log: (pid 383</span><span class="z-meta z-function-call z-shell"></span>) <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">1471552s</span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">run:</span></span><span class="z-meta z-function-call z-arguments z-shell"> puma: (pid 300</span><span class="z-meta z-function-call z-shell"></span>) <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">1471571s</span></span><span class="z-keyword z-operator z-logical z-continue z-shell">;</span> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">run:</span></span><span class="z-meta z-function-call z-arguments z-shell"> log: (pid 307</span><span class="z-meta z-function-call z-shell"></span>) <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">1471570s</span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">run:</span></span><span class="z-meta z-function-call z-arguments z-shell"> sidekiq: (pid 312</span><span class="z-meta z-function-call z-shell"></span>) <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">1471565s</span></span><span class="z-keyword z-operator z-logical z-continue z-shell">;</span> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">run:</span></span><span class="z-meta z-function-call z-arguments z-shell"> log: (pid 320</span><span class="z-meta z-function-call z-shell"></span>) <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">1471564s</span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">run:</span></span><span class="z-meta z-function-call z-arguments z-shell"> sshd: (pid 35</span><span class="z-meta z-function-call z-shell"></span>) <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">1471588s</span></span><span class="z-keyword z-operator z-logical z-continue z-shell">;</span> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">run:</span></span><span class="z-meta z-function-call z-arguments z-shell"> log: (pid 34</span><span class="z-meta z-function-call z-shell"></span>) <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">1471588s</span></span>
</span></code></pre>
<p>我的缓存和数据库都是外置的，然后开了一个gitlab的exporter,他的内存占用还算比较稳定，可以参考下面输出</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">[root@node1</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-meta z-group z-expansion z-tilde"><span class="z-variable z-language z-tilde z-shell">~</span></span>]# kubectl top pod<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>A</span></span><span class="z-keyword z-operator z-logical z-pipe z-shell">|</span><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">grep</span></span><span class="z-meta z-function-call z-arguments z-shell"> gitlab</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">service</span></span><span class="z-meta z-function-call z-arguments z-shell">                      gitlab-cb5f6f764-6vhhz                               22m          3804Mi    </span>
</span></code></pre>
<p>在外部的Prometheus中也可以通过k8s的cAdvisor组件来查询pod的内存占用</p>
<pre data-lang="prosql" class="language-prosql z-code"><code class="language-prosql" data-lang="prosql"><span class="z-text z-plain">container_memory_usage_bytes{namespace=&quot;service&quot;, pod=&quot;gitlab-cb5f6f764-6vhhz&quot;, container=&quot;gitlab&quot;}
</span></code></pre>
<p><img src="https://image.boychai.xyz/article/Pasted%20image%2020241112102755.png" alt="7天内存占用" />
<img src="https://image.boychai.xyz/article/Pasted%20image%2020241112102814.png" alt="1天内存占用" />
我这里占用还算比较平稳。</p>

        </section>
        
        

        
            
            
            

            
        
            
            
            

            
        
            
            
            

            
        
            
            
            

            
        
        </article>
</main>


<span id="copy-success" class="hidden">
        Copied!
    </span>
    <span id="copy-init" class="hidden">
        Copy code to clipboard
    </span>
    <script defer src="https://synex.space/js/copyCodeToClipboard.min.js"></script>


    </div>
    <footer>
    <section>
        <nav class="socials nav-navs">
        </nav>

        
        <nav class="nav-navs">
        </nav>

        <div class="credits">
            <small>
                

                
                Powered by
                <a rel="" 

 href="https://www.getzola.org">Zola</a>
                &amp;
                <a rel="" 

 href="https://github.com/welpo/tabi">tabi</a>

                </small>
        </div>
    </section>

    <div id="searchModal" class="search-modal js" role="dialog" aria-labelledby="modalTitle">
    <h1 id="modalTitle" class="visually-hidden">Search</h1>
    <div id="modal-content">
        <div id="searchBar">
            <div class="search-icon" aria-hidden="true">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960">
                    <path d="M784-120 532-372q-30 24-69 38t-83 14q-109 0-184.5-75.5T120-580q0-109 75.5-184.5T380-840q109 0 184.5 75.5T640-580q0 44-14 83t-38 69l252 252-56 56ZM380-400q75 0 127.5-52.5T560-580q0-75-52.5-127.5T380-760q-75 0-127.5 52.5T200-580q0 75 52.5 127.5T380-400Z"/>
                </svg>
            </div>
            <input id="searchInput" role="combobox" autocomplete="off" spellcheck="false" aria-expanded="false" aria-controls="results-container" placeholder="Search…"/>
            <div id="clear-search" class="close-icon interactive-icon" tabindex="0" role="button" title="Clear search">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960">
                <path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/>
                </svg>
            </div>
        </div>
        <div id="results-container">
            <div id="results-info"><span id="zero_results"> No results</span>
                <span id="one_results"> $NUMBER result</span>
                <span id="many_results"> $NUMBER results</span><span id="two_results"> $NUMBER results</span>
                <span id="few_results"> $NUMBER results</span>
            </div>
            <div id="results" role="listbox"></div>
        </div>
    </div>
</div>
</footer>


    
    
</body>

</html>
