<!DOCTYPE html>
<html lang="en" >

<head>
    <meta charset="UTF-8"><meta http-equiv="Content-Security-Policy"
content="default-src 'self';font-src 'self' data:;img-src 'self' https://* data:;media-src 'self';style-src 'self';frame-src player.vimeo.com https://www.youtube-nocookie.com;connect-src 'self';script-src 'self' 'self'">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="base" content="https://synex.space/">

    
    <title>
~/S9n3x • OpenStack-Stein版搭建-1控制1计算</title>

    
    
    

    
    

    
    
    
        
            <link rel="stylesheet" href="https://synex.space/custom_subset.css?h=0b9535a28bc3d5bf2321">
        
    

    
        <link rel="stylesheet" href="https://synex.space/main.css?h=3716ab3457d2dd050b3c" />
        <link rel="stylesheet" href="https://synex.space/skins/mint.css?h=504215cf6bc10586b487" />

    <meta name="color-scheme" content="light dark" />
        <meta name="description" content="" />
        <meta property="og:description" content="" />

    

    <meta property="og:title" content="OpenStack-Stein版搭建-1控制1计算" />
    <meta property="og:type" content="article" />

    
<meta property="og:locale" content="en_GB" />

    <meta property="og:url" content="https:&#x2F;&#x2F;synex.space&#x2F;blog&#x2F;openstack-steinban-da-jian-1kong-zhi-1ji-suan&#x2F;" /><meta property="og:site_name" content="~&#x2F;S9n3x">
        <noscript><link rel="stylesheet" href="https://synex.space/no_js.css"/></noscript>
        <script type="text/javascript" src="https://synex.space/js/initializeTheme.min.js"></script>
        <script defer src="https://synex.space/js/themeSwitcher.min.js"></script>
        <script defer src="https://synex.space/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e"></script>

        
    
</head>


<body>
    <a href="#main-content" id="skip-link">Skip to content</a>
    <header>
    <nav class="navbar">
        <div class="nav-title">
            <a class="home-title" href="https://synex.space/">~&#x2F;S9n3x</a>
        </div>
            <div class="nav-navs">
                <ul>
                        
                            <li>
                                <a class="nav-links no-hover-padding" href="https://synex.space/blog/">blog
                                </a>
                            </li>
                        
                            <li>
                                <a class="nav-links no-hover-padding" href="https://synex.space/archive/">archive
                                </a>
                            </li>
                        
                            <li>
                                <a class="nav-links no-hover-padding" href="https://synex.space/tags/">tags
                                </a>
                            </li>
                        
                            <li>
                                <a class="nav-links no-hover-padding" href="https://synex.space/friends/">friends
                                </a>
                            </li>
                        <li class="menu-icons-container">
                        <ul class="menu-icons-group">
                            <li class="js menu-icon">
                                <div role="button" tabindex="0" id="search-button" class="search-icon interactive-icon" title="Click or press $SHORTCUT to open search" aria-label="Click or press $SHORTCUT to open search">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960">
                                        <path d="M784-120 532-372q-30 24-69 38t-83 14q-109 0-184.5-75.5T120-580q0-109 75.5-184.5T380-840q109 0 184.5 75.5T640-580q0 44-14 83t-38 69l252 252-56 56ZM380-400q75 0 127.5-52.5T560-580q0-75-52.5-127.5T380-760q-75 0-127.5 52.5T200-580q0 75 52.5 127.5T380-400Z"/>
                                    </svg>
                                </div>
                            </li>

                            
                            

                            <li class="theme-switcher-wrapper js"><div
        title="Toggle dark&#x2F;light mode"
        class="theme-switcher"
        tabindex="0"
        role="button"
        aria-label="Toggle dark mode"
        aria-pressed="false">
    </div><div
        title="Reset mode to default"
        class="theme-resetter arrow"
        tabindex="0"
        role="button"
        aria-hidden="true"
        aria-label="Reset mode to default">
    </div>

</li>
</ul>
                    </li>
                </ul>
            </div>
        
    </nav>
</header>

    <div class="content" id="main-content">

        
        





<main>
    <article class="h-entry">
        <h1 class="p-name article-title">
            OpenStack-Stein版搭建-1控制1计算
        </h1>
        <a class="u-url u-uid" href="https://synex.space/blog/openstack-steinban-da-jian-1kong-zhi-1ji-suan/"></a>

        <ul class="meta"><span class="hidden p-author h-card">
<a rel="author" href="https:&#x2F;&#x2F;synex.space&#x2F;" class="u-url " title=""></a>
</span>
<li><time class="dt-published" datetime="2025-01-04T15:39:00">4th Jan 2025</time></li><li title="3865 words"><span class='separator' aria-hidden='true'>•</span>20 min read</li><li class="tag"><span class='separator' aria-hidden='true'>•</span>Tags:&nbsp;</li><li class="tag"><a class="p-category" href="https://synex.space/tags/kai-yuan-gong-ju/">开源工具</a>,&nbsp;</li><li class="tag"><a class="p-category" href="https://synex.space/tags/openstack/">OpenStack</a>,&nbsp;</li><li class="tag"><a class="p-category" href="https://synex.space/tags/stein/">Stein</a>,&nbsp;</li><li class="tag"><a class="p-category" href="https://synex.space/tags/kvm/">KVM</a></li>
        </ul><section class="e-content body"><h1 id="ban-ben-xuan-ze">版本选择</h1>
<p>Open stack的版本是从A-Z之后的版本似乎是通过年月日来命名的，目前最新版本为<code>2025.1-dev</code>
<img src="https://image.boychai.xyz/article/Pasted%20image%2020241227210146.png" alt="版本列表" />
2024.2的版本，从U版开始就得用CentOS8部署了，具体原因没考究，大概率是因为内核的原因，本篇是S版本的教程，具体<a href="https://docs.openstack.org/stein/index.html">参考</a></p>
<h1 id="zu-jian-xuan-ze">组件选择</h1>
<p>本文只装最基础的组件，Keystone、Glance、Placement、Nova、Neutron、Horizon</p>
<h1 id="ji-chu-huan-jing-pei-zhi">基础环境配置</h1>
<h2 id="wang-luo-huan-jing-pei-zhi">网络环境配置</h2>
<p>我这里采用两台主机构建基础的openstack，具体可参考文档： https://docs.openstack.org/install-guide/environment-networking-controller.html</p>
<table><thead><tr><th>角色</th><th>系统</th><th>配置</th></tr></thead><tbody>
<tr><td>controller</td><td>CentOS 7.9</td><td>4G2H</td></tr>
<tr><td>compute1</td><td>CentOS7.9</td><td>1G1H</td></tr>
<tr><td>所有主机都配置一下hosts文件，有DNS服务则更好，主机名请跟随hosts文件。</td><td></td><td></td></tr>
</tbody></table>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">[root@controller</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-meta z-group z-expansion z-tilde"><span class="z-variable z-language z-tilde z-shell">~</span></span>]# cat /etc/hosts</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">127.0.0.1</span></span><span class="z-meta z-function-call z-arguments z-shell">   localhost localhost.localdomain localhost4 localhost4.localdomain4</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">::1</span></span><span class="z-meta z-function-call z-arguments z-shell">         localhost localhost.localdomain localhost6 localhost6.localdomain6     </span>
</span><span class="z-source z-shell z-bash"><span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell"> controller              </span><span class="z-comment z-line z-number-sign z-shell">
</span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">10.0.0.11</span></span><span class="z-meta z-function-call z-arguments z-shell">       controller</span>
</span><span class="z-source z-shell z-bash"><span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell"> compute1              </span><span class="z-comment z-line z-number-sign z-shell">
</span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">10.0.0.31</span></span><span class="z-meta z-function-call z-arguments z-shell">       compute1</span>
</span></code></pre>
<h2 id="shi-jian-tong-bu">时间同步</h2>
<p>OpenStack所有服务之前是使用Token进行验证的,token都是有有效期的,如果时间对不上则可能会出现token刚分配好就过期了的问题，为了避免时间上不一样的问题，这里使用NTP来进行时间同步。这里使用controller(控制节点)来做NTP服务主机。
在每台主机中执行下面命令来设置时区和安装NTP服务</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">[root@controller</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-meta z-group z-expansion z-tilde"><span class="z-variable z-language z-tilde z-shell">~</span></span>]# timedatectl set-timezone Asia/Shanghai</span>
</span><span class="z-source z-shell z-bash">
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">[root@controller</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-meta z-group z-expansion z-tilde"><span class="z-variable z-language z-tilde z-shell">~</span></span>]# yum<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>y</span> install chrony</span>
</span></code></pre>
<p>下面编辑配置文件<code>/etc/chrony.conf</code>,内容主要参考下面内容</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">[root@controller</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-meta z-group z-expansion z-tilde"><span class="z-variable z-language z-tilde z-shell">~</span></span>]# cat /etc/chrony.conf</span> <span class="z-keyword z-operator z-logical z-pipe z-shell">|</span><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">egrep</span></span><span class="z-meta z-function-call z-arguments z-shell"><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>v</span> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&quot;</span>^#|^$<span class="z-punctuation z-definition z-string z-end z-shell">&quot;</span></span>     </span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">server</span></span><span class="z-meta z-function-call z-arguments z-shell"> ntp5.aliyun.com iburst  </span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">driftfile</span></span><span class="z-meta z-function-call z-arguments z-shell"> /var/lib/chrony/drift</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">makestep</span></span><span class="z-meta z-function-call z-arguments z-shell"> 1.0 3        </span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">rtcsync</span></span><span class="z-meta z-function-call z-arguments z-shell">               </span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">allow</span></span><span class="z-meta z-function-call z-arguments z-shell"> 10.0.0.0/24     </span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">logdir</span></span><span class="z-meta z-function-call z-arguments z-shell"> /var/log/chrony</span>
</span></code></pre>
<p>重启服务</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">[root@controller</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-meta z-group z-expansion z-tilde"><span class="z-variable z-language z-tilde z-shell">~</span></span>]# systemctl restart chronyd</span>
</span></code></pre>
<p>其他openstack主机参考下面配置</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">[root@compute1</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-meta z-group z-expansion z-tilde"><span class="z-variable z-language z-tilde z-shell">~</span></span>]# cat /etc/chrony.conf</span> <span class="z-keyword z-operator z-logical z-pipe z-shell">|</span><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">egrep</span></span><span class="z-meta z-function-call z-arguments z-shell"><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>v</span> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&quot;</span>^#|^$<span class="z-punctuation z-definition z-string z-end z-shell">&quot;</span></span>                          </span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">server</span></span><span class="z-meta z-function-call z-arguments z-shell"> controller iburst                                                           </span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">driftfile</span></span><span class="z-meta z-function-call z-arguments z-shell"> /var/lib/chrony/drift                                                    </span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">makestep</span></span><span class="z-meta z-function-call z-arguments z-shell"> 1.0 3                                                                     </span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">rtcsync</span></span><span class="z-meta z-function-call z-arguments z-shell">                                                                            </span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">logdir</span></span><span class="z-meta z-function-call z-arguments z-shell"> /var/log/chrony</span>
</span></code></pre>
<p>重启服务</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">[root@compute1</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-meta z-group z-expansion z-tilde"><span class="z-variable z-language z-tilde z-shell">~</span></span>]# systemctl restart chronyd</span>
</span></code></pre>
<p>查看状态</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell"> controller 主机</span><span class="z-comment z-line z-number-sign z-shell">
</span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">[root@controller</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-meta z-group z-expansion z-tilde"><span class="z-variable z-language z-tilde z-shell">~</span></span>]# chronyc sources                                               </span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">210</span></span><span class="z-meta z-function-call z-arguments z-shell"> Number of sources = 1                                                          </span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">MS</span></span><span class="z-meta z-function-call z-arguments z-shell"> Name/IP address         Stratum Poll Reach LastRx Last sample                   </span>
</span><span class="z-source z-shell z-bash"><span class="z-keyword z-operator z-assignment z-shell">=</span><span class="z-string z-unquoted z-shell">==============================================================================</span>    
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">^*</span></span><span class="z-meta z-function-call z-arguments z-shell"> 203.107.6.88                  2   6   377    20<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell">   -</span>415us</span><span class="z-keyword z-control z-regexp z-set z-begin z-shell">[</span> <span class="z-keyword z-operator z-word z-shell">-</span>498us<span class="z-keyword z-control z-regexp z-set z-end z-shell">]</span> +/-   18ms    </span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">[root@controller</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-meta z-group z-expansion z-tilde"><span class="z-variable z-language z-tilde z-shell">~</span></span>]# date</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">Sat</span></span><span class="z-meta z-function-call z-arguments z-shell"> Dec 28 20:38:25 CST 2024                                                       </span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">[root@controller</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-meta z-group z-expansion z-tilde"><span class="z-variable z-language z-tilde z-shell">~</span></span>]#</span>
</span><span class="z-source z-shell z-bash"><span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell"> compute1 主机</span><span class="z-comment z-line z-number-sign z-shell">
</span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">[root@compute1</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-meta z-group z-expansion z-tilde"><span class="z-variable z-language z-tilde z-shell">~</span></span>]# chronyc sources                                                 </span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">210</span></span><span class="z-meta z-function-call z-arguments z-shell"> Number of sources = 1                                                          </span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">MS</span></span><span class="z-meta z-function-call z-arguments z-shell"> Name/IP address         Stratum Poll Reach LastRx Last sample                   </span>
</span><span class="z-source z-shell z-bash"><span class="z-keyword z-operator z-assignment z-shell">=</span><span class="z-string z-unquoted z-shell">==============================================================================</span>    
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">^*</span></span><span class="z-meta z-function-call z-arguments z-shell"> controller                    3   6   377    51   +348us<span class="z-keyword z-control z-regexp z-set z-begin z-shell">[</span> +428us<span class="z-keyword z-control z-regexp z-set z-end z-shell">]</span> +/-   20ms    </span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">[root@compute1</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-meta z-group z-expansion z-tilde"><span class="z-variable z-language z-tilde z-shell">~</span></span>]# date</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">Sat</span></span><span class="z-meta z-function-call z-arguments z-shell"> Dec 28 20:38:29 CST 2024                                                       </span>
</span></code></pre>
<p>时间已经同步。</p>
<h2 id="ji-chu-ruan-jian-bao">基础软件包</h2>
<p>我这里是安装s版本的openstack，参考文档地址： https://docs.openstack.org/install-guide/environment-packages-rdo.html
所有主机都执行下面命令,用来安装openstack对应的yum仓库。</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">yum</span></span><span class="z-meta z-function-call z-arguments z-shell"> install<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>y</span> centos-release-openstack-stein</span>
</span></code></pre>
<p>在24年12月28日，他自己的这些源有一部分是不可以用的,通过下面命令进行替换阿里的镜像站</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-support z-function z-cd z-shell">cd</span></span><span class="z-meta z-function-call z-arguments z-shell"> /etc/yum.repos.d</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">sed</span></span><span class="z-meta z-function-call z-arguments z-shell"><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>i</span> <span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>s/mirrorlist=/#mirrorlist=/g<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span> <span class="z-keyword z-operator z-regexp z-quantifier z-shell">*</span>.repo</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">sed</span></span><span class="z-meta z-function-call z-arguments z-shell"><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>i</span> <span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>s/#baseurl=/baseurl=/g<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span> <span class="z-keyword z-operator z-regexp z-quantifier z-shell">*</span>.repo</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">sed</span></span><span class="z-meta z-function-call z-arguments z-shell"><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>i</span> <span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>s/mirror.centos.org/mirrors.aliyun.com/g<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span> <span class="z-keyword z-operator z-regexp z-quantifier z-shell">*</span>.repo</span>
</span></code></pre>
<p>安装openstack的客户端管理工具</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">yum</span></span><span class="z-meta z-function-call z-arguments z-shell"> install python-openstackclient<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>y</span> </span>
</span></code></pre>
<h2 id="shu-ju-ku-zhi-chi">数据库支持</h2>
<p>在控制节点安装下面工具,文档参考地址： https://docs.openstack.org/install-guide/environment-sql-database-rdo.html</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">yum</span></span><span class="z-meta z-function-call z-arguments z-shell"> install<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>y</span> mariadb mariadb-server python2-PyMySQL</span>
</span></code></pre>
<p>根据配置文件，修改一下数据库的配置，编辑文件<code>/etc/my.cnf.d/openstack.cnf</code>，添加下面内容</p>
<pre data-lang="cnf" class="language-cnf z-code"><code class="language-cnf" data-lang="cnf"><span class="z-text z-plain">[mysqld]
</span><span class="z-text z-plain">bind-address = 10.0.0.11
</span><span class="z-text z-plain">
</span><span class="z-text z-plain">default-storage-engine = innodb
</span><span class="z-text z-plain">innodb_file_per_table = on
</span><span class="z-text z-plain">max_connections = 4096
</span><span class="z-text z-plain">collation-server = utf8_general_ci
</span><span class="z-text z-plain">character-set-server = utf8
</span></code></pre>
<p>启动服务</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">systemctl</span></span><span class="z-meta z-function-call z-arguments z-shell"> enable<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>now</span> mariadb.service</span>
</span></code></pre>
<p>之后执行命令<code>mysql_secure_installation</code>安全初始化一下数据库</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">mysql_secure_installation</span></span><span class="z-meta z-function-call z-arguments z-shell">                           </span>
</span></code></pre>
<p>我执行的是,并且它们分别代表的含义是</p>
<ul>
<li>登录的密码 回车(刚装的都是没密码的，所以直接回车)</li>
<li>是否设置root密码 n(不设置，这个等后面设置)</li>
<li>是否移除匿名用户 Y(移除)</li>
<li>是否禁用root远程登陆 Y(禁用)</li>
<li>是否移除test数据库 Y(移除)</li>
<li>是否重载权限表 Y(重载)</li>
</ul>
<h2 id="xiao-xi-dui-lie-zhi-chi">消息队列支持</h2>
<p>open stack支持多种的消息队列，建议使用rabbitmq，这里也不用其他的了。具体可以参考文档： https://docs.openstack.org/install-guide/environment-messaging-rdo.html
在控制节点执行下面命令安装</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">yum</span></span><span class="z-meta z-function-call z-arguments z-shell"> install<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>y</span> rabbitmq-server</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">systemctl</span></span><span class="z-meta z-function-call z-arguments z-shell"> enable<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>now</span> rabbitmq-server.service</span>
</span><span class="z-source z-shell z-bash"><span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell"> 这一步是创建一个rabbit的用户，并且设置密码</span><span class="z-comment z-line z-number-sign z-shell">
</span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">rabbitmqctl</span></span><span class="z-meta z-function-call z-arguments z-shell"> add_user openstack RABBIT_PASS</span>
</span><span class="z-source z-shell z-bash"><span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell"> 授权新建的用户权限</span><span class="z-comment z-line z-number-sign z-shell">
</span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">rabbitmqctl</span></span><span class="z-meta z-function-call z-arguments z-shell"> set_permissions openstack <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&quot;</span>.*<span class="z-punctuation z-definition z-string z-end z-shell">&quot;</span></span> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&quot;</span>.*<span class="z-punctuation z-definition z-string z-end z-shell">&quot;</span></span> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&quot;</span>.*<span class="z-punctuation z-definition z-string z-end z-shell">&quot;</span></span></span>
</span></code></pre>
<h2 id="huan-cun-zhi-chi">缓存支持</h2>
<p>在控制节点为openstack提供缓存支持，具体可参考文档： https://docs.openstack.org/install-guide/environment-memcached-rdo.html
执行下面命令</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">yum</span></span><span class="z-meta z-function-call z-arguments z-shell"> install<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>y</span> memcached python-memcached</span>
</span></code></pre>
<p>紧接着修改一下他的配置文件`/etc/sysconfig/memcached</p>
<pre data-lang="memcached" class="language-memcached z-code"><code class="language-memcached" data-lang="memcached"><span class="z-text z-plain">OPTIONS=&quot;-l 127.0.0.1,::1&quot;
</span><span class="z-text z-plain"># 把上面内容替换成下面的内容
</span><span class="z-text z-plain">OPTIONS=&quot;-l 127.0.0.1,::1,controller&quot;
</span></code></pre>
<p>替换的作用主要是为了公开服务，默认只是监听本地的127.0.0.1，外部是无法访问的，<code>controller</code>则是自己的主机的域名，指向的是自己在当前网络环境的ip。
执行下面命令启动服务</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">systemctl</span></span><span class="z-meta z-function-call z-arguments z-shell"> enable<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>now</span> memcached.service</span>
</span></code></pre>
<h2 id="etcdzhi-chi">ETCD支持</h2>
<p>本架构不需要ETCD的支持，本文安装的组件和ETCD都没关联。其他组件可能用到ETCD，在进阶的安装情况下得注意这个基础环境。</p>
<h1 id="zu-jian-an-zhuang">组件安装</h1>
<p>参考文档： https://docs.openstack.org/keystone/stein/install/
关于文档要注意的是，默认文档打开是没有老版本文档的直链的，需要在stein替换成自己想要装的版本。</p>
<h2 id="keystone-ren-zheng-fu-wu">Keystone - 认证服务</h2>
<p>参考文档： https://docs.openstack.org/keystone/stein/install/keystone-install-rdo.html
在控制节点执行下面内容，用来授权Keystone服务在数据库中的支持</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">[root@controller</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-meta z-group z-expansion z-tilde"><span class="z-variable z-language z-tilde z-shell">~</span></span>]# mysql                                                         </span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">Welcome</span></span><span class="z-meta z-function-call z-arguments z-shell"> to the MariaDB monitor.  Commands end with</span> <span class="z-keyword z-operator z-logical z-continue z-shell">;</span> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">or</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-constant z-character z-escape z-shell">\g</span>.                        Your MariaDB connection id is 15                                                   Server version: 10.3.10-MariaDB MariaDB Server                                     Copyright (c</span><span class="z-meta z-function-call z-shell"></span>) <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">2000,</span></span><span class="z-meta z-function-call z-arguments z-shell"> 2018, Oracle, MariaDB Corporation Ab and others.               Type <span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>help;<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span> or <span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>\h<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span> for help. Type <span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>\c<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span> to clear the current input statement.     MariaDB <span class="z-keyword z-control z-regexp z-set z-begin z-shell">[</span>(none)<span class="z-keyword z-control z-regexp z-set z-end z-shell">]</span><span class="z-keyword z-operator z-assignment z-redirection z-shell">&gt;</span> CREATE DATABASE keystone</span><span class="z-keyword z-operator z-logical z-continue z-shell">;</span>                                        <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">Query</span></span><span class="z-meta z-function-call z-arguments z-shell"> OK, 1 row affected (0.000 sec</span><span class="z-meta z-function-call z-shell"></span>)                                               <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">MariaDB</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-keyword z-control z-regexp z-set z-begin z-shell">[</span>(none)<span class="z-keyword z-control z-regexp z-set z-end z-shell">]</span><span class="z-keyword z-operator z-assignment z-redirection z-shell">&gt;</span>  GRANT ALL PRIVILEGES ON keystone.<span class="z-keyword z-operator z-regexp z-quantifier z-shell">*</span> TO <span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>keystone<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span>@<span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>localhost<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span> <span class="z-constant z-character z-escape z-shell">\ </span>     -<span class="z-keyword z-operator z-assignment z-redirection z-shell">&gt;</span> IDENTIFIED BY <span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>KEYSTONE_DBPASS<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span></span><span class="z-keyword z-operator z-logical z-continue z-shell">;</span>                                            <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">Query</span></span><span class="z-meta z-function-call z-arguments z-shell"> OK, 0 rows affected (0.001 sec</span><span class="z-meta z-function-call z-shell"></span>)                                              <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">MariaDB</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-keyword z-control z-regexp z-set z-begin z-shell">[</span>(none)<span class="z-keyword z-control z-regexp z-set z-end z-shell">]</span><span class="z-keyword z-operator z-assignment z-redirection z-shell">&gt;</span> GRANT ALL PRIVILEGES ON keystone.<span class="z-keyword z-operator z-regexp z-quantifier z-shell">*</span> TO <span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>keystone<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span>@<span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>%<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span> <span class="z-constant z-character z-escape z-shell">\ </span>              -<span class="z-keyword z-operator z-assignment z-redirection z-shell">&gt;</span> IDENTIFIED BY <span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>KEYSTONE_DBPASS<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span></span><span class="z-keyword z-operator z-logical z-continue z-shell">;</span>                                            
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">Query</span></span><span class="z-meta z-function-call z-arguments z-shell"> OK, 0 rows affected (0.000 sec</span><span class="z-meta z-function-call z-shell"></span>) 
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">MariaDB</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-keyword z-control z-regexp z-set z-begin z-shell">[</span>(none)<span class="z-keyword z-control z-regexp z-set z-end z-shell">]</span><span class="z-keyword z-operator z-assignment z-redirection z-shell">&gt;</span>
</span></span></code></pre>
<p>安装相关的包</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">yum</span></span><span class="z-meta z-function-call z-arguments z-shell"> install<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>y</span> openstack-keystone httpd mod_wsgi</span>
</span></code></pre>
<p>修改配置文件<code>/etc/keystone/keystone.conf</code>,再修改之前需要注意的是,文件中有很多很多的注释,还全都是英文的,而且里面有很多Keystone不同类型的配置，直接修改并不好，这里可以通过执行下面命令来简化原本的配置文件，之后在进行修改</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell"> 备份</span><span class="z-comment z-line z-number-sign z-shell">
</span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">cp</span></span><span class="z-meta z-function-call z-arguments z-shell"> /etc/keystone/keystone.conf<span class="z-meta z-group z-expansion z-brace z-shell"><span class="z-punctuation z-section z-expansion z-brace z-begin z-shell">{</span><span class="z-punctuation z-separator z-shell">,</span>.bak<span class="z-punctuation z-section z-expansion z-brace z-end z-shell">}</span></span></span>
</span><span class="z-source z-shell z-bash"><span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell"> 去除空行和注释</span><span class="z-comment z-line z-number-sign z-shell">
</span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">egrep</span></span><span class="z-meta z-function-call z-arguments z-shell"><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>v</span> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&quot;</span>^$|^#<span class="z-punctuation z-definition z-string z-end z-shell">&quot;</span></span> /etc/keystone/keystone.conf.bak <span class="z-keyword z-operator z-assignment z-redirection z-shell">&gt;</span> /etc/keystone/keystone.conf</span>
</span></code></pre>
<p>正常来说，配置文件中所有的配置段的配置都是空的，然后现在添加下面配置</p>
<pre data-lang="conf" class="language-conf z-code"><code class="language-conf" data-lang="conf"><span class="z-source z-genconfig"><span class="z-meta z-comment z-genconfig"><span class="z-comment z-line z-number-sign z-genconfig"># database 配置段中添加下面配置，这里是连接数据库的协议连接，具体代表的内容这里不多写。
</span></span></span><span class="z-source z-genconfig"><span class="z-meta z-param z-genconfig"><span class="z-variable z-parameter z-genconfig">connection</span> <span class="z-keyword z-operator z-genconfig">=</span></span> mysql<span class="z-keyword z-operator z-genconfig">+</span><span class="z-meta z-url z-genconfig"><span class="z-constant z-other z-genconfig">pymysql://keystone:KEYSTONE_DBPASS@controller/keystone</span></span>
</span><span class="z-source z-genconfig"><span class="z-meta z-comment z-genconfig"><span class="z-comment z-line z-number-sign z-genconfig"># token 配置段中添加下面配置，这段配置的作用是指定当前组件使用什么方法提供令牌。
</span></span></span><span class="z-source z-genconfig"><span class="z-meta z-param z-genconfig"><span class="z-variable z-parameter z-genconfig">provider</span> <span class="z-keyword z-operator z-genconfig">=</span></span> fernet
</span></code></pre>
<p>保存后去用keystone的身份去填充数据库</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">su</span></span><span class="z-meta z-function-call z-arguments z-shell"><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>s</span> /bin/sh<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>c</span> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&quot;</span>keystone-manage db_sync<span class="z-punctuation z-definition z-string z-end z-shell">&quot;</span></span> keystone</span>
</span></code></pre>
<p>填充后可以使用下面命令去验证，正常的情况应该是会有好多表，如果啥都没有那应该是出问题了。</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">mysql</span></span><span class="z-meta z-function-call z-arguments z-shell"> keystone<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>e</span> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&quot;</span>show tables;<span class="z-punctuation z-definition z-string z-end z-shell">&quot;</span></span></span>
</span></code></pre>
<p>下面开始初始化 Fernet 密钥存储库，执行下面命令</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">keystone-manage</span></span><span class="z-meta z-function-call z-arguments z-shell"> fernet_setup<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>keystone-user</span> keystone<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>keystone-group</span> keystone</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">keystone-manage</span></span><span class="z-meta z-function-call z-arguments z-shell"> credential_setup<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>keystone-user</span> keystone<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>keystone-group</span> keystone</span>
</span></code></pre>
<p>初始化keystone,这里定义了一些基础信息,如果有修改请根据自己的环境修改。</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">keystone-manage</span></span><span class="z-meta z-function-call z-arguments z-shell"> bootstrap<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>bootstrap-password</span> ADMIN_PASS <span class="z-punctuation z-separator z-continuation z-line z-shell">\
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell"><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell">  --</span>bootstrap-admin-url</span> http://controller:5000/v3/ <span class="z-punctuation z-separator z-continuation z-line z-shell">\
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell"><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell">  --</span>bootstrap-internal-url</span> http://controller:5000/v3/ <span class="z-punctuation z-separator z-continuation z-line z-shell">\
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell"><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell">  --</span>bootstrap-public-url</span> http://controller:5000/v3/ <span class="z-punctuation z-separator z-continuation z-line z-shell">\
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell"><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell">  --</span>bootstrap-region-id</span> RegionOne</span>
</span></code></pre>
<p>下面开始配置一下Apache，编辑<code>/etc/httpd/conf/httpd.conf</code>配置<code>ServerName</code>为<code>controller</code></p>
<pre data-lang="http.conf" class="language-http.conf z-code"><code class="language-http.conf" data-lang="http.conf"><span class="z-text z-plain">ServerName controller
</span></code></pre>
<p>再把keystone的apache配置链接到apache的http.d中</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">ln</span></span><span class="z-meta z-function-call z-arguments z-shell"><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>s</span> /usr/share/keystone/wsgi-keystone.conf /etc/httpd/conf.d/</span>
</span></code></pre>
<p>启用服务</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">systemctl</span></span><span class="z-meta z-function-call z-arguments z-shell"> enable<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>now</span> httpd.service</span>
</span></code></pre>
<p>声明一下环境变量</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-storage z-modifier z-shell">export</span> <span class="z-variable z-other z-readwrite z-assignment z-shell">OS_USERNAME</span><span class="z-keyword z-operator z-assignment z-shell">=</span><span class="z-string z-unquoted z-shell">admin</span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-storage z-modifier z-shell">export</span> <span class="z-variable z-other z-readwrite z-assignment z-shell">OS_PASSWORD</span><span class="z-keyword z-operator z-assignment z-shell">=</span><span class="z-string z-unquoted z-shell">ADMIN_PASS</span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-storage z-modifier z-shell">export</span> <span class="z-variable z-other z-readwrite z-assignment z-shell">OS_PROJECT_NAME</span><span class="z-keyword z-operator z-assignment z-shell">=</span><span class="z-string z-unquoted z-shell">admin</span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-storage z-modifier z-shell">export</span> <span class="z-variable z-other z-readwrite z-assignment z-shell">OS_USER_DOMAIN_NAME</span><span class="z-keyword z-operator z-assignment z-shell">=</span><span class="z-string z-unquoted z-shell">Default</span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-storage z-modifier z-shell">export</span> <span class="z-variable z-other z-readwrite z-assignment z-shell">OS_PROJECT_DOMAIN_NAME</span><span class="z-keyword z-operator z-assignment z-shell">=</span><span class="z-string z-unquoted z-shell">Default</span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-storage z-modifier z-shell">export</span> <span class="z-variable z-other z-readwrite z-assignment z-shell">OS_AUTH_URL</span><span class="z-keyword z-operator z-assignment z-shell">=</span><span class="z-string z-unquoted z-shell">http://controller:5000/v3</span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-storage z-modifier z-shell">export</span> <span class="z-variable z-other z-readwrite z-assignment z-shell">OS_IDENTITY_API_VERSION</span><span class="z-keyword z-operator z-assignment z-shell">=</span><span class="z-string z-unquoted z-shell">3</span></span>
</span></code></pre>
<p>使用此链接的命令之前请务必配置上面所描述的环境变量。关于创建基础域、项目、用户和角色，具体可以参考： https://docs.openstack.org/keystone/stein/install/keystone-users-rdo.html
声明客户端环境变量脚本，其他用户可以参考： https://docs.openstack.org/keystone/stein/install/keystone-openrc-rdo.html#using-the-scripts</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">cat</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-keyword z-operator z-assignment z-redirection z-shell">&gt;</span> admin-openrc <span class="z-keyword z-operator z-assignment z-redirection z-shell">&lt;</span>
</span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-storage z-modifier z-shell">export</span> <span class="z-variable z-other z-readwrite z-assignment z-shell">OS_PROJECT_DOMAIN_NAME</span><span class="z-keyword z-operator z-assignment z-shell">=</span><span class="z-string z-unquoted z-shell">Default</span>                         <span class="z-variable z-other z-readwrite z-assignment z-shell">export</span> <span class="z-variable z-other z-readwrite z-assignment z-shell">OS_USER_DOMAIN_NAME</span><span class="z-keyword z-operator z-assignment z-shell">=</span><span class="z-string z-unquoted z-shell">Default</span>                            <span class="z-variable z-other z-readwrite z-assignment z-shell">export</span> <span class="z-variable z-other z-readwrite z-assignment z-shell">OS_PROJECT_NAME</span><span class="z-keyword z-operator z-assignment z-shell">=</span><span class="z-string z-unquoted z-shell">admin</span>                                  <span class="z-variable z-other z-readwrite z-assignment z-shell">export</span> <span class="z-variable z-other z-readwrite z-assignment z-shell">OS_USERNAME</span><span class="z-keyword z-operator z-assignment z-shell">=</span><span class="z-string z-unquoted z-shell">admin</span>                                      <span class="z-variable z-other z-readwrite z-assignment z-shell">export</span> <span class="z-variable z-other z-readwrite z-assignment z-shell">OS_PASSWORD</span><span class="z-keyword z-operator z-assignment z-shell">=</span><span class="z-string z-unquoted z-shell">ADMIN_PASS</span>                                 <span class="z-variable z-other z-readwrite z-assignment z-shell">export</span> <span class="z-variable z-other z-readwrite z-assignment z-shell">OS_AUTH_URL</span><span class="z-keyword z-operator z-assignment z-shell">=</span><span class="z-string z-unquoted z-shell">http://controller:5000/v3</span>                  <span class="z-variable z-other z-readwrite z-assignment z-shell">export</span> <span class="z-variable z-other z-readwrite z-assignment z-shell">OS_IDENTITY_API_VERSION</span><span class="z-keyword z-operator z-assignment z-shell">=</span><span class="z-string z-unquoted z-shell">3</span>                              <span class="z-variable z-other z-readwrite z-assignment z-shell">export</span> <span class="z-variable z-other z-readwrite z-assignment z-shell">OS_IMAGE_API_VERSION</span><span class="z-keyword z-operator z-assignment z-shell">=</span><span class="z-string z-unquoted z-shell">2</span>                                 <span class="z-variable z-other z-readwrite z-assignment z-shell">EOF</span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">chmod</span></span><span class="z-meta z-function-call z-arguments z-shell"> +x admin-openrc</span>
</span></code></pre>
<p>这个脚本的作用就是用来执行客户端命令的，直接用命令去操控openstack的keystone的时候必须定义这些，保存到文件是为了下次更快的设置自己的用户，下次执行命令的时候只需要执行<code>./admin-openrc</code>即可。这里建议验证一下服务,执行命令<code>openstack token issue</code>查看是否有回显，如果报错则说明搭建过程有问题。</p>
<h2 id="qi-ta-zu-jian-tong-yong-liu-cheng">其他组件通用流程</h2>
<p>除了Keystone，其他服务搭建的流程都遵循下面步骤</p>
<ul>
<li>创库授权</li>
<li>keystone创建账号</li>
<li>keystone创建服务实体</li>
<li>安装服务软件包</li>
<li>修改服务的配置文件</li>
<li>同步数据库</li>
<li>启动服务</li>
<li>验证</li>
</ul>
<h2 id="glance-jing-xiang-fu-wu">Glance - 镜像服务</h2>
<p>此服务安装在控制节点，参考文档地址： https://docs.openstack.org/glance/stein/install/
创库授权，进入数据库节点执行下面命令</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">mysql</span></span><span class="z-meta z-function-call z-arguments z-shell"><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>u</span> root<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>p</span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">CREATE</span></span><span class="z-meta z-function-call z-arguments z-shell"> DATABASE glance</span><span class="z-keyword z-operator z-logical z-continue z-shell">;</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">GRANT</span></span><span class="z-meta z-function-call z-arguments z-shell"> ALL PRIVILEGES ON glance.<span class="z-keyword z-operator z-regexp z-quantifier z-shell">*</span> TO <span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>glance<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span>@<span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>localhost<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span> <span class="z-punctuation z-separator z-continuation z-line z-shell">\
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell">  IDENTIFIED BY <span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>GLANCE_DBPASS<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span></span><span class="z-keyword z-operator z-logical z-continue z-shell">;</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">GRANT</span></span><span class="z-meta z-function-call z-arguments z-shell"> ALL PRIVILEGES ON glance.<span class="z-keyword z-operator z-regexp z-quantifier z-shell">*</span> TO <span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>glance<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span>@<span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>%<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span> <span class="z-punctuation z-separator z-continuation z-line z-shell">\
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell">  IDENTIFIED BY <span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>GLANCE_DBPASS<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span></span><span class="z-keyword z-operator z-logical z-continue z-shell">;</span>
</span></code></pre>
<p>在keystone中创建账号和服务实体</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell"> 加载环境</span><span class="z-comment z-line z-number-sign z-shell">
</span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">./admin-openrc</span></span>
</span><span class="z-source z-shell z-bash"><span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell"> 创建账号</span><span class="z-comment z-line z-number-sign z-shell">
</span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">openstack</span></span><span class="z-meta z-function-call z-arguments z-shell"> user create<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>domain</span> default<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>password</span> GLANCE_PASS glance</span>
</span><span class="z-source z-shell z-bash"><span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell"> 如果在之前的项目创建中已经创建过service则下面这一条可以不需要执行。</span><span class="z-comment z-line z-number-sign z-shell">
</span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">openstack</span></span><span class="z-meta z-function-call z-arguments z-shell"> project create<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>domain</span> default <span class="z-punctuation z-separator z-continuation z-line z-shell">\
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell"><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell">  --</span>description</span> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&quot;</span>Service Project<span class="z-punctuation z-definition z-string z-end z-shell">&quot;</span></span> service</span>
</span><span class="z-source z-shell z-bash"><span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell"> 给创建的用户授权，给一个admin的角色</span><span class="z-comment z-line z-number-sign z-shell">
</span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">openstack</span></span><span class="z-meta z-function-call z-arguments z-shell"> role add<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>project</span> service<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>user</span> glance admin</span>
</span><span class="z-source z-shell z-bash"><span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell"> 创建glance的访问实体</span><span class="z-comment z-line z-number-sign z-shell">
</span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">openstack</span></span><span class="z-meta z-function-call z-arguments z-shell"> service create<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>name</span> glance <span class="z-punctuation z-separator z-continuation z-line z-shell">\
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell"><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell">  --</span>description</span> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&quot;</span>OpenStack Image<span class="z-punctuation z-definition z-string z-end z-shell">&quot;</span></span> image</span>
</span><span class="z-source z-shell z-bash"><span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell"> 为实体创建api访问入口</span><span class="z-comment z-line z-number-sign z-shell">
</span></span><span class="z-source z-shell z-bash"><span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell"> 公共的</span><span class="z-comment z-line z-number-sign z-shell">
</span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">openstack</span></span><span class="z-meta z-function-call z-arguments z-shell"> endpoint create<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>region</span> RegionOne <span class="z-punctuation z-separator z-continuation z-line z-shell">\
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell">  image public http://controller:9292</span>
</span><span class="z-source z-shell z-bash"><span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell"> 组件之间的</span><span class="z-comment z-line z-number-sign z-shell">
</span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">openstack</span></span><span class="z-meta z-function-call z-arguments z-shell"> endpoint create<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>region</span> RegionOne <span class="z-punctuation z-separator z-continuation z-line z-shell">\
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell">  image internal http://controller:9292</span>
</span><span class="z-source z-shell z-bash"><span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell"> 管理员的</span><span class="z-comment z-line z-number-sign z-shell">
</span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">openstack</span></span><span class="z-meta z-function-call z-arguments z-shell"> endpoint create<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>region</span> RegionOne <span class="z-punctuation z-separator z-continuation z-line z-shell">\
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell">  image admin http://controller:9292</span>
</span></code></pre>
<p>下面在控制节点开始安装glance的软件包</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">yum</span></span><span class="z-meta z-function-call z-arguments z-shell"> install<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>y</span> openstack-glance</span>
</span></code></pre>
<p>下面开始修改配置</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell"> 备份</span><span class="z-comment z-line z-number-sign z-shell">
</span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">cp</span></span><span class="z-meta z-function-call z-arguments z-shell"> /etc/glance/glance-api.conf<span class="z-meta z-group z-expansion z-brace z-shell"><span class="z-punctuation z-section z-expansion z-brace z-begin z-shell">{</span><span class="z-punctuation z-separator z-shell">,</span>.bak<span class="z-punctuation z-section z-expansion z-brace z-end z-shell">}</span></span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">cp</span></span><span class="z-meta z-function-call z-arguments z-shell"> /etc/glance/glance-registry.conf<span class="z-meta z-group z-expansion z-brace z-shell"><span class="z-punctuation z-section z-expansion z-brace z-begin z-shell">{</span><span class="z-punctuation z-separator z-shell">,</span>.bak<span class="z-punctuation z-section z-expansion z-brace z-end z-shell">}</span></span></span>
</span><span class="z-source z-shell z-bash"><span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell"> 去除空行和注释</span><span class="z-comment z-line z-number-sign z-shell">
</span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">egrep</span></span><span class="z-meta z-function-call z-arguments z-shell"><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>v</span> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&quot;</span>^$|^#<span class="z-punctuation z-definition z-string z-end z-shell">&quot;</span></span> /etc/glance/glance-api.conf.bak <span class="z-keyword z-operator z-assignment z-redirection z-shell">&gt;</span> /etc/glance/glance-api.conf</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">egrep</span></span><span class="z-meta z-function-call z-arguments z-shell"><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>v</span> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&quot;</span>^$|^#<span class="z-punctuation z-definition z-string z-end z-shell">&quot;</span></span> /etc/glance/glance-registry.conf.bak <span class="z-keyword z-operator z-assignment z-redirection z-shell">&gt;</span> /etc/glance/glance-registry.conf</span>
</span></code></pre>
<p>编辑<code>/etc/glance/glance-api.conf</code>修改以下内容</p>
<pre data-lang="/etc/glance/glance-api.conf" class="language-/etc/glance/glance-api.conf z-code"><code class="language-/etc/glance/glance-api.conf" data-lang="/etc/glance/glance-api.conf"><span class="z-text z-plain"># database 段中添加下面内容
</span><span class="z-text z-plain">connection = mysql+pymysql://glance:GLANCE_DBPASS@controller/glance
</span><span class="z-text z-plain"># keystone_authtoken 段中添加下面内容
</span><span class="z-text z-plain">www_authenticate_uri  = http://controller:5000
</span><span class="z-text z-plain">auth_url = http://controller:5000
</span><span class="z-text z-plain">memcached_servers = controller:11211
</span><span class="z-text z-plain">auth_type = password
</span><span class="z-text z-plain">project_domain_name = Default
</span><span class="z-text z-plain">user_domain_name = Default
</span><span class="z-text z-plain">project_name = service
</span><span class="z-text z-plain">username = glance
</span><span class="z-text z-plain">password = GLANCE_PASS
</span><span class="z-text z-plain"># paste_deploy 段中添加下面内容
</span><span class="z-text z-plain">flavor = keystone
</span><span class="z-text z-plain"># glance_store 段中添加下面内容
</span><span class="z-text z-plain">stores = file,http
</span><span class="z-text z-plain">default_store = file
</span><span class="z-text z-plain">filesystem_store_datadir = /var/lib/glance/images/
</span></code></pre>
<p>编辑<code>/etc/glance/glance-registry.conf</code>修改以下内容</p>
<pre data-lang="/etc/glance/glance-registry.conf" class="language-/etc/glance/glance-registry.conf z-code"><code class="language-/etc/glance/glance-registry.conf" data-lang="/etc/glance/glance-registry.conf"><span class="z-text z-plain"># database 段中添加下面内容
</span><span class="z-text z-plain">connection = mysql+pymysql://glance:GLANCE_DBPASS@controller/glance
</span><span class="z-text z-plain"># keystone_authtoken 段中添加下面内容
</span><span class="z-text z-plain">www_authenticate_uri = http://controller:5000
</span><span class="z-text z-plain">auth_url = http://controller:5000
</span><span class="z-text z-plain">memcached_servers = controller:11211
</span><span class="z-text z-plain">auth_type = password
</span><span class="z-text z-plain">project_domain_name = Default
</span><span class="z-text z-plain">user_domain_name = Default
</span><span class="z-text z-plain">project_name = service
</span><span class="z-text z-plain">username = glance
</span><span class="z-text z-plain">password = GLANCE_PASS
</span><span class="z-text z-plain"># paste_deploy 段中添加下面内容
</span><span class="z-text z-plain">flavor = keystone
</span></code></pre>
<p>以glance的身份填充数据库</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">su</span></span><span class="z-meta z-function-call z-arguments z-shell"><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>s</span> /bin/sh<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>c</span> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&quot;</span>glance-manage db_sync<span class="z-punctuation z-definition z-string z-end z-shell">&quot;</span></span> glance</span>
</span></code></pre>
<p>启动服务</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">systemctl</span></span><span class="z-meta z-function-call z-arguments z-shell"> enable<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>now</span> openstack-glance-api.service <span class="z-punctuation z-separator z-continuation z-line z-shell">\
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell">  openstack-glance-registry.service</span>
</span></code></pre>
<p>验证组件参考： https://docs.openstack.org/glance/stein/install/verify.html</p>
<h2 id="placemen-ji-suan-an-zhi-fu-wu">Placemen - 计算安置服务</h2>
<p>此服务安装在控制节点，文档参考地址： https://docs.openstack.org/placement/stein/install/
先是授权，到数据库节点执行下面命令</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">mysql</span></span><span class="z-meta z-function-call z-arguments z-shell"><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>u</span> root<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>p</span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">CREATE</span></span><span class="z-meta z-function-call z-arguments z-shell"> DATABASE placement</span><span class="z-keyword z-operator z-logical z-continue z-shell">;</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">GRANT</span></span><span class="z-meta z-function-call z-arguments z-shell"> ALL PRIVILEGES ON placement.<span class="z-keyword z-operator z-regexp z-quantifier z-shell">*</span> TO <span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>placement<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span>@<span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>localhost<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span> <span class="z-punctuation z-separator z-continuation z-line z-shell">\
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell">  IDENTIFIED BY <span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>PLACEMENT_DBPASS<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span></span><span class="z-keyword z-operator z-logical z-continue z-shell">;</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">GRANT</span></span><span class="z-meta z-function-call z-arguments z-shell"> ALL PRIVILEGES ON placement.<span class="z-keyword z-operator z-regexp z-quantifier z-shell">*</span> TO <span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>placement<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span>@<span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>%<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span> <span class="z-punctuation z-separator z-continuation z-line z-shell">\
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell">  IDENTIFIED BY <span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>PLACEMENT_DBPASS<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span></span><span class="z-keyword z-operator z-logical z-continue z-shell">;</span>
</span></code></pre>
<p>在keystone中创建账号和服务实体</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell"> 加载环境</span><span class="z-comment z-line z-number-sign z-shell">
</span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">./admin-openrc</span></span>
</span><span class="z-source z-shell z-bash"><span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell"> 创建用户</span><span class="z-comment z-line z-number-sign z-shell">
</span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">openstack</span></span><span class="z-meta z-function-call z-arguments z-shell"> user create<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>domain</span> default<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>password</span> PLACEMENT_PASS placement</span>
</span><span class="z-source z-shell z-bash"><span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell"> 关联权限</span><span class="z-comment z-line z-number-sign z-shell">
</span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">openstack</span></span><span class="z-meta z-function-call z-arguments z-shell"> role add<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>project</span> service<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>user</span> placement admin</span>
</span><span class="z-source z-shell z-bash"><span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell"> 创建实体</span><span class="z-comment z-line z-number-sign z-shell">
</span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">openstack</span></span><span class="z-meta z-function-call z-arguments z-shell"> service create<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>name</span> placement <span class="z-punctuation z-separator z-continuation z-line z-shell">\
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell"><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell">  --</span>description</span> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&quot;</span>Placement API<span class="z-punctuation z-definition z-string z-end z-shell">&quot;</span></span> placement</span>
</span><span class="z-source z-shell z-bash"><span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell"> 开放入口</span><span class="z-comment z-line z-number-sign z-shell">
</span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">openstack</span></span><span class="z-meta z-function-call z-arguments z-shell"> endpoint create<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>region</span> RegionOne <span class="z-punctuation z-separator z-continuation z-line z-shell">\
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell">  placement public http://controller:8778</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">openstack</span></span><span class="z-meta z-function-call z-arguments z-shell"> endpoint create<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>region</span> RegionOne <span class="z-punctuation z-separator z-continuation z-line z-shell">\
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell">  placement internal http://controller:8778</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">openstack</span></span><span class="z-meta z-function-call z-arguments z-shell"> endpoint create<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>region</span> RegionOne <span class="z-punctuation z-separator z-continuation z-line z-shell">\
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell">  placement admin http://controller:8778</span>
</span></code></pre>
<p>安装软件包</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">yum</span></span><span class="z-meta z-function-call z-arguments z-shell"> install<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>y</span> openstack-placement-api</span>
</span></code></pre>
<p>下面开始修改配置</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell"> 备份</span><span class="z-comment z-line z-number-sign z-shell">
</span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">cp</span></span><span class="z-meta z-function-call z-arguments z-shell"> /etc/placement/placement.conf<span class="z-meta z-group z-expansion z-brace z-shell"><span class="z-punctuation z-section z-expansion z-brace z-begin z-shell">{</span><span class="z-punctuation z-separator z-shell">,</span>.bak<span class="z-punctuation z-section z-expansion z-brace z-end z-shell">}</span></span></span>
</span><span class="z-source z-shell z-bash"><span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell"> 去除空行和注释</span><span class="z-comment z-line z-number-sign z-shell">
</span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">egrep</span></span><span class="z-meta z-function-call z-arguments z-shell"><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>v</span> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&quot;</span>^$|^#<span class="z-punctuation z-definition z-string z-end z-shell">&quot;</span></span> /etc/placement/placement.conf.bak <span class="z-keyword z-operator z-assignment z-redirection z-shell">&gt;</span> /etc/placement/placement.conf</span>
</span></code></pre>
<p>编辑<code>/etc/placement/placement.conf</code>修改以下内容</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell"> placement_database 段</span><span class="z-comment z-line z-number-sign z-shell">
</span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">connection</span></span><span class="z-meta z-function-call z-arguments z-shell"> = mysql+pymysql://placement:PLACEMENT_DBPASS@controller/placement</span>
</span><span class="z-source z-shell z-bash"><span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell"> api 段</span><span class="z-comment z-line z-number-sign z-shell">
</span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">auth_strategy</span></span><span class="z-meta z-function-call z-arguments z-shell"> = keystone</span>
</span><span class="z-source z-shell z-bash"><span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell"> keystone_authtoken 段</span><span class="z-comment z-line z-number-sign z-shell">
</span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">auth_url</span></span><span class="z-meta z-function-call z-arguments z-shell"> = http://controller:5000/v3</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">memcached_servers</span></span><span class="z-meta z-function-call z-arguments z-shell"> = controller:11211</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">auth_type</span></span><span class="z-meta z-function-call z-arguments z-shell"> = password</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">project_domain_name</span></span><span class="z-meta z-function-call z-arguments z-shell"> = Default</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">user_domain_name</span></span><span class="z-meta z-function-call z-arguments z-shell"> = Default</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">project_name</span></span><span class="z-meta z-function-call z-arguments z-shell"> = service</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">username</span></span><span class="z-meta z-function-call z-arguments z-shell"> = placement</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">password</span></span><span class="z-meta z-function-call z-arguments z-shell"> = PLACEMENT_PASS</span>
</span></code></pre>
<p>以placement的身份填充数据库</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">su</span></span><span class="z-meta z-function-call z-arguments z-shell"><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>s</span> /bin/sh<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>c</span> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&quot;</span>placement-manage db sync<span class="z-punctuation z-definition z-string z-end z-shell">&quot;</span></span> placement</span>
</span></code></pre>
<p>重启http服务</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">systemctl</span></span><span class="z-meta z-function-call z-arguments z-shell"> restart httpd</span>
</span></code></pre>
<p>验证参考组件参考： https://docs.openstack.org/placement/stein/install/verify.html</p>
<h2 id="nova-ji-suan-kong-zhi-jie-dian">Nova - 计算控制节点</h2>
<p>此服务安装在控制节点，参考文档地址：</p>
<ul>
<li>https://docs.openstack.org/nova/stein/install/</li>
<li>https://docs.openstack.org/nova/stein/install/controller-install-rdo.html
先是建库和授权，到数据库节点执行下面命令</li>
</ul>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">mysql</span></span><span class="z-meta z-function-call z-arguments z-shell"><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>u</span> root<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>p</span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">CREATE</span></span><span class="z-meta z-function-call z-arguments z-shell"> DATABASE nova_api</span><span class="z-keyword z-operator z-logical z-continue z-shell">;</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">CREATE</span></span><span class="z-meta z-function-call z-arguments z-shell"> DATABASE nova</span><span class="z-keyword z-operator z-logical z-continue z-shell">;</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">CREATE</span></span><span class="z-meta z-function-call z-arguments z-shell"> DATABASE nova_cell0</span><span class="z-keyword z-operator z-logical z-continue z-shell">;</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">GRANT</span></span><span class="z-meta z-function-call z-arguments z-shell"> ALL PRIVILEGES ON nova_api.<span class="z-keyword z-operator z-regexp z-quantifier z-shell">*</span> TO <span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>nova<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span>@<span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>localhost<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span> <span class="z-punctuation z-separator z-continuation z-line z-shell">\
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell">  IDENTIFIED BY <span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>NOVA_DBPASS<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span></span><span class="z-keyword z-operator z-logical z-continue z-shell">;</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">GRANT</span></span><span class="z-meta z-function-call z-arguments z-shell"> ALL PRIVILEGES ON nova_api.<span class="z-keyword z-operator z-regexp z-quantifier z-shell">*</span> TO <span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>nova<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span>@<span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>%<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span> <span class="z-punctuation z-separator z-continuation z-line z-shell">\
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell">  IDENTIFIED BY <span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>NOVA_DBPASS<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span></span><span class="z-keyword z-operator z-logical z-continue z-shell">;</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">GRANT</span></span><span class="z-meta z-function-call z-arguments z-shell"> ALL PRIVILEGES ON nova.<span class="z-keyword z-operator z-regexp z-quantifier z-shell">*</span> TO <span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>nova<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span>@<span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>localhost<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span> <span class="z-punctuation z-separator z-continuation z-line z-shell">\
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell">  IDENTIFIED BY <span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>NOVA_DBPASS<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span></span><span class="z-keyword z-operator z-logical z-continue z-shell">;</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">GRANT</span></span><span class="z-meta z-function-call z-arguments z-shell"> ALL PRIVILEGES ON nova.<span class="z-keyword z-operator z-regexp z-quantifier z-shell">*</span> TO <span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>nova<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span>@<span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>%<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span> <span class="z-punctuation z-separator z-continuation z-line z-shell">\
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell">  IDENTIFIED BY <span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>NOVA_DBPASS<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span></span><span class="z-keyword z-operator z-logical z-continue z-shell">;</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">GRANT</span></span><span class="z-meta z-function-call z-arguments z-shell"> ALL PRIVILEGES ON nova_cell0.<span class="z-keyword z-operator z-regexp z-quantifier z-shell">*</span> TO <span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>nova<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span>@<span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>localhost<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span> <span class="z-punctuation z-separator z-continuation z-line z-shell">\
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell">  IDENTIFIED BY <span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>NOVA_DBPASS<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span></span><span class="z-keyword z-operator z-logical z-continue z-shell">;</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">GRANT</span></span><span class="z-meta z-function-call z-arguments z-shell"> ALL PRIVILEGES ON nova_cell0.<span class="z-keyword z-operator z-regexp z-quantifier z-shell">*</span> TO <span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>nova<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span>@<span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>%<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span> <span class="z-punctuation z-separator z-continuation z-line z-shell">\
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell">  IDENTIFIED BY <span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>NOVA_DBPASS<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span></span><span class="z-keyword z-operator z-logical z-continue z-shell">;</span>
</span></code></pre>
<p>在keystone中创建账号和服务实体</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell"> 凭证环境</span><span class="z-comment z-line z-number-sign z-shell">
</span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">./admin-openrc</span></span>
</span><span class="z-source z-shell z-bash"><span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell"> 创建用户</span><span class="z-comment z-line z-number-sign z-shell">
</span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">openstack</span></span><span class="z-meta z-function-call z-arguments z-shell"> user create<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>domain</span> default<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>password</span> NOVA_PASS nova</span>
</span><span class="z-source z-shell z-bash"><span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell"> 关联权限</span><span class="z-comment z-line z-number-sign z-shell">
</span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">openstack</span></span><span class="z-meta z-function-call z-arguments z-shell"> role add<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>project</span> service<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>user</span> nova admin</span>
</span><span class="z-source z-shell z-bash"><span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell"> 创建访问实例</span><span class="z-comment z-line z-number-sign z-shell">
</span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">openstack</span></span><span class="z-meta z-function-call z-arguments z-shell"> service create<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>name</span> nova <span class="z-punctuation z-separator z-continuation z-line z-shell">\
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell"><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell">  --</span>description</span> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&quot;</span>OpenStack Compute<span class="z-punctuation z-definition z-string z-end z-shell">&quot;</span></span> compute</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">openstack</span></span><span class="z-meta z-function-call z-arguments z-shell"> endpoint create<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>region</span> RegionOne <span class="z-punctuation z-separator z-continuation z-line z-shell">\
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell">  compute public http://controller:8774/v2.1</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">openstack</span></span><span class="z-meta z-function-call z-arguments z-shell"> endpoint create<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>region</span> RegionOne <span class="z-punctuation z-separator z-continuation z-line z-shell">\
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell">  compute internal http://controller:8774/v2.1</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">openstack</span></span><span class="z-meta z-function-call z-arguments z-shell"> endpoint create<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>region</span> RegionOne <span class="z-punctuation z-separator z-continuation z-line z-shell">\
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell">  compute admin http://controller:8774/v2.1</span>
</span></code></pre>
<p>安装软件包</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">yum</span></span><span class="z-meta z-function-call z-arguments z-shell"> install<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>y</span> openstack-nova-api openstack-nova-conductor <span class="z-punctuation z-separator z-continuation z-line z-shell">\
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell">  openstack-nova-novncproxy openstack-nova-scheduler</span>
</span></code></pre>
<p>关于三个包的作用</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">openstack-nova-api</span></span><span class="z-meta z-function-call z-arguments z-shell"> 组件之间调用</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">openstack-nova-conductor</span></span><span class="z-meta z-function-call z-arguments z-shell"> 用来协调数据库的，后期计算节点会很多，如果每个都有数据库信息这样并不安全而且也很麻烦，所以这个组件就负责计算节点之前数据库和各类调用与数据库交互用的。</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">openstack-nova-novncproxy</span></span><span class="z-meta z-function-call z-arguments z-shell"> 创建好的机器会开放VNC，这个就是用来提供一个VNC连接的</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">openstack-nova-scheduler</span></span><span class="z-meta z-function-call z-arguments z-shell"> 用来协调资源的，一个实例请求发送过来之后，他来判断那台主机适合创建这台机器。</span>
</span></code></pre>
<p>下面开始修改配置</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell"> 备份</span><span class="z-comment z-line z-number-sign z-shell">
</span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">cp</span></span><span class="z-meta z-function-call z-arguments z-shell"> /etc/nova/nova.conf<span class="z-meta z-group z-expansion z-brace z-shell"><span class="z-punctuation z-section z-expansion z-brace z-begin z-shell">{</span><span class="z-punctuation z-separator z-shell">,</span>.bak<span class="z-punctuation z-section z-expansion z-brace z-end z-shell">}</span></span></span>
</span><span class="z-source z-shell z-bash"><span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell"> 去除空行和注释</span><span class="z-comment z-line z-number-sign z-shell">
</span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">egrep</span></span><span class="z-meta z-function-call z-arguments z-shell"><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>v</span> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&quot;</span>^$|^#<span class="z-punctuation z-definition z-string z-end z-shell">&quot;</span></span> /etc/nova/nova.conf.bak <span class="z-keyword z-operator z-assignment z-redirection z-shell">&gt;</span> /etc/nova/nova.conf</span>
</span></code></pre>
<p>编辑配置<code>/etc/nova/nova.conf</code>，主要修改下面内容</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">[DEFAULT]</span></span><span class="z-meta z-function-call z-arguments z-shell">                                                        </span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">my_ip</span></span><span class="z-meta z-function-call z-arguments z-shell"> = 10.0.0.11                                                </span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">enabled_apis</span></span><span class="z-meta z-function-call z-arguments z-shell"> = osapi_compute,metadata                            </span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">transport_url</span></span><span class="z-meta z-function-call z-arguments z-shell"> = rabbit://openstack:RABBIT_PASS@controller        </span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">use_neutron</span></span><span class="z-meta z-function-call z-arguments z-shell"> = true                                               </span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">firewall_driver</span></span><span class="z-meta z-function-call z-arguments z-shell"> = nova.virt.firewall.NoopFirewallDriver</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">[api]</span></span><span class="z-meta z-function-call z-arguments z-shell">                   </span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">auth_strategy</span></span><span class="z-meta z-function-call z-arguments z-shell"> = keystone</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">[api_database]</span></span><span class="z-meta z-function-call z-arguments z-shell">                                                   </span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">connection</span></span><span class="z-meta z-function-call z-arguments z-shell"> = mysql+pymysql://nova:NOVA_DBPASS@controller/nova_api</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">[database]</span></span><span class="z-meta z-function-call z-arguments z-shell">                                                                         connection = mysql+pymysql://nova:NOVA_DBPASS@controller/nova</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">[glance]</span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">api_servers</span></span><span class="z-meta z-function-call z-arguments z-shell"> = http://controller:9292</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">[keystone_authtoken]</span></span><span class="z-meta z-function-call z-arguments z-shell">                                                               auth_url = http://controller:5000/v3                                               memcached_servers = controller:11211                                               auth_type = password                                                               project_domain_name = Default                                                      user_domain_name = Default                                                         project_name = service                                                             username = nova                                                                    password = NOVA_PASS</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">[oslo_concurrency]</span></span><span class="z-meta z-function-call z-arguments z-shell">                                               </span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">lock_path</span></span><span class="z-meta z-function-call z-arguments z-shell"> = /var/lib/nova/tmp</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">[placement]</span></span><span class="z-meta z-function-call z-arguments z-shell">                                                                        region_name = RegionOne                                                            project_domain_name = Default                                                      project_name = service                                                             auth_type = password                                                               user_domain_name = Default                                                         auth_url = http://controller:5000/v3                                               username = placement     </span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">password</span></span><span class="z-meta z-function-call z-arguments z-shell"> = PLACEMENT_PASS</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">[vnc]</span></span><span class="z-meta z-function-call z-arguments z-shell">                              </span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">enabled</span></span><span class="z-meta z-function-call z-arguments z-shell"> = true                     </span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">server_listen</span></span><span class="z-meta z-function-call z-arguments z-shell"> = <span class="z-meta z-group z-expansion z-parameter z-shell"><span class="z-punctuation z-definition z-variable z-shell">$</span><span class="z-variable z-other z-readwrite z-shell">my_ip</span></span>             </span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">server_proxyclient_address</span></span><span class="z-meta z-function-call z-arguments z-shell"> = <span class="z-meta z-group z-expansion z-parameter z-shell"><span class="z-punctuation z-definition z-variable z-shell">$</span><span class="z-variable z-other z-readwrite z-shell">my_ip</span></span></span>
</span></code></pre>
<p>根据对应段进行添加配置，其中需要注意的是</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">[DEFAULT]</span></span>
</span><span class="z-source z-shell z-bash"><span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell"> ...</span><span class="z-comment z-line z-number-sign z-shell">
</span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">use_neutron</span></span><span class="z-meta z-function-call z-arguments z-shell"> = true</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">firewall_driver</span></span><span class="z-meta z-function-call z-arguments z-shell"> = nova.virt.firewall.NoopFirewallDriver</span>
</span><span class="z-source z-shell z-bash"><span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell"> ...</span><span class="z-comment z-line z-number-sign z-shell">
</span></span></code></pre>
<p>这段中，在老版本的环境中，网络还不是<code>neutron</code>组件来管的，是nova的一个，他为了兼容添加了<code>use_neutron</code>这个参数，需要打开
下面开始填充数据库</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">su</span></span><span class="z-meta z-function-call z-arguments z-shell"><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>s</span> /bin/sh<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>c</span> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&quot;</span>nova-manage api_db sync<span class="z-punctuation z-definition z-string z-end z-shell">&quot;</span></span> nova</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">su</span></span><span class="z-meta z-function-call z-arguments z-shell"><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>s</span> /bin/sh<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>c</span> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&quot;</span>nova-manage cell_v2 map_cell0<span class="z-punctuation z-definition z-string z-end z-shell">&quot;</span></span> nova</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">su</span></span><span class="z-meta z-function-call z-arguments z-shell"><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>s</span> /bin/sh<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>c</span> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&quot;</span>nova-manage cell_v2 create_cell --name=cell1 --verbose<span class="z-punctuation z-definition z-string z-end z-shell">&quot;</span></span> nova</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">su</span></span><span class="z-meta z-function-call z-arguments z-shell"><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>s</span> /bin/sh<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>c</span> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&quot;</span>nova-manage db sync<span class="z-punctuation z-definition z-string z-end z-shell">&quot;</span></span> nova</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">su</span></span><span class="z-meta z-function-call z-arguments z-shell"><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>s</span> /bin/sh<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>c</span> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&quot;</span>nova-manage cell_v2 list_cells<span class="z-punctuation z-definition z-string z-end z-shell">&quot;</span></span> nova</span>
</span></code></pre>
<p>在执行过程中可能有一条会出现几条警告，那个无所谓别出现报错就行。
启动服务，启动服务的命令和官网文档的稍微不一样，这里移除了<code>openstack-nova-consoleauth</code>，这个服务在18.0.0 (Rocky)的时候就被遗弃了。</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">systemctl</span></span><span class="z-meta z-function-call z-arguments z-shell"> enable<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>now</span> openstack-nova-api.service <span class="z-punctuation z-separator z-continuation z-line z-shell">\
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell">  openstack-nova-scheduler.service <span class="z-punctuation z-separator z-continuation z-line z-shell">\
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell">  openstack-nova-conductor.service openstack-nova-novncproxy.service</span>
</span></code></pre>
<p>配置好之后验证好可以参考链接： https://docs.openstack.org/nova/stein/install/verify.html
按照本文的进度搭建好的service组件应该是只有两个
<img src="https://image.boychai.xyz/article/Pasted%20image%2020241230150545.png" alt="" />
这是正常的，然后通过<code>nova-status upgrade check</code>去验证的时候会出现403的错误，这也是正常的，因为这是个bug，具体可参考文章： https://www.cnblogs.com/omgasw/p/12016839.html
解决方案是编辑<code>/etc/httpd/conf.d/00-placement-api.conf</code>，添加配置</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-keyword z-operator z-assignment z-redirection z-shell">&lt;</span>Directory <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">/usr/bin</span></span><span class="z-meta z-function-call z-arguments z-shell"><span class="z-keyword z-operator z-assignment z-redirection z-shell">&gt;</span>
</span></span><span class="z-source z-shell z-bash">   <span class="z-keyword z-operator z-assignment z-redirection z-shell">&lt;</span>IfVersion <span class="z-string z-unquoted z-shell">&gt;=</span> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">2.4</span></span><span class="z-meta z-function-call z-arguments z-shell"><span class="z-keyword z-operator z-assignment z-redirection z-shell">&gt;</span>
</span></span><span class="z-source z-shell z-bash">      <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">Require</span></span><span class="z-meta z-function-call z-arguments z-shell"> all granted</span>
</span><span class="z-source z-shell z-bash">   <span class="z-keyword z-operator z-assignment z-redirection z-shell">&lt;</span>/IfVersion<span class="z-keyword z-operator z-assignment z-redirection z-shell">&gt;</span>
</span><span class="z-source z-shell z-bash">   <span class="z-keyword z-operator z-assignment z-redirection z-shell">&lt;</span>IfVersion <span class="z-keyword z-operator z-assignment z-redirection z-shell">&lt;</span> <span class="z-constant z-numeric z-integer z-decimal z-file-descriptor z-shell">2</span><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">.4</span></span><span class="z-meta z-function-call z-arguments z-shell"><span class="z-keyword z-operator z-assignment z-redirection z-shell">&gt;</span>
</span></span><span class="z-source z-shell z-bash">      <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">Order</span></span><span class="z-meta z-function-call z-arguments z-shell"> allow,deny</span>
</span><span class="z-source z-shell z-bash">      <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">Allow</span></span><span class="z-meta z-function-call z-arguments z-shell"> from all</span>
</span><span class="z-source z-shell z-bash">   <span class="z-keyword z-operator z-assignment z-redirection z-shell">&lt;</span>/IfVersion<span class="z-keyword z-operator z-assignment z-redirection z-shell">&gt;</span>
</span><span class="z-source z-shell z-bash"><span class="z-keyword z-operator z-assignment z-redirection z-shell">&lt;</span>/Directory<span class="z-keyword z-operator z-assignment z-redirection z-shell">&gt;</span>
</span></code></pre>
<p>之后重启apache服务</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">systemctl</span></span><span class="z-meta z-function-call z-arguments z-shell"> restart httpd</span>
</span></code></pre>
<p>即可再次尝试通过<code>nova-status upgrade check</code>去验证。</p>
<h2 id="nova-ji-suan-jie-dian">Nova - 计算节点</h2>
<p>下面的操作是在计算节点中操作，文档参考： https://docs.openstack.org/nova/stein/install/compute-install-rdo.html
下面开始安装组件</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">yum</span></span><span class="z-meta z-function-call z-arguments z-shell"> install<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>y</span> openstack-nova-compute</span>
</span></code></pre>
<p>下面开始修改配置</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell"> 备份</span><span class="z-comment z-line z-number-sign z-shell">
</span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">cp</span></span><span class="z-meta z-function-call z-arguments z-shell"> /etc/nova/nova.conf<span class="z-meta z-group z-expansion z-brace z-shell"><span class="z-punctuation z-section z-expansion z-brace z-begin z-shell">{</span><span class="z-punctuation z-separator z-shell">,</span>.bak<span class="z-punctuation z-section z-expansion z-brace z-end z-shell">}</span></span></span>
</span><span class="z-source z-shell z-bash"><span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell"> 去除空行和注释</span><span class="z-comment z-line z-number-sign z-shell">
</span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">egrep</span></span><span class="z-meta z-function-call z-arguments z-shell"><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>v</span> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&quot;</span>^$|^#<span class="z-punctuation z-definition z-string z-end z-shell">&quot;</span></span> /etc/nova/nova.conf.bak <span class="z-keyword z-operator z-assignment z-redirection z-shell">&gt;</span> /etc/nova/nova.conf</span>
</span></code></pre>
<p>编辑配置<code>/etc/nova/nova.conf</code>，主要修改下面内容</p>
<pre data-lang="/etc/nova/nova.conf" class="language-/etc/nova/nova.conf z-code"><code class="language-/etc/nova/nova.conf" data-lang="/etc/nova/nova.conf"><span class="z-text z-plain">[DEFAULT]                                                
</span><span class="z-text z-plain">my_ip = 10.0.0.31                                        
</span><span class="z-text z-plain">use_neutron = true                                       
</span><span class="z-text z-plain">firewall_driver = nova.virt.firewall.NoopFirewallDriver  
</span><span class="z-text z-plain">enabled_apis = osapi_compute,metadata                    
</span><span class="z-text z-plain">transport_url = rabbit://openstack:RABBIT_PASS@controller
</span><span class="z-text z-plain">[api]
</span><span class="z-text z-plain">auth_strategy = keystone
</span><span class="z-text z-plain">[glance]                            
</span><span class="z-text z-plain">api_servers = http://controller:9292
</span><span class="z-text z-plain">[keystone_authtoken]                                                               auth_url = http://controller:5000/v3                                               memcached_servers = controller:11211                                               auth_type = password                                                               project_domain_name = Default                                                      user_domain_name = Default                                                         project_name = service                                                             username = nova     
</span><span class="z-text z-plain">password = NOVA_PASS
</span><span class="z-text z-plain">[oslo_concurrency]           
</span><span class="z-text z-plain">lock_path = /var/lib/nova/tmp
</span><span class="z-text z-plain">[placement]                                                                        region_name = RegionOne                                                            project_domain_name = Default                                                      project_name = service                                                             auth_type = password                                                               user_domain_name = Default                                                         auth_url = http://controller:5000/v3                                               username = placement     
</span><span class="z-text z-plain">password = PLACEMENT_PASS
</span><span class="z-text z-plain">[vnc]                                                                              enabled = true                                                                     server_listen = 0.0.0.0                                                            server_proxyclient_address = $my_ip                       
</span><span class="z-text z-plain">novncproxy_base_url = http://controller:6080/vnc_auto.html
</span></code></pre>
<p>要注意的是<code>my_ip</code>这里需要改成自己的ip。
启动服务</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">systemctl</span></span><span class="z-meta z-function-call z-arguments z-shell"> enable<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>now</span> libvirtd.service openstack-nova-compute.service</span>
</span></code></pre>
<p>然后验证参考链接： https://docs.openstack.org/nova/stein/install/compute-install-rdo.html#add-the-compute-node-to-the-cell-database
每次加计算节点的时候都需要在控制节点执行</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">su</span></span><span class="z-meta z-function-call z-arguments z-shell"><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>s</span> /bin/sh<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>c</span> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&quot;</span>nova-manage cell_v2 discover_hosts --verbose<span class="z-punctuation z-definition z-string z-end z-shell">&quot;</span></span> nova</span>
</span></code></pre>
<p>这是用来发现主机的，如果不想手动去执行，则可以在nova的控制节点配置中添加这段配置</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">[scheduler]</span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">discover_hosts_in_cells_interval</span></span><span class="z-meta z-function-call z-arguments z-shell"> = 300</span>
</span></code></pre>
<h2 id="neutron-wang-luo-kong-zhi-jie-dian">Neutron - 网络控制节点</h2>
<p>参考文档如下</p>
<ul>
<li>https://docs.openstack.org/neutron/stein/install/install-rdo.html</li>
<li>https://docs.openstack.org/neutron/stein/install/controller-install-rdo.html</li>
<li>https://docs.openstack.org/neutron/stein/install/controller-install-option1-rdo.html
先在数据库节点去创建对应的库和授权</li>
</ul>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">mysql</span></span><span class="z-meta z-function-call z-arguments z-shell"><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>u</span> root<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>p</span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">CREATE</span></span><span class="z-meta z-function-call z-arguments z-shell"> DATABASE neutron</span><span class="z-keyword z-operator z-logical z-continue z-shell">;</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">GRANT</span></span><span class="z-meta z-function-call z-arguments z-shell"> ALL PRIVILEGES ON neutron.<span class="z-keyword z-operator z-regexp z-quantifier z-shell">*</span> TO <span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>neutron<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span>@<span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>localhost<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span> <span class="z-punctuation z-separator z-continuation z-line z-shell">\
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell">  IDENTIFIED BY <span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>NEUTRON_DBPASS<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span></span><span class="z-keyword z-operator z-logical z-continue z-shell">;</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">GRANT</span></span><span class="z-meta z-function-call z-arguments z-shell"> ALL PRIVILEGES ON neutron.<span class="z-keyword z-operator z-regexp z-quantifier z-shell">*</span> TO <span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>neutron<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span>@<span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>%<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span> <span class="z-punctuation z-separator z-continuation z-line z-shell">\
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell">  IDENTIFIED BY <span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>NEUTRON_DBPASS<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span></span><span class="z-keyword z-operator z-logical z-continue z-shell">;</span>
</span></code></pre>
<p>在keystone中创建账号和服务实体</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">./admin-openrc</span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">openstack</span></span><span class="z-meta z-function-call z-arguments z-shell"> user create<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>domain</span> default<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>password</span> NEUTRON_PASS neutron</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">openstack</span></span><span class="z-meta z-function-call z-arguments z-shell"> role add<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>project</span> service<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>user</span> neutron adminopenstack service create<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>name</span> neutron <span class="z-punctuation z-separator z-continuation z-line z-shell">\
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell"><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell">  --</span>description</span> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&quot;</span>OpenStack Networking<span class="z-punctuation z-definition z-string z-end z-shell">&quot;</span></span> network</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">openstack</span></span><span class="z-meta z-function-call z-arguments z-shell"> endpoint create<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>region</span> RegionOne <span class="z-punctuation z-separator z-continuation z-line z-shell">\
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell">  network public http://controller:9696</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">openstack</span></span><span class="z-meta z-function-call z-arguments z-shell"> endpoint create<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>region</span> RegionOne <span class="z-punctuation z-separator z-continuation z-line z-shell">\
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell">  network internal http://controller:9696</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">openstack</span></span><span class="z-meta z-function-call z-arguments z-shell"> endpoint create<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>region</span> RegionOne <span class="z-punctuation z-separator z-continuation z-line z-shell">\
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell">  network admin http://controller:9696</span>
</span></code></pre>
<p>开始安装对应包，openstack默认提供两种网络方案，一个是提供商网络还有一个是自建网络也可以看作为阿里的VPC，这里搭建采用提供商网络，相当于桥接网络。</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">yum</span></span><span class="z-meta z-function-call z-arguments z-shell"> install<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>y</span> openstack-neutron openstack-neutron-ml2 <span class="z-punctuation z-separator z-continuation z-line z-shell">\
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell">  openstack-neutron-linuxbridge ebtables</span>
</span></code></pre>
<p>下面开始修改配置</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell"> 备份</span><span class="z-comment z-line z-number-sign z-shell">
</span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">cp</span></span><span class="z-meta z-function-call z-arguments z-shell"> /etc/neutron/neutron.conf<span class="z-meta z-group z-expansion z-brace z-shell"><span class="z-punctuation z-section z-expansion z-brace z-begin z-shell">{</span><span class="z-punctuation z-separator z-shell">,</span>.bak<span class="z-punctuation z-section z-expansion z-brace z-end z-shell">}</span></span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">cp</span></span><span class="z-meta z-function-call z-arguments z-shell"> /etc/neutron/plugins/ml2/ml2_conf.ini<span class="z-meta z-group z-expansion z-brace z-shell"><span class="z-punctuation z-section z-expansion z-brace z-begin z-shell">{</span><span class="z-punctuation z-separator z-shell">,</span>.bak<span class="z-punctuation z-section z-expansion z-brace z-end z-shell">}</span></span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">cp</span></span><span class="z-meta z-function-call z-arguments z-shell"> /etc/neutron/plugins/ml2/linuxbridge_agent.ini<span class="z-meta z-group z-expansion z-brace z-shell"><span class="z-punctuation z-section z-expansion z-brace z-begin z-shell">{</span><span class="z-punctuation z-separator z-shell">,</span>.bak<span class="z-punctuation z-section z-expansion z-brace z-end z-shell">}</span></span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">cp</span></span><span class="z-meta z-function-call z-arguments z-shell"> /etc/neutron/dhcp_agent.ini<span class="z-meta z-group z-expansion z-brace z-shell"><span class="z-punctuation z-section z-expansion z-brace z-begin z-shell">{</span><span class="z-punctuation z-separator z-shell">,</span>.bak<span class="z-punctuation z-section z-expansion z-brace z-end z-shell">}</span></span></span>
</span><span class="z-source z-shell z-bash"><span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell"> 去除空行和注释</span><span class="z-comment z-line z-number-sign z-shell">
</span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">egrep</span></span><span class="z-meta z-function-call z-arguments z-shell"><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>v</span> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&quot;</span>^$|^#<span class="z-punctuation z-definition z-string z-end z-shell">&quot;</span></span> /etc/neutron/neutron.conf.bak <span class="z-keyword z-operator z-assignment z-redirection z-shell">&gt;</span> /etc/neutron/neutron.conf</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">egrep</span></span><span class="z-meta z-function-call z-arguments z-shell"><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>v</span> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&quot;</span>^$|^#<span class="z-punctuation z-definition z-string z-end z-shell">&quot;</span></span> /etc/neutron/plugins/ml2/ml2_conf.ini.bak <span class="z-keyword z-operator z-assignment z-redirection z-shell">&gt;</span> /etc/neutron/plugins/ml2/ml2_conf.ini</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">egrep</span></span><span class="z-meta z-function-call z-arguments z-shell"><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>v</span> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&quot;</span>^$|^#<span class="z-punctuation z-definition z-string z-end z-shell">&quot;</span></span> /etc/neutron/plugins/ml2/linuxbridge_agent.ini.bak <span class="z-keyword z-operator z-assignment z-redirection z-shell">&gt;</span> /etc/neutron/plugins/ml2/linuxbridge_agent.ini</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">egrep</span></span><span class="z-meta z-function-call z-arguments z-shell"><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>v</span> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&quot;</span>^$|^#<span class="z-punctuation z-definition z-string z-end z-shell">&quot;</span></span> /etc/neutron/dhcp_agent.ini.bak <span class="z-keyword z-operator z-assignment z-redirection z-shell">&gt;</span> /etc/neutron/dhcp_agent.ini</span>
</span></code></pre>
<p>开始配置<code>/etc/neutron/neutron.conf</code></p>
<pre data-lang="/etc/neutron/neutron.conf" class="language-/etc/neutron/neutron.conf z-code"><code class="language-/etc/neutron/neutron.conf" data-lang="/etc/neutron/neutron.conf"><span class="z-text z-plain">[DEFAULT]                                                                          notify_nova_on_port_status_changes = true                                          notify_nova_on_port_data_changes = true                                            transport_url = rabbit://openstack:RABBIT_PASS@controller                          core_plugin = ml2                                                                  auth_strategy = keystone                                                           service_plugins =
</span><span class="z-text z-plain">[database]                                                            
</span><span class="z-text z-plain">connection = mysql+pymysql://neutron:NEUTRON_DBPASS@controller/neutron
</span><span class="z-text z-plain">[keystone_authtoken]                                                               
</span><span class="z-text z-plain">www_authenticate_uri = http://controller:5000                                      
</span><span class="z-text z-plain">auth_url = http://controller:5000                                                  
</span><span class="z-text z-plain">memcached_servers = controller:11211                                               
</span><span class="z-text z-plain">auth_type = password                                                               
</span><span class="z-text z-plain">project_domain_name = default                                                      
</span><span class="z-text z-plain">user_domain_name = default                                                         
</span><span class="z-text z-plain">project_name = service 
</span><span class="z-text z-plain">username = neutron     
</span><span class="z-text z-plain">password = NEUTRON_PASS
</span><span class="z-text z-plain">[oslo_concurrency]              
</span><span class="z-text z-plain">lock_path = /var/lib/neutron/tmp
</span><span class="z-text z-plain">[nova]                                                            
</span><span class="z-text z-plain">auth_url = http://controller:5000                                 
</span><span class="z-text z-plain">auth_type = password                                              
</span><span class="z-text z-plain">project_domain_name = default                                     
</span><span class="z-text z-plain">user_domain_name = default                                        
</span><span class="z-text z-plain">region_name = RegionOne                                           
</span><span class="z-text z-plain">project_name = service                                                             
</span><span class="z-text z-plain">username = nova     
</span><span class="z-text z-plain">password = NOVA_PASS
</span></code></pre>
<p>配置<code>/etc/neutron/plugins/ml2/ml2_conf.ini</code>，这个文件时ml2模块的配置文件</p>
<pre data-lang="/etc/neutron/plugins/ml2/ml2_conf.ini" class="language-/etc/neutron/plugins/ml2/ml2_conf.ini z-code"><code class="language-/etc/neutron/plugins/ml2/ml2_conf.ini" data-lang="/etc/neutron/plugins/ml2/ml2_conf.ini"><span class="z-text z-plain">[ml2]                                                                              
</span><span class="z-text z-plain">type_drivers = flat,vlan                                                           
</span><span class="z-text z-plain">tenant_network_types =  
</span><span class="z-text z-plain">mechanism_drivers = linuxbridge                                                    
</span><span class="z-text z-plain">extension_drivers = port_security                                                  
</span><span class="z-text z-plain">[ml2_type_flat]
</span><span class="z-text z-plain">flat_networks = provider,net_vmnet1
</span><span class="z-text z-plain">[securitygroup]
</span><span class="z-text z-plain">enable_ipset = true                                                           
</span></code></pre>
<p>配置<code>/etc/neutron/plugins/ml2/linuxbridge_agent.ini</code>，这里是linuxbridge的配置</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">[linux_bridge]</span></span><span class="z-meta z-function-call z-arguments z-shell">                                                                </span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">physical_interface_mappings</span></span><span class="z-meta z-function-call z-arguments z-shell"> = provider:ens33                </span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">[vxlan]</span></span><span class="z-meta z-function-call z-arguments z-shell">                                                                       </span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">enable_vxlan</span></span><span class="z-meta z-function-call z-arguments z-shell"> = false                                                          </span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">[securitygroup]</span></span><span class="z-meta z-function-call z-arguments z-shell">                                                               </span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">enable_security_group</span></span><span class="z-meta z-function-call z-arguments z-shell"> = true                                                  </span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">firewall_driver</span></span><span class="z-meta z-function-call z-arguments z-shell"> = neutron.agent.linux.iptables_firewall.IptablesFirewallDriver</span>
</span></code></pre>
<p>下面开始加载系统模块，</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-support z-function z-echo z-shell">echo</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&quot;</span>br_netfilter<span class="z-punctuation z-definition z-string z-end z-shell">&quot;</span></span> <span class="z-keyword z-operator z-assignment z-redirection z-shell">&gt;&gt;</span> /etc/modules-load.d/bridge.conf</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">modprobe</span></span><span class="z-meta z-function-call z-arguments z-shell"> br_netfilter</span>
</span></code></pre>
<p>配置sysctl,编辑<code>/etc/sysctl.conf</code></p>
<pre data-lang="/etc/sysctl.conf" class="language-/etc/sysctl.conf z-code"><code class="language-/etc/sysctl.conf" data-lang="/etc/sysctl.conf"><span class="z-text z-plain">net.bridge.bridge-nf-call-iptables = 1 
</span><span class="z-text z-plain">net.bridge.bridge-nf-call-ip6tables = 1
</span></code></pre>
<p>执行<code>sysctl -p</code>重载,在配置的时候需要注意<code>physical_interface_mappings</code>文档中需要自己指定网卡名字，这里我的网卡是ens33所以指定这个，还有就是关于vxlan，因为这里是采用提供商网络，相当于桥接，不需要vxlan直接关闭，后面配置自由网络还需要开启。
配置<code>/etc/neutron/dhcp_agent.ini</code>，这个文件是为了dhcp的配置</p>
<pre data-lang="/etc/neutron/dhcp_agent.ini" class="language-/etc/neutron/dhcp_agent.ini z-code"><code class="language-/etc/neutron/dhcp_agent.ini" data-lang="/etc/neutron/dhcp_agent.ini"><span class="z-text z-plain">[DEFAULT]
</span><span class="z-text z-plain">interface_driver = linuxbridge
</span><span class="z-text z-plain">dhcp_driver = neutron.agent.linux.dhcp.Dnsmasq
</span><span class="z-text z-plain">enable_isolated_metadata = true
</span></code></pre>
<p>在配置过程中可能有些官网字段不存在，直接自己加上即可。
此时提供商网络已经配置好，现在需要开始配置<code>neutron</code>的其他选项，下面开始修改配置</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell"> 备份</span><span class="z-comment z-line z-number-sign z-shell">
</span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">cp</span></span><span class="z-meta z-function-call z-arguments z-shell"> /etc/neutron/metadata_agent.ini<span class="z-meta z-group z-expansion z-brace z-shell"><span class="z-punctuation z-section z-expansion z-brace z-begin z-shell">{</span><span class="z-punctuation z-separator z-shell">,</span>.bak<span class="z-punctuation z-section z-expansion z-brace z-end z-shell">}</span></span></span>
</span><span class="z-source z-shell z-bash"><span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell"> 去除空行和注释</span><span class="z-comment z-line z-number-sign z-shell">
</span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">egrep</span></span><span class="z-meta z-function-call z-arguments z-shell"><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>v</span> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&quot;</span>^$|^#<span class="z-punctuation z-definition z-string z-end z-shell">&quot;</span></span> /etc/neutron/metadata_agent.ini.bak <span class="z-keyword z-operator z-assignment z-redirection z-shell">&gt;</span> /etc/neutron/metadata_agent.ini</span>
</span></code></pre>
<p>编辑<code>/etc/neutron/metadata_agent.ini</code>,修改内容如下</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">[DEFAULT]</span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">nova_metadata_host</span></span><span class="z-meta z-function-call z-arguments z-shell"> = controller</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">metadata_proxy_shared_secret</span></span><span class="z-meta z-function-call z-arguments z-shell"> = METADATA_SECRET</span>
</span></code></pre>
<p>现在<code>neutron</code>已经配置完成，需要去nova控制节点去对接，编辑文件<code>/etc/nova/nova.conf</code>,修改下面内容</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">[neutron]</span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">url</span></span><span class="z-meta z-function-call z-arguments z-shell"> = http://controller:9696</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">auth_url</span></span><span class="z-meta z-function-call z-arguments z-shell"> = http://controller:5000</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">auth_type</span></span><span class="z-meta z-function-call z-arguments z-shell"> = password</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">project_domain_name</span></span><span class="z-meta z-function-call z-arguments z-shell"> = default</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">user_domain_name</span></span><span class="z-meta z-function-call z-arguments z-shell"> = default</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">region_name</span></span><span class="z-meta z-function-call z-arguments z-shell"> = RegionOne</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">project_name</span></span><span class="z-meta z-function-call z-arguments z-shell"> = service</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">username</span></span><span class="z-meta z-function-call z-arguments z-shell"> = neutron</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">password</span></span><span class="z-meta z-function-call z-arguments z-shell"> = NEUTRON_PASS</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">service_metadata_proxy</span></span><span class="z-meta z-function-call z-arguments z-shell"> = true</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">metadata_proxy_shared_secret</span></span><span class="z-meta z-function-call z-arguments z-shell"> = METADATA_SECRET</span>
</span></code></pre>
<p>下面开始做启动neutron的工作</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell"> 引用ml2模块</span><span class="z-comment z-line z-number-sign z-shell">
</span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">ln</span></span><span class="z-meta z-function-call z-arguments z-shell"><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>s</span> /etc/neutron/plugins/ml2/ml2_conf.ini /etc/neutron/plugin.ini</span>
</span><span class="z-source z-shell z-bash"><span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell"> 填充数据库</span><span class="z-comment z-line z-number-sign z-shell">
</span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">su</span></span><span class="z-meta z-function-call z-arguments z-shell"><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>s</span> /bin/sh<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>c</span> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&quot;</span>neutron-db-manage --config-file /etc/neutron/neutron.conf <span class="z-constant z-character z-escape z-shell">\
</span></span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell"><span class="z-string z-quoted z-double z-shell">  --config-file /etc/neutron/plugins/ml2/ml2_conf.ini upgrade head<span class="z-punctuation z-definition z-string z-end z-shell">&quot;</span></span> neutron</span>
</span><span class="z-source z-shell z-bash"><span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell"> 重启nova控制模块</span><span class="z-comment z-line z-number-sign z-shell">
</span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">systemctl</span></span><span class="z-meta z-function-call z-arguments z-shell"> restart openstack-nova-api.service</span>
</span><span class="z-source z-shell z-bash"><span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell"> 启动neutron的提供商网络,不同的网络方式启动方式不通,请注意官方文档</span><span class="z-comment z-line z-number-sign z-shell">
</span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">systemctl</span></span><span class="z-meta z-function-call z-arguments z-shell"> enable<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>now</span> neutron-server.service <span class="z-punctuation z-separator z-continuation z-line z-shell">\
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell">  neutron-linuxbridge-agent.service neutron-dhcp-agent.service <span class="z-punctuation z-separator z-continuation z-line z-shell">\
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell">  neutron-metadata-agent.service</span>
</span></code></pre>
<p>验证配置参考： https://docs.openstack.org/neutron/stein/install/verify-option1.html
正常的验证效果应该是这样的
<img src="https://image.boychai.xyz/article/Pasted%20image%2020241230165356.png" alt="" /></p>
<h2 id="neutron-wang-luo-ji-suan-jie-dian">Neutron - 网络计算节点</h2>
<p>参考文档： https://docs.openstack.org/neutron/stein/install/compute-install-rdo.html
安装组件</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">yum</span></span><span class="z-meta z-function-call z-arguments z-shell"> install<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>y</span> openstack-neutron-linuxbridge ebtables ipset</span>
</span></code></pre>
<p>备份配置</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell"> 备份</span><span class="z-comment z-line z-number-sign z-shell">
</span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">cp</span></span><span class="z-meta z-function-call z-arguments z-shell"> /etc/neutron/neutron.conf<span class="z-meta z-group z-expansion z-brace z-shell"><span class="z-punctuation z-section z-expansion z-brace z-begin z-shell">{</span><span class="z-punctuation z-separator z-shell">,</span>.bak<span class="z-punctuation z-section z-expansion z-brace z-end z-shell">}</span></span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">cp</span></span><span class="z-meta z-function-call z-arguments z-shell"> /etc/neutron/plugins/ml2/linuxbridge_agent.ini<span class="z-meta z-group z-expansion z-brace z-shell"><span class="z-punctuation z-section z-expansion z-brace z-begin z-shell">{</span><span class="z-punctuation z-separator z-shell">,</span>.bak<span class="z-punctuation z-section z-expansion z-brace z-end z-shell">}</span></span></span>
</span><span class="z-source z-shell z-bash"><span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell"> 去除空行和注释</span><span class="z-comment z-line z-number-sign z-shell">
</span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">egrep</span></span><span class="z-meta z-function-call z-arguments z-shell"><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>v</span> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&quot;</span>^$|^#<span class="z-punctuation z-definition z-string z-end z-shell">&quot;</span></span> /etc/neutron/neutron.conf.bak <span class="z-keyword z-operator z-assignment z-redirection z-shell">&gt;</span> /etc/neutron/neutron.conf</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">egrep</span></span><span class="z-meta z-function-call z-arguments z-shell"><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>v</span> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&quot;</span>^$|^#<span class="z-punctuation z-definition z-string z-end z-shell">&quot;</span></span> /etc/neutron/plugins/ml2/linuxbridge_agent.ini.bak <span class="z-keyword z-operator z-assignment z-redirection z-shell">&gt;</span> /etc/neutron/plugins/ml2/linuxbridge_agent.ini</span>
</span></code></pre>
<p>编辑配置<code>/etc/neutron/neutron.conf</code>主要修改内容如下</p>
<pre data-lang="/etc/neutron/neutron.conf" class="language-/etc/neutron/neutron.conf z-code"><code class="language-/etc/neutron/neutron.conf" data-lang="/etc/neutron/neutron.conf"><span class="z-text z-plain">[DEFAULT]                                                                          transport_url = rabbit://openstack:RABBIT_PASS@controller                          auth_strategy = keystone
</span><span class="z-text z-plain">[keystone_authtoken]                                                               www_authenticate_uri = http://controller:5000                                      auth_url = http://controller:5000                                                  memcached_servers = controller:11211                                               auth_type = password            
</span><span class="z-text z-plain">project_domain_name = default   
</span><span class="z-text z-plain">user_domain_name = default      
</span><span class="z-text z-plain">project_name = service          
</span><span class="z-text z-plain">username = neutron              
</span><span class="z-text z-plain">password = NEUTRON_PASS
</span><span class="z-text z-plain">[oslo_concurrency]              
</span><span class="z-text z-plain">lock_path = /var/lib/neutron/tmp
</span></code></pre>
<p>下面配置<code>ml2</code>模块，编辑<code>/etc/neutron/plugins/ml2/linuxbridge_agent.ini</code>，主要内容和控制节点的一样，直接复制也行，主要内容如下</p>
<pre data-lang="/etc/neutron/plugins/ml2/linuxbridge_agent.ini" class="language-/etc/neutron/plugins/ml2/linuxbridge_agent.ini z-code"><code class="language-/etc/neutron/plugins/ml2/linuxbridge_agent.ini" data-lang="/etc/neutron/plugins/ml2/linuxbridge_agent.ini"><span class="z-text z-plain">[linux_bridge]                                                                
</span><span class="z-text z-plain">physical_interface_mappings = provider:ens33                
</span><span class="z-text z-plain">[vxlan]                                                                       
</span><span class="z-text z-plain">enable_vxlan = false                                                          
</span><span class="z-text z-plain">[securitygroup]                                                               
</span><span class="z-text z-plain">enable_security_group = true                                                  
</span><span class="z-text z-plain">firewall_driver = neutron.agent.linux.iptables_firewall.IptablesFirewallDriver
</span></code></pre>
<p>下面开始加载系统模块，</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-support z-function z-echo z-shell">echo</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&quot;</span>br_netfilter<span class="z-punctuation z-definition z-string z-end z-shell">&quot;</span></span> <span class="z-keyword z-operator z-assignment z-redirection z-shell">&gt;&gt;</span> /etc/modules-load.d/bridge.conf</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">modprobe</span></span><span class="z-meta z-function-call z-arguments z-shell"> br_netfilter</span>
</span></code></pre>
<p>配置sysctl,编辑<code>/etc/sysctl.conf</code></p>
<pre data-lang="/etc/sysctl.conf" class="language-/etc/sysctl.conf z-code"><code class="language-/etc/sysctl.conf" data-lang="/etc/sysctl.conf"><span class="z-text z-plain">net.bridge.bridge-nf-call-iptables = 1 
</span><span class="z-text z-plain">net.bridge.bridge-nf-call-ip6tables = 1
</span></code></pre>
<p>执行<code>sysctl -p</code>重载
下面在计算节点的计算模块对接一下,编辑<code>/etc/nova/nova.conf</code>,主要修改内容如下</p>
<pre data-lang="/etc/nova/nova.conf" class="language-/etc/nova/nova.conf z-code"><code class="language-/etc/nova/nova.conf" data-lang="/etc/nova/nova.conf"><span class="z-text z-plain">[neutron]
</span><span class="z-text z-plain">url = http://controller:9696
</span><span class="z-text z-plain">auth_url = http://controller:5000
</span><span class="z-text z-plain">auth_type = password
</span><span class="z-text z-plain">project_domain_name = default
</span><span class="z-text z-plain">user_domain_name = default
</span><span class="z-text z-plain">region_name = RegionOne
</span><span class="z-text z-plain">project_name = service
</span><span class="z-text z-plain">username = neutron
</span><span class="z-text z-plain">password = NEUTRON_PASS
</span></code></pre>
<p>重启计算节点的<code>nova</code>服务</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">systemctl</span></span><span class="z-meta z-function-call z-arguments z-shell"> restart openstack-nova-compute.service</span>
</span></code></pre>
<p>启动计算节点的<code>neutron</code>模块</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">systemctl</span></span><span class="z-meta z-function-call z-arguments z-shell"> enable<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>now</span> neutron-linuxbridge-agent.service</span>
</span></code></pre>
<h2 id="horizon-yi-biao-pan-fu-wu">Horizon - 仪表盘服务</h2>
<p>参考文档：</p>
<ul>
<li>https://docs.openstack.org/horizon/stein/install/</li>
<li>https://docs.openstack.org/horizon/stein/install/install-rdo.html
这里把仪表盘安装在控制节点中，执行下面命令安装软件包</li>
</ul>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">yum</span></span><span class="z-meta z-function-call z-arguments z-shell"> install<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>y</span> openstack-dashboard</span>
</span></code></pre>
<p>这里备份一下配置</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">cp</span></span><span class="z-meta z-function-call z-arguments z-shell"> /etc/openstack-dashboard/local_settings <span class="z-meta z-group z-expansion z-tilde"><span class="z-variable z-language z-tilde z-shell">~</span></span>/</span>
</span></code></pre>
<p>编辑<code>/etc/openstack-dashboard/local_settings</code>,主要修改内容如下</p>
<pre data-lang="/etc/openstack-dashboard/local_settings" class="language-/etc/openstack-dashboard/local_settings z-code"><code class="language-/etc/openstack-dashboard/local_settings" data-lang="/etc/openstack-dashboard/local_settings"><span class="z-text z-plain"># 设置主机名
</span><span class="z-text z-plain">OPENSTACK_HOST = &quot;controller&quot;
</span><span class="z-text z-plain"># 这里是设置允许访问的主机名，*代表全部
</span><span class="z-text z-plain">ALLOWED_HOSTS = [&#39;*&#39;]
</span><span class="z-text z-plain"># 会话存储引擎指定
</span><span class="z-text z-plain">SESSION_ENGINE = &#39;django.contrib.sessions.backends.cache&#39;
</span><span class="z-text z-plain"># 缓存配置
</span><span class="z-text z-plain">CACHES = {
</span><span class="z-text z-plain">    &#39;default&#39;: {
</span><span class="z-text z-plain">         &#39;BACKEND&#39;: &#39;django.core.cache.backends.memcached.MemcachedCache&#39;,
</span><span class="z-text z-plain">         &#39;LOCATION&#39;: &#39;controller:11211&#39;,
</span><span class="z-text z-plain">    }
</span><span class="z-text z-plain">}
</span><span class="z-text z-plain"># **Keystone** 服务的 URL
</span><span class="z-text z-plain">OPENSTACK_KEYSTONE_URL = &quot;http://%s:5000/v3&quot; % OPENSTACK_HOST
</span><span class="z-text z-plain"># 启用 Keystone 多域支持
</span><span class="z-text z-plain">OPENSTACK_KEYSTONE_MULTIDOMAIN_SUPPORT = True
</span><span class="z-text z-plain"># 定义 OpenStack 服务的 API 版本
</span><span class="z-text z-plain">OPENSTACK_API_VERSIONS = {
</span><span class="z-text z-plain">    &quot;identity&quot;: 3,
</span><span class="z-text z-plain">    &quot;image&quot;: 2,
</span><span class="z-text z-plain">    &quot;volume&quot;: 3,
</span><span class="z-text z-plain">}
</span><span class="z-text z-plain"># 这是 Keystone 服务的配置项，指定默认的域名。
</span><span class="z-text z-plain">OPENSTACK_KEYSTONE_DEFAULT_DOMAIN = &quot;Default&quot;
</span><span class="z-text z-plain"># 新增用户的默认角色(ROLE)
</span><span class="z-text z-plain">OPENSTACK_KEYSTONE_DEFAULT_ROLE = &quot;user&quot;
</span><span class="z-text z-plain"># Neutron 网络服务的设置
</span><span class="z-text z-plain">OPENSTACK_NEUTRON_NETWORK = {
</span><span class="z-text z-plain">    ...
</span><span class="z-text z-plain">    &#39;enable_router&#39;: False,
</span><span class="z-text z-plain">    &#39;enable_quotas&#39;: False,
</span><span class="z-text z-plain">    &#39;enable_distributed_router&#39;: False,
</span><span class="z-text z-plain">    &#39;enable_ha_router&#39;: False,
</span><span class="z-text z-plain">    &#39;enable_lb&#39;: False,
</span><span class="z-text z-plain">    &#39;enable_firewall&#39;: False,
</span><span class="z-text z-plain">    &#39;enable_vpn&#39;: False,
</span><span class="z-text z-plain">    &#39;enable_fip_topology_check&#39;: False,
</span><span class="z-text z-plain">}
</span><span class="z-text z-plain"># 设置时区
</span><span class="z-text z-plain">TIME_ZONE = &quot;Asia/Shanghai&quot;
</span></code></pre>
<p>之后再去编辑<code>/etc/httpd/conf.d/openstack-dashboard.conf</code>,添加下面内容</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">WSGIApplicationGroup</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-meta z-group z-expansion z-job z-shell"><span class="z-punctuation z-definition z-variable z-job z-shell">%</span></span><span class="z-meta z-group z-expansion z-brace z-shell"><span class="z-punctuation z-section z-expansion z-brace z-begin z-shell">{</span>GLOBAL<span class="z-punctuation z-section z-expansion z-brace z-end z-shell">}</span></span></span>
</span></code></pre>
<p>重启服务</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">systemctl</span></span><span class="z-meta z-function-call z-arguments z-shell"> restart httpd.service memcached.service</span>
</span></code></pre>
<p>访问<code>http://10.0.0.11/dashboard</code>
<img src="https://image.boychai.xyz/article/Pasted%20image%2020241230190756.png" alt="" />
默认域<code>default</code>
用户名:<code>admin</code>
密码: <code>ADMIN_PASS</code>
<img src="https://image.boychai.xyz/article/Pasted%20image%2020241230190912.png" alt="" /></p>
<h1 id="jian-dan-shi-yong">简单使用</h1>
<h2 id="qian-yan">前言</h2>
<p>参考文档：</p>
<ul>
<li>https://docs.openstack.org/install-guide/launch-instance.html</li>
<li>https://docs.openstack.org/install-guide/launch-instance-networks-provider.html
这里的使用都是用命令行去创建的，自己也可以通过仪表盘去创建</li>
</ul>
<h2 id="chuang-jian-wang-luo">创建网络</h2>
<p>创建实例前，应该先创建一个网络，可以参考命令</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">openstack</span></span><span class="z-meta z-function-call z-arguments z-shell"> network create<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell">  --</span>share</span><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>external</span> <span class="z-punctuation z-separator z-continuation z-line z-shell">\
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell"><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell">  --</span>provider-physical-network</span> provider <span class="z-punctuation z-separator z-continuation z-line z-shell">\
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell"><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell">  --</span>provider-network-type</span> flat provider</span>
</span></code></pre>
<p><img src="https://image.boychai.xyz/article/Pasted%20image%2020250104140717.png" alt="" />
参数具体含义如下</p>
<ul>
<li>
<p><strong><code>openstack network create</code></strong>：</p>
<ul>
<li>创建一个新的网络。</li>
</ul>
</li>
<li>
<p><strong><code>--share</code></strong>：</p>
<ul>
<li>使网络成为共享的网络，意味着其他租户（project）也可以使用该网络。</li>
</ul>
</li>
<li>
<p><strong><code>--external</code></strong>：</p>
<ul>
<li>标记该网络为外部网络，通常指该网络连接到物理网络或者外部互联网。这通常用于提供公网访问。</li>
</ul>
</li>
<li>
<p><strong><code>--provider-physical-network provider</code></strong>：</p>
<ul>
<li>指定物理网络名称为 <code>provider</code>。这个物理网络是指在网络拓扑中与 OpenStack 的虚拟网络连接的物理网络接口。</li>
</ul>
</li>
<li>
<p><strong><code>--provider-network-type flat</code></strong>：</p>
<ul>
<li>指定网络类型为 <code>flat</code>，表示不使用 VLAN 或者其他网络隔离机制，所有主机之间都在同一个网络中，通常用于简单的网络环境。</li>
</ul>
</li>
<li>
<p><strong><code>provider</code></strong>：</p>
<ul>
<li>这是创建的网络名称。在这个命令中，创建的网络名称是 <code>provider</code>，它是外部共享网络
其中<code>provider</code>是在neutron的ml2模块中指定的。</li>
</ul>
</li>
</ul>
<pre data-lang="/etc/neutron/plugins/ml2/ml2_conf.ini" class="language-/etc/neutron/plugins/ml2/ml2_conf.ini z-code"><code class="language-/etc/neutron/plugins/ml2/ml2_conf.ini" data-lang="/etc/neutron/plugins/ml2/ml2_conf.ini"><span class="z-text z-plain">[ml2]
</span><span class="z-text z-plain">flat_networks = provider                      
</span></code></pre>
<p>之后开始创建子网，执行下面命令创建一个子网</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">openstack</span></span><span class="z-meta z-function-call z-arguments z-shell"> subnet create<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>network</span> provider <span class="z-punctuation z-separator z-continuation z-line z-shell">\
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell"><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell">  --</span>allocation-pool</span> start=START_IP_ADDRESS,end=END_IP_ADDRESS <span class="z-punctuation z-separator z-continuation z-line z-shell">\
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell"><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell">  --</span>dns-nameserver</span> DNS_RESOLVER<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>gateway</span> PROVIDER_NETWORK_GATEWAY <span class="z-punctuation z-separator z-continuation z-line z-shell">\
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell"><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell">  --</span>subnet-range</span> PROVIDER_NETWORK_CIDR provider</span>
</span></code></pre>
<p>注意替换上面相关的参数，这里我替换后的命令是</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">openstack</span></span><span class="z-meta z-function-call z-arguments z-shell"> subnet create<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>network</span> provider <span class="z-punctuation z-separator z-continuation z-line z-shell">\
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell"><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell">  --</span>allocation-pool</span> start=10.0.0.200,end=10.0.0.210 <span class="z-punctuation z-separator z-continuation z-line z-shell">\
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell"><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell">  --</span>dns-nameserver</span> 114.114.114.114<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>gateway</span> 10.0.0.2 <span class="z-punctuation z-separator z-continuation z-line z-shell">\
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell"><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell">  --</span>subnet-range</span> 10.0.0.0/24 provider</span>
</span></code></pre>
<p>要注意的是，因为搭建的时候采用的是供应商网络，相当于直连，想要上网网段需要和虚机网络一样，网关使用虚机的网关。
<img src="https://image.boychai.xyz/article/Pasted%20image%2020250104152819.png" alt="" /></p>
<h2 id="chuang-jian-gui-ge">创建规格</h2>
<p>下面开始创建规格</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">openstack</span></span><span class="z-meta z-function-call z-arguments z-shell"> flavor create<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>id</span> 0<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>vcpus</span> 1<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>ram</span> 64<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>disk</span> 1 m1.nano</span>
</span></code></pre>
<p><img src="https://image.boychai.xyz/article/Pasted%20image%2020250104141706.png" alt="" />
创建一个id为0,cpu数量为1,内存为64,存储为1GB,名字为m1.nano的实例规格</p>
<h2 id="chuang-jian-sshmi-yao-dui">创建SSH密钥对</h2>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell"> 创建密钥对</span><span class="z-comment z-line z-number-sign z-shell">
</span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">ssh-keygen</span></span><span class="z-meta z-function-call z-arguments z-shell"><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>q</span><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>N</span> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&quot;</span><span class="z-punctuation z-definition z-string z-end z-shell">&quot;</span></span></span>
</span><span class="z-source z-shell z-bash"><span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell"> 导入密钥对</span><span class="z-comment z-line z-number-sign z-shell">
</span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">openstack</span></span><span class="z-meta z-function-call z-arguments z-shell"> keypair create<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>public-key</span> <span class="z-meta z-group z-expansion z-tilde"><span class="z-variable z-language z-tilde z-shell">~</span></span>/.ssh/id_rsa.pub mykey</span>
</span></code></pre>
<h2 id="an-quan-zu-gui-ze">安全组规则</h2>
<p>给默认安全组放行icmp协议</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">openstack</span></span><span class="z-meta z-function-call z-arguments z-shell"> security group rule create<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>proto</span> icmp default</span>
</span></code></pre>
<p>放行SSH</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">openstack</span></span><span class="z-meta z-function-call z-arguments z-shell"> security group rule create<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>proto</span> tcp<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>dst-port</span> 22 default</span>
</span></code></pre>
<p>添加安全组规则的原因是因为默认的安全组是一切都拒绝的。</p>
<h2 id="chuang-jian-zhu-ji">创建主机</h2>
<p><img src="https://image.boychai.xyz/article/Pasted%20image%2020250104142612.png" alt="" />
去网页中创建主机。成功运行即成功。</p>
<h1 id="wen-ti-jie-jue">问题解决</h1>
<h2 id="qi-dong-yin-dao-qia-zai-booting-from-hard-disk">启动引导卡在Booting from Hard Disk...</h2>
<p>实例创建好之后进入控制台会出现一直卡在Booting from Hard Disk这一步，这个似乎是因为nova默认设置的主板型号和实际运行的不兼容
<img src="https://image.boychai.xyz/article/Pasted%20image%2020250104143641.png" alt="" />
具体的解决办法是修改nova计算节点的配置文件<code>/etc/nova/nova.conf</code>，修改内容如下</p>
<pre data-lang="/etc/nova/nova.conf" class="language-/etc/nova/nova.conf z-code"><code class="language-/etc/nova/nova.conf" data-lang="/etc/nova/nova.conf"><span class="z-text z-plain"># libvirt 段增加
</span><span class="z-text z-plain">[libvirt]
</span><span class="z-text z-plain">hw_machine_type=x86_64=pc-i440fx-rhel7.2.0
</span></code></pre>
<p>x86_64类型不多说，后面的这个内容是没有问题的型号，因为刚才创建了一台Test主机，可以看一下他的默认型号，他默认使7.6.
<img src="https://image.boychai.xyz/article/Pasted%20image%2020250104144150.png" alt="" />
修改之后重启服务</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">systemctl</span></span><span class="z-meta z-function-call z-arguments z-shell"> restart libvirtd openstack-nova-compute</span>
</span></code></pre>
<p>重启服务之后重启实例(硬重启)，此时就没问题了
<img src="https://image.boychai.xyz/article/Pasted%20image%2020250104144706.png" alt="" /></p>
<p><img src="https://image.boychai.xyz/article/Pasted%20image%2020250104145203.png" alt="" />
账号是：cirros
密码：gocubsgo</p>
<h2 id="gong-ying-shang-wang-luo-pei-zhi-zi-wang-mei-you-wang-luo">供应商网络配置子网没有网络</h2>
<p>要注意的是，因为搭建的时候采用的是供应商网络，相当于直连，想要上网网段需要和虚机网络一样，网关使用虚机的网关。使用其他的自定义的网络是不可以上网的。</p>

        </section>
        
        

        
            
            
            

            
        
            
            
            

            
        
            
            
            

            
        
            
            
            

            
        
        </article>
</main>


<span id="copy-success" class="hidden">
        Copied!
    </span>
    <span id="copy-init" class="hidden">
        Copy code to clipboard
    </span>
    <script defer src="https://synex.space/js/copyCodeToClipboard.min.js"></script>


    </div>
    <footer>
    <section>
        <nav class="socials nav-navs">
        </nav>

        
        <nav class="nav-navs">
        </nav>

        <div class="credits">
            <small>
                

                
                Powered by
                <a rel="" 

 href="https://www.getzola.org">Zola</a>
                &amp;
                <a rel="" 

 href="https://github.com/welpo/tabi">tabi</a>

                </small>
        </div>
    </section>

    <div id="searchModal" class="search-modal js" role="dialog" aria-labelledby="modalTitle">
    <h1 id="modalTitle" class="visually-hidden">Search</h1>
    <div id="modal-content">
        <div id="searchBar">
            <div class="search-icon" aria-hidden="true">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960">
                    <path d="M784-120 532-372q-30 24-69 38t-83 14q-109 0-184.5-75.5T120-580q0-109 75.5-184.5T380-840q109 0 184.5 75.5T640-580q0 44-14 83t-38 69l252 252-56 56ZM380-400q75 0 127.5-52.5T560-580q0-75-52.5-127.5T380-760q-75 0-127.5 52.5T200-580q0 75 52.5 127.5T380-400Z"/>
                </svg>
            </div>
            <input id="searchInput" role="combobox" autocomplete="off" spellcheck="false" aria-expanded="false" aria-controls="results-container" placeholder="Search…"/>
            <div id="clear-search" class="close-icon interactive-icon" tabindex="0" role="button" title="Clear search">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960">
                <path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/>
                </svg>
            </div>
        </div>
        <div id="results-container">
            <div id="results-info"><span id="zero_results"> No results</span>
                <span id="one_results"> $NUMBER result</span>
                <span id="many_results"> $NUMBER results</span><span id="two_results"> $NUMBER results</span>
                <span id="few_results"> $NUMBER results</span>
            </div>
            <div id="results" role="listbox"></div>
        </div>
    </div>
</div>
</footer>


    
    
</body>

</html>
